Rules list {#Rules}
==========

Introduction
------------

\$HTTP\_RAW\_POST\_DATA Usage {#$http\\_raw\\_post\\_data-usage}
-----------------------------

`$HTTP_RAW_POST_DATA` is deprecated, and should be replaced by
`php://input`.

`$HTTP_RAW_POST_DATA` is deprecated since PHP 5.6.

It is possible to prepare code to this lack of feature by setting
`always_populate_raw_post_data` to -1.

``` {.php}
<?php

// PHP 5.5 and older
$postdata = $HTTP_RAW_POST_DATA;

// PHP 5.6 and more recent
$postdata = file_get_contents(php://input);

?>
```

See also [\$HTTP\_RAW\_POST\_DATA
variable](https://www.php.net/manual/en/reserved.variables.httprawpostdata.php).

### Suggestions

-   Use php://input with fopen() instead.

  ------------- ----------------------------------------
  Short name    Php/RawPostDataUsage

  Rulesets      `CompatibilityPHP56`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

\$php\_errormsg Usage {#$php\\_errormsg-usage}
---------------------

\$php\_errormsg is removed since PHP 8.0. \$php\_errormsg tracks the
last error message, with the directive [track\_errors]{.title-ref}. All
was removed in PHP 8.0, and shall be replaced with
[error\_get\_last()](https://www.php.net/error_get_last).

``` {.php}
<?php

function foo() {
    global $php_errormsg;

    echo 'Last error: '.$php_errormsg;

    echo 'Also, last error: '.error_get_last();
}

?>
```

### Suggestions

-   Use error\_get\_last() instead.

  ------------- ----------------------------------------
  Short name    Php/PhpErrorMsgUsage

  Rulesets      `CompatibilityPHP80`{.interpreted-text
                role="ref"}

  Php Version   8.0-

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

\$this Belongs To Classes Or Traits {#$this-belongs-to-classes-or-traits}
-----------------------------------

[\$this](https://www.php.net/manual/en/language.oop5.basic.php) variable
represents the current object, inside a class or trait scope.

It is a pseudo-variable, and should be used within class\'s or trait\'s
methods and not outside. It should also not be used in
[static](https://www.php.net/manual/en/language.oop5.static.php)
methods.

PHP 7.1 is stricter and check for
[\$this](https://www.php.net/manual/en/language.oop5.basic.php) at
several situations. Some are found by
[static](https://www.php.net/manual/en/language.oop5.static.php)
analysis, some are dynamic analysis.

``` {.php}
<?php

// as an argument
function foo($this) {
    // Using global
    global $this;
    // Using static (not a property)
    static $this;

    // Can't unset it
    unset($this);

    try {
        // inside a foreach
        foreach($a as $this) {  }
        foreach($a as $this => $b) {  }
        foreach($a as $b => $this) {  }
    } catch (Exception $this) {
        // inside a catch
    }

    // with Variable Variable
    $a = this;
    $$a = 42;
}

class foo {
    function bar() {
        // Using references
        $a =& $this;
        $a = 42;

        // Using extract(), parse_str() or similar functions
        extract([this => 42]);  // throw new Error(Cannot re-assign $this)
        var_dump($this);
    }

    static function __call($name, $args) {
        // Using __call
        var_dump($this); // prints object(C)#1 (0) {}, php-7.0 printed NULL
        $this->test();   // prints ops
    }

}
?>
```

### Suggestions

-   Do not use [\$this]{.title-ref} as a variable name, except for the
    current object, in a class, trait or closure.

  ------------- ------------------------------------------------------
  Short name    Classes/ThisIsForClasses

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Examples      `openemr-classes-thisisforclasses`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------

\$this Is Not An Array {#$this-is-not-an-array}
----------------------

`$this` variable represents the current object and it is not an array.

This is unless the class (or its parents) has the `ArrayAccess`
interface, or extends `ArrayObject` or `SimpleXMLElement`.

``` {.php}
<?php

// $this is an array
class Foo extends ArrayAccess {
    function bar() {
        ++$this[3];
    }
}

// $this is not an array
class Foo2 {
    function bar() {
        ++$this[3];
    }
}

?>
```

See also
[ArrayAccess](https://www.php.net/manual/en/class.arrayaccess.php),
[ArrayObject](https://www.php.net/manual/en/class.arrayobject.php) and
[The Basics](https://www.php.net/manual/en/language.oop5.basic.php).

### Suggestions

-   Extends `ArrayObject`, or a class that extends it, to use `$this` as
    an array too.
-   Implements `ArrayAccess` to use `$this` as an array too.
-   Use a property in the current class to store the data, instead of
    \$this directly.

  ------------- -----------------------------
  Short name    Classes/ThisIsNotAnArray

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

\$this Is Not For Static Methods {#$this-is-not-for-static-methods}
--------------------------------

[Static](https://www.php.net/manual/en/language.oop5.static.php) methods
shouldn\'t use
[\$this](https://www.php.net/manual/en/language.oop5.basic.php)
variable.

[\$this](https://www.php.net/manual/en/language.oop5.basic.php) variable
represents an object, the current object. It is not compatible with a
[static](https://www.php.net/manual/en/language.oop5.static.php) method,
which may operate without any object.

While executing a
[static](https://www.php.net/manual/en/language.oop5.static.php) method,
[\$this](https://www.php.net/manual/en/language.oop5.basic.php) is
actually set to
[NULL](https://www.php.net/manual/en/language.types.null.php).

``` {.php}
<?php

class foo {
    static $staticProperty = 1;

    // Static methods should use static properties
    static public function count() {
        return self::$staticProperty++;
    }

    // Static methods can't use $this
    static public function bar() {
        return $this->a;   // No $this usage in a static method
    }
}

?>
```

See also [Static
Keyword](https://www.php.net/manual/en/language.oop5.%60static%20%3Chttps://www.php.net/manual/en/language.oop5.static.php).php\>\`\_.

### Suggestions

-   Remove the static keyword on the method, and update all calls to
    this method to use \$this
-   Remove the usage of \$this in the method, replacing it with static
    properties
-   Make \$this an argument (and change its name) : then, make the
    method a function

  ---------- ------------------------------------------------------------------------------------------
  Short name Classes/ThisIsNotForStatic

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-static-this](https://github.com/dseguy/clearPHP/tree/master/rules/no-static-this.md)
  ---------- ------------------------------------------------------------------------------------------

\*\* For Exponent {#**-for-exponent}
-----------------

The operator `**` calculates exponents, also known as power.

Use it instead of the slower function [pow()](https://www.php.net/pow).
This operator was introduced in PHP 5.6.

``` {.php}
<?php
    $cube = pow(2, 3); // 8

    $cubeInPHP56 = 2 ** 3; // 8
?>
```

Be aware the the \'-\' operator has lower priority than the
[\*\*](https://www.php.net/manual/en/language.operators.arithmetic.php)
operator : this leads to the following confusing result.

``` {.php}
<?php
    echo -3 ** 2;
    // displays -9, instead of 9
?>
```

This is due to the parser that processes separately `-` and the
following number. Since `**` has priority, the power operation happens
first.

Being an operator, `**` is faster than [pow()](https://www.php.net/pow).
This is a microoptimisation.

See also [Arithmetic
Operators](https://www.php.net/manual/en/language.operators.arithmetic.php).

### Suggestions

-   Use the `**` operator
-   For powers of 2, use the bitshift operators
-   For literal powers of 2, consider using the `0xFFFFFFFFF` syntax.

  ------------ ----------------------------------------------------------
  Short name   Php/NewExponent

  Rulesets     `Suggestions`{.interpreted-text role="ref"},
               `php-cs-fixable`{.interpreted-text role="ref"}

  Php Version  With PHP 5.6 and more recent

  Severity     Minor

  Time To Fix  Quick (30 mins)

  Precision    Very high

  Examples     `traq-php-newexponent`{.interpreted-text role="ref"},
               `teampass-php-newexponent`{.interpreted-text role="ref"}
  ------------ ----------------------------------------------------------

::class
-------

PHP has a special class constant to hold the name of the class : `class`
keyword. It represents the class name that is used in the left part of
the operator.

Using `\:\:class` is safer than relying on a string. It does adapt if
the class\'s name or its namespace is changed\'. It is also faster,
though it is a micro-optimisation.

It is introduced in PHP 5.5.

``` {.php}
<?php

use A\B\C as UsedName;

class foo {
    public function bar( ) {
        echo ClassName::class; 
        echo UsedName::class; 
    }
}

$f = new Foo( );
$f->bar( );
// displays ClassName 
// displays A\B\C 

?>
```

Be aware that `\:\:class` is a replacement for
[\_\_CLASS\_\_](https://www.php.net/manual/en/language.constants.predefined.php)
magic constant.

See also [Class
Constant](https://www.php.net/manual/en/language.oop5.constants.php).

### Suggestions

-   Use ::class whenever possible. That exclude any dynamic call.

  ------------- ------------------------------------------------------
  Short name    Php/StaticclassUsage

  Rulesets      `CompatibilityPHP53`{.interpreted-text role="ref"},
                `CompatibilityPHP54`{.interpreted-text role="ref"}

  Php Version   With PHP 5.5 and more recent

  Severity      Major

  Time To Fix   Slow (1 hour)

  Precision     Very high
  ------------- ------------------------------------------------------

@ Operator {#@-operator}
----------

[@](https://www.php.net/manual/en/language.operators.errorcontrol.php)
is the \'no scream\' operator : it suppresses error output.

``` {.php}
<?php

// Set x with incoming value, or else null. 
$x = @$_GET['x'];

?>
```

This operator is actually very slow : it will process the error all the
way up, and finally decide not to display it. It is often faster to
check the conditions first, then run the method without `@`.

You may also set display\_error to 0 in the `php.ini` : this will avoid
user\'s error display, but will keep the error in the PHP logs, for
later processing.

The only situation where `@` is useful is when a native PHP function
displays errors messages when error happens and there is no way to check
it from the code.

This is the case with [fopen()](https://www.php.net/fopen),
[stream\_socket\_server()](https://www.php.net/stream_socket_server),
[token\_get\_all()](https://www.php.net/token_get_all).

See also [Error Control
Operators](https://www.php.net/manual/en/language.operators.errorcontrol.php)
and [Five reasons why the shut-op operator should be
avoided](https://derickrethans.nl/five-reasons-why-the-shutop-operator-should-be-avoided.html).

### Suggestions

-   Remove the @ operator by default

  --------------------- -------------------------- ------ --------------------------------
  Name                  Default                    Type   Description

  authorizedFunctions   noscream\_functions.json   data   Functions that are authorized to
                                                          sports a @.
  --------------------- -------------------------- ------ --------------------------------

  ----------- ------------------------------------------------------------------------------------
  Short name  Structures/Noscream

  Rulesets    `Analyze`{.interpreted-text role="ref"}, `Performances`{.interpreted-text
              role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Quick (30 mins)

  Precision   Very high

  ClearPHP    [no-noscream](https://github.com/dseguy/clearPHP/tree/master/rules/no-noscream.md)

  Examples    `phinx-structures-noscream`{.interpreted-text role="ref"},
              `phpipam-structures-noscream`{.interpreted-text role="ref"}
  ----------- ------------------------------------------------------------------------------------

Abstract Away
-------------

Avoid using PHP native functions that produce data direcly in the code.
For example, [date()](https://www.php.net/date) or
[random\_int()](https://www.php.net/random_int). They should be
abstracted away in a method, that will be replaced later for testing
purposes, or even debugging.

To abstract such calls, place them in a method, and add an interface to
this method. Then, create and use those objects.

``` {.php}
<?php

// abstracted away date 
$today = new MyDate();
echo 'Date : '.$today->date('r');

// hard coded date of today : it changes all the time.
echo 'Date : '.date('r');

interface MyCalendar{
    function date($format) : string ;
}

class MyDate implements MyCalendar {
    function date($format) : string { return date('r'); }
}

// Valid implementation, reserved for testing purpose
// This prevents from waiting 4 years for a test.
class MyDateForTest implements MyCalendar {
    function date($format) : string { return date('r', strtotime('2016-02-29 12:00:00')); }
}

?>
```

This analysis targets two API for abstraction : time and random values.
Time and date related functions may be replaced by
[Carbon](https://carbon.nesbot.com/docs/),
[Clock](https://github.com/lcobucci/clock),
[Chronos](https://github.com/cakephp/chronos). Random values may be
replaced with [RandomLib](https://github.com/ircmaxell/RandomLib/) or a
custome interface.

See also [Being in control of time in
PHP](https://blog.frankdejonge.nl/being-in-control-of-time-in-php/) and
[How to test non-deterministic
code](https://www.orbitale.io/2019/12/24/how-to-test-non-deterministic-code.html).

### Suggestions

-   Abstract away the calls to native PHP functions, and upgrade the
    unit tests

  --------------------- --------- ----------- --------------------------------------------
  Name                  Default   Type        Description

  abstractableCalls               ini\_hash   Functions that shouldn\'t be called
                                              directly, unless in a method.

  abstractableClasses             ini\_hash   Classes that shouldn\'t be instantiated
                                              directly, unless in a method.
  --------------------- --------- ----------- --------------------------------------------

  ------------- ---------------------------------
  Short name    Patterns/AbstractAway

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Abstract Or Implements
----------------------

A class must implements all abstract methods of it
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php),
or be abstract too.

While PHP lints this code, it won\'t execute it and stop with a Fatal
Error :
`Class BA contains 1 abstract method and must therefore be declared abstract or implement the remaining methods (A\:\:aFoo)`.

``` {.php}
<?php

abstract class Foo { 
    abstract function FooBar();
}

// This is in another file : php -l would detect it right away

class FooFoo extends Foo { 
    // The method is not defined. 
    // The class must be abstract, just like Foo
}

?>
```

See also [Class Abstraction](https://www.php.net/abstract).

### Suggestions

-   Implements all the abstract methods of the class
-   Make the class abstract

  ------------- --------------------------------------------------------
  Short name    Classes/AbstractOrImplements

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Examples      `zurmo-classes-abstractorimplements`{.interpreted-text
                role="ref"}
  ------------- --------------------------------------------------------

Abstract Static Methods
-----------------------

Methods cannot be both abstract and
[static](https://www.php.net/manual/en/language.oop5.static.php).
[Static](https://www.php.net/manual/en/language.oop5.static.php) methods
belong to a class, and will not be overridden by the child class. For
normal methods, PHP will start at the object level, then go up the
hierarchy to find the method. With
[static](https://www.php.net/manual/en/language.oop5.static.php), it is
necessary to mention the name, or use Late
[Static](https://www.php.net/manual/en/language.oop5.static.php)
Binding, with
[self](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
or [static](https://www.php.net/manual/en/language.oop5.static.php).
Hence, it is useless to have an abstract
[static](https://www.php.net/manual/en/language.oop5.static.php) method
: it should be a
[static](https://www.php.net/manual/en/language.oop5.static.php) method.

A child class is able to declare a method with the same name than a
[static](https://www.php.net/manual/en/language.oop5.static.php) method
in the
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php),
but those two methods will stay independent.

This is not the case anymore in PHP 7.0+.

``` {.php}
<?php

abstract class foo {
    // This is not possible
    static abstract function bar() ;
}

?>
```

See also [Why does PHP 5.2+ disallow abstract \`static
\<https://www.php.net/manual/en/language.oop5.static.php\>]{.title-ref}\_
class methods?
\<<https://stackoverflow.com/questions/999066/why-does-php-5-2-disallow-abstract-%60static>
\<<https://www.php.net/manual/en/language.oop5.static.php>\>[\_-class-methods\>]().

### Suggestions

-   Remove abstract keyword from the method
-   Remove static keyword from the method
-   Remove the method

  ------------- -----------------------------
  Short name    Classes/AbstractStatic

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.0 and older

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Access Protected Structures
---------------------------

It is not allowed to access protected properties or methods from outside
the class or its relatives.

``` {.php}
<?php

class foo {
    protected $bar = 1;
}

$foo = new Foo();
$foo->bar = 2;

?>
```

See also
[Visibility](https://www.php.net/manual/en/language.oop5.visibility.php)
and [Understanding The Concept Of Visibility In Object Oriented
PHP](https://torquemag.io/2016/05/understanding-concept-visibility-object-oriented-php/).

### Suggestions

-   Change \'protected\' to \'public\' to relax the constraint
-   Add a getter method to reach the target value
-   Remove the access to the protected value and find it another way

  ------------- -----------------------------
  Short name    Classes/AccessProtected

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Accessing Private
-----------------

List of calls to private properties/methods that will compile but yield
some fatal error upon execution.

``` {.php}
<?php

class a {
    private $a;
}

class b extends a {
    function c() {
        $this->a;
    }
}

?>
```

  ------------- -----------------------------
  Short name    Classes/AccessPrivate

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Add Default Value
-----------------

Parameter in methods definition may receive a default value. This allows
the called method to set a value when the parameter is omitted.

``` {.php}
<?php

function foo($i) {
    if (!is_integer($i)) {
        $i = 0;
    }
}

?>
```

See also [Function
arguments](https://www.php.net/manual/en/functions.arguments.php).

### Suggestions

-   Add a default value for parameters

  ---------- ------------------------------------------------------------
  Short name Functions/AddDefaultValue

  Rulesets   `Suggestions`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `zurmo-functions-adddefaultvalue`{.interpreted-text
             role="ref"},
             `typo3-functions-adddefaultvalue`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Adding Zero
-----------

Adding 0 is useless, as 0 is the neutral element for addition. Besides,
when one of the argument is an integer, PHP triggers a cast to integer.

It is recommended to make the cast explicit with `(int)`.

``` {.php}
<?php

// Explicit cast
$a = (int) foo();

// Useless addition
$a = foo() + 0;
$a = 0 + foo();

// Also works with minus
$b = 0 - $c; // drop the 0, but keep the minus
$b = $c - 0; // drop the 0 and the minus

$a += 0;
$a -= 0;

?>
```

Adding zero is also reported when the zero is a defined constants.

If it is used to type cast a value to integer, then casting with `(int)`
is clearer.

### Suggestions

-   Remove the +/- 0, may be the whole assignation
-   Use an explicit type casting operator (int)

  ----------- --------------------------------------------------------------------------------------------
  Short name  Structures/AddZero

  Rulesets    `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Instant (5 mins)

  Precision   High

  ClearPHP    [no-useless-math](https://github.com/dseguy/clearPHP/tree/master/rules/no-useless-math.md)

  Examples    `thelia-structures-addzero`{.interpreted-text role="ref"},
              `openemr-structures-addzero`{.interpreted-text role="ref"}
  ----------- --------------------------------------------------------------------------------------------

Aliases Usage
-------------

PHP manual recommends to avoid function aliases.

Some functions have several names, and both may be used the same way.
However, one of the names is the main name, and the others are aliases.
Aliases may be removed or change or dropped in the future. Even if this
is not forecast, it is good practice to use the main name, instead of
the aliases.

``` {.php}
<?php

// official way to count an array
$n = count($array);

// official way to count an array
$n = sizeof($array);

?>
```

Aliases are compiled in PHP, and do not provide any performances over
the normal function.

Aliases are more likely to be removed later, but they have been around
for a long time.

See documentation : [List of function
aliases](https://www.php.net/manual/en/aliases.php).

### Suggestions

-   Always use PHP recommended functions

  ---------- ----------------------------------------------------------------------------------
  Short name Functions/AliasesUsage

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-aliases](https://github.com/dseguy/clearPHP/tree/master/rules/no-aliases.md)

  Examples   `cleverstyle-functions-aliasesusage`{.interpreted-text role="ref"},
             `phpmyadmin-functions-aliasesusage`{.interpreted-text role="ref"}
  ---------- ----------------------------------------------------------------------------------

All Uppercase Variables
-----------------------

Usually, global variables are all in uppercase, so as to differentiate
them easily. Though, this is not always the case, with examples like
\$argc, \$argv or \$http\_response\_header.

When using custom variables, try to use lowercase `$variables`,
`$camelCase`, `$sturdyCase` or `$snake_case`.

``` {.php}
<?php

// PHP super global, also identified by the initial _
$localVariable = $_POST;

// PHP globals
$localVariable = $GLOBALS['HTTPS'];

?>
```

See also [Predefined
Variables](https://www.php.net/manual/en/reserved.variables.php).

  ------------- -------------------------------------------------------------
  Short name    Variables/VariableUppercase

  Rulesets      `Coding Conventions <coding-conventions>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- -------------------------------------------------------------

Already Parents Interface
-------------------------

The same interface is implemented by a class and one of its children.

That way, the child doesn\'t need to implement the interface, nor define
its methods to be an instance of the interface.

``` {.php}
<?php

interface i { 
    function i();
}

class A implements i {
    function i() {
        return __METHOD__;
    }
}

// This implements is useless. 
class AB extends A implements i {
    // No definition for function i()
}

// Implements i is understated
class AB extends A {
    // redefinition of the i method
    function i() {
        return __METHOD__.' ';
    }
}

$x = new AB;
var_dump($x instanceof i);
// true

$x = new AC;
var_dump($x instanceof i);
// true

?>
```

### Suggestions

-   Keep the implements call in the class that do implements the
    methods. Remove it from the children classes.

  ----------- ------------------------------------------------------------------
  Short name  Interfaces/AlreadyParentsInterface

  Rulesets    `Analyze`{.interpreted-text role="ref"},
              `Suggestions`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Instant (5 mins)

  Precision   Very high

  Examples    `wordpress-interfaces-alreadyparentsinterface`{.interpreted-text
              role="ref"},
              `thelia-interfaces-alreadyparentsinterface`{.interpreted-text
              role="ref"}
  ----------- ------------------------------------------------------------------

Already Parents Trait
---------------------

Trait is already used a
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)\'s
class or trait. There is no use to include it a second time.

``` {.php}
<?php

trait ta {
    use tb;
}

trait t1 {
    use ta;
    use tb; // also used by ta
}

class b {
    use t1; // also required by class c
    use ta; // also required by trait t1
}

class c extends b {
    use t1;
}

?>
```

See also
[Traits](https://www.php.net/manual/en/language.oop5.traits.php).

### Suggestions

-   Eliminate one of the trait request

  ------------- -----------------------------
  Short name    Traits/AlreadyParentsTrait

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Altering Foreach Without Reference
----------------------------------

[Foreach()](https://www.php.net/manual/en/control-structures.foreach.php)
loop that should use a reference.

When using a foreach loop that modifies the original source, it is
recommended to use referenced variables, rather than access the original
value with \$source\[\$index\].

Using references is then must faster, and easier to read.

``` {.php}
<?php

// Using references in foreach
foreach($source as $key => &$value) {
    $value = newValue($value, $key);
}

// Avoid foreach : use array_map
$source = array_walk($source, 'newValue');
    // Here, $key MUST be the second argument or newValue

// Slow version to update the array
foreach($source as $key => &$value) {
    $source[$key] = newValue($value, $key);
}
?>
```

You may also use [array\_walk()](https://www.php.net/array_walk) or
[array\_map()](https://www.php.net/array_map) (when \$key is not used)
to avoid the use of foreach.

See also
[foreach](https://www.php.net/manual/en/control-structures.foreach.php).

### Suggestions

-   Add the reference on the modified blind variable, and avoid
    accessing the source array

  ---------- --------------------------------------------------------------------------------------------------------------------------------
  Short name Structures/AlteringForeachWithoutReference

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [use-reference-to-alter-in-foreach](https://github.com/dseguy/clearPHP/tree/master/rules/use-reference-to-alter-in-foreach.md)

  Examples   `contao-structures-alteringforeachwithoutreference`{.interpreted-text role="ref"},
             `wordpress-structures-alteringforeachwithoutreference`{.interpreted-text role="ref"}
  ---------- --------------------------------------------------------------------------------------------------------------------------------

Alternative Syntax Consistence
------------------------------

PHP allows for two syntax : the alternative syntax, and the classic
syntax.

The classic syntax is almost always used. When used, the alternative
syntax is used in templates.

This analysis reports files that are using both syntax at the same time.
This is confusing.

``` {.php}
<?php

// Mixing both syntax is confusing.
foreach($array as $item) : 
    if ($item > 1) {
        print $item elements\n;
    } else {
        print $item element\n;
    }
endforeach;

?>
```

  ------------- -----------------------------------------
  Short name    Structures/AlternativeConsistenceByFile

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------------------

Always Anchor Regex
-------------------

Unanchored regex finds the requested pattern, and leaves room for
malicious content.

Without `^` and `$`, the regex searches for any pattern that satisfies
the criteria, leaving any unused part of the string available for
arbitrary content. It is recommended to use both anchor

``` {.php}
<?php

$birthday = getSomeDate($_GET);

// Permissive version : $birthday = '1970-01-01<script>xss();</script>';
if (!preg_match('/\d{4}-\d{2}-\d{2}/', $birthday) {
    error('Wrong data format for your birthday!');
}

// Restrictive version : $birthday = '1970-01-01';
if (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $birthday) {
    error('Wrong data format for your birthday!');
}

echo 'Your birthday is on '.$birthday;

?>
```

Note that \$ may be a line ending, still leaving room after it for
injection.

``` {.php}
<?php

$birthday = '1970-01-01'.PHP_EOL.'<script>xss();</script>';

?>
```

This analysis reports false positive when the regex is used to search a
pattern in a much larger string. Check if this rule doesn\'t apply,
though.

See also [CWE-625: Permissive Regular
Expression](https://cwe.mitre.org/data/definitions/625.html).

### Suggestions

-   Add an anchor to the beginning and ending of the string

  ------------- ------------------------------
  Short name    Security/AnchorRegex

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)
  ------------- ------------------------------

Always Positive Comparison
--------------------------

Some PHP native functions, such as [count()](https://www.php.net/count),
[strlen()](https://www.php.net/strlen), or
[abs()](https://www.php.net/abs) only returns positive or null values.

When comparing them to 0, the following expressions are always true and
should be avoided.

``` {.php}
<?php

$a = [1, 2, 3];

var_dump(count($a) >= 0);
var_dump(count($a) < 0); 

?>
```

### Suggestions

-   Compare count() to non-zero values
-   Use empty()

  ------------- ------------------------------------------------------
  Short name    Structures/NeverNegative

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)

  Examples      `magento-structures-nevernegative`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------

Always Use Function With array\_key\_exists() {#always-use-function-with-array\\_key\\_exists()}
---------------------------------------------

[array\_key\_exists()](https://www.php.net/array_key_exists) has been
granted a special VM opcode, and is much faster. This applies to PHP 7.4
and more recent.

It requires that
[array\_key\_exists()](https://www.php.net/array_key_exists) is
statically resolved, either with an initial `\`, or a `use function`
expression. This doesn\'t affect the global namespace.

``` {.php}
<?php

namespace my/name/space;

// do not forget the 'function' keyword, or it will apply to classes.
use function array_key_exists as foo; // the alias is not necessary, and may be omitted.

// array_key_exists is aliased to foo : 
$c = foo($a, $b);

// This call requires a fallback to global, and will be slow.
$c = array_key_exists($a, $b);

?>
```

This analysis is related to Php/ShouldUseFunction, and is a special
case, that only concerns
[array\_key\_exists()](https://www.php.net/array_key_exists).

See also [Add array\_key\_exists to the list of specialy compiled
functions](https://bugs.php.net/bug.php?id=76148).

### Suggestions

-   Use the [use]{.title-ref} command for arrray\_key\_exists(), at the
    beginning of the script
-   Use an initial before array\_key\_exists()
-   Remove the namespace

  ------------- ----------------------------------
  Short name    Performances/Php74ArrayKeyExists

  Rulesets      `Performances`{.interpreted-text
                role="ref"}

  Php Version   7.4+

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Ambiguous Array Index
---------------------

Indexes should not be defined with different types than int or string.

Array indices only accept integers and strings, so any other type of
literal is reported. In fact, `null` is turned into an empty string,
booleans are turned into an integer, and real numbers are truncated (not
rounded).

``` {.php}
<?php

$x = [ 1  => 1,
      '1' => 2,
      1.0 => 3,
      true => 4];
// $x only contains one element : 1 => 4

// Still wrong, immediate typecast to 1
$x[1.0]  = 5; 
$x[true] = 6; 

?>
```

They are indeed distinct, but may lead to confusion.

See also
[array](https://www.php.net/manual/en/language.types.array.php).

### Suggestions

-   Only use string or integer as key for an array.
-   Use transtyping operator (string) and (int) to make sure of the type

  ---------- ------------------------------------------------------------
  Short name Arrays/AmbiguousKeys

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `prestashop-arrays-ambiguouskeys`{.interpreted-text
             role="ref"}, `mautic-arrays-ambiguouskeys`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Ambiguous Static
----------------

Methods or properties with the same name, are defined
[static](https://www.php.net/manual/en/language.oop5.static.php) in one
class, and not
[static](https://www.php.net/manual/en/language.oop5.static.php) in
another. This is error prone, as it requires a good knowledge of the
code to make it
[static](https://www.php.net/manual/en/language.oop5.static.php) or not.

Try to keep the methods simple and unique. Consider renaming the methods
and properties to distinguish them easily. A method and a
[static](https://www.php.net/manual/en/language.oop5.static.php) method
have probably different responsibilities.

``` {.php}
<?php

class a {
    function mixedStaticMethod() {}
}

class b {
    static function mixedStaticMethod() {}
}

/... a lot more code later .../

$c->mixedStaticMethod();
// or 
$c::mixedStaticMethod();

?>
```

  ------------- -----------------------------
  Short name    Classes/AmbiguousStatic

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- -----------------------------

Ambiguous Visibilities
----------------------

The properties have the same name, but have different visibilities,
across different classes.

While it is legit to have a property with the same name in different
classes, it may easily lead to confusion. As soon as the context is need
to understand if the property is accessible or not, the readability
suffers.

It is recommended to handle the same properties in the same way across
classes, even when the classes are not related.

``` {.php}
<?php

class person {
    public $name;
    private $address;
}

class gangster {
    private $name;
    public $nickname;
    private $address;
}

$someone = Human::load(123);
echo 'Hello, '.$someone->name;

?>
```

### Suggestions

-   Sync visibilities for both properties, in the different classes
-   Use different names for properties with different usages

  ------------- ---------------------------------------------------------
  Short name    Classes/AmbiguousVisibilities

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Examples      `typo3-classes-ambiguousvisibilities`{.interpreted-text
                role="ref"}
  ------------- ---------------------------------------------------------

Anonymous Classes
-----------------

Anonymous classes.

``` {.php}
<?php

// Anonymous class, available since PHP 7.0
$object = new class { function __construct() { echo __METHOD__; } };

?>
```

  ---------- --------------------------------------------------------------
  Short name Classes/Anonymous

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and more recent
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- --------------------------------------------------------------

Argument Should Be Typehinted
-----------------------------

When a method expects objects as argument, those arguments should be
typehinted. This way, it provides early warning that a wrong object is
being sent to the method.

The analyzer will detect situations where a class, or the keywords
\'array\' or \'callable\'.

``` {.php}
<?php

// What are the possible classes that have a 'foo' method? 
function foo($bar) {
    return $bar->foo();
}

?>
```

[Closure](https://www.php.net/manual/en/class.closure.php) arguments are
omitted.

See also [Type
declarations](https://www.php.net/manual/en/functions.arguments.php#functions.arguments.type-declaration).

### Suggestions

-   Add the typehint to the function arguments

  ---------- --------------------------------------------------------------------------------------------
  Short name Functions/ShouldBeTypehinted

  Rulesets   `Typechecks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  ClearPHP   [always-typehint](https://github.com/dseguy/clearPHP/tree/master/rules/always-typehint.md)

  Examples   `dolphin-functions-shouldbetypehinted`{.interpreted-text role="ref"},
             `mautic-functions-shouldbetypehinted`{.interpreted-text role="ref"}
  ---------- --------------------------------------------------------------------------------------------

Array\_Fill() With Objects {#array\\_fill()-with-objects}
--------------------------

[array\_fill()](https://www.php.net/array_fill) fills an array with
identical objects, not copies nor clones. This means that all the filled
objects are a reference to the same object. Changing one of them will
change any of them.

Make sure this is the intended effect in the code.

``` {.php}
<?php

$x = new StdClass();
$array = array_fill(0, 10, $x);

$array[3]->y = Set in object #3;

// displays Set in object #3;
echo $array[5]->y;

?>
```

This applies to [array\_pad()](https://www.php.net/array_pad) too. It
doesn\'t apply to
[array\_fill\_keys()](https://www.php.net/array_fill_keys), as objects
will be cast to a string before usage in this case.

### Suggestions

-   Use a loop to fill in the array with cloned() objects.

  ------------- ---------------------------------
  Short name    Structures/ArrayFillWithObjects

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Array\_merge Needs Array Of Arrays {#array\\_merge-needs-array-of-arrays}
----------------------------------

When collecting data to feed
[array\_merge()](https://www.php.net/array_merge), use an array of array
as default value. `` `array(`array()) <https://www.php.net/array>`_ ``[
is the neutral value for \`array\_merge()
\<https://www.php.net/array\_merge\>]{.title-ref}\_;

This analysis also reports when the used types are not an array :
[array\_merge()](https://www.php.net/array_merge) does not accept scalar
values, but only arrays.

``` {.php}
<?php

// safe default value
$a = array(array());

// when $list is empty, it is 
foreach($list as $l) {
    $a[] = $l;
}
$b = array_merge($a);

?>
```

Since PHP 7.4, it is possible to call
[array\_merge()](https://www.php.net/array_merge) without an argument :
this means the default value may an empty array. This array shall not
contain scalar values.

See also [array\_merge](https://www.php.net/array_merge).

### Suggestions

-   Use `` `array(array()) ``[ or ]{.title-ref}`[[]]`\` as default value
    for array\_merge()
-   Remove any non-array value from the values in the default array

  ------------- ---------------------------------
  Short name    Structures/ArrayMergeArrayArray

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Assert Function Is Reserved
---------------------------

Avoid defining an `assert` function in namespaces.

While they work fine when the assertions are active
(`zend.assertions=1`), calls to unqualified `assert` are optimized away
when assertions are not active.

Since PHP 7.3, a fatal error is emitted :
`` Defining a custom `assert() <https://www.php.net/assert>`_ function is deprecated, as the function has special semantics ``.

``` {.php}
<?php
//      Run this with zend.assertions=1 and 
// Then run this with zend.assertions=0

namespace Test {
    function assert() {
        global $foo;

        $foo = true;
    }
}

namespace Test {
    assert();

    var_dump(isset($foo));
}

?>
```

See also [assert](https://www.php.net/assert) and [User-defined assert
function is optimized away with
zend.assertions=-1](https://bugs.php.net/bug.php?id=75445).

### Suggestions

-   Rename the custom function with another name

  ------------- -------------------------------------------
  Short name    Php/AssertFunctionIsReserved

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CompatibilityPHP73`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Slow (1 hour)
  ------------- -------------------------------------------

Assign And Compare
------------------

Assignation has a lower precedence than comparison. As such, the
assignation always happens after the comparison. This leads to the
comparison being stored in the variable, and not the value being
compared.

``` {.php}
<?php

if ($id = strpos($string, $needle) !== false) { 
    // $id now contains a boolean (true or false), but not the position of the $needle.
}

// probably valid comparison, as $found will end up being a boolean
if ($found = strpos($string, $needle) === false) { 
    doSomething();
}

// always valid comparison, with parenthesis
if (($id = strpos($string, $needle)) !== false) { 
    // $id now contains a boolean (true or false), but not the position of the $needle.
}

// Being a lone instruction, this is always valid : there is no double usage with if condition
$isFound = strpos($string, $needle) !== false;


?>
```

See also [Operator
Precedence](https://www.php.net/manual/en/language.operators.precedence.php).

### Suggestions

-   Use parenthesis
-   Separate assignation and comparison
-   Drop assignation or comparison

  ------------- ----------------------------------
  Short name    Structures/AssigneAndCompare

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Assign Default To Properties
----------------------------

Properties may be assigned default values at declaration time. Such
values may be later modified, if needed.

``` {.php}
<?php

class foo {
    private $propertyWithDefault = 1;
    private $propertyWithoutDefault;
    private $propertyThatCantHaveDefault;

    public function __construct() {
        // Skip this extra line, and give the default value above
        $this->propertyWithoutDefault = 1;

        // Static expressions are available to set up simple computation at definition time.
        $this->propertyWithoutDefault = OtherClass::CONSTANT + 1;

        // Arrays, just like scalars, may be set at definition time
        $this->propertyWithoutDefault = [1,2,3];

        // Objects or resources can't be made default. That is OK.
        $this->propertyThatCantHaveDefault = fopen('/path/to/file.txt');
        $this->propertyThatCantHaveDefault = new Fileinfo();
    }
}

?>
```

Default values will save some instructions in the constructor, and makes
the value obvious in the code.

### Suggestions

-   Add a default value whenever possible. This is easy for scalars, and
    array()

  ---------- ------------------------------------------------------------------------------------------------------------------------
  Short name Classes/MakeDefault

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [use-properties-default-values](https://github.com/dseguy/clearPHP/tree/master/rules/use-properties-default-values.md)

  Examples   `livezilla-classes-makedefault`{.interpreted-text role="ref"}, `phpmyadmin-classes-makedefault`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------------------------------------------------------------------

Assign With And Precedence
--------------------------

The lettered logical operators yield to assignation. It may collect less
information than expected.

It is recommended to use the &&, \^ and \|\| operators, instead of and,
or and xor, to prevent confusion.

``` {.php}
<?php

// The expected behavior is 
// The following are equivalent
 $a =  $b  && $c;
 $a = ($b && $c);

// The unexpected behavior is 
// The following are equivalent
 $a = $b  and $c;
($a = $b) and $c;

?>
```

See also [Operator
Precedence](https://www.php.net/manual/en/language.operators.precedence.php).

### Suggestions

-   Always use symbol && rather than letter and
-   To be safe, add parenthesis to enforce priorities

  ------------- --------------------------------------------
  Short name    Php/AssignAnd

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Critical

  Time To Fix   Quick (30 mins)

  Precision     Very high

  Examples      `xataface-php-assignand`{.interpreted-text
                role="ref"}
  ------------- --------------------------------------------

Assigned Twice
--------------

The same variable is assigned twice in the same function.

While this is possible and quite common, it is also a good practice to
avoid changing a value from one literal to another. It is far better to
assign the new value to

Incremental changes to a variables are not reported here.

``` {.php}
<?php

function foo() {
    // incremental changes of $a;
    $a = 'a';
    $a++;
    $a = uppercase($a);

    $b = 1;
    $c = bar($b);
    // B changed its purpose. Why not call it $d? 
    $b = array(1,2,3);

    // This is some forgotten debug
    $e = $config->getSomeList();
    $e = array('OneElement');
}

?>
```

  ------------- -------------------------------
  Short name    Variables/AssignedTwiceOrMore

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------

Assumptions
-----------

Assumptions in the code, that leads to possible bugs.

Some conditions may be very weak, and lead to errors. For example, the
code below checks that the variable [\$a]{.title-ref} is not null, then
uses it as an array. There is no relationship between \'not null\' and
\'being an array\', so this is an assumption.

``` {.php}
<?php

// Assumption : if $a is not null, then it is an array. This is not always the case. 
function foo($a) {
    if ($a !== null) {
        echo $a['name'];
    }
}

// Assumption : if $a is not null, then it is an array. Here, the typehint will ensure that it is the case. 
// Although, a more readable test is is_array()
function foo(?array $a) {
    if ($a !== null) {
        echo $a['name'];
    }
}

?>
```

See also [From assumptions to
assertions](https://rskuipers.com/entry/from-assumptions-to-assertions).

### Suggestions

-   

  ------------- -----------------------------
  Short name    Php/Assumptions

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Autoappend
----------

Appending a variable to itself leads to enormous usage of memory.

``` {.php}
<?php

// Always append a value to a distinct variable
foreach($a as $b) {
    $c[] = $b;
}

// This copies the array to itself, and double the size each loop
foreach($a as $b) {
    $c[] = $c;
}
?>
```

### Suggestions

-   Change the variable in the append, on the left
-   Change the variable in the append, on the right

  ------------- ----------------------------------
  Short name    Performances/Autoappend

  Rulesets      `Performances`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Avoid Concat In Loop
--------------------

Concatenations inside a loop generate a lot of temporary variables. They
are accumulated and tend to raise the memory usage, leading to slower
performances.

It is recommended to store the values in an array, and then use
[implode()](https://www.php.net/implode) on that array to make the
concatenation at once. The effect is positive when the source array has
at least 50 elements.

``` {.php}
<?php

// Concatenation in one operation
$tmp = array();
foreach(data_source() as $data) {
    $tmp[] = $data;
}
$final = implode('', $tmp);

// Concatenation in many operations
foreach(data_source() as $data) {
    $final .= $data;
}

?>
```

The same doesn\'t apply to addition and multiplication, with
[array\_sum()](https://www.php.net/array_sum) and array\_multiply(), as
those operations work on the current memory allocation, and don\'t need
to allocate new memory at each step.

See also [PHP 7 performance improvements (3/5): Encapsed strings
optimization](https://blog.blackfire.io/php-7-performance-improvements-encapsed-strings-optimization.html).

### Suggestions

-   Collect all pieces in an array, then implode() the array in one
    call.

  ---------- -------------------------------------------------------------
  Short name Performances/NoConcatInLoop

  Rulesets   `Performances`{.interpreted-text role="ref"},
             `Top10`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Slow (1 hour)
  Fix        

  Examples   `suitecrm-performances-noconcatinloop`{.interpreted-text
             role="ref"},
             `thinkphp-performances-noconcatinloop`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Avoid Large Array Assignation
-----------------------------

Avoid setting large arrays to local variables. This is done every time
the function is called.

There are different ways to avoid this : inject the array, build the
array once. Using an constant or even a global variable is faster.

The effect on small arrays (less than 10 elements) is not significant.
Arrays with 10 elements or more are reported here. The effect is also
more important on functions that are called often, or within loops.

``` {.php}
<?php

// with constants, for functions
const ARRAY = array(1,2,3,4,5,6,7,8,9,10,11);
function foo() {
    $array = ARRAY;
    //more code
}

// with class constants, for methods 
class x {
    const ARRAY = array(1,2,3,4,5,6,7,8,9,10,11);
    function foo() {
        $array = self::ARRAY;
        //more code
    }
}

// with properties, for methods 
class x {
    private $array = array(1,2,3,4,5,6,7,8,9,10,11);

    function foo() {
        $array = $this->array;
        //more code
    }
}

// injection, leveraging default values
function foo($array = array(1,2,3,4,5,6,7,8,9,10,11)) {
    //more code
}

// local cache with static
function foo() {
    static $array;
    if ($array === null) {
        $array = array(1,2,3,4,5,6,7,8,9,10,11);
    }

    //more code
}

// Avoid creating the same array all the time in a function
class x {
    function foo() {
        // assign to non local variable is OK. 
        // Here, to a property, though it may be better in a __construct or as default values
        $this->s = array(1,2,3,4,5,6,7,8,9,10,11);

        // This is wasting resources, as it is done each time. 
        $array = array(1,2,3,4,5,6,7,8,9,10,11);
    }
}

?>
```

### Suggestions

-   Make the literal a global constant or a class constant
-   Make the literal an argument, so it is injected
-   Make the literal an property, with it as default value

  ------------- ------------------------------------
  Short name    Structures/NoAssignationInFunction

  Rulesets      `Performances`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Precision     High
  ------------- ------------------------------------

Avoid Optional Properties
-------------------------

Avoid optional properties, to prevent littering the code with existence
checks.

When a property has to be checked once for existence, it is safer to
check it each time. This leads to a decrease in readability and a lot of
checks added to the code.

Either make sure the property is set with an actual object rather than
with null, or use a null object. A null object offers the same interface
than the expected object, but does nothing. It allows calling its
methods, without running into a Fatal error, nor testing it.

``` {.php}
<?php

// Example is courtesy 'The Coding Machine' : it has been adapted from its original form. See link below.

class MyMailer {
    private $logger;

    public function __construct(LoggerInterface $logger = null) {
        $this->logger = $logger;
    }

    private function sendMail(Mail $mail) {
        // Since $this->logger may be null, it must be tested anytime it is used.
        if ($this->logger) {
            $this->logger->info('Mail successfully sent.');
        }
    }
}

?>
```

See also [Avoid optional services as much as
possible](http://bestpractices.thecodingmachine.com/php/design_beautiful_classes_and_methods.html#avoid-optional-services-as-much-as-possible),
[The Null Object Pattern -- Polymorphism in Domain
Models](https://www.sitepoint.com/the-null-object-pattern-polymorphism-in-domain-models/),
and [Practical PHP Refactoring: Introduce Null
Object](https://dzone.com/articles/practical-php-refactoring-26).

### Suggestions

-   Use a null object to fill any missing value
-   Make sure the property is set at constructor time

  ---------- ---------------------------------------------------------------
  Short name Classes/AvoidOptionalProperties

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Slow (1 hour)
  Fix        

  Examples   `churchcrm-classes-avoidoptionalproperties`{.interpreted-text
             role="ref"},
             `dolibarr-classes-avoidoptionalproperties`{.interpreted-text
             role="ref"}
  ---------- ---------------------------------------------------------------

Avoid Parenthesis
-----------------

Avoid Parenthesis for language construct. Languages constructs are a few
PHP native elements, that looks like functions but are not.

Among other distinction, those elements cannot be directly used as
variable function call, and they may be used with or without
parenthesis.

``` {.php}
<?php

// normal usage of include
include 'file.php';

// This looks like a function and is not
include('file2.php');

?>
```

The usage of parenthesis actually give some feeling of comfort, it
won\'t prevent PHP from combining those argument with any later
operators, leading to unexpected results.

Even if most of the time, usage of parenthesis is legit, it is
recommended to avoid them.

  ------------- ------------------------------------
  Short name    Structures/PrintWithoutParenthesis

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------

Avoid Real
----------

PHP has two float data type : real and double. `real` is rarely used,
and might be deprecated in PHP 7.4.

To prepare code, avoid using [is\_real()](https://www.php.net/is_real)
and the `(real)` typecast.

``` {.php}
<?php

// safe way to check for float
if (!is_float($a)) {
    $a = (float) $a;
}

// Avoid doing that
if (!is_real($a)) {
    $a = (real) $a;
}

?>
```

See also [PHP RFC: Deprecations for PHP
7.4](https://wiki.php.net/rfc/deprecations_php_7_4).

### Suggestions

-   Replace is\_real() by is\_float()
-   Replace (real) by (float)

  ------------- ----------------------------------
  Short name    Php/AvoidReal

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"},
                `Top10`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Avoid Self In Interface
-----------------------

[Self](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
and
[Parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
are tricky when used in an interface.

`self` refers to the current interface or its extended parents : as long
as the constant is defined in the interface family, this is valid. On
the other hand, when `self` refers to the current class, the resolution
of names will happen at execution time, leading to confusing results.

`parent` has the same behavior than `self`, except that it doesn\'t
accept to be used inside an interface, as it will yield an error. This
is one of those error that lint but won\'t execute in certain
conditions.

`Static` can\'t be used in an interface, as it needs to be resolved at
call time anyway.

``` {.php}
<?php

interface i extends ii {
    // This 'self' is valid : it refers to the interface i
    public const I = self::I2 + 2;

    // This 'self' is also valid, as it refers to interface ii, which is a part of interface i
    public const I2 = self::IP + 4; 

    // This makes interface i dependant on the host class
    public const I3 = parent::A;
}

?>
```

See also [Scope Resolution Operator
(::)](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php).

### Suggestions

-   Use a fully qualified namespace instead of self
-   Use a locally defined constant, so self is a valid reference

  ------------- ---------------------------------
  Short name    Interfaces/AvoidSelfInInterface

  Rulesets      `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Slow (1 hour)
  ------------- ---------------------------------

Avoid Substr() One {#avoid-substr()-one}
------------------

Use array notation `$string[$position]` to reach a single byte in a
string.

There are two ways to access a byte in a string :
[substr()](https://www.php.net/substr) and `$v[$pos]`.

The second style is more readable. It may be up to four times faster,
though it is a micro-optimization. It is recommended to use it.

PHP 7.1 also introduces the support of negative offsets as string index
: negative offset are also reported.

``` {.php}
<?php

$string = 'ab人cde';

echo substr($string, $pos, 1);
echo $string[$pos];

echo mb_substr($string, $pos, 1);

// when $pos = 1
// displays bbb
// when $pos = 2
// displays ??人

?>
```

Beware that [substr()](https://www.php.net/substr) and `$v[$pos]` are
similar, while [mb\_substr()](https://www.php.net/mb_substr) is not. The
first function works on bytes, while the latter works on characters.

### Suggestions

-   Replace substr() with the array notations for strings.
-   Replace substr() with a call to mb\_substr().

  ---------- ---------------------------------------------------------------
  Short name Structures/NoSubstrOne

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Performances`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `Suggestions`{.interpreted-text role="ref"},
             `Top10`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `churchcrm-structures-nosubstrone`{.interpreted-text
             role="ref"},
             `livezilla-structures-nosubstrone`{.interpreted-text
             role="ref"}
  ---------- ---------------------------------------------------------------

Avoid Those Hash Functions
--------------------------

The following cryptography algorithms are considered insecure, and
should be replaced with new and more performant algorithms.

`MD2`, `MD4`, `MD5`, `SHA0`, `SHA1`, `CRC`, `DES`, `3DES`, `RC2`, `RC4`.

When possible, avoid using them, may it be as PHP functions, or hashing
function configurations (mcrypt, hash\...).

``` {.php}
<?php

// Weak cryptographic algorithm
echo md5('The quick brown fox jumped over the lazy dog.');

// Weak crypotgraphic algorthim, used with a modern PHP extension (easier to update)
echo hash('md5', 'The quick brown fox jumped over the lazy dog.');

// Strong crypotgraphic algorthim, used with a modern PHP extension
echo hash('sha156', 'The quick brown fox jumped over the lazy dog.');

?>
```

Weak cryptography is commonly used for hashing values when caching them.
In such cases, security is not a primary concern. However, it may later
become such, when hackers get access to the cache folders, or if the
cached identifier is published. As a preventive protection, it is
recommended to always use a secure hashing function.

See also [Secure Hash
Algorithms](https://en.wikipedia.org/wiki/Secure_Hash_Algorithms).

### Suggestions

-   Keep the current crypto, and add a call to a stronger one.
-   Change the crypto for a more modern one and update the related
    databases

  ------------- ------------------------------
  Short name    Security/AvoidThoseCrypto

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

Avoid Using stdClass
--------------------

`stdClass` is the default class for PHP. It is instantiated when PHP
needs to return a object, but no class is specifically available.

It is recommended to avoid instantiating this class, nor use it is any
way.

``` {.php}
<?php

$json = '{a:1,b:2,c:3}';
$object = json_decode($json);
// $object is a stdClass, as returned by json_decode

// Fast building of $o
$a = [];
$a['a'] = 1;
$a['b'] = 2;
$a['c'] = 3;
json_encode( (object) $a);

// Slow building of $o
$o = new stdClass();
$o->a = 1;
$o->b = 2;
$o->c = 3;
json_encode($o);

?>
```

If you need a `stdClass` object, it is faster to build it as an array,
then cast it, than instantiate `stdClass`. This is a micro-optimisation.

### Suggestions

-   Create a custom class to handle the properties

  ------------- -----------------------------
  Short name    Php/UseStdclass

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- -----------------------------

Avoid array\_push() {#avoid-array\\_push()}
-------------------

[array\_push()](https://www.php.net/array_push) is slower than the \[\]
operator.

This is also true if the \[\] operator is called several times, while
[array\_push()](https://www.php.net/array_push) may be called only once.
And using count after the push is also faster than collecting
[array\_push()](https://www.php.net/array_push) return value.

``` {.php}
<?php

$a = [1,2,3];
// Fast version
$a[] = 4;

$a[] = 5;
$a[] = 6;
$a[] = 7;
$count = count($a);

// Slow version
array_push($a, 4);
$count = array_push($a, 5,6,7);

// Multiple version : 
$a[] = 1;
$a[] = 2;
$a[] = 3;
array_push($a, 1, 2, 3);


?>
```

This is a micro-optimisation.

### Suggestions

-   Use the \[\] operator

  ------------- ----------------------------------
  Short name    Performances/AvoidArrayPush

  Rulesets      `Performances`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ----------------------------------

Avoid array\_unique() {#avoid-array\\_unique()}
---------------------

The native function [array\_unique()](https://www.php.net/array_unique)
is much slower than using other alternatives, such as
[array\_count\_values()](https://www.php.net/array_count_values),
[array\_flip()](https://www.php.net/array_flip)/[array\_keys()](https://www.php.net/array_keys),
or even a
[foreach()](https://www.php.net/manual/en/control-structures.foreach.php)
loops.

``` {.php}
<?php

// using array_unique()
$uniques = array_unique($someValues);

// When values are strings or integers
$uniques = array_keys(array_count_values($someValues));
$uniques = array_flip(array_flip($someValues))

//even some loops are faster.
$uniques = [];
foreach($someValues as $s) {
    if (!in_array($uniques, $s)) {
        $uniques[] $s;
    }
}

?>
```

See also [array\_unique](https://www.php.net/array_unique).

### Suggestions

-   Upgrade to PHP 7.2
-   Use an alternative way to make values unique in an array, using
    array\_count\_values(), for example.

  ------------- ----------------------------------
  Short name    Structures/NoArrayUnique

  Rulesets      `Performances`{.interpreted-text
                role="ref"}

  Php Version   7.2-

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Avoid get\_class() {#avoid-get\\_class()}
------------------

`get_class()` should be replaced with the `instanceof` operator to check
the class of an object.

`get_class()` only compares the full namespace name of the object\'s
class, while `instanceof` actually resolves the name, using the local
namespace and aliases.

``` {.php}
<?php

    use Stdclass as baseClass;

    function foo($arg) {
        // Slow and prone to namespace errors
        if (get_class($arg) === 'Stdclass') {
            // doSomething()
        }
    }

    function bar($arg) {
        // Faster, and uses aliases.
        if ($arg instanceof baseClass) {
            // doSomething()
        }
    }
?>
```

See also [get\_class](https://www.php.net/get_class) and
[Instanceof](https://www.php.net/manual/en/language.operators.type.php).

  ----------- -----------------------------------------------------------
  Short name  Structures/UseInstanceof

  Rulesets    `Analyze`{.interpreted-text role="ref"},
              `Analyze`{.interpreted-text role="ref"},
              `CI-checks`{.interpreted-text role="ref"},
              `CI-checks`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Quick (30 mins)
  ----------- -----------------------------------------------------------

Avoid glob() Usage {#avoid-glob()-usage}
------------------

[glob()](https://www.php.net/glob) and
[scandir()](https://www.php.net/scandir) sorts results by default. When
that kind of sorting is not needed, save some time by requesting
`NOSORT` with those functions.

Besides, whenever possible, use [scandir()](https://www.php.net/scandir)
instead of [glob()](https://www.php.net/glob).

``` {.php}
<?php

// Scandir without sorting is the fastest. 
scandir('docs/', SCANDIR_SORT_NONE);

// Scandir sorts files by default. Same as above, but with sorting
scandir('docs/');

// glob sorts files by default. Same as below, but no sorting
glob('docs/*', GLOB_NOSORT);

// glob sorts files by default. This is the slowest version
glob('docs/*');

?>
```

Using [opendir()](https://www.php.net/opendir) and a while loop may be
even faster.

This analysis skips [scandir()](https://www.php.net/scandir) and
[glob()](https://www.php.net/glob) if they are expliciely configured
with flags (aka, sorting is explicitly needed).

[glob()](https://www.php.net/glob) accepts wildchar, such as `*`, that
may not easily replaced with [scandir()](https://www.php.net/scandir) or
[opendir()](https://www.php.net/opendir).

See also [Putting glob to the
test](https://www.phparch.com/2010/04/putting-glob-to-the-test/), [How
to list files recursively in a directory with PHP
iterators](https://dev.to/bdelespierre/how-to-list-files-recursively-in-a-directory-with-php-iterators-5c0m)
and [glob://](https://www.php.net/manual/en/wrappers.glob.php).

### Suggestions

-   Use FilesystemIterator, DirectoryIterator classes.
-   Use `RegexIterator` to filter any unwanted results from
    `FilesystemIterator`.
-   Use `glob` protocol for files : \$it = new
    DirectoryIterator(\'glob://path/to/examples/\*.php\');

  ----------- -----------------------------------------------------------
  Short name  Performances/NoGlob

  Rulesets    `Performances`{.interpreted-text role="ref"}

  Severity    Major

  Time To Fix Quick (30 mins)

  Examples    `phinx-performances-noglob`{.interpreted-text role="ref"},
              `nextcloud-performances-noglob`{.interpreted-text
              role="ref"}
  ----------- -----------------------------------------------------------

Avoid mb\_dectect\_encoding() {#avoid-mb\\_dectect\\_encoding()}
-----------------------------

mb\_dectect\_encoding() is bad at guessing encoding.

For example, UTF-8 and ISO-8859-1 share some common characters : when a
string is build with them it is impossible to differentiate the actual
encoding.

``` {.php}
<?php

$encoding = mb_encoding_detect($_GET['name']);

?>
```

See also [mb\_encoding\_detect](https://php.net/mb-encoding-detect),
[PHP vs. The Developer: Encoding Character
Sets](https://www.daganhenderson.com/blog/2013/07/php-encoding-character-sets),
[DPC2019: Of representation and interpretation: A unified theory -
Arnout Boks](https://youtu.be/K2zS6vbBb9A?t=1375).

### Suggestions

-   Store and transmit the data format

  ------------- -----------------------------
  Short name    Php/AvoidMbDectectEncoding

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Avoid option arrays in constructors
-----------------------------------

Avoid option arrays in constructors. Use one parameter per injected
element.

``` {.php}
<?php

class Foo {
    // Distinct arguments, all typehinted if possible
    function __constructor(A $a, B $b, C $c, D $d) {
        $this->a = $a;
        $this->b = $b;
        $this->c = $c;
        $this->d = $d;
    }
}

class Bar {
    // One argument, spread over several properties
    function __constructor(array $options) {
        $this->a = $options['a'];
        $this->b = $options['b'];
        $this->c = $options['c'];
        $this->d = $options['d'];
    }
}

?>
```

See also [Avoid option arrays in
constructors](http://bestpractices.thecodingmachine.com/php/design_beautiful_classes_and_methods.html#avoid-option-arrays-in-constructors)
and [PHP RFC: Named Arguments (Type-safe and documented
options)](https://wiki.php.net/rfc/named_params#type-safe_and_documented_options).

### Suggestions

-   Spread the options in the argument list, one argument each
-   Use a configuration class, that hold all the elements with clear
    names, instead of an array
-   Use named parameters to pass and document the arguments

  ------------- ------------------------------------
  Short name    Classes/AvoidOptionArrays

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     Medium
  ------------- ------------------------------------

Avoid set\_error\_handler \$context Argument {#avoid-set\\_error\\_handler-$context-argument}
--------------------------------------------

Avoid configuring
[set\_error\_handler()](https://www.php.net/set_error_handler) with a
method that accepts 5 arguments. The last argument, `$errcontext`, is
deprecated since PHP 7.2, and will be removed later.

``` {.php}
<?php

// setting error_handler with an incorrect closure
set_error_handler(function($errno, $errstr, $errfile, $errline) {});

// setting error_handler with an incorrect closure
set_error_handler(function($errno, $errstr, $errfile, $errline, $errcontext) {});

?>
```

See also [set\_error\_handler()](https://www.php.net/set_error_handler);

### Suggestions

-   Remove the 6th argument of registered handlers.

  ---------- -----------------------------------------------------------------
  Short name Php/AvoidSetErrorHandlerContextArg

  Rulesets   `CompatibilityPHP72`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Slow (1 hour)
  Fix        

  Examples   `shopware-php-avoidseterrorhandlercontextarg`{.interpreted-text
             role="ref"},
             `vanilla-php-avoidseterrorhandlercontextarg`{.interpreted-text
             role="ref"}
  ---------- -----------------------------------------------------------------

Avoid sleep()/usleep() {#avoid-sleep()/usleep()}
----------------------

[sleep()](https://www.php.net/sleep) and
[usleep()](https://www.php.net/usleep) help saturate the web server.

Pausing the script for a specific amount of time means that the Web
server is also making all related resources sleep, such as database,
sockets, session, etc. This may used to set up a DOS on the server.

``` {.php}
<?php

$begin = microtime(true);
checkLogin($user, $password);
$end   = microtime(true);

// Making all login checks looks the same
usleep(1000000 - ($end - $begin) * 1000000); 

// Any hit on this page now uses 1 second, no matter if load is high or not
// Is it now possible to saturate the webserver in 1 s ? 

?>
```

As much as possible, avoid delaying the end of the script.

[sleep()](https://www.php.net/sleep) and
[usleep()](https://www.php.net/usleep) have less impact in commandline
(`CLI`).

### Suggestions

-   Add a deadline of usage in the session, and wait past this deadline
    to start serving again. Until then, abort immediately.
-   Use element in the GUI to delay or slow usage.

  ------------- ------------------------------
  Short name    Security/NoSleep

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

Bad Constants Names
-------------------

PHP\'s manual recommends that developer do not use constants with the
convention `__NAME__`. Those are reserved for PHP future use.

For example, `__TRAIT__` recently appeared in PHP, as a magic constant.
In the future, other may appear.

``` {.php}
<?php

const __MY_APP_CONST__ = 1;

const __MY_APP_CONST__ = 1;

define('__MY_OTHER_APP_CONST__', 2);

?>
```

The analyzer will report any constant which name is `__.*.__`, or even
`_.*_` (only one underscore).

See also
[Constants](https://www.php.net/manual/en/language.constants.php).

### Suggestions

-   Avoid using names that doesn\'t comply with PHP\'s convention

  ---------- -------------------------------------------------------------
  Short name Constants/BadConstantnames

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  Examples   `prestashop-constants-badconstantnames`{.interpreted-text
             role="ref"},
             `zencart-constants-badconstantnames`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Bad Typehint Relay
------------------

A bad typehint relay happens where a type hinted argument is relayed to
a parameter with another typehint. This will lead to a Fatal error, and
stop the code. This is possibly a piece of dead code.

``` {.php}
<?php

// the $i argument is relayed to bar, which is expecting a string. 
function foo(int $i) : string {
    return bar($i);
}

// the return value for the bar function is not compatible with the one from foo;
function bar(string $s) : int {
    return (int) $string + 1;
}

?>
```

It is recommended to harmonize the typehints, so the two methods are
compatible.

### Suggestions

-   Harmonize the typehint so they match one with the other.
-   Remove dead code
-   Apply type casting before calling the next function, or return value

  ------------- --------------------------------
  Short name    Functions/BadTypehintRelay

  Rulesets      `Typechecks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- --------------------------------

Bail Out Early
--------------

When using conditions, it is recommended to quit in the current context,
and avoid else clause altogether.

The main benefit is to make clear the method applies a condition, and
stop immediately when it is not satisfied. The main sequence is then
focused on the actual code.

This works with the `break`, `continue`, `throw` and `goto` keywords
too, depending on situations.

``` {.php}
<?php

// Bailing out early, low level of indentation
function foo1($a) {
    if ($a > 0) {
        return false;
    } 

    $a++;
    return $a;
}

// Works with continue too
foreach($array as $a => $b) {
    if ($a > 0) {
        continue false;
    } 

    $a++;
    return $a;
}

// No need for else
function foo2($a) {
    if ($a > 0) {
        return false;
    } else {
        $a++;
    }

    return $a;
}

// No need for else : return goes into then. 
function foo3($a) {
    if ($a < 0) {
        $a++;
    } else {
        return false;
    }

    return $a;
}

// Make a return early, and make the condition visible.
function foo3($a) {
    if ($a < 0) {
        $a++;
        methodcall();
        functioncall();
    } 
}

?>
```

See also [Avoid nesting too deeply and return early (part
1)](https://github.com/jupeter/clean-code-php#avoid-nesting-too-deeply-and-return-early-part-1)
and [Avoid nesting too deeply and return early (part
2)](https://github.com/jupeter/clean-code-php#avoid-nesting-too-deeply-and-return-early-part-2).

### Suggestions

-   Detect errors, and then, return as soon as possible.
-   When a if\...then branches are unbalanced, test for the small
    branch, finish it with return. Then keep the other branch as the
    main code.

  ---------- ------------------------------------------------------------
  Short name Structures/BailOutEarly

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `openemr-structures-bailoutearly`{.interpreted-text
             role="ref"},
             `opencfp-structures-bailoutearly`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Binary Glossary
---------------

List of all the integer values using the binary format.

``` {.php}
<?php

$a = 0b10;
$b = 0B0101;

?>
```

  ------------- ----------------------------------------
  Short name    Type/Binary

  Rulesets      `CompatibilityPHP53`{.interpreted-text
                role="ref"}

  Php Version   With PHP 5.4 and more recent

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Bracketless Blocks
------------------

PHP allows one liners as
[for()](https://www.php.net/manual/en/control-structures.for.php),
[foreach()](https://www.php.net/manual/en/control-structures.foreach.php),
[while()](https://www.php.net/manual/en/control-structures.while.php),
do/[while()](https://www.php.net/manual/en/control-structures.while.php)
loops, or as then/else expressions.

It is generally considered a bad practice, as readability is lower and
there are non-negligible risk of excluding from the loop the next
instruction.

``` {.php}
<?php

// Legit one liner
foreach(range('a', 'z') as $letter) ++$letterCount;

// More readable version, even for a one liner.
foreach(range('a', 'z') as $letter) {
    ++$letterCount;
}

?>
```

[switch()](https://www.php.net/manual/en/control-structures.switch.php)
cannot be without bracket.

  ------------- -------------------------------------------------------------
  Short name    Structures/Bracketless

  Rulesets      `Coding Conventions <coding-conventions>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- -------------------------------------------------------------

Break Outside Loop
------------------

Starting with PHP 7,
[break](https://www.php.net/manual/en/control-structures.break.php) or
[continue](https://www.php.net/manual/en/control-structures.continue.php)
that are outside a loop (for,
[foreach()](https://www.php.net/manual/en/control-structures.foreach.php),
do\...[while()](https://www.php.net/manual/en/control-structures.while.php),
[while())](https://www.php.net/manual/en/control-structures.while.php)
or a
[switch()](https://www.php.net/manual/en/control-structures.switch.php)
statement won\'t compile anymore.

It is not possible anymore to include a piece of code inside a loop that
will then
[break](https://www.php.net/manual/en/control-structures.break.php).

``` {.php}
<?php

    // outside a loop : This won't compile
    break 1; 

    foreach($array as $a) {
        break 1; // Compile OK

        break 2; // This won't compile, as this break is in one loop, and not 2
    }

    foreach($array as $a) {
        foreach($array2 as $a2) {
            break 2; // OK in PHP 5 and 7
        }
    }
?>
```

  ------------- -------------------------------------------
  Short name    Structures/BreakOutsideLoop

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CompatibilityPHP70`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.0 and older

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- -------------------------------------------

Break With 0
------------

Cannot
[break](https://www.php.net/manual/en/control-structures.break.php) 0,
as this makes no sense.
[Break](https://www.php.net/manual/en/control-structures.break.php) 1 is
the minimum, and is the default value.

``` {.php}
<?php
    // Can't break 0. Must be 1 or more, depending on the level of nesting.
    for($i = 0; $i < 10; $i++) {
        break 0;
    }

    for($i = 0; $i < 10; $i++) {
        for($j = 0; $j < 10; $j++) {
            break 2;
        }
    }

?>
```

### Suggestions

-   Remove 0, or the break

  ------------- ----------------------------------------
  Short name    Structures/Break0

  Rulesets      `CompatibilityPHP53`{.interpreted-text
                role="ref"}

  Php Version   With PHP 5.4 and older

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- ----------------------------------------

Break With Non Integer
----------------------

When using a
[break](https://www.php.net/manual/en/control-structures.break.php), the
argument of the operator must be a positive non-null integer literal or
be omitted.

Other values were acceptable in PHP 5.3 and previous version, but this
is now reported as an error.

``` {.php}
<?php
    // Can't break $a, even if it contains an integer.
    $a = 1;
    for($i = 0; $i < 10; $i++) {
        break $a;
    }

    // can't break on float
    for($i = 0; $i < 10; $i++) {
        for($j = 0; $j < 10; $j++) {
            break 2.2;
        }
    }

?>
```

  ------------- ----------------------------------------
  Short name    Structures/BreakNonInteger

  Rulesets      `CompatibilityPHP54`{.interpreted-text
                role="ref"}

  Php Version   With PHP 5.4 and older

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Buried Assignation
------------------

Those assignations are buried in the code, and placed in unexpected
situations.

They are difficult to spot, and may be confusing. It is advised to place
them in a more visible place.

``` {.php}
<?php

// $b may be assigned before processing $a
$a = $c && ($b = 2);

// Display property p immeiately, but also, keeps the object for later
echo ($o = new x)->p;

// legit syntax, but the double assignation is not obvious.
for($i = 2, $j = 3; $j < 10; $j++) {

}
?>
```

### Suggestions

-   Extract the assignation and set it on its own line, prior to the
    current expression.
-   Check if the local variable is necessary

  ---------- -------------------------------------------------------------
  Short name Structures/BuriedAssignation

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  Examples   `xoops-structures-buriedassignation`{.interpreted-text
             role="ref"},
             `mautic-structures-buriedassignation`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Cache Variable Outside Loop
---------------------------

Avoid recalculating constant values inside the loop.

Do the calculation once, outside the loops, and then reuse the value
each time.

One of the classic example if doing `count($array)` in a `for` loop :
since the source is constant during the loop, the result of
[count()](https://www.php.net/count) is always the same.

``` {.php}
<?php

$path = '/some/path';
$fullpath = realpath("$path/more/dirs/");
foreach($files as $file) {
    // Only moving parts are used in the loop
    copy($file, $fullpath.$file);
}

$path = '/some/path';
foreach($files as $file) {
    // $fullpath is calculated each loop
    $fullpath = realpath("$path/more/dirs/");
    copy($file, $fullpath.$file);
}

?>
```

Depending on the load of the called method, this may increase the speed
of the loop from little to enormously.

### Suggestions

-   Avoid using blind variables outside loops.
-   Store blind variables in local variables or properties for later
    reuse.

  ------------ ---------------------------------------
  Short name   Performances/CacheVariableOutsideLoop

  Rulesets     `Performances`{.interpreted-text
               role="ref"}
  ------------ ---------------------------------------

Callback Function Needs Return
------------------------------

When used with [array\_map()](https://www.php.net/array_map) functions,
the callback must return something. This return may be in the form of a
`return` statement, a global variable or a parameter with a reference.
All those solutions extract information from the callback.

``` {.php}
<?php

// This filters each element
$filtered = array_filter($array, function ($x) {return $x == 2; });

// This return void for every element
$filtered = array_filter($array, function ($x) {return ; });

// costly array_sum()
$sum = 0;
$filtered = array_filter($array, function ($x) use (&$sum) {$sum += $x; });

// costly array_sum()
global $sum = 0;
$filtered = array_filter($array, function () {global $sum; $sum += $x; });

// register_shutown_function() doesn't require any return
register_shutown_function(my_shutdown);

?>
```

The following functions are omitted, as they don\'t require the return :

-   [forward\_static\_call\_array()](https://www.php.net/forward_static_call_array)
-   [forward\_static\_call()](https://www.php.net/forward_static_call)
-   [register\_shutdown\_function()](https://www.php.net/register_shutdown_function)
-   [register\_tick\_function()](https://www.php.net/register_tick_function)

See also [array\_map](https://www.php.net/array_map).

### Suggestions

-   Add an explicit return to the callback
-   Use [null]{.title-ref} to unset elements in an array without
    destroying the index

  ----------- -----------------------------------------------------------------
  Short name  Functions/CallbackNeedsReturn

  Rulesets    `Analyze`{.interpreted-text role="ref"},
              `CI-checks`{.interpreted-text role="ref"}

  Severity    Major

  Time To Fix Instant (5 mins)

  Precision   High

  Examples    `contao-functions-callbackneedsreturn`{.interpreted-text
              role="ref"},
              `phpdocumentor-functions-callbackneedsreturn`{.interpreted-text
              role="ref"}
  ----------- -----------------------------------------------------------------

Calltime Pass By Reference
--------------------------

PHP doesn\'t allow when a value is turned into a reference at
functioncall, since PHP 5.4.

Either the function use a reference in its signature, either the
reference won\'t pass.

``` {.php}
<?php

function foo($name) {
    $arg = ucfirst(strtolower($name));
    echo 'Hello '.$arg;
}

$a = 'name';
foo(&$a);

?>
```

### Suggestions

-   Make the signature of the called method accept references
-   Remove the reference from the method call
-   Use an object instead of a scalar

  ------------- ----------------------------------------
  Short name    Structures/CalltimePassByReference

  Rulesets      `CompatibilityPHP54`{.interpreted-text
                role="ref"}

  Php Version   With PHP 5.4 and older

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Can\'t Count Non-Countable {#can't-count-non-countable}
--------------------------

[Count()](https://www.php.net/count) emits an error when it tries to
count scalars or objects what don\'t implement Countable interface.

``` {.php}
<?php

// Normal usage
$a = array(1,2,3,4);
echo count($a).items\n;

// Error emiting usage
$a = '1234';
echo count($a).chars\n;

// Error emiting usage
echo count($unsetVar).elements\n;

?>
```

See also [Warn when counting non-countable
types](https://www.php.net/manual/en/migration72.incompatible.php#migration72.incompatible.warn-on-non-countable-types).

### Suggestions

-   Add a check before using count such as a type check

  ------------- ----------------------------------------
  Short name    Structures/CanCountNonCountable

  Rulesets      `CompatibilityPHP72`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Precision     Medium
  ------------- ----------------------------------------

Can\'t Extend Final {#can't-extend-final}
-------------------

It is not possible to extend final classes.

Since PHP fails with a fatal error, this means that the extending class
is probably not used in the rest of the code. Check for dead code.

``` {.php}
<?php
    // File Foo
    final class foo {
        public final function bar() {
            // doSomething
        }
    }
?>
```

In a separate file :

``` {.php}
<?php
    // File Bar
    class bar extends foo {

    }
?>
```

See also [Final
Keyword](https://www.php.net/manual/en/language.oop5.final.php).

### Suggestions

-   Remove the final keyword
-   Remove the extending class

  ------------- ----------------------------------------------
  Short name    Classes/CantExtendFinal

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `Dead code <dead-code>`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Instant (5 mins)

  Precision     Medium
  ------------- ----------------------------------------------

Can\'t Throw Throwable {#can't-throw-throwable}
----------------------

Classes extending `Throwable` can\'t be thrown. The same applies to
interfaces.

Although this code lints, PHP throws a Fatal error when executing or
including it :
`` Class fooThrowable cannot implement interface `Throwable <https://www.php.net/manual/en/class.throwable.php>`_, extend Exception or Error instead ``.

``` {.php}
<?php

// This is the way to go
class fooException extends \Exception { }

// This is not possible and a lot of work
class fooThrowable implements \throwable { }

?>
```

See also [Throwable](https://www.php.net/manual/en/class.throwable.php),
[Exception](https://www.php.net/manual/en/class.exception.php) and
[Error](https://www.php.net/manual/en/class.error.php).

### Suggestions

-   Extends the Exception class
-   Extends the Error class

  ------------- ----------------------------------------
  Short name    Exceptions/CantThrow

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

Cancel Common Method
--------------------

A
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
method\'s is too little used in children.

The
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
class has a method, which is customised in children classes, though most
of the time, those are empty : hence, cancelled.

``` {.php}
<?php

class x {
    abstract function foo();
    abstract function bar();
}

class y1 extends x {
    function foo() { doSomething(); }
    function bar() { doSomething(); };
}

class y2 extends x {
    // foo is cancelled : it must be written, but has no use. 
    function foo() {  }
    function bar() { doSomething(); };
}

?>
```

A threshold of `cancelThreshold` % of the children methods have to be
cancelled to report the
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
class. By default, it is 75 (or 3 out of 4).

### Suggestions

-   Drop the common method, and the cancelled methods in the children
-   Fill the children\'s methods with actual code

  ----------------- --------- --------- ------------------------------------------------
  Name              Default   Type      Description

  cancelThreshold   75        integer   Minimal number of cancelled methods to suggest
                                        the cancellation of the parent.
  ----------------- --------- --------- ------------------------------------------------

  ------------- ----------------------------------------
  Short name    Classes/CancelCommonMethod

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"},
                `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Cancelled Parameter
-------------------

When a parameter is hardcoded, and doesn\'t have any usage.

``` {.php}
<?php

function foo($a, $b) {
    // $b is cancelled, and cannot be changed.
    $b = 3;

    // $a is the only parameter here
    return $a + $b;
}

function bar($a, $b) {
    // $b is actually processed
    $c = $b;
    $c = process($c);

    $b = $c;

    // $a is the only parameter here
    return $a + $b;
}

?>
```

### Suggestions

-   

  ------------- ------------------------------
  Short name    Functions/CancelledParameter

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

Cant Implement Traversable
--------------------------

It is not possible to implement the `Traversable`interface. The
alternative is to implement `Iterator` or `IteratorAggregate`.

`Traversable` may be useful when used with `instanceof`.

``` {.php}
<?php

// This lints, but doesn't run
class x implements Traversable {

}

if( $argument instanceof Traversable ) {
    // doSomething
}

?>
```

See also
[Traversable](https://www.php.net/manual/en/class.traversable.php),
[Iterator](https://www.php.net/manual/en/class.iterator.php) and
[IteratorAggregate](https://www.php.net/manual/en/class.iteratoraggregate.php)..

### Suggestions

-   Implement Iterator or IteratorAggregate

  ------------- ---------------------------------------------------------
  Short name    Interfaces/CantImplementTraversable

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------------------------------

Cant Inherit Abstract Method
----------------------------

Inheriting abstract methods was made available in PHP 7.2. In previous
versions, it emitted a fatal error.

``` {.php}
<?php

abstract class A           { abstract function bar(stdClass $x);  }
abstract class B extends A { abstract function bar($x): stdClass; }

//   Fatal error: Can't inherit abstract function A::bar()
?>
```

See also [PHP RFC: Allow abstract function
override](https://wiki.php.net/rfc/allow-abstract-function-override).

### Suggestions

-   Avoid inheriting abstract methods for compatibility beyond 7.2 (and
    older)

  ---------- -----------------------------------------------------------------
  Short name Classes/CantInheritAbstractMethod

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.2 and more recent
  Version    

  Severity   Critical

  Time To    Quick (30 mins)
  Fix        
  ---------- -----------------------------------------------------------------

Cant Instantiate Class
----------------------

When constructor is not public, it is not possible to instantiate such a
class. Either this is a conception choice, or there are factories to
handle that. Either way, it is not possible to call new on such class.

PHP reports an error similar to this one : \'Call to private
Y::[\_\_construct()](https://www.php.net/manual/en/language.oop5.decon.php)
from invalid context\'.

``` {.php}
<?php

//This is the way to go
$x = X::factory();

//This is not possible
$x = new X();

class X {
    //This is also the case with proctected __construct
    private function __construct() {}

    static public function factory() {
        return new X();
    }
}

?>
```

See also [In a PHP5 class, when does a private constructor get
called?](https://stackoverflow.com/questions/26079/in-a-php5-class-when-does-a-private-constructor-get-called),
[Named Constructors in
PHP](http://verraes.net/2014/06/named-constructors-in-php/) and [PHP
Constructor Best Practices And The Prototype
Pattern](http://ralphschindler.com/2012/03/09/php-constructor-best-practices-and-the-prototype-pattern).

  ------------- ------------------------------------------------------------
  Short name    Classes/CantInstantiateClass

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Critical

  Time To Fix   Quick (30 mins)

  Examples      `wordpress-classes-cantinstantiateclass`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------------

Cant Use Return Value In Write Context
--------------------------------------

[empty()](https://www.php.net/empty) used to work only on data
containers, such as variables. Until PHP 5.5, it was not possible to use
directly expressions, such as functioncalls, inside an
[empty()](https://www.php.net/empty) function call : they were met with
a \'Can\'t use function return value in write context\' fatal error.

``` {.php}
<?php

function foo($boolean) {
    return $boolean;
}

// Valid since PHP 5.5
echo empty(foo(true)) : 'true' : 'false';

?>
```

This also applies to methodcalls,
[static](https://www.php.net/manual/en/language.oop5.static.php) or not.

See also [Cant Use Return Value In Write
Context](https://stackoverflow.com/questions/1075534/cant-use-method-return-value-in-write-context).

  ------------- ------------------------------------------------------
  Short name    Php/CantUseReturnValueInWriteContext

  Rulesets      `CompatibilityPHP53`{.interpreted-text role="ref"},
                `CompatibilityPHP54`{.interpreted-text role="ref"}

  Php Version   With PHP 5.5 and more recent

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------------------------

Case Insensitive Constants
--------------------------

PHP constants may be case insensitive, when defined with
[define()](https://www.php.net/define) and the third argument.

This feature is deprecated since PHP 7.3 and will be removed in PHP 8.0.

``` {.php}
<?php

// case sensitive
define('A', 1);

// case insensitive
define('B', 1, true);

echo A;
// This is not possible
//echo a;

// both possible
echo B;
echo b;

?>
```

See also [define](https://www.php.net/manual/en/function.define.php).

  ------------- ----------------------------------------
  Short name    Constants/CaseInsensitiveConstants

  Rulesets      `CompatibilityPHP73`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

Cast To Boolean
---------------

This expression may be reduced by casting to boolean type.

``` {.php}
<?php

$variable = $condition == 'met' ? 1 : 0;
// Same as 
$variable = (bool) $condition == 'met';

$variable = $condition == 'met' ? 0 : 1;
// Same as (Note the condition inversion)
$variable = (bool) $condition != 'met';
// also, with an indentical condition
$variable = !(bool) $condition == 'met';

// This also works with straight booleans expressions
$variable = $condition == 'met' ? true : false;
// Same as 
$variable = $condition == 'met';

?>
```

### Suggestions

-   Remove the old expression and use `(bool)` operator instead
-   Change the target values from true/false, or 0/1 to non-binary
    values, like strings or integers beyond 0 and 1.
-   Complete the current branches with other commands

  ---------- -------------------------------------------------------------
  Short name Structures/CastToBoolean

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `mediawiki-structures-casttoboolean`{.interpreted-text
             role="ref"},
             `dolibarr-structures-casttoboolean`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Cast Unset Usage
----------------

Usage of the [(unset)]{.title-ref} cast operator. It is removed in PHP
8.0, and was deprecated since PHP 7.2.0.

``` {.php}
<?php

$a = 1;
(unset) $a;

// functioncall is OK
unset($a);

?>
```

See also [Unset
casting](https://www.php.net/manual/en/language.types.null.php#language.types.null.casting).

### Suggestions

-   Replace [(unset)]{.title-ref} with a call to unset().
-   Remove the unset call altogether.

  ------------- ----------------------------------------
  Short name    Php/CastUnsetUsage

  Rulesets      `CompatibilityPHP80`{.interpreted-text
                role="ref"}

  Php Version   8.0-

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Casting Ternary
---------------

Type casting has a precedence over ternary operator, and is applied
first. When this happens, the condition is cast, although it is often
useless as PHP will do it if needed.

This applies to the ternary operator, the coalesce operator ?: and the
null-coalesce operator ??.

``` {.php}
<?php
    $a = (string) $b ? 3 : 4;
    $a = (string) $b ?: 4;
    $a = (string) $b ?? 4;
?>
```

The last example generates first an error [Undefined variable:
b]{.title-ref}, since \$b is first cast to a string. The result is then
an empty string, which leads to an empty string to be stored into \$a.
Multiple errors cascade.

See also [Operators
Precedence](https://www.php.net/manual/en/language.operators.precedence.php).

### Suggestions

-   Add parenthesis around the ternary operator
-   Skip the casting
-   Cast in another expression

  ------------- ----------------------------------
  Short name    Structures/CastingTernary

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Catch Overwrite Variable
------------------------

The try/catch structure uses some variables that are also in use in this
scope. In case of a caught exception, the exception will be put in the
catch variable, and overwrite the current value, loosing some data.

``` {.php}
<?php

// variables and caught exceptions are distinct
$argument = 1;
try {
    methodThatMayRaiseException($argument);
} (Exception $e) {
    // here, $e has been changed to an exception.
}

// variables and caught exceptions are overlapping
$e = 1;
try {
    methodThatMayRaiseException();
} (Exception $e) {
    // here, $e has been changed to an exception.
}

?>
```

It is recommended to use another name for these catch variables.

### Suggestions

-   Use a standard : only use \$e (or else) to catch exceptions. Avoid
    using them for anything else, parameter, property or local variable.
-   Change the variable, and keep the caught exception

  ---------- --------------------------------------------------------------------------------------------------
  Short name Structures/CatchShadowsVariable

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [no-catch-overwrite](https://github.com/dseguy/clearPHP/tree/master/rules/no-catch-overwrite.md)

  Examples   `phpipam-structures-catchshadowsvariable`{.interpreted-text role="ref"},
             `suitecrm-structures-catchshadowsvariable`{.interpreted-text role="ref"}
  ---------- --------------------------------------------------------------------------------------------------

Catch Undefined Variable
------------------------

Always initialize variable before the try block, when they are used in a
catch block. If the exception is raised before the variable is defined,
the catch block may have to handle an undefined variable, leading to
more chaos.

``` {.php}
<?php

$a = 1;
try {
    mayThrowAnException();
    $b = 2;
} catch (\Exception $e) {
    // $a is already defined, as it was done before the try block
    // $b may not be defined, as it was initialized after the exception-throwing expression
    echo $a + $b;
}

?>
```

### Suggestions

-   Always define the variable used in the catch clause, before the try
    block.

  ------------- -----------------------------------
  Short name    Exceptions/CatchUndefinedVariable

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------------

Check All Types
---------------

When checking for time, avoid using else. Mention explicitly all tested
type, and raise an exception when reaching else.

PHP has a short list of scalar types : null, boolean, integer, real,
strings, object, resource and array. When a variable is not holding one
the the type, then it may be of any other type.

Most of the time, when using a simple
[is\_string()](https://www.php.net/is_string) / else test, this is
relying on the conception of the code. By construction, the arguments
may be one of two types : array or string.

What happens often is that in case of failure in the code (database not
working, another class not checking its results), a third type is pushed
to the structure, and it ends up breaking the execution.

The safe way is to check the various types all the time, and use the
default case (here, the else) to throw exception() or test an assertion
and handle the special case.

``` {.php}
<?php

// hasty version
if (is_array($argument)) {
    $out = $argument;
} else {
    // Here, $argument is NOT an array. What if it is an object ? or a NULL ? 
    $out = array($argument);
}

// Safe type checking : do not assume that 'not an array' means that it is the other expected type.
if (is_array($argument)) {
    $out = $argument;
} elseif (is_string($argument)) {
    $out = array($argument);
} else {
    assert(false, '$argument is not an array nor a string, as expected!');
}

?>
```

Using [is\_callable()](https://www.php.net/is_callable),
[is\_iterable()](https://www.php.net/is_iterable) with this structure is
fine : when variable is callable or not, while a variable is an integer
or else.

Using a type test without else is also accepted here. This is a special
treatment for this test, and all others are ignored. This aspect may
vary depending on situations and projects.

### Suggestions

-   Include a default case to handle all unknown situations
-   Include and process explicit types as much as possible

  ---------- -------------------------------------------------------------
  Short name Structures/CheckAllTypes

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `zend-config-structures-checkalltypes`{.interpreted-text
             role="ref"},
             `vanilla-structures-checkalltypes`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Check Crypto Key Length
-----------------------

Each cryptography algorithm requires a reasonable length. Make sure an
up-to-date length is used.

This rule use the following recommendations :

-   OPENSSL\_KEYTYPE\_RSA\' =\> 3072
-   OPENSSL\_KEYTYPE\_DSA\' =\> 2048
-   OPENSSL\_KEYTYPE\_DH\' =\> 2048
-   OPENSSL\_KEYTYPE\_EC\' =\> 512

The values above are used with the openssl PHP extension.

``` {.php}
<?php

// Extracted from the documentation

// Generates a new and strong key 
$private_key = openssl_pkey_new(array(
    private_key_type => OPENSSL_KEYTYPE_EC,
    private_key_bits => 1024,
));

// Generates a new and weak key 
$private_key = openssl_pkey_new(array(
    private_key_type => OPENSSL_KEYTYPE_EC,
    private_key_bits => 256,
));

?>
```

See also [The Definitive 2019 Guide to Cryptographic Key Sizes and
Algorithm
Recommendations](https://paragonie.com/blog/2019/03/definitive-2019-guide-cryptographic-key-sizes-and-algorithm-recommendations)
and [Cryptographic Key Length
Recommendation](https://www.keylength.com/).

### Suggestions

-   

  ------------- ------------------------------
  Short name    Security/CryptoKeyLength

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

Check JSON
----------

Check errors whenever JSON is encoded or decoded.

In particular, `NULL` is a valid decoded JSON response. If you want to
avoid mistaking
[NULL](https://www.php.net/manual/en/language.types.null.php) for an
error, it is recommended to call `json_last_error`.

``` {.php}
<?php

$encoded = json_encode($incoming);
// Unless JSON must contains some non-null data, this mistakes NULL and error
if(json_last_error() != JSON_ERROR_NONE) {
    die('Error when encoding JSON');
}

$decoded = json_decode($incoming);
// Unless JSON must contains some non-null data, this mistakes NULL and error
if($decoded === null) {
    die('ERROR');
}

?>
```

See also [Option to make json\_encode and json\_decode throw exceptions
on errors](https://ayesh.me/Upgrade-PHP-7.3#json-exceptions),
[json\_last\_error](https://www.php.net/json_last_error).

### Suggestions

-   Always check after JSON operation : encoding or decoding.
-   Add a call to json\_last\_error()
-   Configure operations to throw an exception upon error
    (`JSON_THROW_ON_ERROR`), and catch it.

  ------------- ------------------------------------------------------
  Short name    Structures/CheckJson

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Examples      `woocommerce-structures-checkjson`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------

Check On \_\_Call Usage {#check-on-\\_\\_call-usage}
-----------------------

When using the magic methods
[\_\_call()](https://www.php.net/manual/en/language.oop5.magic.php) and
\_\_staticcall(), make sure the method exists before calling it.

If the method doesn\'t exists, then the same method will be called
again, leading to the same failure. Finally, it will crash PHP.

``` {.php}
<?php

class safeCall {
    function __class($name, $args) {
        // unsafe call, no checks
        if (method_exists($this, $name)) {
            $this->$name(...$args);
        }
    }
}

class unsafeCall {
    function __class($name, $args) {
        // unsafe call, no checks
        $this->$name(...$args);
    }
}

?>
```

See also [Method
overloading](https://www.php.net/manual/en/language.oop5.overloading.php#object.call)
and
`` Magical PHP: `__call <https://www.php.net/manual/en/language.oop5.magic.php>`_ <https://www.garfieldtech.com/index.php/blog/magical-php-call>`_.    Suggestions ^^^^^^^^^^^  * Add a call to method_exists() before using any method name * Relay the call to another object that doesn't handle __call() or __callStatic()  +-------------+----------------------------------+ | Short name  | Classes/CheckOnCallUsage         | +-------------+----------------------------------+ | Rulesets    | :ref:`Analyze`, :ref:`CI-checks` | +-------------+----------------------------------+ | Severity    | Minor                            | +-------------+----------------------------------+ | Time To Fix | Quick (30 mins)                  | +-------------+----------------------------------+    .. _child-class-removes-typehint:  Child Class Removes Typehint ############################   PHP 7.2 introduced the ability to remove a typehint when overloading a method. This is not valid code for older versions.  .. code-block:: php     <?php        class foo {        function foobar(foo $a) {}    }        class bar extends foo {        function foobar($a) {}    }        ?>  +-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | Short name  | Classes/ChildRemoveTypehint                                                                                                                                                         | +-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | Rulesets    | :ref:`CompatibilityPHP53`, :ref:`CompatibilityPHP70`, :ref:`CompatibilityPHP71`, :ref:`CompatibilityPHP54`, :ref:`CompatibilityPHP55`, :ref:`CompatibilityPHP56`, :ref:`Typechecks` | +-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | Php Version | With PHP 7.2 and more recent                                                                                                                                                        | +-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | Severity    | Major                                                                                                                                                                               | +-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | Time To Fix | Quick (30 mins)                                                                                                                                                                     | +-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+    .. _class-const-with-array:  Class Const With Array ######################   Constant defined with const keyword may be arrays but only stating with PHP 5.6. Define never accept arrays : it only accepts scalar values.  +-------------+---------------------------------------------------------------------------------+ | Short name  | Php/ClassConstWithArray                                                         | +-------------+---------------------------------------------------------------------------------+ | Rulesets    | :ref:`CompatibilityPHP53`, :ref:`CompatibilityPHP54`, :ref:`CompatibilityPHP55` | +-------------+---------------------------------------------------------------------------------+ | Php Version | With PHP 5.5 and more recent                                                    | +-------------+---------------------------------------------------------------------------------+ | Severity    | Critical                                                                        | +-------------+---------------------------------------------------------------------------------+ | Time To Fix | Slow (1 hour)                                                                   | +-------------+---------------------------------------------------------------------------------+    .. _class-could-be-final:  Class Could Be Final ####################   Any class that has no extension should be ``final`by default.  As stated by`Matthias
Noback`:`If a class is not marked final, it has at least one
subclass`.  Prevent your classes from being subclassed by making them`final`` . Sometimes, classes are not meant or thought to be derivable.  .. code-block:: php     <?php        class x {}            // This class is extended    class y extends x {}  // This class is extended    class z extends y {}  // This class is not extended        final class z2 extends y {}  // This class is not extended        ?>   See also `Negative architecture, and assumptions about code <https://matthiasnoback.nl/2018/08/negative-architecture-and-assumptions-about-code/>`_.   Suggestions ^^^^^^^^^^^  * Make the class final * Extends the class  +-------------+------------------------------------+ | Short name  | Classes/CouldBeFinal               | +-------------+------------------------------------+ | Rulesets    | :ref:`Analyze`, :ref:`ClassReview` | +-------------+------------------------------------+ | Severity    | Minor                              | +-------------+------------------------------------+ | Time To Fix | Quick (30 mins)                    | +-------------+------------------------------------+    .. _class-function-confusion:  Class Function Confusion ########################   Avoid classes and functions bearing the same name.   When functions and classes bear the same name, calling them may be confusing. This may also lead to forgotten 'new' keyword.  .. code-block:: php     <?php        class foo {}        function foo() {}        // Forgetting the 'new' operator is easy    $object = new foo();    $object = foo();        ?>     Suggestions ^^^^^^^^^^^  * Use a naming convention to distinguish functions and classes * Rename the class or the function (or both) * Use an alias with a `use` expression  +-------------+----------------------------+ | Short name  | Php/ClassFunctionConfusion | +-------------+----------------------------+ | Rulesets    | :ref:`Semantics`           | +-------------+----------------------------+ | Severity    | Minor                      | +-------------+----------------------------+ | Time To Fix | Slow (1 hour)              | +-------------+----------------------------+    .. _class-should-be-final-by-ocramius:  Class Should Be Final By Ocramius #################################   'Make your classes always final, if they implement an interface, and no other public methods are defined'.  When a class should be final, as explained by ``Ocramius`(`Marco
Pivetta`` ).  .. code-block:: php     <?php        interface i1 {        function i1() ;    }        // Class should final, as its public methods are in an interface    class finalClass implements i1 {        // public interface         function i1 () {}                // private method        private function a1 () {}    }        ?>   See also `When to declare classes final <http://ocramius.github.io/blog/when-to-declare-classes-final/>`_.  +-------------+-------------------------+ | Short name  | Classes/FinalByOcramius | +-------------+-------------------------+ | Rulesets    | :ref:`Analyze`          | +-------------+-------------------------+ | Severity    | Minor                   | +-------------+-------------------------+ | Time To Fix | Slow (1 hour)           | +-------------+-------------------------+    .. _class-without-parent:  Class Without Parent ####################   Classes should not refer to ``parent`` when it is not extending another class.   In PHP 7.4, it is a Deprecated warning. In PHP 7.3, it was a Fatal error, when the code was finally executed.  .. code-block:: php     <?php        class x {        function foo() {            parent::foo();        }    }    ?>     Suggestions ^^^^^^^^^^^  * Update the class and make it extends another class * Change the parent mention with a fully qualified name * Remove the call to the parent altogether  +-------------+------------------------------------------------------+ | Short name  | Classes/NoParent                                     | +-------------+------------------------------------------------------+ | Rulesets    | :ref:`Analyze`, :ref:`ClassReview`, :ref:`CI-checks` | +-------------+------------------------------------------------------+ | Php Version | 7.4-                                                 | +-------------+------------------------------------------------------+ | Severity    | Minor                                                | +-------------+------------------------------------------------------+ | Time To Fix | Quick (30 mins)                                      | +-------------+------------------------------------------------------+    .. _class,-interface-or-trait-with-identical-names:  Class, Interface Or Trait With Identical Names ##############################################   The following names are used at the same time for classes, interfaces or traits. For example,   .. code-block:: php     <?php        class a     { /* some definitions */ }        interface a { /* some definitions */ }        trait a     { /* some definitions */ }    ?>   Even if they are in different namespaces, identical names makes classes easy to confuse. This is often solved by using alias at import time : this leads to more confusion, as a class suddenly changes its name.   Internally, PHP use the same list for all classes, interfaces and traits. As such, it is not allowed to have both a trait and a class with the same name.  In PHP 4, and PHP 5 before namespaces, it was not possible to have classes with the same name. They were simply included after a check.     Suggestions ^^^^^^^^^^^  * Use distinct names for every class, trait and interface.  * Keep eponymous classes, traits and interfaces in distinct files, for definition but also for usage. When this happens, rename one of them.  +-------------+---------------------------------------------------------------------------+ | Short name  | Classes/CitSameName                                                       | +-------------+---------------------------------------------------------------------------+ | Rulesets    | :ref:`Analyze`                                                            | +-------------+---------------------------------------------------------------------------+ | Severity    | Minor                                                                     | +-------------+---------------------------------------------------------------------------+ | Time To Fix | Quick (30 mins)                                                           | +-------------+---------------------------------------------------------------------------+ | Examples    | :ref:`shopware-classes-citsamename`, :ref:`nextcloud-classes-citsamename` | +-------------+---------------------------------------------------------------------------+    .. _classes-mutually-extending-each-other:  Classes Mutually Extending Each Other #####################################   Those classes are extending each other, creating an extension loop. PHP will yield a fatal error at running time, even if it is compiling the code.  .. code-block:: php     <?php        // This code is lintable but won't run    class Foo extends Bar { }    class Bar extends Foo { }        // The loop may be quite large    class Foo extends Bar { }    class Bar extends Bar2 { }    class Bar2 extends Foo { }        ?>  +-------------+--------------------------------------------+ | Short name  | Classes/MutualExtension                    | +-------------+--------------------------------------------+ | Rulesets    | :ref:`LintButWontExec`, :ref:`ClassReview` | +-------------+--------------------------------------------+ | Severity    | Major                                      | +-------------+--------------------------------------------+ | Time To Fix | Quick (30 mins)                            | +-------------+--------------------------------------------+    .. _clone-with-non-object:  Clone With Non-Object #####################   The ``clone`keyword must be used on variables, properties or results from a function or method call.`clone`` cannot be used with constants or literals.  .. code-block:: php     <?php        class x { }    $x = new x();        // Valid clone    $y = clone $x;        // Invalid clone    $y = clone x;        ?>   Cloning a non-object lint but won't execute.  See also `Object cloning <https://www.php.net/manual/en/language.oop5.cloning.php>`_.    Suggestions ^^^^^^^^^^^  * Only clone containers (like variables, properties...) * Add typehint to injected properties, so they are checked as objects.  +-------------+----------------------------------------+ | Short name  | Classes/CloneWithNonObject             | +-------------+----------------------------------------+ | Rulesets    | :ref:`Analyze`, :ref:`LintButWontExec` | +-------------+----------------------------------------+ | Severity    | Minor                                  | +-------------+----------------------------------------+ | Time To Fix | Quick (30 mins)                        | +-------------+----------------------------------------+    .. _close-tags:  Close Tags ##########   PHP manual recommends that script should be left open, without the final closing ?>. This way, one will avoid the infamous bug 'Header already sent', associated with left-over spaces, that are lying after this closing tag.  +-------------+-------------------------------------------------------------------------------------------------------------+ | Short name  | Php/CloseTags                                                                                               | +-------------+-------------------------------------------------------------------------------------------------------------+ | Rulesets    | :ref:`Coding Conventions <coding-conventions>`                                                              | +-------------+-------------------------------------------------------------------------------------------------------------+ | Severity    | Minor                                                                                                       | +-------------+-------------------------------------------------------------------------------------------------------------+ | Time To Fix | Instant (5 mins)                                                                                            | +-------------+-------------------------------------------------------------------------------------------------------------+ | ClearPHP    | `leave-last-closing-out <https://github.com/dseguy/clearPHP/tree/master/rules/leave-last-closing-out.md>`__ | +-------------+-------------------------------------------------------------------------------------------------------------+    .. _closure-could-be-a-callback:  Closure Could Be A Callback ###########################   `Closure <https://www.php.net/manual/en/class.closure.php>`_ or arrowfunction could be simplified to a callback. Callbacks are strings or arrays.  A simple closure that only returns arguments relayed to another function or method, could be reduced to a simpler expression. They   `Closure <https://www.php.net/manual/en/class.closure.php>`_ may be simplified with a string, for functioncall, with an array for methodcalls and `static <https://www.php.net/manual/en/language.oop5.static.php>`_ methodcalls.   Performances : simplifying a closure tends to reduce the call time by 50%.   .. code-block:: php     <?php        // Simple and faster call to strtoupper    $filtered = array_map('strtoupper', $array);        // Here the closure doesn't add any feature over strtoupper    $filtered = array_map(function ($x) { return strtoupper($x);}, $array);        // Methodcall example : no fix    $filtered = array_map(function ($x) { return $x->strtoupper() ;}, $array);        // Methodcall example  : replace with array($y, 'strtoupper')    $filtered = array_map(function ($x) use ($y) { return $y->strtoupper($x) ;}, $array);        // Static methodcall example     $filtered = array_map(function ($x) { return $x::strtoupper() ;}, $array);        // Static methodcall example   : replace with array('A', 'strtoupper')    $filtered = array_map(function ($x) { return A::strtoupper($x) ;}, $array);        ?>   See also `Closure class <https://www.php.net/closure>`_ and `Callbacks / Callables <https://www.php.net/manual/en/language.types.callable.php>`_.   Suggestions ^^^^^^^^^^^  * Replace the closure by a string, with the name of the called function * Replace the closure by an array, with the name of the called method and the object as first element  +-------------+-----------------------------------------------------------------------------------+ | Short name  | Functions/Closure2String                                                          | +-------------+-----------------------------------------------------------------------------------+ | Rulesets    | :ref:`Suggestions`, :ref:`Performances`                                           | +-------------+-----------------------------------------------------------------------------------+ | Severity    | Minor                                                                             | +-------------+-----------------------------------------------------------------------------------+ | Time To Fix | Quick (30 mins)                                                                   | +-------------+-----------------------------------------------------------------------------------+ | Examples    | :ref:`tine20-functions-closure2string`, :ref:`nextcloud-functions-closure2string` | +-------------+-----------------------------------------------------------------------------------+    .. _closure-may-use-$this:  Closure May Use $this #####################   `$this <https://www.php.net/manual/en/language.oop5.basic.php>`_ is automatically accessible to closures.  When closures were introduced in PHP, they couldn't use the `$this <https://www.php.net/manual/en/language.oop5.basic.php>`_ variable, making is cumbersome to access local properties when the closure was created within an object.   .. code-block:: php     <?php        // Invalid code in PHP 5.4 and less    class Test    {        public function testing()        {            return function() {                var_dump($this);            };        }    }        $object = new Test;    $function = $object->testing();    $function();            ?>   This is not the case anymore since PHP 5.4.  See also `Anonymous functions <https://www.php.net/manual/en/functions.anonymous.php>`_.  +-------------+---------------------------+ | Short name  | Php/ClosureThisSupport    | +-------------+---------------------------+ | Rulesets    | :ref:`CompatibilityPHP53` | +-------------+---------------------------+ | Php Version | With PHP 5.4 and older    | +-------------+---------------------------+ | Severity    | Minor                     | +-------------+---------------------------+ | Time To Fix | Quick (30 mins)           | +-------------+---------------------------+    .. _coalesce-and-concat:  Coalesce And Concat ###################   The concatenation operator dot has precedence over the coalesce operator ??.   .. code-block:: php     <?php        // Parenthesis are the right solution when in doubt    echo a . ($b ?? 'd') . $e;        // 'a' . $b is evaluated first, leading ot a useless ?? operator    'a' . $b ?? $c;        // 'd' . 'e' is evaluated first, leading to $b OR 'de'.     echo $b ?? 'd' . 'e';        ?>     Suggestions ^^^^^^^^^^^  * Add parenthesis around ?? operator to avoid misbehavior * Do not use dot and ?? together in the same expression  +-------------+----------------------------------+ | Short name  | Structures/CoalesceAndConcat     | +-------------+----------------------------------+ | Rulesets    | :ref:`Analyze`, :ref:`CI-checks` | +-------------+----------------------------------+ | Severity    | Minor                            | +-------------+----------------------------------+ | Time To Fix | Quick (30 mins)                  | +-------------+----------------------------------+    .. _coalesce-equal:  Coalesce Equal ##############   Usage of coalesce assignement operator. The operator is available in PHP since PHP 7.4.  .. code-block:: php     <?php        // Coalesce operator, since PHP 5.3    $a ??= 'default value';        // Equivalent to the line above    $a = $a ?? 'default value';        ?>   See also `Ternary Operator <https://www.php.net/manual/en/language.operators.comparison.php#language.operators.comparison.ternary>`_.   Suggestions ^^^^^^^^^^^  * Use the short assignement syntax  +-------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | Short name  | Php/CoalesceEqual                                                                                                                                                                                                      | +-------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | Rulesets    | :ref:`CompatibilityPHP53`, :ref:`CompatibilityPHP70`, :ref:`CompatibilityPHP71`, :ref:`CompatibilityPHP72`, :ref:`CompatibilityPHP73`, :ref:`CompatibilityPHP54`, :ref:`CompatibilityPHP55`, :ref:`CompatibilityPHP56` | +-------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | Php Version | With PHP 7.4 and more recent                                                                                                                                                                                           | +-------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | Precision   | Very high                                                                                                                                                                                                              | +-------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+    .. _common-alternatives:  Common Alternatives ###################   In the following conditional structures, expressions were found that are common to both 'then' and 'else'. It may be interesting, though not always possible, to put them both out of the conditional, and reduce line count.   .. code-block:: php     <?php    if ($c == 5) {        $b = strtolower($b[2]);         $a++;    } else {        $b = strtolower($b[2]);         $b++;    }    ?>   may be rewritten in :   .. code-block:: php     <?php        $b = strtolower($b[2]);     if ($c == 5) {        $a++;    } else {        $b++;    }        ?>     Suggestions ^^^^^^^^^^^  * Collect common expressions, and move them before of after the if/then expression. * Move a prefix and suffixes to a third-party method  +-------------+-----------------------------------------------------------------------------------------------+ | Short name  | Structures/CommonAlternatives                                                                 | +-------------+-----------------------------------------------------------------------------------------------+ | Rulesets    | :ref:`Analyze`                                                                                | +-------------+-----------------------------------------------------------------------------------------------+ | Severity    | Major                                                                                         | +-------------+-----------------------------------------------------------------------------------------------+ | Time To Fix | Instant (5 mins)                                                                              | +-------------+-----------------------------------------------------------------------------------------------+ | Examples    | :ref:`dolibarr-structures-commonalternatives`, :ref:`nextcloud-structures-commonalternatives` | +-------------+-----------------------------------------------------------------------------------------------+    .. _compact-inexistant-variable:  Compact Inexistant Variable ###########################   `Compact() <https://www.php.net/compact>`_ doesn't warn when it tries to work on an inexistant variable. It just ignores the variable.  This behavior changed in PHP 7.3, and `compact() <https://www.php.net/compact>`_ now emits a warning when the compacted variable doesn't exist.  .. code-block:: php     <?php        function foo($b = 2) {        $a = 1;        // $c doesn't exists, and is not compacted.        return compact('a', 'b', 'c');    }    ?>   For performances reasons, this analysis only works inside methods and functions.  See also `compact <http://www.php.net/compact>`_ and `PHP RFC: Make compact function reports undefined passed variables <https://wiki.php.net/rfc/compact>`_.   Suggestions ^^^^^^^^^^^  * Fix the name of variable in the compact() argument list * Remove the name of variable in the compact() argument list  +-------------+-----------------------------------------------+ | Short name  | Php/CompactInexistant                         | +-------------+-----------------------------------------------+ | Rulesets    | :ref:`Suggestions`, :ref:`CompatibilityPHP73` | +-------------+-----------------------------------------------+ | Severity    | Major                                         | +-------------+-----------------------------------------------+ | Time To Fix | Quick (30 mins)                               | +-------------+-----------------------------------------------+    .. _compare-hash:  Compare Hash ############   When comparing hash values, it is important to use the strict comparison : `hash_equals() <https://www.php.net/hash_equals>`_, ``===`or`!==`.   In a number of situations, the hash value will start with`0e`` , and PHP will understand that the comparison involves integers : it will then convert the strings into numbers, and it may end up converting them to 0.  Here is an example :   .. code-block:: php     <?php        // The two following passwords hashes matches, while they are not the same.     $hashed_password = 0e462097431906509000000000000;    if (hash('md5','240610708',false) == $hashed_password) {      print 'Matched.'.PHP_EOL;    }        // hash returns a string, that is mistaken with 0 by PHP    // The strength of the hashing algorithm is not a problem    if (hash('ripemd160','20583002034',false) == '0') {      print 'Matched.'.PHP_EOL;    }        if (hash('md5','240610708',false) !== $hashed_password) {      print 'NOT Matched.'.PHP_EOL;    }        // Display true    var_dump(md5('240610708') == md5('QNKCDZO') );        ?>   You may also use `password_hash() <https://www.php.net/password_hash>`_ and `password_verify() <https://www.php.net/password_verify>`_ : they work together without integer conversion problems, and they can't be confused with a number.  See also `Magic Hashes <https://blog.whitehatsec.com/magic-hashes/>`_ `What is the best way to compare hashed strings? (PHP) <https://stackoverflow.com/questions/5211132/what-is-the-best-way-to-compare-hashed-strings-php/23959696#23959696>`_ and `md5('240610708') == md5('QNKCDZO') <https://news.ycombinator.com/item?id=9484757>`_.    Suggestions ^^^^^^^^^^^  * Use dedicated functions for hash comparisons * Use identity operators (===), and not equality operators (==) to compare hashes * Compare hashes in the database (or external system), where such confusion is not possible  +-------------+-----------------------------------------------------------------------------------------------------+ | Short name  | Security/CompareHash                                                                                | +-------------+-----------------------------------------------------------------------------------------------------+ | Rulesets    | :ref:`Security`                                                                                     | +-------------+-----------------------------------------------------------------------------------------------------+ | Severity    | Major                                                                                               | +-------------+-----------------------------------------------------------------------------------------------------+ | Time To Fix | Quick (30 mins)                                                                                     | +-------------+-----------------------------------------------------------------------------------------------------+ | ClearPHP    | `strict-comparisons <https://github.com/dseguy/clearPHP/tree/master/rules/strict-comparisons.md>`__ | +-------------+-----------------------------------------------------------------------------------------------------+ | Examples    | :ref:`traq-security-comparehash`, :ref:`livezilla-security-comparehash`                             | +-------------+-----------------------------------------------------------------------------------------------------+    .. _compared-comparison:  Compared Comparison ###################   Usually, comparison are sufficient, and it is rare to have to compare the result of comparison. Check if this two-stage comparison is really needed.  .. code-block:: php     <?php        if ($a === strpos($string, $needle) > 2) {}        // the expression above apply precedence :     // it is equivalent to :     if (($a === strpos($string, $needle)) > 2) {}        ?>   See also `Operators Precedence <https://www.php.net/manual/en/language.operators.precedence.php>`_.  +-------------+-------------------------------+ | Short name  | Structures/ComparedComparison | +-------------+-------------------------------+ | Rulesets    | :ref:`Analyze`                | +-------------+-------------------------------+ | Severity    | Major                         | +-------------+-------------------------------+ | Time To Fix | Quick (30 mins)               | +-------------+-------------------------------+    .. _complex-dynamic-names:  Complex Dynamic Names #####################   Avoid using expressions as names for variables or methods.   There are no place for checks or flow control, leading to any rogue value to be used as is. Besides, the expression is often overlooked, and not expected there : this makes the code less readable.  It is recommended to build the name in a separate variable, apply the usual checks for existence and validity, and then use the name.  .. code-block:: php     <?php        $a = new foo();        // Code is more readable    $name = strolower($string);    if (!property_exists($a, $name)) {        throw new missingPropertyexception($name);    }    echo $a->$name;        // This is not check    echo $a->{strtolower($string)};        ?>   This analysis only accept simple containers, such as variables, properties.   See also `Dynamically Access PHP Object Properties with `$this <https://www.php.net/manual/en/language.oop5.basic.php>`_ <https://drupalize.me/blog/201508/dynamically-access-php-object-properties>`_.    Suggestions ^^^^^^^^^^^  * Extract the expression from the variable syntax, and make it a separate variable.  +-------------+-------------------------------+ | Short name  | Variables/ComplexDynamicNames | +-------------+-------------------------------+ | Rulesets    | :ref:`Suggestions`            | +-------------+-------------------------------+ | Severity    | Minor                         | +-------------+-------------------------------+ | Time To Fix | Quick (30 mins)               | +-------------+-------------------------------+    .. _concat-and-addition:  Concat And Addition ###################   Precedence between addition and concatenation has changed. In PHP 7.4, addition has precedence, and before, addition and concatenation had the same precedence.  From the RFC : ``Currently
the precedence of \'.\', \'+\' and \'-\' operators are equal. Any
combination of these operators are simply evaluated
left-to-right`.  This is counter-intuitive though: you rarely want to add or subtract concatenated strings which in general are not numbers. However, given PHP's capability of seamlessly converting an integer to a string, concatenation of these values is desired.`

``` {.php}
<?php
// Extracted from the RFC
echo sum: . $a + $b;

// current behavior: evaluated left-to-right
echo (sum: . $a) + $b;

// desired behavior: addition and subtraction have a higher precendence
echo sum : . ($a + $b);

?>
```

This analysis reports any addition and concatenation that are mixed,
without parenthesis. Addition also means substraction here, aka using
[+]{.title-ref} or [-]{.title-ref}.

The same applies to bitshift operations, `<<` and `>>`. There is no RFC
for this change.

See also [Change the precedence of the concatenation
operator](https://wiki.php.net/rfc/concatenation_precedence).

### Suggestions

-   Add parenthesis around the addition to ensure its expected priority
-   Move the addition outside the concatenation

  ---------- --------------------------------------------------------------------
  Short name Php/ConcatAndAddition

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"},
             `CompatibilityPHP73`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP74`{.interpreted-text role="ref"},
             `CompatibilityPHP80`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"},
             `Top10`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text
             role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        
  ---------- --------------------------------------------------------------------

Concat Empty String
-------------------

Using a concatenation to make a value a string should be replaced with a
type cast.

Type cast to a string is done with `(string)` operator. There is also
the function [strval()](https://www.php.net/strval), although it is less
recommended.

``` {.php}
<?php

$a = 3;

// explicite way to cast a value
$b = (string) $a; // $b is a string with the content 3

// Wrong way to cast a value
$c = $a . ''; // $c is a string with the content 3
$c = '' . $a; // $c is a string with the content 3
$a .= '';     // $a is a string with the content 3

// Wrong way to cast a value
$c = $a . '' . $b; // This is not reported. The empty string is useless, but not meant to type cast

?>
```

See also [Type
Casting](https://php.net/manual/en/language.types.type-juggling.php#language.types.typecasting)
and [PHP Type
Casting](https://developer.hyvor.com/tutorials/php/type-casting).

### Suggestions

-   Avoid concatenating with empty strings
-   Use (string) operator to cast to string
-   Remove any concatenated empty string

  ------------- -----------------------------
  Short name    Structures/ConcatEmpty

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Concrete Visibility
-------------------

Methods that implements an interface in a class must be public.

PHP does lint this, unless the interface and the class are in the same
file. At execution, it stops immediately with a Fatal error : \'Access
level to c::iPrivate() must be public (as in class i) \';

``` {.php}
<?php

interface i {
    function iPrivate() ;
    function iProtected() ;
    function iPublic() ;
}

class c implements i {
    // Methods that implements an interface in a class must be public.  
    private function iPrivate() {}
    protected function iProtected() {}
    public function iPublic() {}
}

?>
```

See also
[Interfaces](https://www.php.net/manual/en/language.oop5.interfaces.php).

### Suggestions

-   Always set interface methods to public.

  ------------- ----------------------------------------
  Short name    Interfaces/ConcreteVisibility

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)
  ------------- ----------------------------------------

Configure Extract
-----------------

The [extract()](https://www.php.net/extract) function overwrites local
variables when left unconfigured.

Extract imports variables from an array into the local scope. In case of
a conflict, that is when a local variable already exists, it overwrites
the previous variable.

In fact, [extract()](https://www.php.net/extract) may be configured to
handle the situation differently : it may skip the conflicting variable,
prefix it, prefix it only if it exists, only import overwriting
variables\... It may also import them as references to the original
values.

This analysis reports [extract()](https://www.php.net/extract) when it
is not configured explicitly. If overwriting is the intended objective,
it is not reported.

``` {.php}
<?php

// ignore overwriting variables
extract($array, EXTR_SKIP);

// prefix all variables explicitly variables with 'php_'
extract($array, EXTR_PREFIX_ALL, 'php_');

// overwrites explicitly variables
extract($array, EXTR_OVERWRITE);

// overwrites implicitely variables : do we really want that? 
extract($array, EXTR_OVERWRITE);

?>
```

Always avoid using [extract()](https://www.php.net/extract) on untrusted
sources, such as `$_GET`, `$_POST`, `$_FILES`, or even databases
records.

See also [extract](https://www.php.net/extract).

### Suggestions

-   Always use the second argument of extract(), and avoid using
    `EXTR_OVERWRITE`

  ---------- ------------------------------------------------------------
  Short name Security/ConfigureExtract

  Rulesets   `Security`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `zurmo-security-configureextract`{.interpreted-text
             role="ref"},
             `dolibarr-security-configureextract`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Const Visibility Usage
----------------------

Visibility for class constant controls the accessibility to class
constant.

A public constant may be used anywhere in the code; a protected constant
usage is restricted to the class and its relatives; a private constant
is restricted to itself.

This feature was introduced in PHP 7.1. It is recommended to use
explicit visibility, and, whenever possible, make the visibility
private.

``` {.php}
<?php

class x {
    public const a = 1;
    protected const b = 2;
    private const c = 3;
    const d = 4;
}

interface i {
    public const a = 1;
      const d = 4;
}

?>
```

See also [Class
Constants](https://www.php.net/manual/en/language.oop5.constants.php)
and [PHP RFC: Support Class Constant
Visibility](https://wiki.php.net/rfc/class_const_visibility).

### Suggestions

-   Add constant visibility, at least \'public\'.

  ---------- ----------------------------------------------------------------
  Short name Classes/ConstVisibilityUsage

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.1 and more recent
  Version    

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        
  ---------- ----------------------------------------------------------------

Const With Array
----------------

The const keyword supports array. This feature was added in PHP 5.6.

The array must be filled with other constants. It may also be build
using the \'+\' operator.

``` {.php}
<?php

const PRIMES = [2, 3, 5, 7];

class X {
    const TWENTY_THREE = 23;
    const MORE_PRIMES = PRIMES + [11, 13, 17, 19];
    const EVEN_MORE_PRIMES = self::MORE_PRIMES + [self::TWENTY_THREE];
}

?>
```

See also [Class
Constants](https://www.php.net/manual/en/language.oop5.constants.php)
and [Constants
Syntax](https://www.php.net/manual/en/language.constants.syntax.php).

  ---------- ------------------------------------------------------------
  Short name Php/ConstWithArray

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"}

  Php        With PHP 5.5 and more recent
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- ------------------------------------------------------------

Constant Class
--------------

A class or an interface only made up of constants. Constants usually
have to be used in conjunction of some behavior (methods, class\...) and
never alone.

``` {.php}
<?php

class ConstantClass {
    const KBIT = 1000;
    const MBIT = self::KBIT * 1000;
    const GBIT = self::MBIT * 1000;
    const PBIT = self::GBIT * 1000;
}

?>
```

As such, they should be PHP constants (build with define or const), or
included in a class with other methods and properties.

See also [PHP Classes containing only
constants](https://stackoverflow.com/questions/16838266/php-classes-containing-only-constants).

### Suggestions

-   Make the class an interface
-   Make the class an abstract class, to avoid its instantiation

  ------------- ----------------------------------
  Short name    Classes/ConstantClass

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------

Constant Comparison
-------------------

Constant to the left or right is a favorite.

Comparisons are commutative : they may be \$a == B or B == \$a. The
analyzed code show less than 10% of one of the two : for consistency
reasons, it is recommended to make them all the same.

Putting the constant on the left is also called \'Yoda Comparison\', as
it mimics the famous characters style of speech. It prevents errors like
\'B = \$a\' where the comparison is turned into an assignation.

The natural way is to put the constant on the right. It is often less
surprising.

Every comparison operator is used when finding the favorite.

``` {.php}
<?php

// 
if ($a === B) { doSomething(); }
if ($c > D) { doSomething(); }
if ($e !== G) { doSomething(); }
do { doSomething(); } while ($f === B);
while ($a === B) { doSomething(); }

// be consistent
if (B === $a) {}

// Compari
if (B <= $a) {}

?>
```

  ------------- -------------------------------------------------------------
  Short name    Structures/ConstantComparisonConsistance

  Rulesets      `Coding Conventions <coding-conventions>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------------------------------------

Constant Scalar Expressions
---------------------------

Define constant with the result of
[static](https://www.php.net/manual/en/language.oop5.static.php)
expressions. This means that constants may be defined with the const
keyword, with the help of various operators but without any
functioncalls.

This feature was introduced in PHP 5.6. It also supports
[array()](https://www.php.net/array), and expressions in arrays.

Those expressions (using simple operators) may only manipulate other
constants, and all values must be known at compile time.

``` {.php}
<?php

// simple definition
const A = 1;

// constant scalar expression
const B = A * 3;

// constant scalar expression
const C = [A ** 3, '3' => B];

?>
```

See also [Constant Scalar
Expressions](https://wiki.php.net/rfc/const_scalar_exprs).

  ---------- ------------------------------------------------------------
  Short name Structures/ConstantScalarExpression

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"}

  Php        With PHP 5.6 and more recent
  Version    

  Severity   Major

  Time To    Quick (30 mins)
  Fix        
  ---------- ------------------------------------------------------------

Constant Typo Looks Like A Variable
-----------------------------------

A constant bears the same name as a variable. This might be a typo.

When the constant doesn\'t exist, PHP 8.0 yields a Fatal Error and stops
execution. PHP 7.4 turns the undefined constant into its string
equivalent.

``` {.php}
<?php

// Get an object or null
$object = foo(); 

// PHP 8.0 stops here, with a Fatal Error
// PHP 7.4 makes this a string, and the condition is always true
if (!empty(object)) {
    // In PHP 7.4, this is not protected by the condition, and may yield an error.
    $object->doSomething();
}

?>
```

This analysis is case sensitive.

### Suggestions

-   Add a \$ sign to the constant
-   Use a different name for the variable, or the constant

  -------------- -----------------------------------------
  Short name     Variables/ConstantTypo

  Rulesets       `Analyze`{.interpreted-text role="ref"}

  Php Version    8.0-

  Severity       Minor

  Time To Fix    Quick (30 mins)

  Precision      Medium

  Related rule   `undefined-constants`{.interpreted-text
                 role="ref"}
  -------------- -----------------------------------------

Constants Created Outside Its Namespace
---------------------------------------

Constants Created Outside Its Namespace.

Using the [define()](https://www.php.net/define) function, it is
possible to create constant outside their namespace, but using the fully
qualified namespace.

``` {.php}
<?php

namespace A\B {
    // define A\B\C as 1
    define('C', 1);
}

namespace D\E {
    // define A\B\C as 1, while outside the A\B namespace
    define('A\B\C', 1);
}

?>
```

However, this makes the code confusing and difficult to debug. It is
recommended to move the constant definition to its namespace.

  ------------- --------------------------------------
  Short name    Constants/CreatedOutsideItsNamespace

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- --------------------------------------

Constants With Strange Names
----------------------------

List of constants being defined with names that are incompatible with
PHP standards.

``` {.php}
<?php

// Define a valid PHP constant
define('ABC', 1); 
const ABCD = 2; 

// Define an invalid PHP constant
define('ABC!', 1); 
echo defined('ABC!') ? constant('ABC!') : 'Undefined';

// Const doesn't allow illegal names

?>
```

See also [PHP
Constants](https://www.php.net/manual/en/language.constants.php).

  ------------- ----------------------------------
  Short name    Constants/ConstantStrangeNames

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------

Continue Is For Loop
--------------------

[break](https://www.php.net/manual/en/control-structures.break.php) and
[continue](https://www.php.net/manual/en/control-structures.continue.php)
are very similar in PHP : they both
[break](https://www.php.net/manual/en/control-structures.break.php) out
of loop or switch. Yet,
[continue](https://www.php.net/manual/en/control-structures.continue.php)
should be reserved for loops.

Since PHP 7.3, the execution will emit a warning when finding a
[continue](https://www.php.net/manual/en/control-structures.continue.php)
inside a switch inside a loop :
\'\"[continue](https://www.php.net/manual/en/control-structures.continue.php)\"
targeting switch is equivalent to
\"[break](https://www.php.net/manual/en/control-structures.break.php)\".
Did you mean to use
\"[continue](https://www.php.net/manual/en/control-structures.continue.php)
2\"?\'

``` {.php}
<?php

while ($foo) {
    switch ($bar) {
        case 'baz':
            continue; // In PHP: Behaves like 'break;'
                      // In C:   Behaves like 'continue 2;'
    }
}

?>
```

See also [Deprecate and remove \`continue
\<https://www.php.net/manual/en/control-structures.continue.php\>]{.title-ref}\_
targeting switch
\<<https://wiki.php.net/rfc/continue_on_switch_deprecation>\>\`\_.

### Suggestions

-   Replace break by continue

  ---------- ------------------------------------------------------------------
  Short name Structures/ContinueIsForLoop

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"},
             `CompatibilityPHP73`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `xoops-structures-continueisforloop`{.interpreted-text role="ref"}
  ---------- ------------------------------------------------------------------

Could Be Abstract Class
-----------------------

An abstract class is never instantiated, and has children class that
are. As such, a
\'[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)\'
class that is never instantiated by itself, but has its own children
instantiated could be marked as abstract.

That will prevent new code to try to instantiate it.

``` {.php}
<?php

// Example code would actually be split over multiple files.


// That class could be abstract
class motherClass {}

// Those classes shouldn't be abstract
class firstChildren extends motherClass {}
class secondChildren extends motherClass {}
class thirdChildren extends motherClass {}

new firstChildren();
new secondChildren();
new thirdChildren();

//Not a single : new motherClass()

?>
```

See also [Class Abstraction](https://www.php.net/abstract) [Abstract
classes and
methods](https://phpenthusiast.com/object-oriented-php-tutorials/abstract-classes-and-methods).

### Suggestions

-   Make this class an abstract class

  ---------- -------------------------------------------------------------
  Short name Classes/CouldBeAbstractClass

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `ClassReview`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `edusoho-classes-couldbeabstractclass`{.interpreted-text
             role="ref"},
             `shopware-classes-couldbeabstractclass`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Could Be Callable
-----------------

Mark arguments and return types that can be set to `callable`.

``` {.php}
<?php

// Accept a callable as input 
function foo($b) {
    // Returns value as return
    return $b();
}

?>
```

### Suggestions

-   Add [callable]{.title-ref} typehint to the code.

  ------------- --------------------------------
  Short name    Typehints/CouldBeCallable

  Rulesets      `Typechecks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- --------------------------------

Could Be Class Constant
-----------------------

When a property is defined and read, but never modified, it may be a
constant.

``` {.php}
<?php

class foo {
    // $this->bar is never modified. 
    private $bar = 1;

    // $this->foofoo is modified, at least once
    private $foofoo = 2;

    function method($a) {
        $this->foofoo = $this->bar + $a + $this->foofoo;

        return $this->foofoo;
    }

}

?>
```

Starting with PHP 5.6, even [array()](https://www.php.net/array) may be
defined as constants.

  ------------- ---------------------------------
  Short name    Classes/CouldBeClassConstant

  Rulesets      `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Could Be Constant
-----------------

Literals may be replaced by an existing constant.

Constants makes the code easier to read, as they may bear a meaningful
name. They also hide implementation values, with a readable name, such
as `const READABLE= true;`. Later, upgrading constant values is easier
than scouring the code with a new literal.

Not all literal can be replaced by a constant values : sometimes,
literal may have the same literal value, but different meanings. Check
with your application semantics before changing any literal with a
constant.

``` {.php}
<?php

const A = 'abc';
define('B', 'ab');

class foo {
    const X = 'abcd';
}

// Could be replaced by B;
$a = 'ab'; 

// Could be replaced by A;
$a = 'abc'; 

// Could be replaced by foo::X;
$a = 'abcd'; 

?>
```

This analysis currently doesn\'t support arrays.

This analysis also skips very common values, such as boolean, `0` and
`1`. This prevents too many false positive.

### Suggestions

-   Turn the literal into an existing constant

  ------------- ---------------------------------
  Short name    Constants/CouldBeConstant

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Could Be Else
-------------

Merge opposition conditions into one if/then structure.

When two if/then structures follow each other, using a condition and its
opposite, they may be merged into one.

``` {.php}
<?php

// Short version
if ($a == 1) {
    $b = 2;
} else {
    $b = 1;
}

// Long version
if ($a == 1) {
    $b = 2;
}

if ($a != 1) {
    $b = 3;
}

?>
```

### Suggestions

-   Merge the two conditions into one structure
-   Check if the second condition is still applicable

  ---------- ------------------------------------------------------------
  Short name Structures/CouldBeElse

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `sugarcrm-structures-couldbeelse`{.interpreted-text
             role="ref"},
             `openemr-structures-couldbeelse`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Could Be Float
--------------

Mark arguments, properties and return types that can be set to `float`.

``` {.php}
<?php

// Accept an int as input 
function foo($b) {
    // Returns a float (cubic root of $b);
    return pow($b, 1 / 3);
}

?>
```

### Suggestions

-   Add [float]{.title-ref} typehint to the code.

  ------------- --------------------------------
  Short name    Typehints/CouldBeFloat

  Rulesets      `Typechecks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- --------------------------------

Could Be Integer
----------------

Mark arguments, properties and return types that can be set to `int`.

``` {.php}
<?php

// Accept an int as input 
function foo($b) {
    // Returns an int
    return $b + 8;
}

?>
```

### Suggestions

-   Add [int]{.title-ref} typehint to the code.

  ------------- --------------------------------
  Short name    Typehints/CouldBeInt

  Rulesets      `Typechecks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- --------------------------------

Could Be Iterable
-----------------

Mark arguments, properties and return types that can be set to
`iterable`.

``` {.php}
<?php

// Accept an array or a traversable Object as input 
function foo($b) {
    foreach($b as $c) {

    }

    // Returns an array
    return [$b];
}

?>
```

### Suggestions

-   Add [iterable]{.title-ref} typehint to the code (PHP 8.0+).

  ------------- --------------------------------
  Short name    Typehints/CouldBeIterable

  Rulesets      `Typechecks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- --------------------------------

Could Be Null
-------------

Mark arguments and return types that can be null.

``` {.php}
<?php

// Accept null as input, when used as third argument of file_get_contents
function foo($b) {
    $s = file_get_contents(URL, false, $b);

    // Returns a string
    return shell_exec($s);
}

?>
```

### Suggestions

-   Add [null]{.title-ref} typehint to the code (PHP 8.0+).
-   Add [?]{.title-ref} typehint to the code.

  ------------- --------------------------------
  Short name    Typehints/CouldBeNull

  Rulesets      `Typechecks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- --------------------------------

Could Be Parent
---------------

Mark arguments, return types and properties that can be set to `parent`.

This analysis works when typehints have already been configured.

``` {.php}
<?php

class x extends w {
    // Accept a w object as input 
    function foo(w $b) : w {
        // Returns a w object
        return $b;
    }   
}

?>
```

### Suggestions

-   Add [parent]{.title-ref} typehint to the code.
-   Add the literal class/type typehint to the code.

  ------------- --------------------------------
  Short name    Typehints/CouldBeParent

  Rulesets      `Typechecks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- --------------------------------

Could Be Parent Method
----------------------

A method is defined in several children, but not in a the
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
class. It may be worth checking if this method doesn\'t belong the
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
class, as an abstraction.

``` {.php}
<?php

// The parent class
class x { }

// The children class
class y1 extends x {
    // foo is common to y1 and y2, so it shall be also a method in x
    function foo() {}
    // fooY1 is specific to y1
    function fooY1() {}
}

class y2 extends x {
    function foo() {}
    // fooY2 is specific to y1
    function fooY2() {}
}

?>
```

Only the name of the method is used is for gathering purposes. If the
code has grown organically, the signature (default values, typehint,
argument names) may have followed different path, and will require a
refactorisation.

### Suggestions

-   Create an abstract method in the parent
-   Create an concrete method in the parent, and move default behavior
    there by removing it in children classes

  ------------- --------- --------- -----------------------------------------
  Name          Default   Type      Description

  minChildren   4         integer   Minimal number of children using this
                                    method.
  ------------- --------- --------- -----------------------------------------

  ------------- ---------------------------------
  Short name    Classes/CouldBeParentMethod

  Rulesets      `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- ---------------------------------

Could Be Private Class Constant
-------------------------------

Class constant may use `private` visibility.

Since PHP 7.1, constants may also have a public/protected/private
visibility. This restrict their usage to anywhere, class and children or
class.

As a general rule, it is recommended to make constant `private` by
default, and to relax this restriction as needed. PHP makes them public
by default.

``` {.php}
<?php

class foo {
    // pre-7.1 style
    const PRE_71_CONSTANT = 1;

    // post-7.1 style
    private const PRIVATE_CONSTANT = 2;
    public const PUBLIC_CONSTANT = 3;

    function bar() {
        // PRIVATE CONSTANT may only be used in its class
        echo self::PRIVATE_CONSTANT;
    }
}

// Other constants may be used anywhere
function x($a = foo::PUBLIC_CONSTANT) {
    echo $a.' '.foo:PRE_71_CONSTANT;
}

?>
```

Constant shall stay `public` when the code has to be compatible with PHP
7.0 and older.

They also have to be public in the case of component : some of those
constants have to be used by external actors, in order to configure the
component.

See also [Class
Constants](https://www.php.net/manual/en/language.oop5.constants.php).

  ------------- -----------------------------------------------------------
  Short name    Classes/CouldBePrivateConstante

  Rulesets      `ClassReview`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `phinx-classes-couldbeprivateconstante`{.interpreted-text
                role="ref"}
  ------------- -----------------------------------------------------------

Could Be Protected Class Constant
---------------------------------

Class constant may use \'protected\' visibility.

Since PHP 7.1, constants may also have a public/protected/private
visibility. This restrict their usage to anywhere, class and children or
class.

As a general rule, it is recommended to make constant \'private\' by
default, and to relax this restriction as needed. PHP makes them public
by default.

``` {.php}
<?php

class foo {
    // pre-7.1 style
    const PRE_71_CONSTANT = 1;

    // post-7.1 style
    protected const PROTECTED_CONSTANT = 2;
    public const PUBLIC_CONSTANT = 3;
}

class foo2 extends foo {
    function bar() {
        // PROTECTED_CONSTANT may only be used in its class or its children
        echo self::PROTECTED_CONSTANT;
    }
}

class foo3 extends foo {
    function bar() {
        // PROTECTED_CONSTANT may only be used in its class or any of its children
        echo self::PROTECTED_CONSTANT;
    }
}

// Other constants may be used anywhere
function x($a = foo::PUBLIC_CONSTANT) {
    echo $a.' '.foo:PRE_71_CONSTANT;
}

?>
```

  ------------- ----------------------------------
  Short name    Classes/CouldBeProtectedConstant

  Rulesets      `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Could Be Protected Method
-------------------------

Those methods are declared public, but are never used publicly. They may
be made protected.

``` {.php}
<?php

class foo {
    // Public, and used publicly
    public publicMethod() {}

    // Public, but never used outside the class or its children
    public protectedMethod() {}

    private function bar() {
        $this->protectedMethod();
    }
}

$foo = new Foo();
$foo->publicMethod();

?>
```

These properties may even be made private.

  ------------- ---------------------------------
  Short name    Classes/CouldBeProtectedMethod

  Rulesets      `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Could Be Protected Property
---------------------------

Those properties are declared public, but are never used publicly. They
may be made protected.

``` {.php}
<?php

class foo {
    // Public, and used publicly
    public $publicProperty;
    // Public, but never used outside the class or its children
    public $protectedProperty;

    function bar() {
        $this->protectedProperty = 1;
    }
}

$foo = new Foo();
$foo->publicProperty = 3;

?>
```

This property may even be made private.

  ------------- ----------------------------------
  Short name    Classes/CouldBeProtectedProperty

  Rulesets      `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------

Could Be Self
-------------

Mark arguments, return types and properties that can be set to `self`.

This analysis works when typehints have already been configured.

``` {.php}
<?php

class x {
    // Accept a x object as input 
    function foo(x $b) : x {
        // Returns a x object
        return $b;
    }   
}

?>
```

### Suggestions

-   Add [self]{.title-ref} typehint to the code.
-   Add the literal class/type typehint to the code.

  ------------- --------------------------------
  Short name    Typehints/CouldBeSelf

  Rulesets      `Typechecks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- --------------------------------

Could Be Static
---------------

This global is only used in one function or method. It may be called
\'[static](https://www.php.net/manual/en/language.oop5.static.php)\',
instead of global. This allows you to keep the value between call to the
function, but will not be accessible outside this function.

``` {.php}
<?php
function foo( ) {
    static $variableIsReservedForX; // only accessible within foo( ), even between calls.
    global $variableIsGlobal;       //      accessible everywhere in the application
}
?>
```

  ---------- ------------------------------------------------------------
  Short name Structures/CouldBeStatic

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `ClassReview`{.interpreted-text role="ref"},
             `Analyze`{.interpreted-text role="ref"},
             `ClassReview`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `dolphin-structures-couldbestatic`{.interpreted-text
             role="ref"},
             `contao-structures-couldbestatic`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Could Be Static Closure
-----------------------

[Closure](https://www.php.net/manual/en/class.closure.php) may be
[static](https://www.php.net/manual/en/language.oop5.static.php), and
prevent the import of `$this`.

By preventing the useless import of `$this`, you avoid useless work.

This also has the added value to prevent the usage of `$this` from the
closure. This is a good security practice.

``` {.php}
<?php

class Foo
{
    function __construct()
    {

        // Not possible to use $this
        $func = static function() {
            var_dump($this);
        };
        $func();

        // Normal import of $this
        $closure = function() {
            var_dump($this);
        };
    }
};
new Foo();

?>
```

This is a micro-optimisation. Apply it in case of intensive usage.

See also [Anonymous
functions](https://www.php.net/manual/en/functions.anonymous.php),
[GeneratedHydrator](https://github.com/Ocramius/GeneratedHydrator/releases/tag/3.0.0)
and [Static anonymous
functions](https://www.php.net/manual/en/functions.anonymous.php#functions.anonymous-functions.%60static%20%3Chttps://www.php.net/manual/en/language.oop5.static.php)\>\`\_.

### Suggestions

-   Add the static keyword to the closure.
-   Make actual usage of \$this in the closure.

  ------------- -----------------------------------------------------------
  Short name    Functions/CouldBeStaticClosure

  Rulesets      `Suggestions`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `piwigo-functions-couldbestaticclosure`{.interpreted-text
                role="ref"}
  ------------- -----------------------------------------------------------

Could Be String
---------------

Mark arguments and return types that can be set to string.

``` {.php}
<?php

// Accept a string as input 
function foo($a) {
    // Returns a string
    return $a . 'string';
}

?>
```

### Suggestions

-   Choose the string typehint, and add it to the code.

  ------------- --------------------------------
  Short name    Typehints/CouldBeString

  Rulesets      `Typechecks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- --------------------------------

Could Be Stringable
-------------------

Stringable is an interface that mark classes as string-castable. It is
introduced in PHP 8.0.

Classes that defined a
[\_\_toString()](https://www.php.net/manual/en/language.oop5.magic.php)
magic method may be turned into a string when the typehint, argument,
return or property, requires it. This is not the case when strict\_types
is activated. Yet, until PHP 8.0, there was nothing to identify a class
as such.

``` {.php}
<?php 

// This class may implement Stringable
class x {
    function __tostring() {
        return 'asd';
    }
}

echo (new x);

?>
```

See also [PHP RFC: Add Stringable
interface](https://wiki.php.net/rfc/stringable).

### Suggestions

-   

  ------------- ----------------------------------------
  Short name    Classes/CouldBeStringable

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text
                role="ref"}

  Php Version   8.0+

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Could Be Void
-------------

Mark return types that can be set to void.

``` {.php}
<?php

// No return, this should be void.
function foo() {
    ++$a; // Not useful
}

?>
```

All abstract methods (in classes or in interfaces) are omitted here.

### Suggestions

-   Add the void typehint to the code.

  ------------- --------------------------------
  Short name    Typehints/CouldBeVoid

  Rulesets      `Typechecks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- --------------------------------

Could Make A Function
---------------------

When a function is called across the code with the same arguments often
enough, it should be turned into a local API.

This approach is similar to turning literals into constants : it
centralize the value, it helps refactoring by updating it. It also makes
the code more readable. Moreover, it often highlight common grounds
between remote code locations.

The analysis looks for functions calls, and checks the arguments. When
the calls occurs more than 4 times, it is reported.

``` {.php}
<?php

// str_replace is used to clean '&' from strings. 
// It should be upgraded to a central function
function foo($arg ) {
    $arg = str_replace('&', '', $arg);
    // do something with $arg
}

class y {
    function bar($database ) {
        $value = $database->queryName();
        $value = str_replace('&', '', $value);
        // $value = removeAmpersand($value);
        // do something with $arg2
    }
}

// helper function
function removeAmpersand($string) {
    return str_replace('&', '', $string);
}

?>
```

See also [Don\'t repeat yourself
(DRY)](https://en.wikipedia.org/wiki/Don%27t_repeat_yourself).

### Suggestions

-   Create a constant for common pieces of data
-   Create a function based on context-free repeated elements
-   Create a class based on repeated elements with dependent values

  --------------------- --------- --------- -------------------------------------------
  Name                  Default   Type      Description

  centralizeThreshold   8         integer   Minimal number of calls of the function
                                            with one common argument.
  --------------------- --------- --------- -------------------------------------------

  ------------- ------------------------------------
  Short name    Functions/CouldCentralize

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- ------------------------------------

Could Use Alias
---------------

This long name may be reduced by using an available alias.

This applies to classes (as full name or prefix), and to constants and
functions.

``` {.php}
<?php

use a\b\c;
use function a\b\c\foo;
use const a\b\c\D;

// This may be reduced with the above alias to c\d()
new a\b\c\d();

// This may be reduced to c\d\e\f 
new a\b\c\d\e\f();

// This may be reduced to c()
new a\b\c();

// This may be reduced to D
echo a\b\c\D;

// This may be reduced to D
a\b\c\foo();

// This can't be reduced : it is an absolute name
\a\b\c\foo();

// This can't be reduced : it is no an alias nor a prefix
a\b\d\foo();

?>
```

### Suggestions

-   Use all your aliases so as to make the code shorter and more
    readable
-   Add new aliases for missing path
-   Make class names absolute and drop the aliases

  ------------- ---------------------------------
  Short name    Namespaces/CouldUseAlias

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Could Use Compact
-----------------

[Compact()](https://www.php.net/compact) turns a group of variables into
an array. It may be used to simplify expressions.

``` {.php}
<?php

$a = 1;
$b = 2;

// Compact call
$array = compact('a', 'b');

$array === [1, 2];

// Detailing all the keys and their value
$array = ['a' => $a, 'b' => $b];

?>
```

Note that compact accepts any string, and any undefined variable is not
set, without a warning.

See also [compact](http://www.php.net/compact).

### Suggestions

-   Replace the array() call with a compact() call.

  ------------- ----------------------------------------------------------
  Short name    Structures/CouldUseCompact

  Rulesets      `Suggestions`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `wordpress-structures-couldusecompact`{.interpreted-text
                role="ref"}
  ------------- ----------------------------------------------------------

Could Use Promoted Properties
-----------------------------

Promoted properties reduce PHP code at
[\_\_construct()](https://www.php.net/manual/en/language.oop5.decon.php)
time. This feature is available in PHP 8.0.

``` {.php}
<?php

class x {
    function __construct($a, $b) {
        // $a argument may be promoted to property $c
        $this->c = $a;

        // $b argument cannot be upgraded to property, as it is updated. 
        // Move the addition to the new call, or keep the syntax below
        $this->d = $b + 2;
    }
}

?>
```

See also [PHP 8: Constructor property
promotion](https://stitcher.io/blog/constructor-promotion-in-php-8) and
[PHP RFC: Constructor Property
Promotion](https://wiki.php.net/rfc/constructor_promotion).

### Suggestions

-   Update the constructor syntax, and remove the property
    specification.

  ------------- ---------------------------------
  Short name    Php/CouldUsePromotedProperties

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Php Version   8.0+

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Could Use Short Assignation
---------------------------

Use short assignment operator, to speed up code, and keep syntax clear.

Some operators, like \* or +, have a compact and fast \'do-and-assign\'
version. They looks like a compacted version for = and the operator.
This syntax is good for readability, and saves some memory in the
process.

Depending on the operator, not all permutations of arguments are
possible.

Addition and short assignation of addition have a different set of
features when applied to arrays. Do not exchange one another in that
case.

``` {.php}
<?php

$a = 10 + $a;
$a += 10;

$b = $b - 1;
$b -= 1;

$c = $c * 2;
$c *= 2;

$d = $d / 3;
$d /= 3;

$e = $e % 4;
$e %= 4;

$f = $f | 5;
$f |= 5;

$g = $g & 6;
$g &= 6;

$h = $h ^ 7;
$h ^= 7;

$i = $i >> 8;
$i >>= 8;

$j = $j << 9;
$j <<= 9;

// PHP 7.4 and more recent
$l = $l ?? 'value';
$l ??= 'value';

?>
```

Short operators are faster than the extended version, though it is a
micro-optimization.

See also [Assignation
Operators](https://www.php.net/manual/en/language.operators.assignment.php).

### Suggestions

-   Change the expression to use the short assignation

  ---------- ----------------------------------------------------------------------------------------------------------
  Short name Structures/CouldUseShortAssignation

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `Performances`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [use-short-assignations](https://github.com/dseguy/clearPHP/tree/master/rules/use-short-assignations.md)

  Examples   `churchcrm-structures-coulduseshortassignation`{.interpreted-text role="ref"},
             `thelia-structures-coulduseshortassignation`{.interpreted-text role="ref"}
  ---------- ----------------------------------------------------------------------------------------------------------

Could Use Try
-------------

Some commands may raise exceptions. It is recommended to use the
try/catch block to intercept those exceptions, and process them.

-   / : `DivisionByZeroError`
-   \% : `DivisionByZeroError`
-   [intdiv()](https://www.php.net/intdiv) : `DivisionByZeroError`
-   \<\< : `ArithmeticError`
-   \>\> : `ArithmeticError`
-   `Phar\:\:mungserver` : `PharException`
-   `Phar\:\:webphar` : `PharException`

See also [Predefined
Exceptions](https://www.php.net/manual/en/reserved.exceptions.php),
[PharException](https://www.php.net/manual/en/class.pharexception.php).

### Suggestions

-   Add a try/catch clause around those commands
-   Add a check on the values used with those operator : for example,
    check a dividend is not 0, or a bitshift is not negative

  ------------- ---------------------------------------------------
  Short name    Exceptions/CouldUseTry

  Rulesets      `Suggestions`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     High

  Examples      `mautic-exceptions-couldusetry`{.interpreted-text
                role="ref"}
  ------------- ---------------------------------------------------

Could Use \_\_[DIR](autoload()%20is%20deprecated%20since%20PHP%207.2%20and%20possibly%20removed%20in%20later%20versions.%20spl_register_autoload()%20was%20introduced%20in%20PHP%205.1.0.) {#could-use-\\_\\_dir\\_\\_}
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Use
[\_\_DIR\_\_](https://www.php.net/manual/en/language.constants.predefined.php)
constant to access the current file\'s
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
directory.

Avoid using [dirname()](https://www.php.net/dirname) on
[\_\_FILE\_\_](https://www.php.net/manual/en/language.constants.predefined.php).

``` {.php}
<?php

// Better way
$fp = fopen(__DIR__.'/myfile.txt', 'r');

// compatible, but slow way
$fp = fopen(dirname(__FILE__).'/myfile.txt', 'r');

// Since PHP 5.3
assert(dirname(__FILE__) == __DIR__);

?>
```

[\_\_DIR\_\_](https://www.php.net/manual/en/language.constants.predefined.php)
has been introduced in PHP 5.3.0.

See also [Magic
Constants](https://www.php.net/manual/en/language.constants.predefined.php).

### Suggestions

-   Use
    \_\_[DIR](autoload()%20may%20only%20be%20declared%20once,%20and%20cannot%20be%20modified%20later.%20This%20creates%20potential%20conflicts%20between%20libraries%20that%20try%20to%20set%20up%20their%20own%20autoloading%20schema.)
    instead of `dirname(__FILE__);`

  ---------- ------------------------------------------------------------
  Short name Structures/CouldUseDir

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Suggestions`{.interpreted-text role="ref"},
             `php-cs-fixable`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `woocommerce-structures-couldusedir`{.interpreted-text
             role="ref"},
             `piwigo-structures-couldusedir`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Could Use array\_fill\_keys {#could-use-array\\_fill\\_keys}
---------------------------

[array\_fill\_keys()](https://www.php.net/array_fill_keys) is a native
PHP function that creates an array from keys. It gets the list of keys,
and a constant value to assign to each keys.

This is twice faster than doing the same with a loop.

Note that is possible to use an object as initializing value : every
element of the final array will be pointing to the same value. And,
also, using an object as initializing value means that the same object
will be used for each key : the object will not be cloned for each
value.

``` {.php}
<?php

$array = range('a', 'z');

// Fast way to build the array
$b = array_fill_keys($a, 0);

// Fast way to build the array, but every element will be the same object
$b = array_fill_keys($a, new Stdclass());

// Slow way to build the array
foreach($array as $a) {
    $b[$a] = 0;
}

// Setting everything to null, slowly
$array = array_map(function() {}, $array);

?>
```

See also [array\_fill\_keys](https://www.php.net/array_fill_keys).

### Suggestions

-   Use array\_fill\_keys()

  ---------- ----------------------------------------------------------------
  Short name Structures/CouldUseArrayFillKeys

  Rulesets   `Suggestions`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  Examples   `churchcrm-structures-couldusearrayfillkeys`{.interpreted-text
             role="ref"},
             `phpipam-structures-couldusearrayfillkeys`{.interpreted-text
             role="ref"}
  ---------- ----------------------------------------------------------------

Could Use array\_unique {#could-use-array\\_unique}
-----------------------

Use [array\_unique()](https://www.php.net/array_unique) to collect
unique elements from an array.

Always try to use native PHP functions, instead of rebuilding them with
custom PHP code.

``` {.php}
<?php

    $unique = array();
    foreach ($array as $b) {
        if (!in_array($b, $unique)) {
            /*  May be more code */
            $unique[] = $b;
        }
    }
?>
```

See also [array\_unique](https://www.php.net/array_unique).

### Suggestions

-   Turn the foreach() and its condition into a call to array\_unique()
-   Extract the condition from the foreach() and add a separate call to
    array\_unique()

  ---------- -------------------------------------------------------------
  Short name Structures/CouldUseArrayUnique

  Rulesets   `Suggestions`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `dolibarr-structures-couldusearrayunique`{.interpreted-text
             role="ref"},
             `openemr-structures-couldusearrayunique`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Could Use self
--------------

`self` keyword refers to the current class, or any of its parents. Using
it is just as fast as the full class name, it is as readable and it is
will not be changed upon class or namespace change.

It is also routinely used in traits : there, `self` represents the class
in which the trait is used, or the trait itself.

``` {.php}
<?php

class x {
    const FOO = 1;

    public function bar() {
        return self::FOO;
// same as return x::FOO;
    }
}

?>
```

See also [Scope Resolution Operator
(::)](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php).

### Suggestions

-   replace the explicit name with self

  ---------- ------------------------------------------------------------
  Short name Classes/ShouldUseSelf

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Suggestions`{.interpreted-text role="ref"},
             `ClassReview`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `wordpress-classes-shoulduseself`{.interpreted-text
             role="ref"},
             `livezilla-classes-shoulduseself`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Could Use str\_repeat() {#could-use-str\\_repeat()}
-----------------------

Use [str\_repeat()](https://www.php.net/str_repeat) or
[str\_pad()](https://www.php.net/str_pad) instead of making a loop.

Making a loop to repeat the same concatenation is actually much longer
than using [str\_repeat()](https://www.php.net/str_repeat). As soon as
the loop repeats more than twice,
[str\_repeat()](https://www.php.net/str_repeat) is much faster. With
arrays of 30, the difference is significant, though the whole operation
is short by itself.

``` {.php}
<?php

// This adds 7 'e' to $x
$x .= str_repeat('e', 7);

// This is the same as above, 
for($a = 3; $a < 10; ++$a) {
    $x .= 'e';
}

// here, $default must contains 7 elements to be equivalent to the previous code
foreach($default as $c) {
    $x .= 'e';
}

?>
```

### Suggestions

-   Use strrepeat() whenever possible

  ------------- ----------------------------------------------------------
  Short name    Structures/CouldUseStrrepeat

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `Top10`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Precision     Very high

  Examples      `zencart-structures-couldusestrrepeat`{.interpreted-text
                role="ref"}
  ------------- ----------------------------------------------------------

Crc32() Might Be Negative {#crc32()-might-be-negative}
-------------------------

[crc32()](https://www.php.net/crc32) may return a negative number, on 32
bits platforms.

According to the manual : Because PHP\'s integer type is signed many
`CRC32` checksums will result in negative integers on 32 bits platforms.
On 64 bits installations, all [crc32()](https://www.php.net/crc32)
results will be positive integers though.

``` {.php}
<?php

// display the checksum with %u, to make it unsigned
echo sprintf('%u', crc32($str));

// turn the checksum into an unsigned hexadecimal
echo dechex(crc32($str));

// avoid concatenating crc32 to a string, as it may be negative on 32bits platforms 
echo 'prefix'.crc32($str);

?>
```

See also [crc32()](https://www.php.net/crc32).

  ------------- -----------------------------
  Short name    Php/Crc32MightBeNegative

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- -----------------------------

Cyclic References
-----------------

Avoid cyclic references.

Cyclic references happen when an object points to another object, which
reciprocate. This is particularly possible with classes, when the child
class has to keep a reference to the
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
class.

``` {.php}
<?php

class a {
    private $p = null;

    function foo() {
        $this->p = new b();
        // the current class is stored in the child class
        $this->p->m($this);
    }
}

class b {
    private $pb = null;

    function n($a) {
        // the current class keeps a link to its parent
        $this->pb = $a;
    }
}
?>
```

Cyclic references, or circular references, are memory intensive : only
the garbage collector can understand when they may be flushed from
memory, which is a costly operation. On the other hand, in an acyclic
reference code, the reference counter will know immediately know that an
object is free or not.

See also [About circular references in
PHP](https://johann.pardanaud.com/blog/about-circular-references-in-php)
and [A Journey to find a memory
leak](https://jolicode.com/blog/a-journey-to-find-a-memory-leak/).

### Suggestions

-   Use a different object when calling the child objects.
-   Refactor your code to avoid the cyclic reference.

  ------------- ------------------------------------
  Short name    Classes/CyclicReferences

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------

Dangling Array References
-------------------------

Always unset a referenced-variable used in a loop.

It is highly recommended to unset blind variables when they are set up
as references after a loop.

``` {.php}
<?php

$array = array(1,2,3,4);

foreach($array as &$a) {
    $a += 1;
}
// This only unset the reference, not the value
unset($a);


// Dangling array problem
foreach($array as &$a) {
    $a += 1;
}
//$array === array(3,4,5,6);

// This does nothing (apparently)
// $a is already a reference, even if it doesn't show here.
foreach($array as $a) {}
//$array === array(3,4,5,5);

?>
```

When omitting this step, the next loop that will also require this
variable will deal with garbage values, and produce unexpected results.

See also : [No Dangling
Reference](https://github.com/dseguy/clearPHP/blob/master/rules/no-dangling-reference.md),
[PHP foreach pass-by-reference: Do it right, or better not at
all](https://coderwall.com/p/qx3fpa/php-foreach-pass-by-reference-do-it-right-or-better-not-at-all),
[How does PHP \'foreach\' actually
work?](https://stackoverflow.com/questions/10057671/how-does-php-foreach-actually-work/14854568#14854568),
[References and
foreach](https://schlueters.de/blog/archives/141-references-and-foreach.html).

### Suggestions

-   Avoid using the reference altogether : sometimes, the reference is
    not needed.
-   Add unset() right after the loop, to avoid reusing the reference.

  ---------- --------------------------------------------------------------------------------------------------------
  Short name Structures/DanglingArrayReferences

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `Top10`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [no-dangling-reference](https://github.com/dseguy/clearPHP/tree/master/rules/no-dangling-reference.md)

  Examples   `typo3-structures-danglingarrayreferences`{.interpreted-text role="ref"},
             `sugarcrm-structures-danglingarrayreferences`{.interpreted-text role="ref"}
  ---------- --------------------------------------------------------------------------------------------------------

Deep Definitions
----------------

Structures, such as functions, classes, interfaces, traits, etc. may be
defined anywhere in the code, including inside functions. This is legit
code for PHP.

Since the availability of autoload, with spl\_register\_autoload(),
there is no need for that kind of code. Structures should be defined,
and accessible to the autoloading. Inclusions and deep definitions
should be avoided, as they compel code to load some definitions, while
autoloading will only load them if needed.

``` {.php}
<?php

class X {
    function init() {
        // myFunction is defined when and only if X::init() is called.
        if (!function_exists('myFunction'){
            function myFunction($a) {
                return $a + 1;
            }
        })
    }
}

?>
```

Functions are excluded from autoload, but shall be gathered in
libraries, and not hidden inside other code.

Constants definitions are tolerated inside functions : they may be used
for avoiding repeat, or noting the usage of such function.

Definitions inside a if/then statement, that include PHP version check
are accepted here.

See also [Autoloading
Classes](https://www.php.net/manual/en/language.oop5.autoload.php).

### Suggestions

-   Move function definitions to the global space : outside structures,
    and method.

  ------------- -------------------------------------------------------
  Short name    Functions/DeepDefinitions

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)

  Examples      `dolphin-functions-deepdefinitions`{.interpreted-text
                role="ref"}
  ------------- -------------------------------------------------------

Define With Array
-----------------

PHP 7.0 has the ability to define an array as a constant, using the
[define()](https://www.php.net/define) native call. This was not
possible until that version, only with the const keyword.

``` {.php}
<?php

//Defining an array as a constant
define('MY_PRIMES', [2, 3, 5, 7, 11]);

?>
```

  ---------- --------------------------------------------------------------
  Short name Php/DefineWithArray

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and more recent
  Version    

  Severity   Critical

  Time To    Slow (1 hour)
  Fix        
  ---------- --------------------------------------------------------------

Dependant Abstract Classes
--------------------------

Abstract classes should be autonomous. It is recommended to avoid
depending on methods, constant or properties that should be made
available in inheriting classes, without explicitly abstracting them.

The following abstract classes make usage of constant, methods and
properties,
[static](https://www.php.net/manual/en/language.oop5.static.php) or not,
that are not defined in the class. This means the inheriting classes
must provide those constants, methods and properties, but there is no
way to enforce this.

This may also lead to dead code : when the abstract class is removed,
the host class have unused properties and methods.

``` {.php}
<?php

// autonomous abstract class : all it needs is within the class
abstract class c {
    private $p = 0;

    function foo() {
        return ++$this->p;
    }
}

// dependant abstract class : the inheriting classes needs to provide some properties or methods
abstract class c2 {
    function foo() {
        // $p must be provided by the extending class
        return ++$this->p;
    }
}

class c3 extends c2 {
    private $p = 0;
}
?>
```

See also `dependant-trait`{.interpreted-text role="ref"}.

### Suggestions

-   Make the class only use its own resources
-   Split the class in autonomous classes
-   Add local property definitions to make the class independent

  ------------- ------------------------------------
  Short name    Classes/DependantAbstractClass

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------

Dependant Trait
---------------

Traits should be autonomous. It is recommended to avoid depending on
methods or properties that should be in the using class.

The following traits make usage of methods and properties,
[static](https://www.php.net/manual/en/language.oop5.static.php) or not,
that are not defined in the trait. This means the host class must
provide those methods and properties, but there is no way to enforce
this.

This may also lead to dead code : when the trait is removed, the host
class have unused properties and methods.

``` {.php}
<?php

// autonomous trait : all it needs is within the trait
trait t {
    private $p = 0;

    function foo() {
        return ++$this->p;
    }
}

// dependant trait : the host class needs to provide some properties or methods
trait t2 {
    function foo() {
        return ++$this->p;
    }
}

class x {
    use t2;

    private $p = 0;
}
?>
```

See also `dependant-abstract-classes`{.interpreted-text role="ref"}.

### Suggestions

-   Add local property definitions to make the trait independent
-   Make the trait only use its own resources
-   Split the trait in autonomous traits

  ------------- ---------------------------------------------------
  Short name    Traits/DependantTrait

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Examples      `zencart-traits-dependanttrait`{.interpreted-text
                role="ref"}
  ------------- ---------------------------------------------------

Deprecated PHP Functions
------------------------

The following functions are deprecated. It is recommended to stop using
them now and replace them with a durable equivalent.

Note that these functions may be still usable : they generate warning
that help tracking their usage in the log. To eradicate their usage,
watch the logs, and update any deprecated warning. This way, the code
won\'t be stuck when the function is actually removed from PHP.

``` {.php}
<?php

// This is the current function
list($day, $month, $year) = explode('/', '08/06/1995');

// This is deprecated
list($day, $month, $year) = split('/', '08/06/1995');

?>
```

### Suggestions

-   Replace those deprecated with modern syntax
-   Stop using deprecated syntax

  ----------- ----------------------------------------------------------------------------------------
  Short name  Php/Deprecated

  Rulesets    `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity    Major

  Time To Fix Quick (30 mins)

  Precision   High

  ClearPHP    [no-deprecated](https://github.com/dseguy/clearPHP/tree/master/rules/no-deprecated.md)

  Examples    `dolphin-php-deprecated`{.interpreted-text role="ref"}
  ----------- ----------------------------------------------------------------------------------------

Dereferencing String And Arrays
-------------------------------

PHP allows the direct dereferencing of strings and arrays.

This was added in PHP 5.5. There is no need anymore for an intermediate
variable between a string and array (or any expression generating such
value) and accessing an index.

``` {.php}
<?php
$x = array(4,5,6); 
$y = $x[2] ; // is 6

May be replaced by 
$y = array(4,5,6)[2];
$y = [4,5,6][2];
?>
```

  ------------- ------------------------------------------------------
  Short name    Structures/DereferencingAS

  Rulesets      `CompatibilityPHP53`{.interpreted-text role="ref"},
                `CompatibilityPHP54`{.interpreted-text role="ref"}

  Php Version   With PHP 5.3 and older

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------------------------

Detect Current Class
--------------------

Detecting the current class should be done with
[self::class]{.title-ref} or [static::class]{.title-ref} operator.

[\_\_CLASS\_\_](https://www.php.net/manual/en/language.constants.predefined.php)
may be replaced by `self\:\:class`.
[get\_called\_class()](https://www.php.net/get_called_class) may be
replaced by `static\:\:class`.

[\_\_CLASS\_\_](https://www.php.net/manual/en/language.constants.predefined.php)
and [get\_called\_class()](https://www.php.net/get_called_class) are set
to be deprecated in PHP 7.4.

``` {.php}
<?php

class X {
    function foo() {
        echo __CLASS__.\n;          // X
        echo self::class.\n;        // X

        echo get_called_class().\n;  // Y
        echo static::class.\n;       // Y
    }
}

class Y extends X {}

$y = new Y();
$y->foo();

?>
```

See also [PHP RFC: Deprecations for PHP
7.4](https://wiki.php.net/rfc/deprecations_php_7_4).

### Suggestions

-   Use the self::class operator to detect the current class name,
    instead of \_\_[CLASS](DIR__%20Then%20Slash) and get\_class().
-   Use the static::class operator to detect the current called class
    name, instead of get\_called\_class().

  ------------- -----------------------------------------------
  Short name    Php/DetectCurrentClass

  Rulesets      `Suggestions`{.interpreted-text role="ref"},
                `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Php Version   With PHP 8.0 and older

  Precision     Very high
  ------------- -----------------------------------------------

Different Argument Counts
-------------------------

Two methods with the same name shall have the same number of compulsory
argument. PHP accepts different number of arguments between two methods,
if the extra arguments have default values. Basically, they shall be
called interchangeably with the same number of arguments.

The number of compulsory arguments is often mistaken for the same number
of arguments. When this is the case, it leads to confusion between the
two signatures. It will also create more difficulties when refactoring
the signature.

While this code is legit, it is recommended to check if the two
signatures could be synchronized, and reduce future surprises.

``` {.php}
<?php

class x {
    function foo($a ) {}
}

class y extends x {
    // This method is compatible with the above, its signature is different
    function foo($a, $b = 1) {}
}

?>
```

### Suggestions

-   Extract the extra arguments into other methods
-   Remove the extra arguments
-   Add the extra arguments to all the signatures

  ------------- ------------------------------------
  Short name    Classes/DifferentArgumentCounts

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------

Direct Call To \_\_clone() {#direct-call-to-\\_\\_clone()}
--------------------------

Direct call to magic method
[\_\_clone()](https://www.php.net/manual/en/language.oop5.magic.php) was
forbidden. It is allowed since PHP 7.0.

From the RFC :
`` Doing calls like $obj->`__clone( <https://www.php.net/manual/en/language.oop5.magic.php>`_ ) is now allowed. This was the only magic method that had a compile-time check preventing some calls to it, which doesn't make sense. If we allow all other magic methods to be called, there's no reason to forbid this one ``.

``` {.php}
<?php

    class Foo {
        function __clone() {}
    }

    $a = new Foo;
    $a->__clone();
?>
```

See also [Directly calling ](debugInfo()%20Usage)clone
\<<https://www.php.net/manual/en/language.oop5.magic.php>\>[\_ is
allowed](https://wiki.php.net/rfc/abstract_syntax_tree#directly_calling_clone_is_allowed).

### Suggestions

-   Use the clone operator to call the \_\_clone magic method

  ---------- --------------------------------------------------------------
  Short name Php/DirectCallToClone

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and more recent
  Version    

  Severity   Critical

  Time To    Slow (1 hour)
  Fix        
  ---------- --------------------------------------------------------------

Direct Injection
----------------

The following code act directly upon PHP incoming variables like `$_GET`
and `$_POST`. This makes those snippets very unsafe.

``` {.php}
<?php

// Direct injection
echo Hello.$_GET['user']., welcome.;

// less direct injection
foo($_GET['user']);
function foo($user) {
    echo Hello.$user., welcome.;
}

?>
```

See also [Cross-Site Scripting
(XSS)](https://phpsecurity.readthedocs.io/en/latest/Cross-Site-Scripting-(XSS).html)

### Suggestions

-   Validate input : make sure the incoming data are what you expect
    from them.
-   Escape output : prepare outgoing data for the next system to use.

  ------------- ------------------------------
  Short name    Security/DirectInjection

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

Directly Use File
-----------------

Some PHP functions have a close cousin that work directly on files : use
them. This is faster and less code to write.

-   [md5()](https://www.php.net/md5) =\>
    [md5\_file()](https://www.php.net/md5_file)
-   [highlight\_string()](https://www.php.net/highlight_string) =\>
    [highlight\_file()](https://www.php.net/highlight_file),
    [show\_source()](https://www.php.net/show_source)
-   [parsekit\_compile\_string()](https://www.php.net/parsekit_compile_string)
    =\>
    [parsekit\_compile\_file()](https://www.php.net/parsekit_compile_file)
-   [parse\_ini\_string()](https://www.php.net/parse_ini_string) =\>
    [parse\_ini\_file()](https://www.php.net/parse_ini_file)
-   [sha1()](https://www.php.net/sha1) =\>
    [sha1\_file()](https://www.php.net/sha1_file)
-   [simplexml\_load\_string()](https://www.php.net/simplexml_load_string)
    =\>
    [simplexml\_load\_file()](https://www.php.net/simplexml_load_file)
-   [yaml\_parse()](https://www.php.net/yaml_parse) =\>
    [yaml\_parse\_file()](https://www.php.net/yaml_parse_file)
-   [hash()](https://www.php.net/hash) =\>
    [hash\_file()](https://www.php.net/hash_file)
-   [hash\_hmac()](https://www.php.net/hash_hmac) =\> hash\_mac\_file()
-   [hash\_update()](https://www.php.net/hash_update) =\>
    [hash\_update\_file()](https://www.php.net/hash_update_file)
-   [recode()](https://www.php.net/recode) =\>
    [recode\_file()](https://www.php.net/recode_file)
-   [recode\_string()](https://www.php.net/recode_string) =\>
    [recode\_file()](https://www.php.net/recode_file)

``` {.php}
<?php

// Good way
$file_hash = hash_file('sha512', 'example.txt');

// Slow way
$file_hash = hash('sha512', file_get_contents('example.txt'));

?>
```

See also
[hash\_file](https://www.php.net/manual/en/function.hash-file.php).

### Suggestions

-   Use the \_file() version of those functions

  ------------- ---------------------------------
  Short name    Structures/DirectlyUseFile

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ---------------------------------

Disconnected Classes
--------------------

One class is extending the other, but they do not use any features from
one another. Basically, those two classes are using extends, but they
are completely independent and may be separated.

When using the \'extends\' keyword, the newly created classes are now
acting together and making one. This should be visible in calls from one
class to the other, or simply by property usage : they can\'t live
without each other.

On the other hand, two completely independent classes that are merged,
although they should be kept separated.

``` {.php}
<?php

class A {
    private $pa = 1;

    function fooA() {
        $this->pa = 2;
    }
}

// class B and Class A are totally independent
class B extends A {
    private $pb = 1;

    function fooB() {
        $this->pb = 2;
    }
}


// class C makes use of class A : it is dependent on the parent class
class C extends A {
    private $pc = 1;

    function fooB() {
        $this->pc = 2 + $this->fooA();
    }
}
?>
```

### Suggestions

-   Remove the extension
-   Make actual usage of the classes, at least from one of them

  ------------- -----------------------------------------------------------
  Short name    Classes/DisconnectedClasses

  Rulesets      `ClassReview`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Examples      `wordpress-classes-disconnectedclasses`{.interpreted-text
                role="ref"}
  ------------- -----------------------------------------------------------

Do In Base
----------

Use SQL expression to compute aggregates.

``` {.php}
<?php

// Efficient way
$res = $db->query('SELECT sum(e) AS sumE FROM table WHERE condition');

// The sum is already done
$row = $res->fetchArray();
$c += $row['sumE'];

// Slow way
$res = $db->query('SELECT e FROM table WHERE condition');

// This aggregates the column e in a slow way
while($row = $res->fetchArray()) { 
    $c += $row['e'];
}

?>
```

### Suggestions

-   Rework the query to move the calculations in the database

  ------------- ----------------------------------
  Short name    Performances/DoInBase

  Rulesets      `Performances`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Don\'t Be Too Manual {#don't-be-too-manual}
--------------------

Adapt the examples from the PHP manual to your code. Don\'t reuse
directly the same names in your code : be more specific about what to
expect in those variables.

``` {.php}
<?php

// Search for phone numbers in a text
preg_match_all('/((\d{3})-(\d{3})-(\d{4}))/', $string, $phoneNumber);

// Search for phone numbers in a text
preg_match_all('/(\d{3})-(\d{3})-(\d{4})/', $string, $matches);

?>
```

### Suggestions

-   Use precise name with your variables

  ------------- -------------------------------------------------------------
  Short name    Structures/DontBeTooManual

  Rulesets      `Coding Conventions <coding-conventions>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------------------------------------

Don\'t Change Incomings {#don't-change-incomings}
-----------------------

PHP hands over a lot of information using special variables like
[\$\_GET](https://www.php.net/manual/en/reserved.variables.get.php),
[\$\_POST](https://www.php.net/manual/en/reserved.variables.post.php),
etc\... Modifying those variables and those values inside variables
means that the original content is lost, while it will still look like
raw data, and, as such, will be untrustworthy.

``` {.php}
<?php

// filtering and keeping the incoming value. 
$_DATA'id'] = (int) $_GET['id'];

// filtering and changing the incoming value. 
$_GET['id'] = strtolower($_GET['id']);

?>
```

It is recommended to put the modified values in another variable, and
keep the original one intact.

  ------------- --------------------------------------
  Short name    Structures/NoChangeIncomingVariables

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- --------------------------------------

Don\'t Echo Error {#don't-echo-error}
-----------------

It is recommended to avoid displaying error messages directly to the
browser.

PHP\'s uses the `display_errors` directive to control display of errors
to the browser. This must be kept to `off` when in production.

``` {.php}
<?php

// Inside a 'or' test
mysql_connect('localhost', $user, $pass) or die(mysql_error());

// Inside a if test
$result = pg_query( $db, $query );
if( !$result )
{
 echo Erreur SQL: . pg_error();
 exit;
}

// Changing PHP configuration
ini_set('display_errors', 1);
// This is also a security error : 'false' means actually true.
ini_set('display_errors', 'false');

?>
```

Error messages should be logged, but not displayed.

See also [Error
reporting](https://php.earth/docs/security/intro#error-reporting) and
[List of php.ini
directives](https://www.php.net/manual/en/ini.list.php).

### Suggestions

-   Remove any echo, print, printf() call built with error messages from
    an exception, or external source.

  ---------- -------------------------------------------------------------
  Short name Security/DontEchoError

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Security`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Critical

  Time To    Instant (5 mins)
  Fix        

  Examples   `churchcrm-security-dontechoerror`{.interpreted-text
             role="ref"},
             `phpdocumentor-security-dontechoerror`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Don\'t Loop On Yield {#don't-loop-on-yield}
--------------------

Use `yield from`, instead of looping on a generator with `yield`.

`yield from` delegate the yielding to another generator, and keep
calling that generator until it is finished. It also works with implicit
generator datastructure, like arrays.

``` {.php}
<?php

function generator() {
    for($i = 0; $i < 10; ++$i) {
        yield $i;
    }
}

function delegatingGenerator() {
    yield from generator();
}

// Too much code here
function generator2() {
    foreach(generator() as $g) {
        yield $g;
    }
}

?>
```

There is a performance gain when delegating, over looping manually on
the generator. You may even consider writing the loop to store all
values in an array, then `yield from` the array.

See also [Generator delegation via yield
from](https://www.php.net/manual/en/language.generators.syntax.php#control-structures.yield.from).

### Suggestions

-   Use [yield from]{.title-ref} instead of the whole foreach() loop

  ---------- -------------------------------------------------------------
  Short name Structures/DontLoopOnYield

  Rulesets   `Suggestions`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `dolibarr-structures-dontlooponyield`{.interpreted-text
             role="ref"},
             `tikiwiki-structures-dontlooponyield`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Don\'t Pollute Global Space {#don't-pollute-global-space}
---------------------------

Avoid creating definitions in the global name space.

The global namespace is the default namespace, where all functions,
classes, constants, traits and interfaces live. The [global
namespace](https://www.php.net/manual/en/language.namespaces.global.php)
is also known as the root namespace.

In particular, PHP native classes usually live in that namespace. By
creating functions in that namespace, the code may encounter naming
conflict, when the PHP group decides to use a name that the code also
uses. This already happened in PHP version 5.1.1, where a `Date` native
class was introduced, and had to be [disabled in the following minor
version](https://www.php.net/ChangeLog-5.php#5.1.1).

Nowadays, conflicts appear between components, which claim the same
name.

See also [Using namespaces: fallback to global
function/constant](https://www.php.net/manual/en/language.namespaces.fallback.php).

### Suggestions

-   Create a namespace for your code, and store your definition there.

  ------------- -----------------------------
  Short name    Php/DontPolluteGlobalSpace

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Don\'t Read And Write In One Expression {#don't-read-and-write-in-one-expression}
---------------------------------------

Avoid giving value and using it at the same time, in one expression.
This is an undefined behavior of PHP, and may change without warning.

One of those changes happens between PHP 7.2 and 7.3 :

``` {.php}
<?php

$arr = [1];
$ref =& $arr[0];
var_dump($arr[0] + ($arr[0] = 2));
// PHP 7.2: int(4)
// PHP 7.3: int(3)

?>
```

See also [UPGRADING
7.3](https://github.com/php/php-src/blob/PHP-7.3/UPGRADING#L83-L95).

### Suggestions

-   Split the expression in two separate expressions

  ----------- -----------------------------------------------------------
  Short name  Structures/DontReadAndWriteInOneExpression

  Rulesets    `Analyze`{.interpreted-text role="ref"},
              `CompatibilityPHP73`{.interpreted-text role="ref"},
              `CompatibilityPHP74`{.interpreted-text role="ref"}

  Severity    Critical

  Time To Fix Quick (30 mins)
  ----------- -----------------------------------------------------------

Don\'t Send \$this In Constructor {#don't-send-$this-in-constructor}
---------------------------------

Don\'t use `$this` as an argument while in the
[\_\_construct()](https://www.php.net/manual/en/language.oop5.decon.php).
Until the constructor is finished, the object is not finished, and may
be in an unstable state. Providing it to another code may lead to error.

This is true when the receiving structure puts the incoming object
immediately to work, and don\'t store it for later use.

``` {.php}
<?php

// $this is only provided when Foo is constructed
class Foo {
    private $bar = null;
    private $data = array();

    static public function build($data) {
        $foo = new Foo($data);
        // Can't build in one call. Must make it separate.
        $foo->finalize();
    }

    private function __construct($data) {
        // $this is provided too early
        $this->data = $data;
    }

    function finalize() {
        $this->bar = new Bar($this);
    }
}

// $this is provided too early, leading to error in Bar
class Foo2 extends Foo {
    private $bar = null;
    private $data = array();

    function __construct($data) {
        // $this is provided too early
        $this->bar = new Bar($this);
        $this->data = $data;
    }
}

class Bar {
    function __construct(Foo $foo) {
        // the cache is now initialized with a wrong 
        $this->cache = $foo->getIt();
    }
}

?>
```

See also [Don\'t pass this out of a
constructor](http://www.javapractices.com/topic/TopicAction.do?Id=252).

### Suggestions

-   Finish the constructor first, then call an external object.
-   Sending \$this should be made accessible in a separate method, so
    external objects may call it.
-   Sending the current may be the responsibility of the method creating
    the object.

  ---------- -------------------------------------------------------------------
  Short name Classes/DontSendThisInConstructor

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  Examples   `woocommerce-classes-dontsendthisinconstructor`{.interpreted-text
             role="ref"},
             `contao-classes-dontsendthisinconstructor`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------------

Don\'t Unset Properties {#don't-unset-properties}
-----------------------

Avoid unsetting properties. They would go undefined, and raise more
warnings.

When getting rid of a property, assign it to null. This keeps the
property in the object, yet allows existence check without errors.

``` {.php}
<?php

class Foo {
    public $a = 1;
}

$a = new Foo();

var_dump((array) $a) ;
// la propriété est reportée, et null
// ['a' => null]

unset($a->a);

var_dump((array) $a) ;
//Empty []

// Check if a property exists
var_dump($a->b === null);

// Same result as above, but with a warning
var_dump($a->c === null);

?>
```

This analysis works on properties and
[static](https://www.php.net/manual/en/language.oop5.static.php)
properties. It also reports magic properties being unset.

Thanks for [Benoit Burnichon](https://twitter.com/BenoitBurnichon) for
the original idea.

### Suggestions

-   Never unset properties : set it to null or its default value instead
-   Make the property an array, and set/unset its index

  ---------- -------------------------------------------------------------
  Short name Classes/DontUnsetProperties

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Top10`{.interpreted-text role="ref"},
             `php-cs-fixable`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Slow (1 hour)
  Fix        

  Examples   `vanilla-classes-dontunsetproperties`{.interpreted-text
             role="ref"},
             `typo3-classes-dontunsetproperties`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Dont Change The Blind Var
-------------------------

When using a
[foreach()](https://www.php.net/manual/en/control-structures.foreach.php),
the blind variables hold a copy of the original value. It is confusing
to modify them, as it seems that the original value may be changed.

When actually changing the original value, use the reference in the
foreach definition to make it obvious, and save the final reassignation.

When the value has to be prepared before usage, then save the filtered
value in a separate variable. This makes the clean value obvious, and
preserve the original value for a future usage.

``` {.php}
<?php

// $bar is duplicated and kept 
$foo = [1, 2, 3];
foreach($foo as $bar) {
    // $bar is updated but its original value is kept
    $nextBar = $bar + 1;
    print $bar . ' => ' . ($nextBar) . PHP_EOL;
    foobar($nextBar);
}

// $bar is updated and lost
$foo = [1, 2, 3];
foreach($foo as $bar) {
    // $bar is updated but its final value is lost
    print $bar . ' => ' . (++$bar) . PHP_EOL;
    // Now that $bar is reused, it is easy to confuse its value
    foobar($bar);
}

// $bar is updated and kept
$foo = [1, 2, 3];
foreach($foo as &$bar) {
    // $bar is updated and keept
    print $bar . ' => ' . (++$bar) . PHP_EOL;
    foobar($bar);
}

?>
```

  ------------- -------------------------------
  Short name    Structures/DontChangeBlindKey

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------

Dont Collect Void
-----------------

When a method returns void, there is no need to collect the result. The
collected value will actually be `null`.

``` {.php}
<?php

function foo() : void {
    // doSomething()
}

// This is useless
$result = foo(); 

// This is useless. It looks like this is a left over from code refactoring
echo foo(); 

?>
```

### Suggestions

-   Move the call to the function to its own expression with a
    semi-colon.
-   Remove assignation of the result of such calls.

  ------------- -----------------------------
  Short name    Functions/DontUseVoid

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     Very high
  ------------- -----------------------------

Dont Compare Typed Boolean
--------------------------

There is no need to compare explicitly a function call to a boolean,
when the definition has a boolean return typehint.

The analysis checks for equality and identity comparisons. It doesn\'t
check for the not operator usage.

``` {.php}
<?php

// Sufficient check
if (foo()) {
    doSomething();
}

// Superfluous check
if (foo() === true) {
    doSomething();
}

function foo() : bool {}

?>
```

### Suggestions

-   Simplify the code and make it short

  ------------- ------------------------------------
  Short name    Structures/DontCompareTypedBoolean

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------

Dont Mix ++ {#dont-mix-++}
-----------

++ operators, pre and post, have two distinct behaviors, and should be
used separately.

When mixed in a larger expression, they are difficult to read, and may
lead to unwanted behaviors.

``` {.php}
<?php

    // Clear and defined behavior
    $i++;
    $a[$i] = $i;

    // The index is also incremented, as it is used AFTP the incrementation
    // With $i = 2; $a is array(3 => 3)
    $a[$i] = ++$i;

    // $i is actually modified twice 
    $i = --$i + 1; 
?>
```

See also [EXP30-C. Do not depend on the order of evaluation for side
effects](https://wiki.sei.cmu.edu/confluence/display/c/EXP30-C.+Do+not+depend+on+the+order+of+evaluation+for+side+effects).

### Suggestions

-   Extract the increment from the expression, and put it on a separate
    line.

  ----------- ------------------------------------------------------------
  Short name  Structures/DontMixPlusPlus

  Rulesets    `Analyze`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Instant (5 mins)

  Precision   High

  Examples    `contao-structures-dontmixplusplus`{.interpreted-text
              role="ref"},
              `typo3-structures-dontmixplusplus`{.interpreted-text
              role="ref"}
  ----------- ------------------------------------------------------------

Double Assignation
------------------

This happens when a container (variable, property, array index) is
assigned with values twice in a row. One of them is probably a debug
instruction, that was forgotten.

``` {.php}
<?php

// Normal assignation
$a = 1;

// Double assignation
$b = 2;
$b = 3;

?>
```

  ------------- ------------------------------
  Short name    Structures/DoubleAssignation

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

Double Instructions
-------------------

Twice the same call in a row. This is worth a check.

``` {.php}
<?php

// repetition of the same command, with the same effect each time. 
$a = array_merge($b, $c);
$a = array_merge($b, $c);

// false positive : commands are identical, but the effect is compounded 
$a = array_merge($a, $c);
$a = array_merge($a, $c);

?>
```

### Suggestions

-   Remove double work
-   Avoid repetition by using loops, variadic or quantifiers
    [(dirname(\$path, 2))]{.title-ref}

  ------------- ------------------------------
  Short name    Structures/DoubleInstruction

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ------------------------------

Double Object Assignation
-------------------------

Make sure that assigning the same object to two variables is the
intended purpose.

``` {.php}
<?php

// $x and $y are the same object, as they both hold a reference to the same object.
// This means that changing $x, will also change $y.
$x = $y = new Z();

// $a and $b are distinct values, by default
$a = $b = 1;

?>
```

### Suggestions

-   

  ------------- ------------------------------------
  Short name    Structures/DoubleObjectAssignation

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------

Double array\_flip() {#double-array\\_flip()}
--------------------

Avoid double [array\_flip()](https://www.php.net/array_flip) to gain
speed. While [array\_flip()](https://www.php.net/array_flip) alone is
usually useful, a double call to
[array\_flip()](https://www.php.net/array_flip) is made to make values
and keys unique.

``` {.php}
<?php

// without array_flip
function foo($array, $value) {
    $key = array_search($array, $value);

    if ($key !== false) {
        unset($array[$key]);
    }

    return $array;
}

// double array_flip
// array_flip() usage means that $array's values are all unique
function foo($array, $value) {
    $flipped = array_flip($value);
    unset($flipped[$value]);
    return array_flip($flipped);
}

?>
```

### Suggestions

-   use array\_unique() or array\_count\_values
-   use array\_flip() once, and let PHP garbage collect it later
-   Keep the original values in a separate variable

  ------------- ------------------------------------------------------------
  Short name    Performances/DoubleArrayFlip

  Rulesets      `Performances`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Examples      `nextcloud-performances-doublearrayflip`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------------

Drop Else After Return
----------------------

Avoid else clause when the then clause returns, but not the else. And
vice-versa.

This way, the else block disappears, and is now the main sequence of the
function.

This is also true if else has a return, and then not. When doing so,
don\'t forget to reverse the condition.

``` {.php}
<?php

// drop the else
if ($a) {
    return $a;
} else {
    doSomething();
}

// drop the then
if ($b) {
    doSomething();
} else {
    return $a;
}

// return in else and then
if ($a3) {
    return $a;
} else {
    $b = doSomething();
    return $b;
}

?>
```

### Suggestions

-   Remove the else clause and move its code to the main part of the
    method

  ------------- ------------------------------------------------------
  Short name    Structures/DropElseAfterReturn

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `Suggestions`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------------------------

Drop Substr Last Arg
--------------------

[Substr()](https://www.php.net/substr) works till the end of the string
when the last argument is omitted. There is no need to calculate string
size to make this work.

``` {.php}
<?php

$string = 'abcdef';

// Extract the end of the string
$cde = substr($string, 2);

// Too much work
$cde = substr($string, 2, strlen($string));

?>
```

See also [substr](http://www.php.net/substr).

### Suggestions

-   Use negative length
-   Omit the last argument to get the string till its end

  ---------- ------------------------------------------------------------
  Short name Structures/SubstrLastArg

  Rulesets   `Suggestions`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `suitecrm-structures-substrlastarg`{.interpreted-text
             role="ref"},
             `tine20-structures-substrlastarg`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Duplicate Literal
-----------------

Report literals that are repeated across the code. The minimum
replication is 5, and is configurable with `maxDuplicate`.

Repeated literals should be considered a prime candidate for constants.

Integer, reals and strings are considered here. Boolean, Null and Arrays
are omitted. 0, 1, 2, 10 and the empty string are all omitted, as too
common.

``` {.php}
<?php
    // array index are omitted
    $x[3] = 'b';

    // constanst are omitted
    const X = 11;
    define('Y', 'string')

    // 0, 1, 2, 10 are omitted
    $x = 0; 

?>
```

### Suggestions

-   Create a constant and use it in place of the literal
-   Create a class constant and use it in place of the literal

  -------------- --------- --------- ---------------------------------------------
  Name           Default   Type      Description

  minDuplicate   15        integer   Minimal number of duplication before the
                                     literal is reported.
  -------------- --------- --------- ---------------------------------------------

  ------------- -------------------------------
  Short name    Type/DuplicateLiteral

  Rulesets      `Semantics`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------

Dynamic Library Loading
-----------------------

Loading a variable dynamically requires a lot of care in the preparation
of the library name.

In case of injection in the variable, the dynamic loading of a library
gives a lot of power to an intruder.

``` {.php}
<?php

    // dynamically loading a library
 dl($library. PHP_SHLIB_SUFFIX);

    // dynamically loading ext/vips
 dl('vips.' . PHP_SHLIB_SUFFIX);

    // static loading ext/vips (unix only)
 dl('vips.so');

?>
```

See also [dl](http://www.php.net/dl).

### Suggestions

-   Use a switch structure, to make the dl() calls static.
-   Avoid using dl() and make the needed extension always available in
    PHP binary.

  ------------- ------------------------------
  Short name    Security/DynamicDl

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ------------------------------

Echo Or Print
-------------

Echo and print have the same functional use. \<?= and
[printf()](https://www.php.net/printf) are also considered in this
analysis.

There seems to be a choice that is not enforced : one form is dominant,
(\> 90%) while the others are rare.

The analyzed code has less than 10% of one of the three : for
consistency reasons, it is recommended to make them all the same.

It happens that print, echo or \<?= are used depending on coding style
and files. One file may be consistently using print, while the others
are all using echo.

``` {.php}
<?php

echo 'a';
echo 'b';
echo 'c';
echo 'd';
echo 'e';
echo 'f';
echo 'g';
echo 'h';
echo 'i';
echo 'j';
echo 'k';

// This should probably be written 'echo';
print 'l';

?>
```

  ------------- -------------------------------------------------------------
  Short name    Structures/EchoPrintConsistance

  Rulesets      `Coding Conventions <coding-conventions>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------------------------------------

Echo With Concat
----------------

Optimize your `echo`\'s by not concatenating at `echo` time, but serving
all argument separated. This will save PHP a memory copy.

If values, literals and variables, are small enough, this won\'t have
visible impact. Otherwise, this is less work and less memory waste.

``` {.php}
<?php
  echo $a, ' b ', $c;
?>
```

instead of

``` {.php}
<?php
  echo  $a . ' b ' . $c;
  echo $a b $c;
?>
```

### Suggestions

-   Turn the concatenation into a list of argument, by replacing the
    dots by commas.

  ---------- ------------------------------------------------------------------------------------------------------------------------------------
  Short name Structures/EchoWithConcat

  Rulesets   `Performances`{.interpreted-text role="ref"}, `Analyze`{.interpreted-text role="ref"}, `Suggestions`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-unnecessary-string-concatenation](https://github.com/dseguy/clearPHP/tree/master/rules/no-unnecessary-string-concatenation.md)

  Examples   `phpdocumentor-structures-echowithconcat`{.interpreted-text role="ref"}, `teampass-structures-echowithconcat`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------------------------------------------------------------------------------

Ellipsis Usage
--------------

Usage of the ellipsis keyword. The keyword is three dots :
[\...](https://www.php.net/manual/en/functions.arguments.php#functions.variable-arg-list)
. It is also named variadic or splat operator.

It may be in function definitions, either in functioncalls.

[\...](https://www.php.net/manual/en/functions.arguments.php#functions.variable-arg-list)
allows for packing or unpacking arguments into an array.

``` {.php}
<?php

$args = [1, 2, 3];
foo(...$args); 
// Identical to foo(1,2,3);

function bar(...$a) {
    // Identical to : $a = func_get_args();
}
?>
```

See also [PHP RFC: Syntax for variadic
functions](https://wiki.php.net/rfc/variadics), [PHP 5.6 and the Splat
Operator](https://lornajane.net/posts/2014/php-5-6-and-the-splat-operator),
and [Variable-length argument
lists](https://www.php.net/manual/en/functions.arguments.php#functions.variable-arg-list).

  ---------- ------------------------------------------------------------
  Short name Php/EllipsisUsage

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"}

  Php        With PHP 5.6 and more recent
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- ------------------------------------------------------------

Else If Versus Elseif
---------------------

Always use elseif instead of else and if.

\"The keyword elseif SHOULD be used instead of else if so that all
control keywords look like single words\". Quoted from the PHP-FIG
documentation

``` {.php}
<?php

// Using elseif 
if ($a == 1) { doSomething(); }
elseif ($a == 2) { doSomethingElseIf(); }
else { doSomethingElse(); }

// Using else if 
if ($a == 1) { doSomething(); }
else if ($a == 2) { doSomethingElseIf(); }
else { doSomethingElse(); }

// Using else if, no {}
if ($a == 1)  doSomething(); 
else if ($a == 2) doSomethingElseIf(); 
else  doSomethingElse(); 

?>
```

See also [elseif/else
if](https://www.php.net/manual/en/control-structures.elseif.php).

### Suggestions

-   Merge else and if into elseif
-   Turn the else expression into a block, and have more than the second
    if in this block
-   Turn the if / else if / else into a switch structure

  ---------- -------------------------------------------------------------
  Short name Structures/ElseIfElseif

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `php-cs-fixable`{.interpreted-text role="ref"},
             `Rector`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `teampass-structures-elseifelseif`{.interpreted-text
             role="ref"},
             `phpdocumentor-structures-elseifelseif`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Empty Blocks
------------

Full empty block, part of a control structures.

It is recommended to remove those blocks, so as to reduce confusion in
the code.

``` {.php}
<?php

foreach($foo as $bar) ; // This block seems erroneous
    $foobar++;

if ($a === $b) {
    doSomething();
} else {
    // Empty block. Remove this
}

// Blocks containing only empty expressions are also detected
for($i = 0; $i < 10; $i++) {
    ;
}

// Although namespaces are not control structures, they are reported here
namespace A;
namespace B;

?>
```

### Suggestions

-   Fill the block with a command
-   Fill the block with a comment that explain the situation
-   Remove the block and its commanding operator

  ---------- ------------------------------------------------------------
  Short name Structures/EmptyBlocks

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `cleverstyle-structures-emptyblocks`{.interpreted-text
             role="ref"},
             `phpipam-structures-emptyblocks`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Empty Classes
-------------

Classes that do no define anything at all. This is probably dead code.

Classes that are directly derived from an exception are omitted.

``` {.php}
<?php

//Empty class
class foo extends bar {}

//Not an empty class
class foo2 extends bar {
    const FOO = 2;
}

//Not an empty class, as derived from Exception
class barException extends \Exception {}

?>
```

### Suggestions

-   Remove an empty class :it is probably dead code.
-   Add some code to the class to make it concrete.

  ------------- --------------------------------------------------
  Short name    Classes/EmptyClass

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `wordpress-classes-emptyclass`{.interpreted-text
                role="ref"}
  ------------- --------------------------------------------------

Empty Function
--------------

Function or method whose body is empty.

Such functions or methods are rarely useful. As a bare minimum, the
function should return some useful value, even if constant.

A method is considered empty when it contains nothing, or contains
expressions without impact.

``` {.php}
<?php

// classic empty function
function emptyFunction() {}

class bar {
    // classic empty method
    function emptyMethod() {}

    // classic empty function
    function emptyMethodWithParent() {}
}

class barbar extends bar {
    // NOT an empty method : it overwrites the parent method
    function emptyMethodWithParent() {}
}

?>
```

Methods which overwrite another methods are omitted. Methods which are
the concrete version of an abstract method are considered.

### Suggestions

-   Fill the function with actual code
-   Remove any usage of the function, then remove the function

  ------------- ----------------------------------------------------
  Short name    Functions/EmptyFunction

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     High

  Examples      `contao-functions-emptyfunction`{.interpreted-text
                role="ref"}
  ------------- ----------------------------------------------------

Empty Instructions
------------------

Empty instructions are part of the code that have no instructions.

This may be trailing semi-colon or empty blocks for if-then structures.

Comments that explains the reason of the situation are not taken into
account.

``` {.php}
<?php
    $condition = 3;;;;
    if ($condition) { } 
?>
```

### Suggestions

-   Remove the empty lines
-   Fill the empty lines

  ----------- -----------------------------------------------------------
  Short name  Structures/EmptyLines

  Rulesets    `Dead code <dead-code>`{.interpreted-text role="ref"},
              `Analyze`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Instant (5 mins)

  Examples    `zurmo-structures-emptylines`{.interpreted-text
              role="ref"},
              `thinkphp-structures-emptylines`{.interpreted-text
              role="ref"}
  ----------- -----------------------------------------------------------

Empty Interfaces
----------------

Empty interfaces are a code smell. Interfaces should contains at least a
method or a constant, and not be totally empty.

``` {.php}
<?php

// an empty interface
interface empty {}

// an normal interface
interface normal {
    public function i() ;
}

// a constants interface
interface constantsOnly {
    const FOO = 1;
}

?>
```

See also [Empty interfaces are bad
practice](https://r.je/empty-interfaces-bad-practice.html) and [Blog :
Are empty interfaces code
smell?](https://hackernoon.com/are-interfaces-code-smell-bd19abc266d3).

### Suggestions

-   Remove the interface
-   Add some methods or constants to the interface

  ------------- -----------------------------
  Short name    Interfaces/EmptyInterface

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- -----------------------------

Empty List
----------

Empty [list()](https://www.php.net/list) are not allowed anymore in PHP
7. There must be at least one variable in the list call.

``` {.php}
<?php

//Not accepted since PHP 7.0
list() = array(1,2,3);

//Still valid PHP code
list(,$x) = array(1,2,3);

?>
```

### Suggestions

-   Remove empty list() calls

  ------------- -------------------------------------------
  Short name    Php/EmptyList

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CompatibilityPHP70`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.0 and older

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------------------

Empty Namespace
---------------

Declaring a namespace in the code and not using it for structure
declarations or global instructions is useless.

Using simple style :

``` {.php}
<?php

namespace Y;

class foo {}


namespace X;
// This is useless

?>
```

Using bracket-style syntax :

``` {.php}
<?php

namespace X {
    // This is useless
}

namespace Y {

    class foo {}

}

?>
```

### Suggestions

-   Remove the namespace

  ---------- --------------------------------------------------------------------------------------------------
  Short name Namespaces/EmptyNamespace

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `Dead code <dead-code>`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [no-empty-namespace](https://github.com/dseguy/clearPHP/tree/master/rules/no-empty-namespace.md)
  ---------- --------------------------------------------------------------------------------------------------

Empty Slots In Arrays
---------------------

PHP tolerates the last element of an array to be empty.

``` {.php}
<?php
    $a = array( 1, 2, 3, );
    $b =      [ 4, 5, ];
?>
```

  ------------- -------------------------------------------------------------
  Short name    Arrays/EmptySlots

  Rulesets      `Coding Conventions <coding-conventions>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- -------------------------------------------------------------

Empty Traits
------------

List of all empty trait defined in the code.

``` {.php}
<?php

// empty trait
trait t { }

// Another empty trait
trait t2 {
    use t; 
}

?>
```

Such traits may be reserved for future use. They may also be forgotten,
and dead code.

### Suggestions

-   Add some code to the trait
-   Remove the trait

  ------------- -----------------------------
  Short name    Traits/EmptyTrait

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- -----------------------------

Empty Try Catch
---------------

The code does try, then catch errors but do no act upon the error.

``` {.php}
<?php

try { 
    doSomething();
} catch (Throwable $e) {
    // ignore this
}

?>
```

At worst, the error should be logged, so as to measure the actual usage
of the catch expression.

`catch( Exception $e)` (PHP 5) or
`` catch(`Throwable <https://www.php.net/manual/en/class.throwable.php>`_ $e) ``
with empty catch block should be banned. They ignore any error and
proceed as if nothing happened. At worst, the event should be logged for
future analysis.

See also [Empty Catch Clause](http://wiki.c2.com/?EmptyCatchClause).

### Suggestions

-   Add some logging in the catch
-   Add a comment to mention why the catch is empty
-   Change the exception, chain it and throw again

  ---------- ------------------------------------------------------------
  Short name Structures/EmptyTryCatch

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `livezilla-structures-emptytrycatch`{.interpreted-text
             role="ref"},
             `mautic-structures-emptytrycatch`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Empty With Expression
---------------------

[empty()](https://www.php.net/empty) doesn\'t accept expressions until
PHP 5.5. Until then, it is necessary to store the result of the
expression in a variable and then, test it with
[empty()](https://www.php.net/empty).

``` {.php}
<?php

// PHP 5.5+ empty() usage
if (empty(strtolower($b . $c))) {
    doSomethingWithoutA();
}

// Compatible empty() usage
$a = strtolower($b . $c);
if (empty($a)) {
    doSomethingWithoutA();
}

?>
```

See also [empty](http://www.php.net/empty).

### Suggestions

-   Use the compatible syntax, and store the result in a local variable
    before testing it with empty

  ------------- -------------------------------------------------------------
  Short name    Structures/EmptyWithExpression

  Rulesets      `Suggestions`{.interpreted-text role="ref"}

  Php Version   With PHP 5.5 and more recent

  Severity      Major

  Time To Fix   Quick (30 mins)

  Examples      `humo-gen-structures-emptywithexpression`{.interpreted-text
                role="ref"}
  ------------- -------------------------------------------------------------

Encoded Simple Letters
----------------------

Some simple letters are written in escape sequence.

Usually, escape sequences are made to encode unusual characters. Using
escape sequences for simple characters, like letters or numbers is
suspicious.

This analysis also detects Unicode codepoint with superfluous leading
zeros.

``` {.php}
<?php

// This escape sequence makes eval hard to spot
$a = ev1l;
$a('php_info();');

// With a PHP 7.0 unicode code point sequence
$a = ev\u{000041}l;
$a('php_info();');

// With a PHP 5.0+ hexadecimal sequence
$a = ev\x41l;
$a('php_info();');

?>
```

### Suggestions

-   Make all simple letter appear clearly
-   Add comments about why this code is encoded

  ------------- ---------------------------------------------------
  Short name    Security/EncodedLetters

  Rulesets      `Security`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `zurmo-security-encodedletters`{.interpreted-text
                role="ref"}
  ------------- ---------------------------------------------------

Eval() Usage {#eval()-usage}
------------

Using [eval()](https://www.php.net/eval) is evil.

Using [eval()](https://www.php.net/eval) is bad for performances
(compilation time), for caches (it won\'t be compiled), and for security
(if it includes external data).

``` {.php}
<?php
    // Avoid using incoming data to build the eval() expression : any filtering error leads to PHP injection
    $mathExpression = $_GET['mathExpression']; 
    $mathExpression = preg_replace('#[^0-9+\-*/\(/)]#is', '', $mathExpression); // expecting 1+2
    $literalCode = '$a = '.$mathExpression.';';
    eval($literalCode);
    echo $a;

    // If the code code given to eval() is known at compile time, it is best to put it inline
    $literalCode = 'phpinfo();';
    eval($literalCode);

?>
```

Most of the time, it is possible to replace the code by some standard
PHP, like variable variable for accessing a variable for which you have
the name. At worse, including a pregenerated file is faster and
cacheable.

There are several situations where [eval()](https://www.php.net/eval) is
actually the only solution :

For PHP 7.0 and later, it is important to put
[eval()](https://www.php.net/eval) in a try..catch expression.

See also [eval](http://www.php.net/eval) and [The Land Where PHP Uses
\`eval() \<https://www.php.net/eval\>]{.title-ref}\_
\<<https://www.exakat.io/land-where-php-uses-eval/>\>\`\_.

### Suggestions

-   Use a dynamic feature of PHP to replace the dynamic code
-   Store the code on the disk, and use include
-   Replace create\_function() with a closure!

  ---------- ----------------------------------------------------------------------------
  Short name Structures/EvalUsage

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `Performances`{.interpreted-text
             role="ref"}, `Security`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-eval](https://github.com/dseguy/clearPHP/tree/master/rules/no-eval.md)

  Examples   `xoops-structures-evalusage`{.interpreted-text role="ref"},
             `mautic-structures-evalusage`{.interpreted-text role="ref"}
  ---------- ----------------------------------------------------------------------------

Exceeding Typehint
------------------

The typehint is not fully used in the method. Some of the defined
methods in the typehint are unused. A tighter typehint could be used, to
avoid method pollution.

``` {.php}
<?php

interface i {
    function i1();
    function i2();
}

interface j {
    function j1();
    function j2();
}

function foo(i $a, j $b) {
    // the i typehint is totally used
    $a->i1();
    $a->i2();

    // the i typehint is not totally used : j2() is not used.
    $b->j1();
}

?>
```

Tight typehint prevents the argument from doing too much. They also
require more maintenance : creation of dedicated interfaces, method
management to keep all typehint tight.

See also `insufficient-typehint`{.interpreted-text role="ref"}.

### Suggestions

-   Keep the typehint tight, do not inject more than needed.

  ------------- ---------------------------------
  Short name    Functions/ExceedingTypehint

  Rulesets      `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Exception Order
---------------

When catching exception, the most specialized exceptions must be in the
early catch, and the most general exceptions must be in the later catch.
Otherwise, the general catches intercept the exception, and the more
specialized will not be read.

``` {.php}
<?php

class A extends \Exception {}
class B extends A {}

try {
    throw new A();
} 
catch(A $a1) { }
catch(B $b2 ) { 
    // Never reached, as previous Catch is catching the early worm
}

?>
```

### Suggestions

-   Remove one of the catch clause

  ------------ ----------------------------------------------------------
  Short name   Exceptions/AlreadyCaught

  Rulesets     `Dead code <dead-code>`{.interpreted-text role="ref"}

  Precision    High

  Examples     `woocommerce-exceptions-alreadycaught`{.interpreted-text
               role="ref"}
  ------------ ----------------------------------------------------------

Exit() Usage {#exit()-usage}
------------

Using [exit](https://www.www.php.net/exit) or
[die()](https://www.php.net/%60die%20%3Chttps://www.php.net/die)\>[\_ in
the code makes the code untestable (it will \`break
\<https://www.php.net/manual/en/control-structures.break.php\>]{.title-ref}\_
unit tests). Moreover, if there is no reason or string to display, it
may take a long time to spot where the application is stuck.

``` {.php}
<?php

// Throw an exception, that may be caught somewhere
throw new \Exception('error');

// Dying with error message. 
die('error');

function foo() {
    //exiting the function but not dying
    if (somethingWrong()) {
        return true;
    }
}
?>
```

Try exiting the function/class with return, or throw exception that may
be caught later in the code.

### Suggestions

-   Avoid exit and die. Let the script finish.
-   Throw an exception and let it be handled before finishing

  ---------- ----------------------------------------------------------------------------
  Short name Structures/ExitUsage

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text
             role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-exit](https://github.com/dseguy/clearPHP/tree/master/rules/no-exit.md)

  Examples   `traq-structures-exitusage`{.interpreted-text role="ref"},
             `thinkphp-structures-exitusage`{.interpreted-text role="ref"}
  ---------- ----------------------------------------------------------------------------

Exponent Usage
--------------

Usage of the
[\*\*](https://www.php.net/manual/en/language.operators.arithmetic.php)
operator or \*\*=, to make exponents.

``` {.php}
<?php

$eight = 2 ** 3;

$sixteen = 4;
$sixteen \*\*\= 2;

?>
```

See also [Arithmetic
Operators](https://www.php.net/manual/en/language.operators.arithmetic.php).

### Suggestions

-   Use the operator when no literal negative number is in the
    expression

  ----------- ------------------------------------------------------------
  Short name  Php/ExponentUsage

  Rulesets    `CompatibilityPHP53`{.interpreted-text role="ref"},
              `CompatibilityPHP54`{.interpreted-text role="ref"},
              `CompatibilityPHP55`{.interpreted-text role="ref"}

  Php Version With PHP 5.6 and more recent

  Severity    Major

  Time To Fix Instant (5 mins)

  Precision   Very high
  ----------- ------------------------------------------------------------

Failed Substr Comparison
------------------------

The extracted string must be of the size of the compared string.

This is also true for negative lengths.

``` {.php}
<?php

// Possible comparison
if (substr($a, 0, 3) === 'abc') { }
if (substr($b, 4, 3) === 'abc') { }

// Always failing
if (substr($a, 0, 3) === 'ab') { }
if (substr($a, 3, -3) === 'ab') { }

// Omitted in this analysis
if (substr($a, 0, 3) !== 'ab') { }

?>
```

### Suggestions

-   Fix the string
-   Fix the length of the string
-   Put the string in a constant, and use strlen() or mb\_strlen()

  ---------- ------------------------------------------------------------------
  Short name Structures/FailingSubstrComparison

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `Top10`{.interpreted-text
             role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Instant (5 mins)
  Fix        

  Examples   `zurmo-structures-failingsubstrcomparison`{.interpreted-text
             role="ref"},
             `mediawiki-structures-failingsubstrcomparison`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------------

Fetch One Row Format
--------------------

When reading results with ext/Sqlite3, it is recommended to explicitly
request SQLITE3\_NUM or SQLITE3\_ASSOC, while avoiding the default value
and SQLITE3\_BOTH.

``` {.php}
<?php

$res = $database->query($query);

// Fastest version, but less readable
$row = $res->fetchArray(\SQLITE3_NUM);
// Almost the fastest version, and more readable
$row = $res->fetchArray(\SQLITE3_ASSOC);

// Default version. Quite slow
$row = $res->fetchArray();

// Worse case
$row = $res->fetchArray(\SQLITE3_BOTH);

?>
```

This is a micro-optimisation. The difference may be visible with 200k
rows fetches, and measurable with 10k.

### Suggestions

-   Specify the result format when reading rows from a Sqlite3 database

  ------------- ----------------------------------
  Short name    Performances/FetchOneRowFormat

  Rulesets      `Performances`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ----------------------------------

Filter To add\_slashes() {#filter-to-add\\_slashes()}
------------------------

`FILTER_SANITIZE_MAGIC_QUOTES` is deprecated. In PHP 7.4, it should be
replaced with [addslashes()](https://www.php.net/addslashes)

According to the migration RDFC : \'Magic quotes were deprecated all the
way back in PHP 5.3 and later removed in PHP 5.4. The filter extension
implements a sanitization filter that mimics this behavior of
magic\_quotes by calling [addslashes()](https://www.php.net/addslashes)
on the input in question.\'

``` {.php}
<?php

// Deprecated way to filter input
$var = filter_input($input, FILTER_SANITIZE_MAGIC_QUOTES);

// Alternative way to filter input
$var = addslashes($input);

?>
```

[addslashes()](https://www.php.net/addslashes) used to filter data while
building SQL queries, to prevent injections. Nowadays, prepared queries
are a better option.

See also [Deprecations for PHP
7.4](https://wiki.php.net/rfc/deprecations_php_7_4).

### Suggestions

-   Replace `FILTER_SANITIZE_MAGIC_QUOTES` with addslashes()
-   Replace `FILTER_SANITIZE_MAGIC_QUOTES` with an adapted escaping
    system

  ------------- ----------------------------------------
  Short name    Php/FilterToAddSlashes

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Final Class Usage
-----------------

List of all final classes being used.

final may be applied to classes and methods.

``` {.php}
<?php
class BaseClass {
   public function test() {
       echo 'BaseClass::test() called'.PHP_EOL;
   }

   final public function moreTesting() {
       echo 'BaseClass::moreTesting() called'.PHP_EOL;
   }
}

class ChildClass extends BaseClass {
   public function moreTesting() {
       echo 'ChildClass::moreTesting() called'.PHP_EOL;
   }
}
// Results in Fatal error: Cannot override final method BaseClass::moreTesting()
?>
```

See also [Final
Keyword](https://www.php.net/manual/en/language.oop5.final.php).

  ------------ --------------------------------------------
  Short name   Classes/Finalclass

  Rulesets     `ClassReview`{.interpreted-text role="ref"},
               `LintButWontExec`{.interpreted-text
               role="ref"}
  ------------ --------------------------------------------

Final Methods Usage
-------------------

List of all final methods being used.

final may be applied to classes and methods.

``` {.php}
<?php
class BaseClass {
   public function test() {
       echo 'BaseClass::test() called'.PHP_EOL;
   }

   final public function moreTesting() {
       echo 'BaseClass::moreTesting() called'.PHP_EOL;
   }
}

class ChildClass extends BaseClass {
   public function moreTesting() {
       echo 'ChildClass::moreTesting() called'.PHP_EOL;
   }
}
// Results in Fatal error: Cannot override final method BaseClass::moreTesting()
?>
```

See also [Final
Keyword](https://www.php.net/manual/en/language.oop5.final.php).

  ------------ --------------------------------------------
  Short name   Classes/Finalmethod

  Rulesets     `LintButWontExec`{.interpreted-text
               role="ref"}, `ClassReview`{.interpreted-text
               role="ref"}
  ------------ --------------------------------------------

Flexible Heredoc
----------------

Flexible syntax for Heredoc.

The new flexible syntax for heredoc and nowdoc enable the closing marker
to be indented, and remove the new line requirement after the closing
marker.

It was introduced in PHP 7.3.

``` {.php}
<?php

// PHP 7.3 and newer
foo($a = <<<END

    flexible syntax
    with extra indentation

    END);

// All PHP versions
$a = <<<END

    Normal syntax

END;


?>
```

This syntax is backward incompatible : once adopted in the code,
previous versions won\'t compile it.

See also
[Heredoc](https://www.php.net/manual/en/language.types.string.php#language.types.string.syntax.heredoc)
and [Flexible Heredoc and Nowdoc
Syntaxes](https://wiki.php.net/rfc/flexible_heredoc_nowdoc_syntaxes).

  ---------- ------------------------------------------------------------------
  Short name Php/FlexibleHeredoc

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.3 and more recent
  Version    

  Severity   Critical

  Time To    Instant (5 mins)
  Fix        
  ---------- ------------------------------------------------------------------

Fn Argument Variable Confusion
------------------------------

Avoid using local variables as arrow function arguments.

When a local variable name is used as an argument\'s name in an arrow
function, the local variable from the original scope is not imported.
They are now two distinct variables.

When the local variable is not listed as argument, it is then imported
in the arrow function.

``` {.php}
<?php

function foo() {
    $locale = 1;

    // Actually ignores the argument, and returns the local variable ``$locale``.
    $fn2 = fn ($argument) => $locale;

    // Seems similar to above, but returns the incoming argument    
    $fn2 = fn ($locale) => $locale;
}

?>
```

See also [Arrow
functions](https://www.php.net/manual/en/functions.arrow.php).

### Suggestions

-   Change the name of the local variable
-   Change the name of the argument

  ------------- ---------------------------------------
  Short name    Functions/FnArgumentVariableConfusion

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `Semantics`{.interpreted-text
                role="ref"}

  Php Version   7.4+

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- ---------------------------------------

For Using Functioncall
----------------------

It is recommended to avoid functioncall in the
[for()](https://www.php.net/manual/en/control-structures.for.php)
statement.

``` {.php}
<?php

// Fastest way
$nb = count($array); 
for($i = 0; $i < $nb; ++$i) {
    doSomething($i);
} 

// Same as above, but slow
for($i = 0; $i < count($array); ++$i) {
    doSomething($i);
} 

// Same as above, but slow
foreach($portions as &$portion) {
    // here, array_sum() doesn't depends on the $grade. It should be out of the loop
    $portion = $portion / array_sum($portions);
} 

$total = array_sum($portion);
foreach($portion as &$portion) {
    $portion = $portion / $total;
} 

?>
```

This is true with any kind of functioncall that returns the same value
throughout the loop.

### Suggestions

-   Call the function once, before the loop

  ----------- ------------------------------------------------------------------------------------------------------------
  Short name  Structures/ForWithFunctioncall

  Rulesets    `Performances`{.interpreted-text role="ref"}, `Top10`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Slow (1 hour)

  Precision   High

  ClearPHP    [no-functioncall-in-loop](https://github.com/dseguy/clearPHP/tree/master/rules/no-functioncall-in-loop.md)
  ----------- ------------------------------------------------------------------------------------------------------------

Foreach Don\'t Change Pointer {#foreach-don't-change-pointer}
-----------------------------

[foreach](https://www.php.net/manual/en/control-structures.foreach.php)
loops use their own internal cursor.

A foreach loop won\'t change the internal pointer of the array, as it
works on a copy of the source. Hence, applying array pointer\'s
functions such as [current()](https://www.php.net/current) or
[next()](https://www.php.net/next) to the source array won\'t have the
same behavior in PHP 5 than PHP 7.

This only applies when a
[foreach()](https://www.php.net/manual/en/control-structures.foreach.php)
by reference is used.

``` {.php}
<?php

$numbers = range(1, 10);
next($numbers);
foreach($numbers as &$number){
    print $number;
    print current($numbers).\n; // Always 
}

?>
```

See also [foreach no longer changes the internal array
pointer](https://www.php.net/manual/en/migration70.incompatible.php#migration70.incompatible.foreach.array-pointer)
and
[foreach](https://www.php.net/manual/en/control-structures.foreach.php).

### Suggestions

-   Do not change the pointer on the source array while in the loop

  ------------- ----------------------------------------
  Short name    Php/ForeachDontChangePointer

  Rulesets      `CompatibilityPHP70`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.0 and older

  Severity      Major

  Time To Fix   Slow (1 hour)

  Precision     High
  ------------- ----------------------------------------

Foreach On Object
-----------------

Foreach on object looks like a typo. This is particularly true when both
object and member are variables.

Foreach on an object member is a legit PHP syntax, though it is very
rare : blind variables rarely have to be securing in an object to be
processed.

``` {.php}
<?php

// Looks suspicious
foreach($array as $o -> $b) { 
    doSomething();
}

// This is the real thing
foreach($array as $o => $b) { 
    doSomething();
}

?>
```

  ------------- -----------------------------
  Short name    Php/ForeachObject

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)
  ------------- -----------------------------

Foreach Reference Is Not Modified
---------------------------------

Foreach statement may loop using a reference, especially when the loop
has to change values of the array it is looping on.

In the spotted loop, reference are used but never modified. They may be
removed.

``` {.php}
<?php

$letters = range('a', 'z');

// $letter is not used here
foreach($letters as &$letter) {
    $alphabet .= $letter;
}

// $letter is actually used here
foreach($letters as &$letter) {
    $letter = strtoupper($letter);
}

?>
```

### Suggestions

-   Remove the reference from the foreach
-   Actually modify the content of the reference

  ----------- -----------------------------------------------------------------------
  Short name  Structures/ForeachReferenceIsNotModified

  Rulesets    `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text
              role="ref"}

  Severity    Minor

  Time To Fix Quick (30 mins)

  Precision   High

  Examples    `dolibarr-structures-foreachreferenceisnotmodified`{.interpreted-text
              role="ref"},
              `vanilla-structures-foreachreferenceisnotmodified`{.interpreted-text
              role="ref"}
  ----------- -----------------------------------------------------------------------

Foreach With list() {#foreach-with-list()}
-------------------

Foreach loops have the ability to use [list()](https://www.php.net/list)
(or \[\]) as blind variables. This syntax assign directly array elements
to various variables.

PHP 5.5 introduced the usage of list in
[foreach()](https://www.php.net/manual/en/control-structures.foreach.php)
loops. Until PHP 7.1, it was not possible to use non-numerical arrays as
[list()](https://www.php.net/list) wouldn\'t support string-indexed
arrays.

``` {.php}
<?php
    // PHP 5.5 and later, with numerically-indexed arrays
    foreach($array as list($a, $b)) { 
        // do something 
    }


    // PHP 7.1 and later, with arrays
    foreach($array as list('col1' => $a, 'col3' => $b)) { // 'col2 is ignored'
        // do something 
    }
?>
```

Previously, it was compulsory to
[extract()](https://www.php.net/extract) the data from the blind array :

``` {.php}
<?php
    foreach($array as $c) { 
        list($a, $b) = $c;
        // do something 
    }
?>
```

See also [The list function & practical uses of array destructuring in
PHP](https://sebastiandedeyne.com/the-list-function-and-practical-uses-of-array-destructuring-in-php)
and [Array destructuring in
PHP](https://stitcher.io/blog/array-destructuring-with-list-in-php#in-loops).

  ------------- ------------------------------------------------------
  Short name    Structures/ForeachWithList

  Rulesets      `CompatibilityPHP53`{.interpreted-text role="ref"},
                `CompatibilityPHP54`{.interpreted-text role="ref"}

  Php Version   With PHP 5.5 and more recent

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Precision     Very high
  ------------- ------------------------------------------------------

Forgotten Interface
-------------------

The following classes have been found implementing an interface\'s
methods, though it doesn\'t explicitly implements this interface. This
may have been forgotten.

``` {.php}
<?php

interface i {
    function i(); 
}

// i is not implemented and declared
class foo {
    function i() {}
    function j() {}
}

// i is implemented and declared
class foo implements i {
    function i() {}
    function j() {}
}

?>
```

See also `could-use-trait`{.interpreted-text role="ref"}.

### Suggestions

-   Mention interfaces explicitly whenever possible

  ------------- ------------------------------
  Short name    Interfaces/CouldUseInterface

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

Forgotten Thrown
----------------

An exception is instantiated, but not thrown.

``` {.php}
<?php

class MyException extends \Exception { }

if ($error !== false) {
    // This looks like 'throw' was omitted
    new MyException();
}

?>
```

### Suggestions

-   Remove the throw expression
-   Add the new to the throw expression

  ------------- -----------------------------
  Short name    Exceptions/ForgottenThrown

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)
  ------------- -----------------------------

Forgotten Visibility
--------------------

Some classes elements (property, method, constant) are missing their
explicit visibility.

By default, it is public. It should at least be mentioned as public, or
may be reviewed as protected or private.

Class constants support also visibility since PHP 7.1.

final, [static](https://www.php.net/manual/en/language.oop5.static.php)
and abstract are not counted as visibility. Only public, private and
protected. The PHP 4 var keyword is counted as undefined.

Traits, classes and interfaces are checked.

``` {.php}
<?php

// Explicit visibility
class X {
    protected sconst NO_VISIBILITY_CONST = 1; // For PHP 7.2 and later

    private $noVisibilityProperty = 2; 

    public function Method() {}
}

// Missing visibility
class X {
    const NO_VISIBILITY_CONST = 1; // For PHP 7.2 and later

    var $noVisibilityProperty = 2; // Only with var

    function NoVisibilityForMethod() {}
}

?>
```

See also
[Visibility](https://www.php.net/manual/en/language.oop5.visibility.php)
and [Understanding The Concept Of Visibility In Object Oriented
PHP](https://torquemag.io/2016/05/understanding-concept-visibility-object-oriented-php/).

### Suggestions

-   Always add explicit visibility to methods and constants in a class
-   Always add explicit visibility to properties in a class, after PHP
    7.4

  ---------- ----------------------------------------------------------------------------------------------------------
  Short name Classes/NonPpp

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [always-have-visibility](https://github.com/dseguy/clearPHP/tree/master/rules/always-have-visibility.md)

  Examples   `fuelcms-classes-nonppp`{.interpreted-text role="ref"}, `livezilla-classes-nonppp`{.interpreted-text
             role="ref"}
  ---------- ----------------------------------------------------------------------------------------------------------

Forgotten Whitespace
--------------------

Forgotten whitespaces only bring misery to the code.

White spaces have been left at either end of a file : before the PHP
opening tag, or after the closing tag.

Usually, such whitespaces are forgotten, and may end up summoning the
infamous \'headers already sent\' error. It is better to remove them.

``` {.php}
<?php
    // This script has no forgotten whitespace, not at the beginning
    function foo() {}

    // This script has no forgotten whitespace, not at the end
?>
```

See also [How to fix Headers already sent error in
PHP](http://stackoverflow.com/questions/8028957/how-to-fix-headers-already-sent-error-in-php).

### Suggestions

-   Remove all whitespaces before and after a script. This doesn\'t
    apply to template, which may need to use those spaces.
-   Remove the final tag, to prevent any whitespace to be forgotten at
    the end of the file. This doesn\'t apply to the opening PHP tag,
    which is always necessary.

  ------------- ----------------------------------
  Short name    Structures/ForgottenWhiteSpace

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ----------------------------------

Fossilized Method
-----------------

A method is fossilized when it is overwritten so often that changing a
default value, a return type or an argument type is getting difficult.

This happens when a class is extended. When a method is overwritten
once, it may be easy to update the signature in two places. The more
methods are overwriting a
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
method, the more difficult it is to update it.

This analysis counts the number of times a method is overwritten, and
report any method that is ovrewritten more than 6 times. This threshold
may be configured.

``` {.php}
<?php

class x1 {
    // foo1() is never overwritten. It is easy to update.
    function foo1() {}

    // foo7() is overwritten seven times. It is hard to update.
    function foo7() {}
}

// classes x2 to x7, all overwrite foo7();
// Only x2 is presente here.
class x2 extends x1 {
    function foo7() {}
}

?>
```

  ------------------------ --------- --------- ---------------------------------------------
  Name                     Default   Type      Description

  fossilizationThreshold   6         integer   Minimal number of overwriting methods to
                                               consider a method difficult to update.
  ------------------------ --------- --------- ---------------------------------------------

  ------------- ---------------------------------------
  Short name    Classes/FossilizedMethod

  Rulesets      `ClassReview`{.interpreted-text
                role="ref"},
                `Typechecks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------------

Fully Qualified Constants
-------------------------

Constants defined with their namespace.

When defining constants with [define()](https://www.php.net/define)
function, it is possible to include the actual namespace :

``` {.php}
<?php

define('a\b\c', 1); 

?>
```

However, the name should be fully qualified without the initial . Here,
abc constant will never be accessible as a namespace constant, though it
will be accessible via the [constant()](https://www.php.net/constant)
function.

Also, the namespace will be absolute, and not a relative namespace of
the current one.

### Suggestions

-   Drop the initial when creating constants with define() : for
    example, use trim(\$x, \'\'), which removes anti-slashes before and
    after.

  ------------- -----------------------------------
  Short name    Namespaces/ConstantFullyQualified

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- -----------------------------------

Function Subscripting
---------------------

It is possible to use the result of a methodcall directly as an array,
without storing the result in a temporary variable.

This works, given that the method actually returns an array.

This syntax was not possible until PHP 5.4. Until then, it was
compulsory to store the result in a variable first. Although this is now
superfluous, it has been a standard syntax in PHP, and is still being
used.

``` {.php}
<?php

function foo() {
    return array(1 => 'a', 'b', 'c');
}

echo foo()[1]; // displays 'a';

// Function subscripting, the old way
function foo() {
    return array(1 => 'a', 'b', 'c');
}

$x = foo();
echo $x[1]; // displays 'a';

?>
```

Storing the result in a variable is still useful if the result is
actually used more than once.

  ------------- ----------------------------------------
  Short name    Structures/FunctionSubscripting

  Rulesets      `CompatibilityPHP53`{.interpreted-text
                role="ref"}

  Php Version   With PHP 5.4 and more recent

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ----------------------------------------

Function Subscripting, Old Style {#function-subscripting,-old-style}
--------------------------------

Since PHP 5.4, it is now possible use function results as an array, and
access directly its element :

``` {.php}
<?php

function foo() {
    return array(1 => 'a', 'b', 'c');
}

echo foo()[1]; // displays 'a';

// Function subscripting, the old way
function foo() {
    return array(1 => 'a', 'b', 'c');
}

$x = foo();
echo $x[1]; // displays 'a';

?>
```

### Suggestions

-   Skip the local variable and directly use the return value from the
    function

  ------------- -----------------------------------------------------------------
  Short name    Structures/FunctionPreSubscripting

  Rulesets      `Suggestions`{.interpreted-text role="ref"}

  Php Version   With PHP 5.4 and more recent

  Severity      Minor

  Time To Fix   Instant (5 mins)

  Examples      `openconf-structures-functionpresubscripting`{.interpreted-text
                role="ref"}
  ------------- -----------------------------------------------------------------

Functions Removed In PHP 5.4
----------------------------

Those functions were removed in PHP 5.4.

``` {.php}
<?php

// Deprecated as of PHP 5.4.0
$link = mysql_connect('localhost', 'mysql_user', 'mysql_password');
$db_list = mysql_list_dbs($link);

while ($row = mysql_fetch_object($db_list)) {
     echo $row->Database . "\n";
}

?>
```

See also [Deprecated features in PHP
5.4.x](https://www.php.net/manual/en/migration54.deprecated.php).

  ------------- ----------------------------------------
  Short name    Php/Php54RemovedFunctions

  Rulesets      `CompatibilityPHP54`{.interpreted-text
                role="ref"}

  Php Version   With PHP 5.4 and older

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Functions Removed In PHP 5.5
----------------------------

Those functions were removed in PHP 5.5.

-   [php\_logo\_guid()](https://www.php.net/php_logo_guid)
-   [php\_egg\_logo\_guid()](https://www.php.net/php_egg_logo_guid)
-   [php\_real\_logo\_guid()](https://www.php.net/php_real_logo_guid)
-   [zend\_logo\_guid()](https://www.php.net/zend_logo_guid)
-   [mcrypt\_cbc()](https://www.php.net/mcrypt_cbc)
-   [mcrypt\_cfb()](https://www.php.net/mcrypt_cfb)
-   [mcrypt\_ecb()](https://www.php.net/mcrypt_ecb)
-   [mcrypt\_ofb()](https://www.php.net/mcrypt_ofb)

``` {.php}
<?php

echo '<img src="' . $_SERVER['PHP_SELF'] .
     '?=' . php_logo_guid() . '" alt="PHP Logo !" />';

?>
```

See also [Deprecated features in PHP
5.5.x](https://www.php.net/manual/en/migration55.deprecated.php).

### Suggestions

-   Stop using those functions

  ------------- ----------------------------------------
  Short name    Php/Php55RemovedFunctions

  Rulesets      `CompatibilityPHP55`{.interpreted-text
                role="ref"}

  Php Version   With PHP 5.5 and older

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Generator Cannot Return
-----------------------

Generators could not use return and yield at the same time. In PHP 7.0,
generator can now use both of them.

``` {.php}
<?php

// This is not allowed until PHP 7.0
function foo() {
    yield 1;
    return 'b';
}

?>
```

### Suggestions

-   Remove the return

  ---------- --------------------------------------------------------------
  Short name Functions/GeneratorCannotReturn

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        7.0+
  Version    

  Severity   Major

  Time To    Quick (30 mins)
  Fix        
  ---------- --------------------------------------------------------------

Getting Last Element
--------------------

Getting the last element of an array relies on array\_key\_last().

array\_key\_last() was added in PHP 7.3. Before that,

``` {.php}
<?php

$array = ['a' => 1, 'b' => 2, 'c' => 3];

// Best solutions, by far
$last = $array[array_key_last($array)];

// Best solutions, just as fast as each other
$last = $array[count($array) - 1];
$last = end($array);

// Bad solutions

// popping, but restoring the value. 
$last = array_pop($array);
$array[] = $last; 

// array_unshift would be even worse

// reversing array
$last = array_reverse($array)[0];

// slicing the array
$last = array_slice($array, -1)[0]',
$last = current(array_slice($array, -1));
);

?>
```

### Suggestions

-   Use PHP native function : array\_key\_last(), when using PHP 7.4 and
    later
-   Use PHP native function : array\_pop()
-   Organise the code to put the last element in the first position
    (array\_unshift() instead of append operator \[\])

  ------------- ------------------------------------------------------
  Short name    Arrays/GettingLastElement

  Rulesets      `Performances`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)

  Examples      `thelia-arrays-gettinglastelement`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------

Global Inside Loop
------------------

The global keyword must be used out of loops. Otherwise, it is evaluated
each loop, slowing the whole process.

``` {.php}
<?php

// Here, global is used once
global $total;
foreach($a as $b) {
    $total += $b;
}

// Global is called each time : this is slow.
foreach($a as $b) {
    global $total;
    $total += $b;
}
?>
```

### Suggestions

-   Move the global keyword outside the loop

  ------------ ----------------------------------
  Short name   Structures/GlobalOutsideLoop

  Rulesets     `Performances`{.interpreted-text
               role="ref"}
  ------------ ----------------------------------

Global Usage
------------

List usage of globals variables, with global keywords or direct access
to \$GLOBALS.

``` {.php}
<?php
$a = 1; /* global scope */ 

function test()
{ 
    echo $a; /* reference to local scope variable */ 
} 

test();

?>
```

It is recommended to avoid using global variables, at it makes it very
difficult to track changes in values across the whole application.

See also [Variable
scope](https://www.php.net/manual/en/language.variables.scope.php).

  ---------- --------------------------------------------------------------------------------
  Short name Structures/GlobalUsage

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  ClearPHP   [no-global](https://github.com/dseguy/clearPHP/tree/master/rules/no-global.md)
  ---------- --------------------------------------------------------------------------------

Group Use Declaration
---------------------

The group use declaration is used in the code.

``` {.php}
<?php

// Adapted from the RFC documentation 
// Pre PHP 7 code
use some\name_space\ClassA;
use some\name_space\ClassB;
use some\name_space\ClassC as C;

use function some\name_space\fn_a;
use function some\name_space\fn_b;
use function some\name_space\fn_c;

use const some\name_space\ConstA;
use const some\name_space\ConstB;
use const some\name_space\ConstC;

// PHP 7+ code
use some\name_space\{ClassA, ClassB, ClassC as C};
use function some\name_space\{fn_a, fn_b, fn_c};
use const some\name_space\{ConstA, ConstB, ConstC};

?>
```

See also [Group Use Declaration
RFC](https://wiki.php.net/rfc/group_use_declarations) and [Using
namespaces:
Aliasing/Importing](https://www.php.net/manual/en/language.namespaces.importing.php).

  ---------- --------------------------------------------------------------
  Short name Php/GroupUseDeclaration

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        
  ---------- --------------------------------------------------------------

Group Use Trailing Comma
------------------------

The usage of a final empty slot in [array()](https://www.php.net/array)
was allowed with use statements. This works in PHP 7.2 and more recent.

Although this empty instruction is ignored at execution, this allows for
clean presentation of code, and short diff when committing in a VCS.

``` {.php}
<?php

// Valid in PHP 7.2 and more recent.
use a\b\{c, 
         d, 
         e, 
         f,
        };

// This won't compile in 7.1 and older.

?>
```

See also [Trailing Commas In List
Syntax](https://wiki.php.net/rfc/list-syntax-trailing-commas) and
[Revisit trailing commas in function
arguments](https://www.mail-archive.com/internals@lists.php.net/msg81138.html).

  ---------- -----------------------------------------------------------------
  Short name Php/GroupUseTrailingComma

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.2 and more recent
  Version    

  Severity   Major

  Time To    Instant (5 mins)
  Fix        
  ---------- -----------------------------------------------------------------

Hardcoded Passwords
-------------------

Hardcoded passwords in the code.

Hardcoding passwords is a bad idea. Not only it make the code difficult
to change, but it is an information leak. It is better to hide this kind
of information out of the code.

``` {.php}
<?php

$ftp_server = '300.1.2.3';   // yes, this doesn't exists, it's an example
$conn_id = ftp_connect($ftp_server); 

// login with username and password
$login_result = ftp_login($conn_id, 'login', 'password'); 

?>
```

See also [10 GitHub Security Best
Practices](https://snyk.io/blog/ten-git-hub-security-best-practices/)
and [Git How-To: Remove Your Password from a
Repository](https://davidverhasselt.com/git-how-to-remove-your-password-from-a-repository/).

### Suggestions

-   Remove all passwords from the code. Also, check for history if you
    are using a VCS.

  --------------- --------------------- ------ -------------------------------------------------
  Name            Default               Type   Description

  passwordsKeys   password\_keys.json   data   List of array index and property names that shall
                                               be checked for potential secret key storages.
  --------------- --------------------- ------ -------------------------------------------------

  ---------- ------------------------------------------------------------------------------------------------------------
  Short name Functions/HardcodedPasswords

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `Security`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Slow (1 hour)
  Fix        

  ClearPHP   [no-hardcoded-credential](https://github.com/dseguy/clearPHP/tree/master/rules/no-hardcoded-credential.md)
  ---------- ------------------------------------------------------------------------------------------------------------

Hash Algorithms
---------------

There is a long but limited list of hashing algorithm available to PHP.
The one found doesn\'t seem to be existing.

``` {.php}
<?php

// This hash has existed in PHP. Check with hash_algos() if it is available on your system. 
echo hash('ripmed160', 'The quick brown fox jumped over the lazy dog.');

// This hash doesn't exist
echo hash('ripemd160', 'The quick brown fox jumped over the lazy dog.');

?>
```

See also [hash\_algos](https://www.php.net/hash_algos).

### Suggestions

-   Use a hash algorithm that is available on several PHP versions
-   Fix the name of the hash algorithm

  ------------- -----------------------------
  Short name    Php/HashAlgos

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- -----------------------------

Hash Algorithms Incompatible With PHP 5.3
-----------------------------------------

List of hash algorithms incompatible with PHP 5.3.

``` {.php}
<?php

// Compatible only with 5.3 and more recent
echo hash('md2', 'The quick brown fox jumped over the lazy dog.');

// Always compatible
echo hash('ripemd320', 'The quick brown fox jumped over the lazy dog.');

?>
```

See also [hash\_algos](https://www.php.net/hash_algos).

  ---------- ------------------------------------------------------------------
  Short name Php/HashAlgos53

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- ------------------------------------------------------------------

Hash Algorithms Incompatible With PHP 5.4/5.5 {#hash-algorithms-incompatible-with-php-5.4/5.5}
---------------------------------------------

List of hash algorithms incompatible with PHP 5.4 and 5.5.

``` {.php}
<?php

// Compatible only with 5.4 and more recent
echo hash('fnv132', 'The quick brown fox jumped over the lazy dog.');

// Always compatible
echo hash('ripemd320', 'The quick brown fox jumped over the lazy dog.');

?>
```

See also [hash\_algos](https://www.php.net/hash_algos).

  ---------- -----------------------------------------------------------------
  Short name Php/HashAlgos54

  Rulesets   `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"}

  Php        With PHP 5.4 and older
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- -----------------------------------------------------------------

::: {#hash-algorithms-incompatible-with-php-7.1-}
Hash Algorithms Incompatible With PHP
7.1-\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#
:::

List of hash algorithms incompatible with PHP 7.1 and more recent. At
the moment of writing, this is compatible up to 7.3.

The hash algorithms were introduced in PHP 7.1.

``` {.php}
<?php

// Compatible only with 7.1 and more recent
echo hash('sha512/224', 'The quick brown fox jumped over the lazy dog.');

// Always compatible
echo hash('ripemd320', 'The quick brown fox jumped over the lazy dog.');

?>
```

See also [hash\_algos](https://www.php.net/hash_algos).

  ---------- ----------------------------------------------------------------
  Short name Php/HashAlgos71

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.1 and older
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- ----------------------------------------------------------------

::: {#hash-algorithms-incompatible-with-php-7.4-}
Hash Algorithms Incompatible With PHP
7.4-\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#
:::

List of hash algorithms incompatible with PHP 7.3 and older recent. At
the moment of writing, this is compatible up to 7.4s.

The hash algorithms were introduced in PHP 7.4s.

``` {.php}
<?php

// Compatible only with 7.1 and more recent
echo hash('crc32cs', 'The quick brown fox jumped over the lazy dog.');

// Always compatible
echo hash('ripemd320', 'The quick brown fox jumped over the lazy dog.');

?>
```

See also [hash\_algos](https://www.php.net/hash_algos).

  ------------- ----------------------------------------
  Short name    Php/HashAlgos74

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.4 and older

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

Hash Will Use Objects
---------------------

The [ext/hash extension](http://www.php.net/manual/en/book.hash.php)
used resources, and is being upgraded to use resources.

``` {.php}
<?php

// Post 7.2 code 
    $hash = hash_init('sha256');
    if (!is_object($hash)) {
        trigger_error('error');
    }
    hash_update($hash, $message);

// Pre-7.2 code
    $hash = hash_init('md5');
    if (!is_resource($hash)) {
        trigger_error('error');
    }
    hash_update($hash, $message);

?>
```

See also [Move ext/hash from resources to
objects](https://www.php.net/manual/en/migration72.incompatible.php#migration72.incompatible.hash-ext-to-objects).

  ------------- ----------------------------------------
  Short name    Php/HashUsesObjects

  Rulesets      `CompatibilityPHP72`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Heredoc Delimiter
-----------------

Heredoc and Nowdoc expressions may use a variety of delimiters.

There seems to be a standard delimiter in the code, and some exceptions
: one or several forms are dominant (\> 90%), while the others are rare.

The analyzed code has less than 10% of the rare delimiters. For
consistency reasons, it is recommended to make them all the same.

Generally, one or two delimiters are used, with generic value. It is
recommended to use a humanly readable delimiter : SQL, HTML, XML,
GREMLIN, etc. This helps readability in the code.

``` {.php}
<?php

echo <<<SQL
SELECT * FROM table1;
SQL;

echo <<<SQL
SELECT * FROM table2;
SQL;

echo <<<SQL
SELECT * FROM table3;
SQL;

echo <<<SQL
SELECT * FROM table4;
SQL;

echo <<<SQL
SELECT * FROM table5;
SQL;

echo <<<SQL
SELECT * FROM table11;
SQL;

echo <<<SQL
SELECT * FROM table12;
SQL;

echo <<<SQL
SELECT * FROM table13;
SQL;

// Nowdoc
echo <<<'SQL'
SELECT * FROM table14;
SQL;

echo <<<SQL
SELECT * FROM table15;
SQL;


echo <<<HEREDOC
SELECT * FROM table215;
HEREDOC;

?>
```

  ------------ -------------------------------------------------------------
  Short name   Structures/HeredocDelimiterFavorite

  Rulesets     `Coding Conventions <coding-conventions>`{.interpreted-text
               role="ref"}
  ------------ -------------------------------------------------------------

Hexadecimal In String
---------------------

Mark strings that may be confused with hexadecimal.

Until PHP 7.0, PHP recognizes hexadecimal numbers inside strings, and
converts them accordingly.

PHP 7.0 and until 7.1, converts the string to 0, silently.

PHP 7.1 and later, emits a \'A non-numeric value encountered\' warning,
and convert the string to 0.

``` {.php}
<?php
    $a = '0x0030';
    print $a + 1;
    // Print 49

    $c = '0x0030zyc';
    print $c + 1;
    // Print 49

    $b = 'b0x0030';
    print $b + 1;
    // Print 0
?>
```

  ------------- ------------------------------------------------------
  Short name    Type/HexadecimalString

  Rulesets      `CompatibilityPHP70`{.interpreted-text role="ref"},
                `CompatibilityPHP71`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ------------------------------------------------------

Hidden Nullable
---------------

Argument with default value of null are nullable. Even when the `null`
typehint (PHP 8.0), or the `?` operator are not used, setting the
default value to null is allowed, and makes the argument nullable.

This doesn\'t happen with properties : they must be defined with the
nullable type to accept a `null`value as default value.

This doesn\'t happen with constant, which can\'t be typehinted.

``` {.php}
<?php

// explicit nullable parameter $s
function bar(?string $s = null) {

// implicit nullable parameter $s
function foo(string $s = null) {
    echo $s ?? 'NULL-value';
}

// both display NULL-value
foo(); 
foo(null);

?>
```

See also [Nullable types](https://wiki.php.net/rfc/nullable_types) and
[Type
declaration](https://www.php.net/manual/en/functions.arguments.php#functions.arguments.type-declaration).

### Suggestions

-   Change the default value to a compatible literal : for example,
    `string $s = ''`
-   Add the explicit `?` nullable operator, or `null`with PHP 8.0
-   Remove the default value

  ------------- ------------------------------------
  Short name    Classes/HiddenNullable

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------

Hidden Use Expression
---------------------

The use expression for namespaces should always be at the beginning of
the namespace block.

It is where everyone expect them, and it is less confusing than having
them at various levels.

``` {.php}
<?php

// This is visible 
use A;

class B {}

// This is hidden 
use C as D;

class E extends D {
    use traitT; // This is a use for a trait

    function foo() {
        // This is a use for a closure
        return function ($a) use ($b) {}
    }
}

?>
```

### Suggestions

-   Group all uses together, at the beginning of the namespace or class

  ----------- -----------------------------------------------------------
  Short name  Namespaces/HiddenUse

  Rulesets    `Analyze`{.interpreted-text role="ref"},
              `CI-checks`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Instant (5 mins)

  Examples    `tikiwiki-namespaces-hiddenuse`{.interpreted-text
              role="ref"},
              `openemr-namespaces-hiddenuse`{.interpreted-text
              role="ref"}
  ----------- -----------------------------------------------------------

Htmlentities Calls
------------------

[htmlentities()](https://www.php.net/htmlentities) and
[htmlspecialchars()](https://www.php.net/htmlspecialchars) are used to
prevent injecting special characters in HTML code. As a bare minimum,
they take a string and encode it for HTML.

The second argument of the functions is the type of protection. The
protection may apply to quotes or not, to HTML 4 or 5, etc. It is highly
recommended to set it explicitly.

The third argument of the functions is the encoding of the string. In
PHP 5.3, it is `ISO-8859-1`, in 5.4, was `UTF-8`, and in 5.6, it is now
default\_charset, a `php.ini` configuration that has the default value
of `UTF-8`. It is highly recommended to set this argument too, to avoid
distortions from the configuration.

``` {.php}
<?php
$str = 'A quote is <b>bold</b>';

// Outputs, without depending on the php.ini: A &#039;quote&#039; is &lt;b&gt;bold&lt;/b&gt; 
echo htmlentities($str, ENT_QUOTES, 'UTF-8');

// Outputs, while depending on the php.ini: A quote is &lt;b&gt;bold&lt;/b&gt;
echo htmlentities($str);

?>
```

Also, note that arguments 2 and 3 are constants and string,
respectively, and should be issued from the list of values available in
the manual. Other values than those will make PHP use the default
values.

See also [htmlentities](https://www.php.net/htmlentities) and
[htmlspecialchars](https://www.php.net/htmlspecialchars).

### Suggestions

-   Always use the third argument with htmlentities()

  ------------- ----------------------------------
  Short name    Structures/Htmlentitiescall

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)
  ------------- ----------------------------------

Identical Conditions
--------------------

These logical expressions contain members that are identical.

This means those expressions may be simplified.

``` {.php}
<?php

// twice $a
if ($a || $b || $c || $a) {  }

// Hiding in parenthesis is bad
if (($a) ^ ($a)) {}

// expressions may be large
if ($a === 1 && 1 === $a) {}

?>
```

### Suggestions

-   Merge the two structures into one unique test
-   Add extra expressions between the two structures
-   Nest the structures, to show that different attempts are made

  ---------- ----------------------------------------------------------------
  Short name Structures/IdenticalConditions

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Critical

  Time To    Quick (30 mins)
  Fix        

  Examples   `wordpress-structures-identicalconditions`{.interpreted-text
             role="ref"},
             `dolibarr-structures-identicalconditions`{.interpreted-text
             role="ref"},
             `mautic-structures-identicalconditions`{.interpreted-text
             role="ref"}
  ---------- ----------------------------------------------------------------

Identical Consecutive Expression
--------------------------------

Identical consecutive expressions are worth being checked.

They may be a copy/paste with unmodified content. When the content has
to be duplicated, it is recommended to avoid executing the expression
again, and just access the cached result.

``` {.php}
<?php

$current  = $array[$i];
$next     = $array[$i + 1];
$nextnext = $array[$i + 1]; // OOps, nextnext is wrong.

// Initialization
$previous = foo($array[1]); // previous is initialized with the first value on purpose
$next     = foo($array[1]); // the second call to foo() with the same arguments should be avoided
// the above can be rewritten as : 
$next     = $previous; // save the processing.

for($i = 1; $i < 200; ++$i) {
    $next = doSomething();
}
?>
```

  ------------- ---------------------------------
  Short name    Structures/IdenticalConsecutive

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ---------------------------------

Identical On Both Sides
-----------------------

Operands should be different when comparing or making a logical
combination. Of course, the value each operand holds may be identical.
When the same operand appears on both sides of the expression, the
result is know before execution.

``` {.php}
<?php

// Trying to confirm consistency
if ($login == $login) {
    doSomething();
}

// Works with every operators
if ($object->login( ) !== $object->login()) {
    doSomething();
}

if ($sum >= $sum) {
    doSomething();
}

//
if ($mask && $mask) {
    doSomething();
}

if ($mask || $mask) {
    doSomething();
}

?>
```

### Suggestions

-   Remove one of the alternative, and remove the logical link
-   Modify one of the alternative, and make it different from the other

  ---------- ----------------------------------------------------------------
  Short name Structures/IdenticalOnBothSides

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `phpmyadmin-structures-identicalonbothsides`{.interpreted-text
             role="ref"},
             `humo-gen-structures-identicalonbothsides`{.interpreted-text
             role="ref"}
  ---------- ----------------------------------------------------------------

If With Same Conditions
-----------------------

Successive If / then structures that have the same condition may be
either merged or have one of the condition changed.

``` {.php}
<?php

if ($a == 1) {
    doSomething();
}

if ($a == 1) {
    doSomethingElse();
}

// May be replaced by 
if ($a == 1) {
    doSomething();
    doSomethingElse();
}

?>
```

Note that if the values used in the condition have been modified in the
first if/then structure, the two distinct conditions may be needed.

``` {.php}
<?php

// May not be merged
if ($a == 1) {
    // Check that this is really the situation
    $a = checkSomething();
}

if ($a == 1) {
    doSomethingElse();
}

?>
```

### Suggestions

-   Merge the two conditions so the condition is used once.
-   Change one of the condition, so they are different
-   Make it obvious that the first condition is a try, preparing the
    normal conditions.

  ---------- -------------------------------------------------------------------
  Short name Structures/IfWithSameConditions

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `phpmyadmin-structures-ifwithsameconditions`{.interpreted-text
             role="ref"},
             `phpdocumentor-structures-ifwithsameconditions`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------------

Iffectations
------------

Affectations that appears in a condition.

Iffectations are a way to do both a test and an affectations. They may
also be typos, such as if (\$x = 3) {
[\...](https://www.php.net/manual/en/functions.arguments.php#functions.variable-arg-list)
}, leading to a constant condition.

``` {.php}
<?php

// an iffectation : assignation in a If condition
if($connexion = mysql_connect($host, $user, $pass)) {
    $res = mysql_query($connexion, $query);
}

// Iffectation may happen in while too.
while($row = mysql_fetch($res)) {
    $store[] = $row;
}

?>
```

### Suggestions

-   Move the assignation inside the loop, and make an existence test in
    the condition.
-   Move the assignation before the if/then, make an existence test in
    the condition.

  ------------- -----------------------------
  Short name    Structures/Iffectation

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     Very high
  ------------- -----------------------------

Illegal Name For Method
-----------------------

PHP has reserved usage of methods starting with `__` for magic methods.
It is recommended to avoid using this prefix, to prevent confusions.

``` {.php}
<?php

class foo{
    // Constructor
    function __construct() {}

    // Constructor's typo
    function __constructor() {}

    // Illegal function name, even as private
    private function __bar() {}
}

?>
```

See also [Magic
Methods](https://www.php.net/manual/en/language.oop5.magic.php).

### Suggestions

-   Avoid method names starting with a double underscore : `__`
-   Use method visibilities to ensure that methods are only available to
    the current class or its children

  ----------- -----------------------------------------------------------
  Short name  Classes/WrongName

  Rulesets    `Analyze`{.interpreted-text role="ref"}

  Severity    Major

  Time To Fix Slow (1 hour)

  Examples    `prestashop-classes-wrongname`{.interpreted-text
              role="ref"}, `magento-classes-wrongname`{.interpreted-text
              role="ref"}
  ----------- -----------------------------------------------------------

Implement Is For Interface
--------------------------

With class heritage, implements should be used for interfaces, and
extends with classes.

PHP defers the implements check until execution : the code in example
does lint, but won,t run.

``` {.php}
<?php

class x {
    function foo() {}
}

interface y {
    function foo();
}

// Use implements with an interface
class z implements y {}

// Implements is for an interface, not a class
class z implements x {}

?>
```

### Suggestions

-   Create an interface from the class, and use it with the implements
    keyword

  ------------- ---------------------------------
  Short name    Classes/ImplementIsForInterface

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Implemented Methods Are Public
------------------------------

Class methods that are defined in an interface must be public. They
cannot be either private, nor protected.

This error is not reported by lint, but is reported at execution time.

``` {.php}
<?php

interface i {
    function foo();
}

class X {
    // This method is defined in the interface : it must be public
    protected function foo() {}

    // other methods may be private
    private function bar() {}
}

?>
```

See also
[Interfaces](https://www.php.net/manual/en/language.oop5.interfaces.php)
and [Interfaces - the next level of
abstraction](https://phpenthusiast.com/object-oriented-php-tutorials/interfaces).

### Suggestions

-   Make the implemented method public

  ------------- -------------------------------------
  Short name    Classes/ImplementedMethodsArePublic

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)
  ------------- -------------------------------------

Implied If
----------

It is confusing to emulate if/then with boolean operators.

It is possible to emulate a if/then structure by using the operators
\'and\' and \'or\'. Since optimizations will be applied to them : when
the left operand of \'and\' is false, the right one is not executed, as
its result is useless; when the left operand of \'or\' is true, the
right one is not executed, as its result is useless;

However, such structures are confusing. It is easy to misread them as
conditions, and ignore an important logic step.

``` {.php}
<?php

// Either connect, or die
mysql_connect('localhost', $user, $pass) or die();

// Defines a constant if not found. 
defined('SOME_CONSTANT') and define('SOME_CONSTANT', 1);

// Defines a default value if provided is empty-ish 
// Warning : this is 
$user = $_GET['user'] || 'anonymous';

?>
```

It is recommended to use a real \'if then\' structures, to make the
condition readable.

  ---------- ----------------------------------------------------------------------------------------
  Short name Structures/ImpliedIf

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [no-implied-if](https://github.com/dseguy/clearPHP/tree/master/rules/no-implied-if.md)
  ---------- ----------------------------------------------------------------------------------------

Implode One Arg
---------------

[implode()](https://www.php.net/implode) may be called with one arg. It
is recommended to avoid it.

Using two arguments makes it less surprising to new comers, and
consistent with [explode()](https://www.php.net/explode) syntax.

``` {.php}
<?php

$array = range('a', 'c');

// empty string is the glue
print implode('', $array);

// only the array : PHP uses the empty string as glue. 
// Avoid this
print implode($array);

?>
```

See also [implode](https://www.php.net/implode).

### Suggestions

-   Add an empty string as first argument

  ------------- -------------------------------------------
  Short name    Php/ImplodeOneArg

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"},
                `php-cs-fixable`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------------------

Implode() Arguments Order {#implode()-arguments-order}
-------------------------

[implode()](https://www.php.net/implode) accepted two signatures, but is
only recommending one. Both types orders of string then array, and array
then string have been possible until PHP 7.4.

In PHP 7.4, the order array then string is deprecated, and emits a
warning. It will be removed in PHP 8.0.

``` {.php}
<?php

$glue = ',';
$pieces = range(0, 4);

// documented argument order
$s = implode($glue, $pieces);

// Pre 7.4 argument order
$s = implode($pieces, $glue);

// both produces 0,1,2,3,4

?>
```

See also [implode()](https://www.php.net/implode).

### Suggestions

-   Always use the array as the second argument

  ------------- ----------------------------------
  Short name    Structures/ImplodeArgsOrder

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Inclusion Wrong Case
--------------------

Inclusion should follow exactly the case of included files and path.
This prevents the infamous case-sensitive filesystem bug, where files
are correctly included in a case-insensitive system, and failed to be
when moved to production.

``` {.php}
<?php

// There must exist a path called path/to and a file library.php with this case
include path/to/library.php;

// Error on the case, while the file does exist
include path/to/LIBRARY.php;

// Error on the case, on the PATH
include path/TO/library.php;

?>
```

See also
[include\_once](https://www.php.net/manual/en/function.include-once.php),
about case sensitivity and inclusions.

### Suggestions

-   Make the inclusion string identical to the file name.
-   Change the name of the file to reflect the actual inclusion. This is
    the best way when a naming convention has been set up for the
    project, and the file doesn\'t adhere to it. Remember to change all
    other inclusion.

  ------------- -----------------------------
  Short name    Files/InclusionWrongCase

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- -----------------------------

Incompatible Signature Methods
------------------------------

Methods should have the same signature when being overwritten.

The same signatures means the children class must have : + the same name
+ the same visibility or less restrictive + the same typehint or removed
+ the same default value or removed + a reference like its
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)

This problem emits a fatal error, for abstract methods, or a warning
error, for normal methods. Yet, it is difficult to lint, because classes
are often stored in different files. As such, PHP do lint each file
independently, as unknown
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
classes are not checked if not present. Yet, when executing the code,
PHP lint the actual code and may encounter a fatal error.

``` {.php}
<?php

class a {
    public function foo($a = 1) {}
}

class ab extends a {
    // foo is overloaded and now includes a default value for $a
    public function foo($a) {}
}

?>
```

See also [Object
Inheritance](http://www.php.net/manual/en/language.oop5.inheritance.php).

### Suggestions

-   Make signatures compatible again

  ------------- ------------------------------------------------------------
  Short name    Classes/IncompatibleSignature

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text role="ref"}

  Php Version   7.4-

  Severity      Critical

  Time To Fix   Quick (30 mins)

  Examples      `suitecrm-classes-incompatiblesignature`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------------

Incompatible Signature Methods With Covariance
----------------------------------------------

Methods should have the compatible signature when being overwritten.

The same signatures means the children class must have : + the same name
+ the same visibility or less restrictive + the same contravariant
typehint or removed + the same covariant return typehint or removed +
the same default value or removed + a reference like its
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)

This problem emits a fatal error, for abstract methods, or a warning
error, for normal methods. Yet, it is difficult to lint, because classes
are often stored in different files. As such, PHP do lint each file
independently, as unknown
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
classes are not checked if not present. Yet, when executing the code,
PHP lint the actual code and may encounter a fatal error.

``` {.php}
<?php

class a {
    public function foo($a = 1) {}
}

class ab extends a {
    // foo is overloaded and now includes a default value for $a
    public function foo($a) {}
}

?>
```

See also [Object Inheritance](http://www.php.net/manual/en/language.oop5.inheritance.php),

:   [PHP RFC: Covariant Returns and Contravariant
    Parameters](https://wiki.php.net/rfc/covariant-returns-and-contravariant-parameters)
    and `incompatible-signature-methods`{.interpreted-text role="ref"}.

### Suggestions

-   Make signatures compatible again

  ------------- --------------------------------------------------------------
  Short name    Classes/IncompatibleSignature74

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Php Version   7.4+

  Severity      Critical

  Time To Fix   Quick (30 mins)

  Examples      `suitecrm-classes-incompatiblesignature74`{.interpreted-text
                role="ref"}
  ------------- --------------------------------------------------------------

Incompilable Files
------------------

Files that cannot be compiled, and, as such, be run by PHP. Scripts are
linted against various versions of PHP.

This is usually undesirable, as all code must compile before being
executed. It may be that such files are not compilable because they are
not yet ready for an upcoming PHP version.

``` {.php}
<?php

// Can't compile this : Print only accepts one argument
print $a, $b, $c;

?>
```

Code that is not compilable with older PHP versions means that the code
is breaking backward compatibility : good or bad is project decision.

When the code is used as a template for PHP code generation, for example
at installation time, it is recommended to use a distinct file
extension, so as to distinguish them from actual PHP code.

### Suggestions

-   If this file is a template for PHP code, change the extension to
    something else than .php
-   Fix the syntax so it works with various versions of PHP

  ---------- --------------------------------------------------------------------------------------------
  Short name Php/Incompilable

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Critical

  Time To    Slow (1 hour)
  Fix        

  ClearPHP   [no-incompilable](https://github.com/dseguy/clearPHP/tree/master/rules/no-incompilable.md)

  Examples   `xataface-php-incompilable`{.interpreted-text role="ref"}
  ---------- --------------------------------------------------------------------------------------------

Inconsistent Elseif
-------------------

Chaining if/elseif requires a consistent string of conditions. The
conditions are executed one after the other, and the conditions
shouldn\'t overlap.

This analysis reports chains of elseif that don\'t share a common
variable (or array, or property, etc.. ). As such, testing different
conditions are consistent.

``` {.php}
<?php

// $a is always common, so situations are mutually exclusive
if ($a === 1) {
    doSomething();
} else if ($a > 1) {
    doSomethingElse();
} else {
    doSomethingDefault();
}

// $a is always common, so situations are mutually exclusive
// although, it may be worth checking the consistency here
if ($a->b === 1) {
    doSomething();
} else if ($a->c > 1) {
    doSomethingElse();
} else {
    doSomethingDefault();
}

// if $a === 1, then $c doesn't matter? 
// This happens, but then logic doesn't appear in the code.
if ($a === 1) {
    doSomething();
} else if ($c > 1) {
    doSomethingElse();
} else {
    doSomethingDefault();
}

?>
```

  ------------- -------------------------------
  Short name    Structures/InconsistentElseif

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- -------------------------------

Indices Are Int Or String
-------------------------

Indices in an array notation such as `$array['indice']` may only be
integers or string.

Boolean, Null or float will be converted to their integer or string
equivalent.

``` {.php}
<?php
    $a = [true => 1,
          1.0  => 2,
          1.2  => 3,
          1    => 4,
          '1'  => 5,
          0.8  => 6,
          0x1  => 7,
          01   => 8,

          null  => 1,
          ''    => 2,

          false => 1,
          0     => 2,

          '0.8' => 3,
          '01'  => 4,
          '2a'  => 5
          ];

    print_r($a);

/*
The above displays
Array
(
    [1] => 8
    [0] => 2
    [] => 2
    [0.8] => 3
    [01] => 4
    [2a] => 5
)
*/
?>
```

Decimal numbers are rounded to the closest integer; Null is transtyped
to \'\' (empty string); true is 1 and false is 0; Integers in strings
are transtyped, while partial numbers or decimals are not analyzed in
strings.

As a general rule of thumb, only use integers or strings that don\'t
look like integers.

This analyzer may find constant definitions, when available.

Note also that PHP detects integer inside strings, and silently turn
them into integers. Partial and octal numbers are not transformed.

``` {.php}
<?php
    $a = [1      => 1,
          '2'    => 2,
          '011'  => 9, // octal number
          '11d'  => 11, // partial number 
          ];

    var_dump($a);

/*
The above displays
array(4) {
  [1]=>
  int(1)
  [2]=>
  int(2)
  [011]=>
  int(9)
  [11d]=>
  int(11)
}*/
?>
```

See also [Arrays
syntax](https://www.php.net/manual/en/language.types.array.php).

### Suggestions

-   Do not use any type but string or integer
-   Force typecast the keys when building an array

  ---------- --------------------------------------------------------------
  Short name Structures/IndicesAreIntOrString

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `zencart-structures-indicesareintorstring`{.interpreted-text
             role="ref"},
             `mautic-structures-indicesareintorstring`{.interpreted-text
             role="ref"}
  ---------- --------------------------------------------------------------

Indirect Injection
------------------

Look for injections through indirect usage for GPRC values
([\$\_GET](https://www.php.net/manual/en/reserved.variables.get.php),
[\$\_POST](https://www.php.net/manual/en/reserved.variables.post.php),
[\$\_REQUEST](https://www.php.net/manual/en/reserved.variables.request.php),
\$\_COOKIE).

``` {.php}
<?php

$a = $_GET['a'];
echo $a;

function foo($b) {
    echo $b;
}
foo($_POST['c']);

?>
```

### Suggestions

-   Always validate incoming values before using them.

  ------------- ------------------------------
  Short name    Security/IndirectInjection

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Slow (1 hour)
  ------------- ------------------------------

Infinite Recursion
------------------

A method is calling itself, with unchanged arguments. This will probably
repeat indefinitely.

This applies to recursive functions without any condition. This also
applies to function which inject the incoming arguments, without
modifications.

``` {.php}
<?php

function foo($a, $b) {
    if ($a > 10) {
        return;
    }
    foo($a, $b);
}

function foo2($a, $b) {
    ++$a;   // $a is modified
    if ($a > 10) {
        return;
    }
    foo2($a, $b);
}

?>
```

### Suggestions

-   Modify arguments before injecting them again in the same method
-   Use different values when calling the same method

  ------------- ------------------------------
  Short name    Structures/InfiniteRecursion

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

Instantiating Abstract Class
----------------------------

PHP cannot instantiate an abstract class.

The classes are actually abstract classes, and should be derived into a
concrete class to be instantiated.

``` {.php}
<?php

abstract class Foo {
    protected $a;
}

class Bar extends Foo {
    protected $b;
}

// instantiating a concrete class.
new Bar();

// instantiating an abstract class.
// In real life, this is not possible also because the definition and the instantiation are in the same file
new Foo();

?>
```

See also [Class Abstraction](https://www.php.net/abstract).

  ------------- ------------------------------------
  Short name    Classes/InstantiatingAbstractClass

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------

Insufficient Property Typehint
------------------------------

The typehint used for a class property doesn\'t cover all it usage.

The typehint is insufficient when a undefined method is called, or if
members are access while the typehint is an interface.

``` {.php}
<?php

class A {
    function a1() {}
}

// PHP 7.4 and more recent
class B {
    private A $a = null;

    function b2() {
        // this method is available in A
        $this->a->a1();
        // this method is NOT available in A
        $this->a->a2();
    }
}

// Supported by all PHP versions
class C {
    private $a = null;

    function __construct(A $a) {
        $this->a = $a;
    }

    function b2() {
        // this method is available in A
        $this->a->a1();
        // this method is NOT available in A
        $this->a->a2();
    }
}

?>
```

This analysis relies on typehinted properties, as introduced in PHP 7.4.
It also relies on typehinted assignations at construct time : the
typehint of the assigned argument will be used as the property typehint.
Getters and setters are not considered here.

### Suggestions

-   Change the typehint to match the actual usage of the object in the
    class.

  ------------- --------------------------------------
  Short name    Classes/InsufficientPropertyTypehint

  Rulesets      `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- --------------------------------------

Insufficient Typehint
---------------------

An argument is typehinted, but it actually calls methods that are not
listed in the interface.

Classes may be implementing more methods than the one that are listed in
the interface they also implements. This means that filtering objects
with a typehint, but calling other methods will be solved at execution
time : if the method is available, it will be used; if it is not, a
fatal error is reported.

``` {.php}
<?php

class x implements i {
    function methodI() {}
    function notInI() {}
}

interface i {
    function methodI();
}

function foo(i $x) {
    $x->methodI(); // this call is valid
    $x->notInI();  // this call is not garanteed
}
?>
```

Inspired by discussion with [Brandon
Savage](https://twitter.com/BrandonSavage).

### Suggestions

-   Extend the interface with the missing called methods
-   Change the body of the function to use only the methods that are
    available in the interface
-   Change the used objects so they don\'t depend on extra methods

  ------------- -----------------------------------
  Short name    Functions/InsufficientTypehint

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `Typechecks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------------

Integer As Property
-------------------

It is backward incompatible to use integers are property names. This
feature was introduced in PHP 7.2.

If the code must be compatible with previous versions, avoid casting
arrays to object.

``` {.php}
<?php

// array to object
$arr = [0 => 1];
$obj = (object) $arr;
var_dump(
    $obj,
    $obj->{'0'}, // PHP 7.2+ accessible
    $obj->{0} // PHP 7.2+ accessible

    $obj->{'b'}, // always been accessible
);
?>
```

See also [PHP RFC: Convert numeric keys in object/array
casts](https://wiki.php.net/rfc/convert_numeric_keys_in_object_array_casts).

  ---------- -----------------------------------------------------------------
  Short name Classes/IntegerAsProperty

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.2 and more recent
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- -----------------------------------------------------------------

Integer Conversion
------------------

Comparing incoming variables to integer may lead to injection.

When comparing a variable to an integer, PHP applies type juggling, and
transform the variable in an integer too. When the value converts
smoothly to an integer, this means the validation may pass and yet, the
value may carry an injection.

``` {.php}
<?php

// This is safer
if ($_GET['x'] === 2) {
    echo $_GET['x'];
}

// Using (int) for validation and display
if ((int) $_GET['x'] === 2) {
    echo (int) $_GET['x'];
}

// This is an injection
if ($_GET['x'] == 2) {
    echo $_GET['x'];
}

// This is unsafe, as $_GET['x']  is tester as an integer, but echo'ed raw
if ((int) $_GET['x'] === 2) {
    echo $_GET['x'];
}

?>
```

This analysis spots situations where an incoming value is compared to an
integer. The usage of the validated value is not considered.

See also [Type Juggling Authentication Bypass Vulnerability in CMS Made
Simple](https://www.netsparker.com/blog/web-security/type-juggling-authentication-bypass-cms-made-simple/),
[PHP STRING COMPARISON
VULNERABILITIES](https://hydrasky.com/network-security/php-string-comparison-vulnerabilities/)
and [PHP Magic Tricks: Type
Juggling](https://www.owasp.org/images/6/6b/PHPMagicTricks-TypeJuggling.pdf).

### Suggestions

-   

  ------------- ------------------------------
  Short name    Security/IntegerConversion

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

Interfaces Don\'t Ensure Properties {#interfaces-don't-ensure-properties}
-----------------------------------

When using an interface as a typehint, properties are not enforced, nor
available.

An interface is a template for a class, which specify the minimum amount
of methods and constants. Properties are never defined in an interface,
and should not be relied upon.

``` {.php}
<?php

interface i {
    function m () ;
}

class x implements i {
    public $p = 1;

    function m() {
        return $this->p;
    }
}

function foo(i $i, x $x) {
    // this is invalid, as $p is not defined in i, so it may be not available
    echo $i->p;

    // this is valid, as $p is defined in $x
    echo $x->p;
}

?>
```

### Suggestions

-   Use classes for typehint when properties are accessed
-   Only use methods and constants which are available in the interface

  ------------- ------------------------------------------
  Short name    Interfaces/NoGaranteeForPropertyConstant

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- ------------------------------------------

Interfaces Is Not Implemented
-----------------------------

Classes that implements interfaces, must implements each of the
interface\'s methods.

``` {.php}
<?php

class x implements i {
    // This method implements the foo method from the i interface
    function foo() {}

    // The method bar is missing, yet is requested by interface i
    function foo() {}
}

interface i {
    function foo();
    function bar(); 
}

?>
```

This problem tends to occur in code that splits interfaces and classes
by file. This means that PHP\'s linting will skip the definitions and
not find the problem. At execution time, the definitions will be
checked, and a Fatal error will occur.

This situation usually detects code that was forgotten during a
refactorisation of the interface or the class and its sibblings.

See also
[Interfaces](https://www.php.net/manual/en/language.oop5.interfaces.php).

### Suggestions

-   Implements all the methods from the interfaces
-   Remove the class
-   Make the class abstract
-   Make the missing methods abstract

  ----------- ------------------------------------------------------------
  Short name  Interfaces/IsNotImplemented

  Rulesets    `Analyze`{.interpreted-text role="ref"},
              `ClassReview`{.interpreted-text role="ref"},
              `LintButWontExec`{.interpreted-text role="ref"},
              `CI-checks`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Quick (30 mins)

  Precision   High
  ----------- ------------------------------------------------------------

Interpolation
-------------

The following strings contain variables that are will be replaced.
However, the following characters are ambiguous, and may lead to
confusion.

``` {.php}
<?php

class b { 
    public $b = 'c';
    function __toString() { return __CLASS__; }
}
$x = array(1 => new B());

// -> after the $x[1] looks like a 2nd dereferencing, but it is not. 
print $x[1]->b;
// displays : b->b

print {$x[1]->b};
// displays : c

?>
```

It is advised to add curly brackets around those structures to make them
non-ambiguous.

See also [Double
quoted](https://www.php.net/manual/en/language.types.string.php#language.types.string.syntax.double).

  ------------- -------------------------------------------------------------
  Short name    Type/StringInterpolation

  Rulesets      `Coding Conventions <coding-conventions>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------------------------------------

Invalid Constant Name
---------------------

There is a naming convention for PHP constants names.

According to PHP\'s manual, constant names, \' A valid constant name
starts with a letter or underscore, followed by any number of letters,
numbers, or underscores.\'.

Constant, must follow this regex :
`/[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*/`.

In particular when defined using [define()](https://www.php.net/define)
function, no error is produced. When using `const`, on the other hand,
the

``` {.php}
<?php

define('+3', 1); // wrong constant! 

echo constant('+3'); // invalid constant access

?>
```

See also
[Constants](https://www.php.net/manual/en/language.constants.php).

### Suggestions

-   Change constant name

  ------------- ---------------------------------------------------
  Short name    Constants/InvalidName

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Examples      `openemr-constants-invalidname`{.interpreted-text
                role="ref"}
  ------------- ---------------------------------------------------

Invalid Octal In String
-----------------------

Any octal sequence inside a string can\'t be go 7. Those will be a fatal
error at parsing time.

The check is applied to the string, starting with PHP 7.1. In PHP 7.0
and older, those sequences were silently adapted (modulo/% 0).

``` {.php}
<?php

// A valid octal in a PHP string
echo 0; // @

// Emit a warning in PHP 7.1
//Octal escape sequence overflow 0 is greater than 7
echo 0; // @

// Silent conversion
echo 8; // 8

?>
```

See also
[Integers](https://www.php.net/manual/en/language.types.integer.php).

### Suggestions

-   Use a double slash to avoid the sequence to be an octal sequence
-   Use a function call, such as decoct() to convert larger number to
    octal notation

  ------------- ----------------------------------------
  Short name    Type/OctalInString

  Rulesets      `CompatibilityPHP71`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.1 and older

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Invalid Pack Format
-------------------

Some characters are invalid in a [pack()](https://www.php.net/pack)
format string.

[pack()](https://www.php.net/pack) and
[unpack()](https://www.php.net/unpack) accept the following format
specifiers : `aAhHcCsSnviIlLNVqQJPfgGdeExXZ`.

[unpack()](https://www.php.net/unpack) also accepts a name after the
format specifier and an optional quantifier.

All other situations is not a valid, and produces a warning :
`pack(): Type t: unknown format code`

``` {.php}
<?php
    $binarydata = pack(nvc*, 0x1234, 0x5678, 65, 66);

    // the first unsigned short is stored as 'first'. The next matches are names with numbers.
    $res = unpack('nfirst/vc*', $binarydata);
?>
```

Check [pack()](https://www.php.net/pack) documentation for format
specifiers that were introduced in various PHP version, namely 7.0, 7.1
and 7.2.

See also [pack](https://www.php.net/pack) and
[unpack](https://www.php.net/pack).

### Suggestions

-   Fix the packing format with correct values

  ------------- ----------------------------------
  Short name    Structures/InvalidPackFormat

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Invalid Regex
-------------

The PCRE regex doesn\'t compile. It isn\'t a valid regex.

Several reasons may lead to this situation : syntax error, Unknown
modifier, missing parenthesis or reference.

``` {.php}
<?php

// valid regex
preg_match('/[abc]/', $string);

// invalid regex (missing terminating ] for character class 
preg_match('/[abc/', $string);

?>
```

Regex are check with the Exakat version of PHP.

Dynamic regex are only checked for simple values. Dynamic values may
eventually generate a compilation error.

### Suggestions

-   Fix the regex before running it

  ------------- ------------------------------------------------------
  Short name    Structures/InvalidRegex

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Examples      `sugarcrm-structures-invalidregex`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------

Is Actually Zero
----------------

This addition actually may be simplified because one term is actually
negated by another.

This kind of error happens when the expression is very large : the more
terms are included, the more chances are that some auto-annihilation
happens.

This error may also be a simple typo : for example, calculating the
difference between two consecutive terms.

``` {.php}
<?php

// This is quite obvious
$a = 2 - 2;

// This is obvious too. This may be a typo-ed difference between two consecutive terms. 
// Could have been $c = $fx[3][4] - $fx[3][3] or $c = $fx[3][5] - $fx[3][4];
$c = $fx[3][4] - $fx[3][4];

// This is less obvious
$a = $b[3] - $c + $d->foo(1,2,3) + $c + $b[3];

?>
```

### Suggestions

-   Clean the code and remove the null sum
-   Fix one of the variable : this expression needs another variable
    here
-   When adding differences, calculate the difference in a temporary
    variable first.

  ----------- -----------------------------------------------------------
  Short name  Structures/IsZero

  Rulesets    `Analyze`{.interpreted-text role="ref"},
              `CI-checks`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Instant (5 mins)

  Examples    `dolibarr-structures-iszero`{.interpreted-text role="ref"},
              `suitecrm-structures-iszero`{.interpreted-text role="ref"}
  ----------- -----------------------------------------------------------

Is\_A() With String {#is\\_a()-with-string}
-------------------

When using [is\_a()](https://www.php.net/is_a) with a string as first
argument, the third argument is compulsory.

``` {.php}
<?php

// is_a() works with string as first argument, when the third argument is 'true'
if (is_s('A', 'B', true)) {}

// is_a() works with object as first argument
if (is_s(new A, 'A')) {}
?>
```

See also [is\_a()](https://www.php.net/is_a).

### Suggestions

-   Add the third argument, and set it to true
-   Use an object as a first argument

  ------------- -------------------------------------------------
  Short name    Php/IsAWithString

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `Rector`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- -------------------------------------------------

Isset Multiple Arguments
------------------------

[isset()](https://www.www.php.net/isset) may be used with multiple
arguments and acts as a AND.

``` {.php}
<?php

// isset without and 
if (isset($a, $b, $c)) {
    // doSomething()
}

// isset with and 
if (isset($a) && isset($b) && isset($c)) {
    // doSomething()
}

?>
```

See also
[Isset](http://www.php.net/%60isset%20%3Chttps://www.www.php.net/isset)\>\`\_.

### Suggestions

-   Merge all isset() calls into one

  ---------- ------------------------------------------------------------
  Short name Php/IssetMultipleArgs

  Rulesets   `Suggestions`{.interpreted-text role="ref"},
             `php-cs-fixable`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `thinkphp-php-issetmultipleargs`{.interpreted-text
             role="ref"},
             `livezilla-php-issetmultipleargs`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Isset() On The Whole Array {#isset()-on-the-whole-array}
--------------------------

[Isset()](https://www.www.php.net/isset) works quietly on a whole array.
There is no need to test all previous index before testing for the
target index.

``` {.php}
<?php

// Straight to the point
if (isset($a[1]['source'])) {
    // Do something with $a[1]['source']
}

// Doing too much work
if (isset($a) && isset($a[1]) && isset($a[1]['source'])) {
    // Do something with $a[1]['source']
}

?>
```

There is a gain in readability, by avoiding long and hard to read
logical expression, and reducing them in one simple
[isset](https://www.www.php.net/isset) call.

There is a gain in performances by using one call to
[isset](https://www.www.php.net/isset), instead of several, but it is a
micro-optimization.

See also
[Isset](http://www.php.net/%60isset%20%3Chttps://www.www.php.net/isset)\>\`\_.

### Suggestions

-   Remove all unnecessary calls to isset()

  ---------- -------------------------------------------------------------------
  Short name Performances/IssetWholeArray

  Rulesets   `Suggestions`{.interpreted-text role="ref"},
             `Performances`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `tine20-performances-issetwholearray`{.interpreted-text
             role="ref"},
             `expressionengine-performances-issetwholearray`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------------

Joining file() {#joining-file()}
--------------

Use [file()](https://www.php.net/file) to read lines separately.

Applying join(\'\', ) or implode(\'\', ) to the result of
[file()](https://www.php.net/file) provides the same results than using
[file\_get\_contents()](https://www.php.net/file_get_contents), but at a
higher cost of memory and processing.

If the delimiter is not \'\', then
[implode()](https://www.php.net/implode) and
[file()](https://www.php.net/file) are a better solution than
[file\_get\_contents()](https://www.php.net/file_get_contents) and
[str\_replace()](https://www.php.net/str_replace) or
[nl2br()](https://www.php.net/nl2br).

``` {.php}
<?php

// memory intensive
$content = file_get_contents('path/to/file.txt');

// memory and CPU intensive
$content = join('', file('path/to/file.txt'));

// Consider reading the data line by line and processing it along the way, 
// to save memory 
$fp = fopen('path/to/file.txt', 'r');
while($line = fget($fp)) {
    // process a line
}
fclose($fp);

?>
```

Always use
[file\_get\_contents()](https://www.php.net/file_get_contents) to get
the content of a file as a string. Consider using
[readfile()](https://www.php.net/readfile) to echo the content directly
to the output.

See also [file\_get\_contents](https://www.php.net/file_get_contents)
and [file](https://www.php.net/file).

### Suggestions

-   Use file\_get\_contents() instead of implode(file()) to read the
    whole file at once.
-   Use readfile() to echo the content to stdout at once.
-   Use fopen() to read the lines one by one, generator style.

  ---------- -----------------------------------------------------------------
  Short name Performances/JoinFile

  Rulesets   `Performances`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `wordpress-performances-joinfile`{.interpreted-text role="ref"},
             `spip-performances-joinfile`{.interpreted-text role="ref"},
             `expressionengine-performances-joinfile`{.interpreted-text
             role="ref"}, `prestashop-performances-joinfile`{.interpreted-text
             role="ref"}
  ---------- -----------------------------------------------------------------

Keep Files Access Restricted
----------------------------

Avoid using 0777 as file or directory mode. In particular, setting a
file or a directory to 0777 (or universal read-write-execute) may lead
to security vulnerabilities, as anything on the server may read, write
and even execute

File mode may be changed using the [chmod()](https://www.php.net/chmod)
function, or at directory creation, with
[mkdir()](https://www.php.net/mkdir).

``` {.php}
<?php

file_put_contents($file, $content);

// this file is accessible to the current user, and to his group, for reading and writing. 
chmod($file, 0550); 

// this file is accessible to everyone 
chmod($file, 0777); 

?>
```

By default, this analysis report universal access (0777). It is possible
to make this analysis more restrictive, by providing more forbidden
modes in the `filePrivileges` parameter. For example : `511,510,489`.
Only use a decimal representation.

See also `mkdir-default`{.interpreted-text role="ref"} and [Least
Privilege
Violation](https://owasp.org/www-community/vulnerabilities/Least_Privilege_Violation).

### Suggestions

-   Set the file mode to a level of restriction as low as possible.

  ---------------- --------- -------- -----------------------------------------
  Name             Default   Type     Description

  filePrivileges   0777      string   List of forbidden file modes (comma
                                      separated).
  ---------------- --------- -------- -----------------------------------------

  ------------- ------------------------------
  Short name    Security/KeepFilesRestricted

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

Large Try Block
---------------

Try block should enclosing only the expression that may emit an
exception.

When writing large blocks of code in a try, it becomes difficult to
understand where the expression is coming from. Large blocks may also
lead to catch multiples exceptions, with a long list of catch clause.

In particular, the catch clause will resume the execution without
knowing where the try was interrupted : there are no indication of
achievement, even partial. In fact, catching an exception signals a very
dirty situation.

``` {.php}
<?php

// try is one expression only
try {
    $database->query($query);
} catch (DatabaseException $e) {
    // process exception
}

// Too many expressions around the one that may actually emit the exception
try {
    $SQL = build_query($arguments);
    $database = new Database($dsn);
    $database->setOption($options);
    $statement = $database->prepareQuery($SQL);
    $result = $statement->query($query);
} catch (DatabaseException $e) {
    // process exception
}

?>
```

This analysis reports try blocks that are 5 lines or more. This
threshold may be configured with the directive `tryBlockMaxSize`. Catch
clause, and finally are not considered here.

### Suggestions

-   Reduce the amount of code in the block, by moving it before and
    after

  ----------------- --------- --------- ----------------------------------------
  Name              Default   Type      Description

  tryBlockMaxSize   5         integer   Maximal number of expressions in the try
                                        block.
  ----------------- --------- --------- ----------------------------------------

  ------------- ---------------------------------
  Short name    Exceptions/LargeTryBlock

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

List Short Syntax
-----------------

Usage of short syntax version of [list()](https://www.php.net/list).

``` {.php}
<?php

// PHP 7.1 short list syntax
// PHP 7.1 may also use key => value structures with list
[$a, $b, $c] = ['2', 3, '4'];

// PHP 7.0 list syntax
list($a, $b, $c) = ['2', 3, '4'];

?>
```

  ---------- ----------------------------------------------------------------
  Short name Php/ListShortSyntax

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.1 and more recent
  Version    

  Severity   Major

  Time To    Quick (30 mins)
  Fix        
  ---------- ----------------------------------------------------------------

List With Appends
-----------------

[List()](https://www.php.net/list) behavior has changed in PHP 7.0 and
it has impact on the indexing when list is used with the \[\] operator.

``` {.php}
<?php

$x = array();
list($x[], $x[], $x[]) = [1, 2, 3];

print_r($x);

?>
```

In PHP 7.0, results are ::

    Array
    (
        [0] => 1
        [1] => 2
        [2] => 3
    )

In PHP 5.6, results are ::

    Array
    (
        [0] => 3
        [1] => 2
        [2] => 1
    )

### Suggestions

-   Refactor code to avoid using append in a list() call

  ------------- ----------------------------------------
  Short name    Php/ListWithAppends

  Rulesets      `CompatibilityPHP70`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

List With Keys
--------------

Setting keys when using [list()](https://www.php.net/list) is a PHP 7.1
feature.

``` {.php}
<?php

// PHP 7.1 and later only
list('a' => $a, 'b' => $b) = ['b' => 1, 'c' => 2, 'a' => 3];

?>
```

  ---------- ----------------------------------------------------------------
  Short name Php/ListWithKeys

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.1 and more recent
  Version    

  Severity   Major

  Time To    Quick (30 mins)
  Fix        
  ---------- ----------------------------------------------------------------

List With Reference
-------------------

Support for references in list calls is not backward compatible with
older versions of PHP. The support was introduced in PHP 7.3.

``` {.php}
<?php

$array = [1,2,3];

[$c, &$d, $e] = $a;

$d++; 
$c++;
print_r($array);
/*
displays
Array
(
    [0] => 1  // Not a reference to $c, unchanged
    [1] => 3  // Reference from $d
    [2] => 3
)
*/
?>
```

See also [list() Reference
Assignment](https://wiki.php.net/rfc/list_reference_assignment).

### Suggestions

-   Avoid using references in list for backward compatibility

  ---------- ------------------------------------------------------------------
  Short name Php/ListWithReference

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.3 and more recent
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- ------------------------------------------------------------------

Locally Unused Property
-----------------------

Those properties are defined in a class, and this class doesn\'t have
any method that makes use of them.

While this is syntactically correct, it is unusual that defined
resources are used in a child class. It may be worth moving the
definition to another class, or to move accessing methods to the class.

``` {.php}
<?php

class foo {
    public $unused, $used;// property $unused is never used in this class

    function bar() {
        $this->used++; // property $used is used in this method
    }
}

class foofoo extends foo {
    function bar() {
        $this->unused++; // property $unused is used in this method, but defined in the parent class
    }
}

?>
```

### Suggestions

-   Move the property definition to the child classes
-   Move some of the child method, using the property, to the parent
    class

  ------------- -------------------------------------------
  Short name    Classes/LocallyUnusedProperty

  Rulesets      `Dead code <dead-code>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- -------------------------------------------

Logical Mistakes
----------------

Avoid logical mistakes within long expressions.

Sometimes, the logic is not what it seems. It is important to check the
actual impact of every part of the logical expression. Do not hesitate
to make a table with all possible cases. If those cases are too
numerous, it may be time to rethink the whole expression.

``` {.php}
<?php 

// Always true
if ($a != 1 || $a != 2) { } 

// $a == 1 is useless
if ($a == 1 || $a != 2) {}

// Always false
if ($a == 1 && $a == 2) {}

// $a != 2 is useless
if ($a == 1 && $a != 2) {}

?>
```

Based on article from `Andrey Karpov` [Logical Expressions in C/C++.
Mistakes Made by Professionals](http://www.viva64.com/en/b/0390/)

### Suggestions

-   Change the expressions for them to have a real meaning

  ---------- -------------------------------------------------------------
  Short name Structures/LogicalMistakes

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Critical

  Time To    Quick (30 mins)
  Fix        

  Examples   `dolibarr-structures-logicalmistakes`{.interpreted-text
             role="ref"},
             `cleverstyle-structures-logicalmistakes`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Logical Operators Favorite
--------------------------

PHP has two sets of logical operators : letters (and, or, xor) and chars
(&&, \|\|, \^).

The analyzed code has less than 10% of one of the two sets : for
consistency reasons, it is recommended to make them all the same.

Warning : the two sets of operators have different precedence levels.
Using and or && is not exactly the same, especially and not only, when
assigning the results to a variable.

``` {.php}
<?php 

$a1 = $b and $c;
$a1 = $b and $c;
$a1 = $b and $c;
$a1 = $b or $c;
$a1 = $b OR $c;
$a1 = $b and $c;
$a1 = $b and $c;
$a1 = $b and $c;
$a1 = $b or $c;
$a1 = $b OR $c;
$a1 = $b ^ $c;

?>
```

Using and or && are also the target of other analysis.

See also [Logical
Operators](https://www.php.net/manual/en/language.operators.logical.php)
and [Operators
Precedence](https://www.php.net/manual/en/language.operators.precedence.php).

### Suggestions

-   Pick a favorite, and enforce it

  ------------ --------------------------------
  Short name   Php/LetterCharsLogicalFavorite

  Rulesets     `Top10`{.interpreted-text
               role="ref"}
  ------------ --------------------------------

Logical Should Use Symbolic Operators
-------------------------------------

Logical operators come in two flavors : and / &&, \|\| / or, \^ / xor.
However, they are not exchangeable, as && and and have different
precedence.

``` {.php}
<?php

// Avoid lettered operator, as they have lower priority than expected
$a = $b and $c;
// $a === 3 because equivalent to ($a = $b) and $c;

// safe way to write the above : 
$a = ($b and $c);

$a = $b && $c;
// $a === 1

?>
```

It is recommended to use the symbol operators, rather than the letter
ones.

See also [Logical
Operators](https://www.php.net/manual/en/language.operators.logical.php).

### Suggestions

-   Change the letter operators to the symbol one : and =\> &&, or =\>
    \|\|, xor =\> \^. Review the new expressions as processing order may
    have changed.
-   Add parenthesis to make sure that the order is the expected one

  ---------- ------------------------------------------------------------------------------------------------
  Short name Php/LogicalInLetters

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `Suggestions`{.interpreted-text role="ref"},
             `Top10`{.interpreted-text role="ref"}, `php-cs-fixable`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [no-letter-logical](https://github.com/dseguy/clearPHP/tree/master/rules/no-letter-logical.md)

  Examples   `cleverstyle-php-logicalinletters`{.interpreted-text role="ref"},
             `openconf-php-logicalinletters`{.interpreted-text role="ref"}
  ---------- ------------------------------------------------------------------------------------------------

Logical To in\_array {#logical-to-in\\_array}
--------------------

Multiples exclusive comparisons may be replaced by
[in\_array()](https://www.php.net/in_array).

[in\_array()](https://www.php.net/in_array) makes the alternatives more
readable, especially when the number of alternatives is large. In fact,
the list of alternative may even be set in a variable, and centralized
for easier management.

Even two \'or\' comparisons are slower than using a
[in\_array()](https://www.php.net/in_array) call. More calls are even
slower than just two. This is a micro-optimisation : speed gain is low,
and marginal. Code centralisation is a more significant advantage.

``` {.php}
<?php

// Set the list of alternative in a variable, property or constant. 
$valid_values = array(1, 2, 3, 4);
if (in_array($a, $valid_values) ) {
    // doSomething()
}

if ($a == 1 || $a == 2 || $a == 3 || $a == 4) {
    // doSomething()
}

// in_array also works with strict comparisons
if (in_array($a, $valid_values, true) ) {
    // doSomething()
}

if ($a === 1 || $a === 2 || $a === 3 || $a === 4) {
    // doSomething()
}

?>
```

See also [in\_array()](https://www.php.net/in_array).

### Suggestions

-   Replace the list of comparisons with a in\_array() call on an array
    filled with the various values
-   Replace the list of comparisons with a isset() call on a hash whose
    keys are the various values

  ------------- -----------------------------------------------------------
  Short name    Performances/LogicalToInArray

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     Very high

  Examples      `zencart-performances-logicaltoinarray`{.interpreted-text
                role="ref"}
  ------------- -----------------------------------------------------------

Lone Blocks
-----------

Any grouped code without a commanding structure is useless.

Blocks are compulsory when defining a structure, such as a class or a
function. They are most often used with flow control instructions, like
if then or switch.

Blocks are also valid syntax that group several instructions together,
though they have no effect at all, except confuse the reader. Most
often, it is a ruin from a previous flow control instruction, whose
condition was removed or commented. They should be removed.

``` {.php}
<?php

    // Lone block
    //foreach($a as $b) 
    {
        $b++;
    }
?>
```

### Suggestions

-   Remove the useless curly brackets

  ----------- -----------------------------------------------------------
  Short name  Structures/LoneBlock

  Rulesets    `Analyze`{.interpreted-text role="ref"},
              `CI-checks`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Instant (5 mins)

  Examples    `thinkphp-structures-loneblock`{.interpreted-text
              role="ref"},
              `tine20-structures-loneblock`{.interpreted-text role="ref"}
  ----------- -----------------------------------------------------------

Long Arguments
--------------

Long arguments should be put in variable, to preserve readability.

When literal arguments are too long, they
[break](https://www.php.net/manual/en/control-structures.break.php) the
hosting structure by moving the next argument too far on the right.
Whenever possible, long arguments should be set in a local variable to
keep the readability.

``` {.php}
<?php

// Now the call to foo() is easier to read.
$reallyBigNumber = <<<BIGNUMBER
123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890
BIGNUMBER
foo($reallyBigNumber, 2, '12345678901234567890123456789012345678901234567890');

// where are the next arguments ? 
foo('123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890', 2, '123456789012345678901234567890123456789012345678901234567890');

// This is still difficult to read
foo(<<<BIGNUMBER
123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890
BIGNUMBER
, 2, '123456789012345678901234567890123456789012345678901234567890');

?>
```

Literal strings and heredoc strings, including variables, that are over
50 chars longs are reported here.

### Suggestions

-   Put the long arguments in a separate variable, and use the variable
    in the second expression, reducing its total length

  ------------- --------- --------- -------------------------------------------------
  Name          Default   Type      Description

  codeTooLong   100       integer   Minimum size of a functioncall or a methodcall to
                                    be considered too long.
  ------------- --------- --------- -------------------------------------------------

  ---------- -------------------------------------------------------------
  Short name Structures/LongArguments

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `cleverstyle-structures-longarguments`{.interpreted-text
             role="ref"},
             `contao-structures-longarguments`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Lost References
---------------

Either avoid references, or propagate them correctly.

When assigning a referenced variable with another reference, the initial
reference is lost, while the intend was to transfer the content.

``` {.php}
<?php

function foo(&$lostReference, &$keptReference)
{
    $c = 'c';

    // $lostReference was a reference, but now, it is another
    $lostReference =& $c;
    // $keptReference was a reference : now it contains the actual value
    $keptReference = $c;
}

$bar = 'bar';
$bar2 = 'bar';
foo($bar, $bar2); 

//displays bar c, instead of bar bar
print $bar. ' '.$bar2;

?>
```

Do not reassign a reference with another reference. Assign new content
to the reference to change its value.

### Suggestions

-   Always assign new value to an referenced argument, and don\'t
    reassign a new reference

  ------------- --------------------------------------------------------
  Short name    Variables/LostReferences

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Examples      `wordpress-variables-lostreferences`{.interpreted-text
                role="ref"}
  ------------- --------------------------------------------------------

Magic Visibility
----------------

The class magic methods must have public visibility and cannot be
[static](https://www.php.net/manual/en/language.oop5.static.php).

``` {.php}
<?php

class foo{
    // magic method must bt public and non-static
    public static function __clone($name) {    }

    // magic method can't be private
    private function __get($name) {    }

    // magic method can't be protected
    private function __set($name, $value) {    }

    // magic method can't be static
    public static function __isset($name) {    }
}

?>
```

See also [Magic
methods](https://www.php.net/manual/en/language.oop5.magic.php).

  ------------- ----------------------------------------
  Short name    Classes/toStringPss

  Rulesets      `CompatibilityPHP70`{.interpreted-text
                role="ref"}

  Php Version   With PHP 5.4 and older

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Make Global A Property
----------------------

Calling global (or \$GLOBALS) in methods is slower and less testable
than setting the global to a property, and using this property.

Using properties is slightly faster than calling global or \$GLOBALS,
though the gain is not important.

Setting the property in the constructor (or in a factory), makes the
class easier to test, as there is now a single point of configuration.

``` {.php}
<?php 

// Wrong way
class fooBad {
    function x() {
        global $a;
        $a->do();
        // Or $GLOBALS['a']->do();
    }
}

class fooGood {
    private $bar = null;

    function __construct() {
        global $bar; 
        $this->bar = $bar;
        // Even better, do this via arguments
    }

    function x() {
        $this->a->do();
    }
}

?>
```

### Suggestions

-   Avoid using global variables, and use properties instead
-   Remove the usage of these global variables

  ------------- -----------------------------
  Short name    Classes/MakeGlobalAProperty

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- -----------------------------

Make Magic Concrete
-------------------

Speed up execution by replacing magic calls by concrete properties.

Magic properties are managed dynamically, with `__get`and `__set`. They
replace property access by a methodcall, and they are much slower than
the first.

When a property name is getting used more often, it is worth creating a
concrete property, and skip the method call. The threshold for
\'magicMemberUsage\' is 1, by default.

``` {.php}
<?php

class x {
    private $values = array('a' => 1,
                            'b' => 2);

    function __get($name) {
        return $this->values[$name] ?? '';
    }
}

$x = new x();
// Access to 'a' is repeated in the code, at least 'magicMemberUsage' time (cf configuration below)
echo $x->a; 

?>
```

See also `memoize-magiccall`{.interpreted-text role="ref"}.

### Suggestions

-   Make frequently used properties concrete; keep the highly dynamic as
    magic

  ------------------ --------- --------- -------------------------------------------------
  Name               Default   Type      Description

  magicMemberUsage   1         integer   Minimal number of magic member usage across the
                                         code, to trigger a concrete property.
  ------------------ --------- --------- -------------------------------------------------

  ------------- ----------------------------------
  Short name    Classes/MakeMagicConcrete

  Rulesets      `Performances`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Make One Call With Array
------------------------

Avoid calling the same function several times by batching the calls with
arrays.

Calling the same function to chain modifications tends to be slower than
calling the same function with all the transformations at the same time.
Some PHP functions accept scalars or arrays, and using the later is more
efficient.

``` {.php}
<?php

$string = 'abcdef'; 

//str_replace() accepts arrays as arguments
$string = str_replace( ['a', 'b', 'c'],
                       ['A', 'B', 'C'],
                       $string);

// Too many calls to str_replace
$string = str_replace( 'a', 'A', $string);
$string = str_replace( 'b', 'B', $string);
$string = str_replace( 'c', 'C', $string);

// Too many nested calls to str_replace
$string = str_replace( 'a', 'A', str_replace( 'b', 'B', str_replace( 'c', 'C', $string)));

?>
```

Potential replacements :

  ------------------------------------------------------------------------ -------------------------------------------------------------------------------------
  Function                                                                 Replacement

  [str\_replace()](https://www.php.net/str_replace)                        [str\_replace()](https://www.php.net/str_replace)
  [str\_ireplace()](https://www.php.net/str_ireplace)                      [str\_replace()](https://www.php.net/str_replace)
  [substr\_replace()](https://www.php.net/substr_replace)                  [substr\_replace()](https://www.php.net/substr_replace)
  [preg\_replace()](https://www.php.net/preg_replace)                      [preg\_replace()](https://www.php.net/preg_replace)
  [preg\_replace\_callback()](https://www.php.net/preg_replace_callback)   [preg\_replace\_callback\_array()](https://www.php.net/preg_replace_callback_array)
  ------------------------------------------------------------------------ -------------------------------------------------------------------------------------

``` {.php}
<?php
$subject = 'Aaaaaa Bbb';


//preg_replace_callback_array() is better than multiple preg_replace_callback : 
preg_replace_callback_array(
    [
        '~[a]+~i' => function ($match) {
            echo strlen($match[0]), ' matches for a found', PHP_EOL;
        },
        '~[b]+~i' => function ($match) {
            echo strlen($match[0]), ' matches for b found', PHP_EOL;
        }
    ],
    $subject
);

$result = preg_replace_callback('~[a]+~i', function ($match) {
            echo strlen($match[0]), ' matches for a found', PHP_EOL;
        }, $subject);

$result = preg_replace_callback('~[b]+~i', function ($match) {
            echo strlen($match[0]), ' matches for b found', PHP_EOL;
        }, $subject);

//str_replace() accepts arrays as arguments
$string = str_replace( ['a', 'b', 'c'],
                       ['A', 'B', 'C'],
                       $string);

// Too many calls to str_replace
$string = str_replace( 'a', 'A');
$string = str_replace( 'b', 'B');
$string = str_replace( 'c', 'C');

?>
```

### Suggestions

-   use str\_replace() with arrays as arguments.
-   use preg\_replace() with arrays as arguments.
-   use preg\_replace\_callback() for merging multiple complex calls.

  ---------- ------------------------------------------------------------
  Short name Performances/MakeOneCall

  Rulesets   `Performances`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `humo-gen-performances-makeonecall`{.interpreted-text
             role="ref"},
             `edusoho-performances-makeonecall`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Malformed Octal
---------------

Those numbers starts with a 0, so they are using the PHP octal
convention. Therefore, one can\'t use 8 or 9 figures in those numbers,
as they don\'t belong to the octal base. The resulting number will be
truncated at the first erroneous figure. For example, 090 is actually 0,
and 02689 is actually 22.

``` {.php}
<?php

// A long way to write 0 in PHP 5
$a = 0890; 

// A fatal error since PHP 7

?>
```

Also, note that very large octal, usually with more than 21 figures,
will be turned into a real number and undergo a reduction in precision.

See also
[Integers](https://www.php.net/manual/en/language.types.integer.php).

  ---------- --------------------------------------------------------------
  Short name Type/MalformedOctal

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and older
  Version    

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        
  ---------- --------------------------------------------------------------

Max Level Of Nesting
--------------------

Avoid nesting structures too deep, as it hurts readability.

Nesting structures are : if/then, switch, for, foreach, while,
do\...while. Ternary operator, try/catch are not considered a nesting
structures.

Closures, and more generally, functions definitions are counted
separatedly.

This analysis checks for 4 levels of nesting, by default. This may be
changed by configuration.

``` {.php}
<?php

// 5 levels of indentation
function foo() {
    if (1) {
        if (2) {
            if (3) {
                if (4) {
                    if (5) {
                        51;
                    } else {
                        5;
                    }
                } else {
                    4;
                }
            } else {
                3;
            }
        } else {
            2;
        }
    } else {
        1;
    }
}

// 2 levels of indentation
function foo() {
    if (1) {
        if (2) {
            // 3 levels of indentation
            return function () {
                if (3) {
                    if (4) {
                        if (5) {
                            51;
                        } else {
                            5;
                        }
                    } else {
                        4;
                    }
                } else {
                    3;
                }
            }
        } else {
            2;
        }
    } else {
        1;
    }
}


?>
```

### Suggestions

-   Refactor code to avoid nesting
-   Export some nested blocks to an external method or function

  ---------- --------- --------- -------------------------------------------------
  Name       Default   Type      Description

  maxLevel   4         integer   Maximum level of nesting for control flow
                                 structures in one scope.
  ---------- --------- --------- -------------------------------------------------

  ------------- ---------------------------------
  Short name    Structures/MaxLevelOfIdentation

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Maybe Missing New
-----------------

This functioncall looks like a class instantiation that is missing the
new keyword.

Any function definition was found for that function, but a class with
that name was. New is probably missing.

``` {.php}
<?php

// Functioncall
$a = foo();

// Class definition
class foo {}
// Function definition
function foo {}


// Functioncall
$a = BAR;

// Function definition
class bar {}
// Constant definition
const BAR = 1;


?>
```

### Suggestions

-   Add the new
-   Rename the class to distinguish it from the function
-   Rename the function to distinguish it from the class

  ------------- -----------------------------
  Short name    Structures/MissingNew

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Instant (5 mins)

  Precision     Medium
  ------------- -----------------------------

Mbstring Third Arg
------------------

Some mbstring functions use the third argument for offset, not for
encoding.

Those are the following functions :

-   [mb\_strrichr()](https://www.php.net/mb_strrichr)
-   [mb\_stripos()](https://www.php.net/mb_stripos)
-   [mb\_strrpos()](https://www.php.net/mb_strrpos)
-   [mb\_strstr()](https://www.php.net/mb_strstr)
-   [mb\_stristr()](https://www.php.net/mb_stristr)
-   [mb\_strpos()](https://www.php.net/mb_strpos)
-   [mb\_strripos()](https://www.php.net/mb_strripos)
-   [mb\_strrchr()](https://www.php.net/mb_strrchr)
-   [mb\_strrichr()](https://www.php.net/mb_strrichr)
-   [mb\_substr()](https://www.php.net/mb_substr)

``` {.php}
<?php

// Display BC
echo mb_substr('ABC', 1 , 2, 'UTF8');

// Yields Warning: mb_substr() expects parameter 3 to be int, string given
// Display 0 (aka, substring from 0, for length (int) 'UTF8' => 0)
echo mb_substr('ABC', 1 ,'UTF8');

?>
```

See also [mb\_substr()](https://www.php.net/mb_substr) manual pages.

### Suggestions

-   Add a third argument
-   Use the default encoding (aka, omit both third AND fourth argument)

  ------------- ----------------------------------
  Short name    Structures/MbstringThirdArg

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Mbstring Unknown Encoding
-------------------------

The encoding used is not known to the ext/mbstring extension.

This analysis takes in charge all `mbstring` encoding and aliases. The
full list of supported mbstring encoding is available with
[mb\_list\_encodings()](https://www.php.net/mb_list_encodings). Each
encoding alias is available with
[mb\_encoding\_aliases()](https://www.php.net/mb_encoding_aliases).

``` {.php}
<?php

// Invalid encoding
$str = mb_strtolower($str, 'utf_8');

// Valid encoding
$str = mb_strtolower($str, 'utf8');
$str = mb_strtolower($str, 'UTF8');
$str = mb_strtolower($str, 'UTF-8');

?>
```

See also [ext/mbstring](http://www.php.net/manual/en/book.mbstring.php).

### Suggestions

-   Use a valid mbstring encoding

  ------------- ------------------------------------
  Short name    Structures/MbstringUnknownEncoding

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- ------------------------------------

Memoize MagicCall
-----------------

Cache calls to magic methods in local variable. Local cache is faster
than calling again the magic method as soon as the second call, provided
that the value hasn\'t changed.

`__get` is slower, as it turns a simple member access into a full method
call.

``` {.php}
<?php

class x {
    private $values = array();

    function __get($name) {
        return $this->values[$name];
    }
    // more code to set values to this class
}

function foo(x $b) {
    $a = $b->a; 
    $c = $b->c;

    $d = $c;     // using local cache, no new access to $b->__get($name)
    $e = $b->a;  // Second access to $b->a, through __get
}

function bar(x $b) {
    $a = $b->a; 
    $c = $b->c;

    $b->bar2(); // this changes $b->a and $b->c, but we don't see it

    $d = $b->c; 
    $e = $b->a;  // Second access to $b->a, through __get
}

?>
```

The caching is not possible if the processing of the object changes the
value of the property.

See also [\_\_get performance questions with
PHP](https://stackoverflow.com/questions/3330852/get-set-call-performance-questions-with-php),
`make-magic-concrete`{.interpreted-text role="ref"} and [Benchmarking
magic](https://www.garfieldtech.com/blog/benchmarking-magic).

### Suggestions

-   Cache the value in a local variable, and reuse that variable
-   Make the property concrete in the class, so as to avoid \_\_get()
    altogether

  -------------------- --------- --------- ----------------------------------------------
  Name                 Default   Type      Description

  minMagicCallsToGet   2         integer   Minimal number of calls of a magic property to
                                           make it worth locally caching.
  -------------------- --------- --------- ----------------------------------------------

  ------------- ------------------------------------
  Short name    Performances/MemoizeMagicCall

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------

Merge If Then
-------------

Two successive if/then into one, by merging the two conditions.

``` {.php}
<?php

// two merge conditions
if ($a == 1 && $b == 2) {
    // doSomething()
}

// two distinct conditions
// two nesting
if ($a == 1) {
    if ($b == 2) {
        // doSomething()
    }
}

?>
```

### Suggestions

-   Merge the two structures into one

  ------------- ----------------------------------
  Short name    Structures/MergeIfThen

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Method Collision Traits
-----------------------

Two or more traits are included in the same class, and they have methods
collisions.

Those collisions should be solved with a `use` expression. When they are
not, PHP stops execution with a fatal error :
`Trait method M has not been applied, because there are collisions with other trait methods on C`.

``` {.php}
<?php

trait A {
    public function A() {}
    public function M() {}
}

trait B {
    public function B() {}
    public function M() {}
}

class C {
    use  A, B;
}

class D {
    use  A, B{
        B::M insteadof A;
    };
}

?>
```

The code above lints, but doesn\'t execute.

See also
[Traits](https://www.php.net/manual/en/language.oop5.traits.php).

  ------------- ----------------------------------------
  Short name    Traits/MethodCollisionTraits

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- ----------------------------------------

Method Could Be Private Method
------------------------------

The following methods are never used outside their class of definition.
Given the analyzed code, they could be set as private.

``` {.php}
<?php

class foo {
    public function couldBePrivate() {}
    public function cantdBePrivate() {}

    function bar() {
        // couldBePrivate is used internally. 
        $this->couldBePrivate();
    }
}

class foo2 extends foo {
    function bar2() {
        // cantdBePrivate is used in a child class. 
        $this->cantdBePrivate();
    }
}

//couldBePrivate() is not used outside 
$foo = new foo();

//cantdBePrivate is used outside the class
$foo->cantdBePrivate();

?>
```

Note that dynamic properties (such as \$x-\>\$y) are not taken into
account.

  ------------- ---------------------------------
  Short name    Classes/CouldBePrivateMethod

  Rulesets      `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Method Could Be Static
----------------------

A method that doesn\'t make any usage of
[\$this](https://www.php.net/manual/en/language.oop5.basic.php) could be
turned into a
[static](https://www.php.net/manual/en/language.oop5.static.php) method.

While [static](https://www.php.net/manual/en/language.oop5.static.php)
methods are usually harder to handle, recognizing the
[static](https://www.php.net/manual/en/language.oop5.static.php) status
is a first step before turning the method into a standalone function.

``` {.php}
<?php

class foo {
    static $property = 1;

    // legit static method
    static function staticMethod() {
        return self::$property;
    }

    // This is not using $this, and could be static
    function nonStaticMethod() {
        return self::$property;
    }

    // This is not using $this nor self, could be a standalone function
    function nonStaticMethod() {
        return self::$property;
    }
}

?>
```

### Suggestions

-   Make the method static
-   Make the method a standalone function
-   Make use of \$this in the method : may be it was forgotten.

  ---------- -------------------------------------------------------------
  Short name Classes/CouldBeStatic

  Rulesets   none

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `fuelcms-classes-couldbestatic`{.interpreted-text
             role="ref"},
             `expressionengine-classes-couldbestatic`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Method Signature Must Be Compatible
-----------------------------------

Make sure methods signature are compatible.

PHP generates the infamous Fatal error at execution :
`Declaration of FooParent\:\:Bar() must be compatible with FooChildren\:\:Bar()`

``` {.php}
<?php

class x {
    function xa() {}
}

class xxx extends xx {
    function xa($a) {}
}

?>
```

### Suggestions

-   Fix the child class method() signature.
-   Fix the parent class method() signature, after checking that it
    won\'t affect the other children.

  ------------- -----------------------------------------
  Short name    Classes/MethodSignatureMustBeCompatible

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------------------

Methodcall On New
-----------------

It is possible to call a method right at object instantiation.

This syntax was added in PHP 5.4+. Before, this was not possible : the
object had to be stored in a variable first.

``` {.php}
<?php

// Data is collected
$data = data_source();

// Data is saved, but won't be reused from this databaseRow object. It may be ignored.
$result = (new databaseRow($data))->save();

// The actual result of the save() is collected and tested.
if ($result !== true) {
    processSaveError($data);
}

?>
```

This syntax is interesting when the object is not reused, and may be
discarded

  ------------- ----------------------------------------
  Short name    Php/MethodCallOnNew

  Rulesets      `CompatibilityPHP53`{.interpreted-text
                role="ref"}

  Php Version   With PHP 5.4 and more recent

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Methods Without Return
----------------------

List of all the function, closures, methods that have no explicit
return.

Functions that hold the `void` return type are omitted.

``` {.php}
<?php

// With return null : Explicitly not returning
function withExplicitReturn($a = 1) {
    $a++;
    return null;
}

// Without indication
function withoutExplicitReturn($a = 1) {
    $a++;
}

// With return type void : Explicitly not returning
function withExplicitReturnType($a = 1) : void {
    $a++;
}

?>
```

See also [return](https://www.php.net/manual/en/function.return.php).

### Suggestions

-   Add the returntype \'void\' to make this explicit behavior

  ------------- -----------------------------
  Short name    Functions/WithoutReturn

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     Very high
  ------------- -----------------------------

Minus One On Error
------------------

Some PHP native functions return -1 on error. They also return 1 in case
of success, and 0 in case of failure. This leads to confusions.

In case the native function is used as a condition without explicit
comparison, PHP type cast the return value to a boolean. In this case,
-1 and 1 are both converted to true, and the condition applies. This
means that an error situation is mistaken for a successful event.

``` {.php}
<?php

// Proper check of the return value
if (openssl_verify($data, $signature, $public) === 1) {
    $this->loginAsUser($user);
}

// if this call fails, it returns -1, and is confused with true
if (openssl_verify($data, $signature, $public)) {
    $this->loginAsUser($user);
}
?>
```

This analysis searches for if/then structures, ternary operators inside
[while()](https://www.php.net/manual/en/control-structures.while.php) /
do\...[while()](https://www.php.net/manual/en/control-structures.while.php)
loops.

See also [Can you spot the vulnerability?
(openssl\_verify)](https://twitter.com/ripstech/status/1124325237967994880)
and [Incorrect Signature
Verification](https://snyk.io/vuln/SNYK-PHP-SIMPLESAMLPHPSIMPLESAMLPHPMODULEINFOCARD-70167).

### Suggestions

-   Compare explicitly the return value to 1

  ------------- ------------------------------
  Short name    Security/MinusOneOnError

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Instant (5 mins)
  ------------- ------------------------------

Mismatch Parameter And Type
---------------------------

When the name of the parameter contradicts the type of the parameter.

This is mostly semantics, so it will affect the coder and the auditor of
the code. PHP is immune to those errors.

``` {.php}
<?php

// There is a discrepancy between the typehint and the name of the variable
function foo(int $string) { }

// The parameter name is practising coding convention typehints
function bar(int $int) { }

?>
```

### Suggestions

-   Synch the name of the parameter and the typehint.

  ------------- ------------------------------------
  Short name    Functions/MismatchParameterAndType

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `Semantics`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------

Mismatch Parameter Name
-----------------------

Parameter name change in overwritten method. This may lead to errors
when using PHP 8.0 named arguments.

PHP use the name of the parameter in the method whose code is executed.
When the name change between the method and the overwritten method, the
consistency is broken.

``` {.php}
<?php

class x {
    function getValue($name) {}
}

class y extends x {
    // consistent with the method above
    function getValue($name) {}
}

class z extends x {
    // inconsistent with the method above
    function getValue($label) {}
}

?>
```

Here is another example, in early PHP 8.0 (courtesy of
[Carnage](https://twitter.com/giveupalready)).

``` {.php}
<?php

interface Pager 
{
    public function fetch($page = 0, ...$categories);
}

class DbPager implements Pager
{
    public function fetch($seite = 0, ...$kategorien)
    {
        var_dump($kategorien);
    }
}

$dbPager = new DbPager();
$dbPager->fetch(page: 1, categories: 2);

?>
```

### Suggestions

-   Make sure all the names are the same, between methods

  ------------- -------------------------------------------
  Short name    Functions/MismatchParameterName

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CompatibilityPHP80`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------------------

Mismatch Properties Typehints
-----------------------------

Properties must match within the same family.

When a property is declared both in a
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
class, and a child class, they must have the same type. The same type
includes a possible null value.

This doesn\'t apply to private properties, which are only visible
locally.

\<?php

// property \$p is declared as an object of type a class x { protected A
\$p; }

// property \$p is declared again, this time without a type class a
extends x { protected \$p; }

This code will lint, but not execute.

### Suggestions

-   Remove some of the property declarations, and only keep it in the
    highest ranking parent
-   Match the typehints of the property declarations
-   Make the properties private
-   Remove the child class (or the parent class)

  ------------- ---------------------------------------------------------
  Short name    Classes/MismatchProperties

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text role="ref"},
                `ClassReview`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------------------------------

Mismatch Type And Default
-------------------------

The argument typehint and its default value don\'t match.

The code may lint and load, and even work when the arguments are
provided. Though, PHP won\'t eventually execute it.

Most of the mismatch problems are caught by PHP at linting time. It
displays the following error message : \'Argument 1 passed to foo() must
be of the type integer, string given\'.

The default value may be a constant (normal or class constant) : as
such, PHP might find its value only at execution time, from another
include. As such, PHP doesn\'t report anything about the situation at
compile time.

The default value may also be a constant scalar expression : since PHP
7, some of the simple operators such as +, -, *, %, \`*\*
\<<https://www.php.net/manual/en/language.operators.arithmetic.php>\>\`\_,
etc. are available to build default values. Among them, the ternary
operator and Coalesce. Again, those expression may be only evaluated at
execution time, when the value of the constants are known.

``` {.php}
<?php

// bad definition : the string is actually an integer
const STRING = 3;

function foo(string $s = STRING) {
    echo $s;
}

// works without problem
foo('string');

// Fatal error at compile time
foo();

// Fail only at execution time (missing D), and when default is needed
function foo2(string $s = D ? null : array()) {
    echo $s;
}

?>
```

PHP reports typehint and default mismatch at compilation time, unless
there is a
[static](https://www.php.net/manual/en/language.oop5.static.php)
expression that can\'t be resolved within the compiled file : then it is
checked only at runtime, leading to a Fatal error.

See also [Type
declarations](https://www.php.net/manual/en/functions.arguments.php#functions.arguments.type-declaration).

### Suggestions

-   Match the typehint with the default value
-   Do not rely on PHP type juggling to change the type on the fly

  ------------- ---------------------------------------------------------
  Short name    Functions/MismatchTypeAndDefault

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text role="ref"},
                `Typechecks`{.interpreted-text role="ref"}

  Severity      Critical

  Time To Fix   Slow (1 hour)
  ------------- ---------------------------------------------------------

Mismatched Default Arguments
----------------------------

Arguments are relayed from one method to the other, and the arguments
have different default values.

Although it is possible to have different default values, it is worth
checking why this is actually the case.

``` {.php}
<?php

function foo($a = null, $b = array() ) {
    // foo method calls directly bar. 
    // When argument are provided, it's OK
    // When argument are omited, the default value is not the same as the next method
    bar($a, $b);
}

function bar($c = 1, $d = array() ) {

}

?>
```

### Suggestions

-   Synchronize default values to avoid surprises
-   Drop some of the default values

  ------------- ---------------------------------------------------------------
  Short name    Functions/MismatchedDefaultArguments

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `Typechecks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `spip-functions-mismatcheddefaultarguments`{.interpreted-text
                role="ref"}
  ------------- ---------------------------------------------------------------

Mismatched Ternary Alternatives
-------------------------------

A ternary operator should yield the same type on both branches.

Ternary operator applies a condition, and yield two different results.
Those results will then be processed by code that expects the same
types. It is recommended to match the types on both branches of the
ternary operator.

``` {.php}
<?php

// $object may end up in a very unstable state
$object = ($type == 'Type') ? new $type() : null;

//same result are provided by both alternative, though process is very different
$result = ($type == 'Addition') ? $a + $b : $a * $b;

//Currently, this is omitted
$a = 1;
$result = empty($condition) ? $a : 'default value';
$result = empty($condition) ? $a : getDefaultValue();

?>
```

### Suggestions

-   Use compatible data type in both branch of the alternative
-   Turn the ternary into a if/then, with different processing

  ---------- -------------------------------------------------------------
  Short name Structures/MismatchedTernary

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Suggestions`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `phpadsnew-structures-mismatchedternary`{.interpreted-text
             role="ref"},
             `openemr-structures-mismatchedternary`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Mismatched Typehint
-------------------

Relayed arguments don\'t have the same typehint.

Typehint acts as a filter method. When an object is checked with a first
class, and then checked again with a second distinct class, the whole
process is always false : \$a can\'t be of two different classes at the
same time.

``` {.php}
<?php

// Foo() calls bar()
function foo(A $a, B $b) {
    bar($a, $b);
}

// $a is of A typehint in both methods, but 
// $b is of B then BB typehing
function bar(A $a, BB $b) {

}

?>
```

Note : This analysis currently doesn\'t check generalisation of classes
: for example, when B is a child of BB, it is still reported as a
mismatch.

### Suggestions

-   Ensure that the default value match the expected typehint.

  ------------- ------------------------------------------------------------
  Short name    Functions/MismatchedTypehint

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `Typechecks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Precision     High

  Examples      `wordpress-functions-mismatchedtypehint`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------------

Missing Abstract Method
-----------------------

Abstract methods must have a non-abstract version for the class to be
complete. A class that is missing one abstract definition cannot be
instantiated.

``` {.php}
<?php

// This is a valid definition
class b extends a {
    function foo() {}
    function bar() {}
}

// This compiles, but will emit a fatal error if instantiated
class c extends a {
    function bar() {}
}

// This illustration lint but doesn't run.
// moving this class at the beginning of the code will make lint fail
abstract class a {
    abstract function foo() ;
}

?>
```

See also [Classes
Abstraction](https://www.php.net/manual/en/language.oop5.abstract.php).

### Suggestions

-   Implement the missing methods
-   Remove the partially implemented class
-   Mark the partially implemented class abstract

  ------------- ------------------------------------
  Short name    Classes/MissingAbstractMethod

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------

Missing Cases In Switch
-----------------------

It seems that some cases are missing in this switch structure.

When comparing two different
[switch()](https://www.php.net/manual/en/control-structures.switch.php)
structures, it appears that some cases are missing in one of them. The
set of cases are almost identical, but one of the values are missing.

[Switch()](https://www.php.net/manual/en/control-structures.switch.php)
structures using strings as literals are compared in this analysis. When
the discrepancy between two lists is below 25%, both switches are
reported.

``` {.php}
<?php

// This switch operates on a, b, c, d and default 
switch($a) {
    case 'a': doSomethingA(); break 1;
    case 'b': doSomethingB(); break 1;
    case 'c': doSomethingC(); break 1;
    case 'd': doSomethingD(); break 1;
    default: doNothing();
}

// This switch operates on a, b, d and default 
switch($o->p) {
    case 'a': doSomethingA(); break 1;
    case 'b': doSomethingB(); break 1;

    case 'd': doSomethingD(); break 1;
    default: doNothing();
}

?>
```

In the example, one may argue that the \'c\' case is actually handled by
the \'default\' case. Otherwise, business logic may request that
omission.

### Suggestions

-   Add the missing cases
-   Add comments to mention that missing cases are processed in the
    default case

  ------------- ------------------------------------------------------
  Short name    Structures/MissingCases

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Examples      `tikiwiki-structures-missingcases`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------

Missing Include
---------------

The included files doesn\'t exists in the repository. The inclusions
target a files that doesn\'t exist.

The analysis works with every type of inclusion : include(), require(),
include\_once() and require\_once(). It also works with parenthesis when
used as parameter delimiter.

The analysis doesn\'t take into account `include_path`. This may yield
false positives.

``` {.php}
<?php

include 'non_existent.php';

// variables are not resolved. This won't be reported.
require ($path.'non_existent.php');

?>
```

Missing included files may lead to a fatal error, a warning or other
error later in the execution.

  ------------------------------ --------- -------- ---------------------------------------------------------------
  Name                           Default   Type     Description

  constant\_or\_variable\_name   100       string   Literal value to be used when including files. For example, by
                                                    configuring \'Files\_MissingInclude\[\"HOME\_DIR\"\] =
                                                    \"/tmp/myDir/\";\', then \'include HOME\_DIR .
                                                    \"my\_class.php\"; will be actually be used as
                                                    \'/tmp/myDir/my\_class.php\'. Constants must be configured with
                                                    their correct case. Variable must be configured with their
                                                    initial \'\$\'. Configure any number of variable and constant
                                                    names.
  ------------------------------ --------- -------- ---------------------------------------------------------------

  ------------- -----------------------------
  Short name    Files/MissingInclude

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Instant (5 mins)
  ------------- -----------------------------

Missing Parenthesis
-------------------

Add parenthesis to those expression to prevent bugs.

``` {.php}
<?php

// Missing some parenthesis!!
if (!$a instanceof Stdclass) {
    print Not\n;
} else {
    print Is\n;
}

// Could this addition be actually
$c = -$a + $b;

// This one ? 
$c = -($a + $b);

?>
```

See also [Operators
Precedence](https://www.php.net/manual/en/language.operators.precedence.php).

  ------------- ----------------------------------
  Short name    Structures/MissingParenthesis

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)
  ------------- ----------------------------------

Missing Some Returntype
-----------------------

The specified typehints are not compatible with the returned values.

The code of the method may return other types, which are not specified
and will lead to a PHP fatal error. It is the case for insufficient
typehints, when a typehint is missing, or inconsistent typehints, when
the method returns varied types.

``` {.php}
<?php

// correct return typehint
function fooSN() : ?string  {
    return shell_exec('ls -hla');
}

// insufficient return typehint
// shell_exec() may return null or string. Here, only string in specified for fooS, and that may lead to a Fatal error
function fooS() : string  {
    return shell_exec('ls -hla');
}

// inconsistent return typehint
function bar() : int {
    return rand(0, 10) ? 1 : b;
}

?>
```

The analysis reports a method when it finds other return types than the
one expected. In the case of multiple typehints, as for the last
example, the PHP code may require an upgrade to PHP 8.0.

### Suggestions

-   Update the typehint to accept more types
-   Update the code of the method to fit the expected returntype

  ------------- ----------------------------------
  Short name    Typehints/MissingReturntype

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     Very high
  ------------- ----------------------------------

Missing Typehint
----------------

No typehint was found for this parameter, or as a return type for the
function.

void is considered a specified typehint, and is not reported here.

``` {.php}
<?php

function foo($no_typehint) : void {}

function no_return_type() {}

?>
```

See also [Type
Declaration](https://www.php.net/manual/en/functions.arguments.php#functions.arguments.type-declaration).

### Suggestions

-   

  ------------- --------------------------------
  Short name    Functions/MissingTypehint

  Rulesets      `Typechecks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- --------------------------------

Mistaken Concatenation
----------------------

A unexpected structure is built for initialization. It may be a typo
that creates an unwanted expression.

``` {.php}
<?php

// This 'cd' is unexpected. Isn't it 'c', 'd' ? 
$array = array('a', 'b', 'c'. 'd');
$array = array('a', 'b', 'c', 'd');

// This 4.5 is unexpected. Isn't it 4, 5 ? 
$array = array(1, 2, 3, 4.5);
$array = array(1, 2, 3, 4, 5);

?>
```

  ------------- -------------------------------------------------------------
  Short name    Arrays/MistakenConcatenation

  Rulesets      `Coding Conventions <coding-conventions>`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)
  ------------- -------------------------------------------------------------

Mixed Concat And Interpolation
------------------------------

Mixed usage of concatenation and string interpolation is error prone. It
is harder to read, and leads to overlooking the concatenation or the
interpolation.

``` {.php}
<?php

// Concatenation string
$a = $b . 'c' . $d;

// Interpolation strings
$a = {$b}c{$d};   // regular form
$a = {$b}c$d;     // irregular form

// Mixed Concatenation and Interpolation string
$a = {$b}c . $d;
$a = $b . c$d;
$a = $b . c{$d};

// Mixed Concatenation and Interpolation string with constant
$a = {$b}c . CONSTANT;

?>
```

Fixing this issue has no impact on the output. It makes code less error
prone.

There are some situations where using concatenation are compulsory :
when using a constant, calling a function, running a complex expression
or make use of the escape sequence. You may also consider pushing the
storing of such expression in a local variable.

### Suggestions

-   Only use one type of variable usage : either interpolation, or
    concatenation

  ---------- ------------------------------------------------------------------
  Short name Structures/MixedConcatInterpolation

  Rulesets   `Coding Conventions <coding-conventions>`{.interpreted-text
             role="ref"}, `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `suitecrm-structures-mixedconcatinterpolation`{.interpreted-text
             role="ref"},
             `edusoho-structures-mixedconcatinterpolation`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------------

Mixed Keys Arrays
-----------------

Avoid mixing constants and literals in array keys.

When defining default values in arrays, it is recommended to avoid
mixing constants and literals, as PHP may mistake them and overwrite the
previous with the latter.

Either switch to a newer version of PHP (5.5 or newer), or make sure the
resulting array hold the expected data. If not, reorder the definitions.

``` {.php}
<?php

const ONE = 1;

$a = [ 1   => 2,
       ONE => 3];

?>
```

### Suggestions

-   Use only literals or constants when building the array

  ------------- ------------------------------------------------------
  Short name    Arrays/MixedKeys

  Rulesets      `CompatibilityPHP53`{.interpreted-text role="ref"},
                `CompatibilityPHP54`{.interpreted-text role="ref"}

  Php Version   With PHP 5.6 and more recent

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- ------------------------------------------------------

Mkdir Default
-------------

[mkdir()](https://www.php.net/mkdir) gives universal access to created
folders, by default. It is recommended to gives limited set of rights
(0755, 0700), or to explicitly set the rights to 0777.

``` {.php}
<?php

// By default, this dir is 777
mkdir('/path/to/dir');

// Explicitely, this is wanted. It may also be audited easily
mkdir('/path/to/dir', 0777);

// This dir is limited to the current user. 
mkdir('/path/to/dir', 0700);

?>
```

See also [Why 777 Folder Permissions are a Security
Risk](https://www.spiralscripts.co.uk/Blog/why-777-folder-permissions-are-a-security-risk.html).

### Suggestions

-   Always use the lowest possible privileges on folders
-   Don\'t use the PHP default : at least, make it explicit that the
    \'universal\' rights are voluntary

  ----------- -----------------------------------------------------------
  Short name  Security/MkdirDefault

  Rulesets    `Security`{.interpreted-text role="ref"}

  Severity    Major

  Time To Fix Quick (30 mins)

  Examples    `mautic-security-mkdirdefault`{.interpreted-text
              role="ref"},
              `openemr-security-mkdirdefault`{.interpreted-text
              role="ref"}
  ----------- -----------------------------------------------------------

Modernize Empty With Expression
-------------------------------

[empty()](https://www.php.net/empty) accepts expressions as argument.
This feature was added in PHP 5.5.

There is no need to store the expression in a variable before testing,
unless it is reused later.

``` {.php}
<?php

// PHP 5.5+ empty() usage
if (empty(foo($b . $c))) {
    doSomethingWithoutA();
}

// Compatible empty() usage
$a = foo($b . $c);
if (empty($a)) {
    doSomethingWithoutA();
}

// $a2 is reused, storage is legit
$a2 = strtolower($b . $c);
if (empty($a2)) {
    doSomething();
} else {
    echo $a2;
}

?>
```

See also [empty()](https://www.php.net/empty) and [empty() supports
arbitrary
expressions](https://www.php.net/manual/en/migration55.new-features.php#migration55.new-features.empty).

### Suggestions

-   Avoid the temporary variable, and use directly empty()

  ------------- ------------------------------
  Short name    Structures/ModernEmpty

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Php Version   With PHP 5.5 and more recent

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

Modified Typed Parameter
------------------------

Reports modified parameters, which have a non-scalar typehint. Such
variables should not be changed within the body of the method. Unlike
typed properties, which always hold the expected type, typed parameters
are only garanteed type at the beginning of the method block.

``` {.php}
<?php

class x {

    function foo(Y $y) {
        // $y is type Y

        // A cast version of $y is stored into $yAsString. $y is untouched.
        $yAsString = (string) $y;

        // $y is of type 'int', now.
        $y = 1;

        // Some more code

        // display the string version.
        echo $yAsString; 
        // so, Y $y is now raising an error
        echo $y->name; 
    }
}

?>
```

This problem doesn\'t apply to scalar types : by default, PHP pass
scalar parameters by value, not by reference. Class types are always
passed by reference.

This problem is similar to [Classes/DontUnsetProperties]() : the
[static](https://www.php.net/manual/en/language.oop5.static.php)
specification of the property may be unset, leading to confusing
\'undefined property\', while the class hold the property definition.

### Suggestions

-   Use different variable names when convertir a parameter to a
    different type.
-   Only use methods and properties calls on a typed parameter.

  ------------- ------------------------------------
  Short name    Functions/ModifyTypedParameter

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------

Multiple Alias Definitions
--------------------------

Some aliases are representing different classes across the repository.
This leads to potential confusion.

Across an application, it is recommended to use the same namespace for
one alias. Failing to do this lead to the same keyword to represent
different values in different files, with different behavior. Those are
hard to find bugs.

``` {.php}
<?php

namespace A {
    use d\d; // aka D
}

// Those are usually in different files, rather than just different namespaces.

namespace B {
    use b\c as D; // also D. This could be named something else
}

?>
```

### Suggestions

-   Give more specific names to classes
-   Use an alias \'use AB ac BC\' to give locally another name

  ---------- -------------------------------------------------------------------
  Short name Namespaces/MultipleAliasDefinitions

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `churchcrm-namespaces-multiplealiasdefinitions`{.interpreted-text
             role="ref"},
             `phinx-namespaces-multiplealiasdefinitions`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------------

Multiple Alias Definitions Per File
-----------------------------------

Avoid aliasing the same name with different aliases. This leads to
confusion.

``` {.php}
<?php

// first occurrence
use name\space\ClasseName;

// when this happens, several other uses are mentionned

// name\space\ClasseName has now two names
use name\space\ClasseName as anotherName;

?>
```

See also Namespaces/MultipleAliasDefinition.

  ------------- -------------------------------------------
  Short name    Namespaces/MultipleAliasDefinitionPerFile

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- -------------------------------------------

Multiple Class Declarations
---------------------------

It is possible to declare several times the same class in the code. PHP
will not mention it until execution time, since declarations may be
conditional.

``` {.php}
<?php

$a = 1;

// Conditional declaration
if ($a == 1) {
    class foo {
        function method() { echo 'class 1';}
    }
} else {
    class foo {
        function method() { echo 'class 2';}
    }
}

(new foo())->method();
?>
```

It is recommended to avoid declaring several times the same class in the
code. The best practice is to separate them with namespaces, they are
for here for that purpose. In case those two classes are to be used
interchangeably, the best is to use an abstract class or an interface.

### Suggestions

-   Store classes with different names in different namespaces
-   Change the name of the classes and give them a common interface to
    allow from common behavior

  ------------- ----------------------------------
  Short name    Classes/MultipleDeclarations

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Multiple Classes In One File
----------------------------

It is regarded as a bad practice to store several classes in the same
file. This is usually done to make life of \_\_autoload() easier.

It is often unexpected to find class `foo` in the `bar.php` file. This
is also the case for interfaces and traits.

``` {.php}
<?php

// three classes in the same file
class foo {}
class bar {}
class foobar{}

?>
```

One good reason to have multiple classes in one file is to reduce
include time by providing everything into one nice include.

See also [Is it a bad practice to have multiple classes in the same
file?](https://stackoverflow.com/questions/360643/is-it-a-bad-practice-to-have-multiple-classes-in-the-same-file).

### Suggestions

-   Split the file into smaller files, one for each class

  ------------- -------------------------------------------------------------
  Short name    Classes/MultipleClassesInFile

  Rulesets      `Coding Conventions <coding-conventions>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------------------------------------

Multiple Constant Definition
----------------------------

Some constants are defined several times in your code. This will lead to
a fatal error, if they are defined during the same execution.

Multiple definitions may happens at bootstrap, when the application code
is collecting information about the current environment. It may also
happen at inclusion time, which one set of constant being loaded, while
other definition are not, avoiding conflict. Both are false positive.

``` {.php}
<?php

// OS is defined twice. 
if (PHP_OS == 'Windows') {
    define('OS', 'Win');
} else {
    define('OS', 'Other');
}

?>
```

### Suggestions

-   Move the constants to a class, and include the right class based on
    control flow.
-   Give different names to the constants, and keep the condition close
    to utilisation.
-   Move the constants to an external configuration file : it will be
    easier to identify that those constants may change.

  ---------- -------------------------------------------------------------------
  Short name Constants/MultipleConstantDefinition

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `dolibarr-constants-multipleconstantdefinition`{.interpreted-text
             role="ref"},
             `openconf-constants-multipleconstantdefinition`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------------

Multiple Declaration Of Strict\_types {#multiple-declaration-of-strict\\_types}
-------------------------------------

At least two declare() commands are declaring
[strict\_types]{.title-ref} in one file. Only one is sufficient, and
should be the first expression in the file.

Indeed, any [strict\_types]{.title-ref} set to 1 will have the final
word. Setting [strict\_types]{.title-ref} to 0 will not revert the
configuration, wherever is this call made.

``` {.php}
<?php 
declare(strict_types=1);
declare(strict_types=1);

// rest of the code 

?>
```

See also
[Declare](https://www.php.net/manual/en/control-structures.declare.php).

### Suggestions

-   Just remove all but one of them.

  ------------- -----------------------------
  Short name    Php/MultipleDeclareStrict

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Multiple Definition Of The Same Argument
----------------------------------------

A method\'s signature is holding twice (or more) the same argument. For
example, function x (\$a, \$a) {
[\...](https://www.php.net/manual/en/functions.arguments.php#functions.variable-arg-list)
}.

This is accepted as is by PHP 5, and the last parameter\'s value will be
assigned to the variable. PHP 7.0 and more recent has dropped this
feature, and reports a fatal error when linting the code.

``` {.php}
<?php
  function x ($a, $a) { print $a; };
  x(1,2); => display 2

    // special case with a closure : 
  function ($a) use ($a) { print $a; };
  x(1,2); => display 2

?>
```

However, this is not common programming practise : all arguments should
be named differently.

See also [Prepare for PHP 7 error messages (part
3)](https://www.exakat.io/prepare-for-php-7-error-messages-part-3/).

### Suggestions

-   Give different names to different parameters

  ---------- ------------------------------------------------------------------------------------------------------
  Short name Functions/MultipleSameArguments

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"}, `CompatibilityPHP54`{.interpreted-text
             role="ref"}, `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and older
  Version    

  Severity   Major

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [all-unique-arguments](https://github.com/dseguy/clearPHP/tree/master/rules/all-unique-arguments.md)
  ---------- ------------------------------------------------------------------------------------------------------

Multiple Exceptions Catch() {#multiple-exceptions-catch()}
---------------------------

It is possible to have several distinct exceptions class caught by the
same catch, preventing code repetition.

This is a new feature since PHP 7.1.

``` {.php}
<?php

// PHP 7.1 and more recent
try {  
    throw new someException(); 
} catch (Single $s) {
    doSomething();
} catch (oneType | anotherType $s) {
    processIdentically();
} finally {

}

// PHP 7.0 and older
try {  
    throw new someException(); 
} catch (Single $s) {
    doSomething();
} catch (oneType $s) {
    processIdentically();
} catch (anotherType $s) {
    processIdentically();
} finally {

}

?>
```

This is a backward incompatible feature of PHP 7.1.

  ---------- ----------------------------------------------------------------
  Short name Exceptions/MultipleCatch

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        
  ---------- ----------------------------------------------------------------

Multiple Identical Trait Or Interface
-------------------------------------

There is no need to use the same trait, or implements the same interface
more than once.

Up to PHP 7.1 (at least), this doesn\'t raise any warning. Traits are
only imported once, and interfaces may be implemented as many times as
wanted.

``` {.php}
<?php

class foo {
    use t3,t3,t3;
}

class bar implements i,i,i {

}

?>
```

### Suggestions

-   Remove the duplicate trait or interfaces

  ------------- ----------------------------------
  Short name    Classes/MultipleTraitOrInterface

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ----------------------------------

Multiple Index Definition
-------------------------

Indexes that are defined multiple times in the same array.

``` {.php}
<?php
    // Multiple identical keys
    $x = array(1 => 2, 
               2 => 3,  
               1 => 3);

    // Multiple identical keys (sneaky version)
    $x = array(1 => 2, 
               1.1 => 3,  
               true => 4);

    // Multiple identical keys (automated version)
    $x = array(1 => 2, 
               3,        // This will be index 2
               2 => 4);  // this index is overwritten
?>
```

They are indeed overwriting each other. This is most probably a typo.

### Suggestions

-   Review your code and check that arrays only have keys defined once.
-   Review carefully your code and check indirect values, like
    constants, static constants.

  ---------- -------------------------------------------------------------
  Short name Arrays/MultipleIdenticalKeys

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `magento-arrays-multipleidenticalkeys`{.interpreted-text
             role="ref"},
             `mediawiki-arrays-multipleidenticalkeys`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Multiple Type Variable
----------------------

Avoid using the same variable with different types of data.

It is recommended to use different names for differently typed data,
while processing them. This prevents errors where one believe the
variable holds the former type, while it has already been cast to the
later.

Incrementing variables, with math operations or concatenation, is OK :
the content changes, but not the type. And casting the variable without
storing it in itself is OK.

``` {.php}
<?php

// $x is an array
$x = range('a', 'z');
// $x is now a string
$x = join('', $x);
$c = count($x); // $x is not an array anymore


// $letters is an array
$letters = range('a', 'z');
// $alphabet is a string
$alphabet = join('', $letters);

// Here, $letters is cast by PHP, but the variable is changed.
if ($letters) { 
    $count = count($letters); // $letters is still an array 
}

?>
```

### Suggestions

-   Use a class that accepts one type of argument, and exports another
    type of argument.
-   Use different variable for each type of data format : \$rows (for
    array), \$list (for implode(\'\', \$rows))
-   Pass the final result as argument to another method, avoiding the
    temporary variable

  ---------- -------------------------------------------------------------
  Short name Structures/MultipleTypeVariable

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `typo3-structures-multipletypevariable`{.interpreted-text
             role="ref"},
             `vanilla-structures-multipletypevariable`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Multiple Unset() {#multiple-unset()}
----------------

[Unset()](https://www.php.net/unset) accepts multiple arguments,
unsetting them one after each other. It is more efficient to call
[unset()](https://www.php.net/unset) once, than multiple times.

``` {.php}
<?php

// One call to unset only
unset($a, $b, $c, $d);

// Too many calls to unset
unset($a);
unset($b);
unset($c);
unset($d);

?>
```

See also [unset](https://www.php.net/unset).

### Suggestions

-   Merge all unset into one call

  ------------- -------------------------------------------
  Short name    Structures/MultipleUnset

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"},
                `php-cs-fixable`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------------------

Multiple Usage Of Same Trait
----------------------------

The same trait is used several times. One trait usage is sufficient.

``` {.php}
<?php

// C is used twice, and could be dropped from B
trait A { use B, C;}
trait B { use C;}

?>
```

PHP doesn\'t raise any error when traits are included multiple times.

See also
[Traits](https://www.php.net/manual/en/language.oop5.traits.php).

### Suggestions

-   Remove any multiple traits from use expressions
-   Review the class tree, and remove any trait mentioned multiple times

  ------------- ----------------------------------------------------
  Short name    Traits/MultipleUsage

  Rulesets      `Suggestions`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)

  Examples      `nextcloud-traits-multipleusage`{.interpreted-text
                role="ref"}
  ------------- ----------------------------------------------------

Multiples Identical Case
------------------------

Some cases are defined multiple times, but only one will be processed.
Check the list of cases, and remove the extra one.

Exakat tries to find the value of the case as much as possible, and
ignore any dynamic cases (using variables).

``` {.php}
<?php

const A = 1;

case ($x) {
    case 1 : 
        break;
    case true:    // This is a duplicate of the previous
        break; 
    case 1 + 0:   // This is a duplicate of the previous
        break; 
    case 1.0 :    // This is a duplicate of the previous
        break; 
    case A :      // The A constant is actually 1
        break; 
    case $y  :    // This is not reported.
        break; 
    default:

}
?>
```

### Suggestions

-   Remove the double case
-   Change the case to another and rightful value

  ---------- ------------------------------------------------------------------------------------------------
  Short name Structures/MultipleDefinedCase

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-duplicate-case](https://github.com/dseguy/clearPHP/tree/master/rules/no-duplicate-case.md)

  Examples   `sugarcrm-structures-multipledefinedcase`{.interpreted-text role="ref"},
             `expressionengine-structures-multipledefinedcase`{.interpreted-text role="ref"}
  ---------- ------------------------------------------------------------------------------------------------

Multiply By One
---------------

Multiplying by 1 is a fancy type cast.

If it is used to type cast a value to number, then casting (integer) or
(real) is clearer. This behavior may change with PHP 7.1, which has
unified the behavior of all hidden casts.

``` {.php}
<?php

// Still the same value than $m, but now cast to integer or real
$m = $m * 1; 

// Still the same value than $m, but now cast to integer or real
$n *= 1; 

// make typecasting clear, and merge it with the producing call.
$n = (int) $n;

?>
```

See also [Type
Juggling](https://www.php.net/manual/en/language.types.type-juggling.php)

### Suggestions

-   Typecast to (int) or (float) for better readability
-   Skip useless math operation altogether

  ----------- --------------------------------------------------------------------------------------------
  Short name  Structures/MultiplyByOne

  Rulesets    `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Instant (5 mins)

  Precision   High

  ClearPHP    [no-useless-math](https://github.com/dseguy/clearPHP/tree/master/rules/no-useless-math.md)

  Examples    `sugarcrm-structures-multiplybyone`{.interpreted-text role="ref"},
              `edusoho-structures-multiplybyone`{.interpreted-text role="ref"}
  ----------- --------------------------------------------------------------------------------------------

Must Call Parent Constructor
----------------------------

Some PHP native classes require a call to
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)::[\_\_construct()](https://www.php.net/manual/en/language.oop5.decon.php)
to be stable.

As of PHP 7.3, two classes currently need that call : SplTempFileObject
and SplFileObject.

The error is only emitted if the class is instantiated, and a
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
class is called.

``` {.php}
<?php

class mySplFileObject extends \SplFileObject {
    public function __construct()    { 
        // Forgottent call to parent::__construct()
    }
}

(new mySplFileObject())->passthru();
?>
```

See also [Why, php? WHY???](https://gist.github.com/everzet/4215537).

### Suggestions

-   Add a call to the parent\'s constructor
-   Remove the extension of the parent class

  ------------- -------------------------------
  Short name    Php/MustCallParentConstructor

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------

Must Return Methods
-------------------

The following methods are expected to return a value that will be used
later. Without return, they are useless.

Methods that must return are :
[\_\_get()](https://www.php.net/manual/en/language.oop5.magic.php),
[\_\_isset()](https://www.php.net/manual/en/language.oop5.magic.php),
[\_\_sleep()](https://www.php.net/manual/en/language.oop5.magic.php),
[\_\_toString()](https://www.php.net/manual/en/language.oop5.magic.php),
[\_\_set\_state()](https://www.php.net/manual/en/language.oop5.magic.php),
[\_\_invoke()](https://www.php.net/manual/en/language.oop5.magic.php),
[\_\_debugInfo()](https://www.php.net/manual/en/language.oop5.magic.php).
Methods that may not return, but are often expected to :
[\_\_call()](https://www.php.net/manual/en/language.oop5.magic.php),
[\_\_callStatic()](https://www.php.net/manual/en/language.oop5.magic.php).

``` {.php}
<?php

class foo {
    public function __isset($a) {
        // returning something useful
        return isset($this->$var[$a]);
    }

    public function __get($a) {
        $this->$a++;
        // not returning... 
    }

    public function __call($name, $args) {
        $this->$name(...$args);
        // not returning anything, but that's OK
    }

}
?>
```

### Suggestions

-   Add a return expression, with a valid data type
-   Remove the return typehint

  ------------- ---------------------------------------------------------
  Short name    Functions/MustReturn

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------------------------------

Named Regex
-----------

Captured subpatterns may be named, for easier reference.

From the manual : It is possible to name a subpattern using the syntax
`(?P<name>pattern)`. This subpattern will then be indexed in the matches
array by its normal numeric position and also by name. PHP 5.2.2
introduced two alternative syntaxes `(?<name>pattern)` and
`(?'name'pattern)`.

Naming subpatterns makes it easier to know what is read from the results
of the subpattern : for example, `$r['name']` has more meaning than
`$r[1]`.

Named subpatterns may also be shifted in the regex without impact on the
resulting array.

``` {.php}
<?php

$x = 'abc';
preg_match_all('/(?<name>a)/', $x, $r);
print_r($r[1]);
print_r($r['name']);

preg_match("/(?<name>a)(?'sub'b)/", $x, $s);
print $s[2];
print $s['sub'];

?>
```

See also
[Subpatterns](https://www.php.net/manual/en/regexp.reference.subpatterns.php).

### Suggestions

-   Use named regex, and stop using integer-named subpatterns

  ---------- ------------------------------------------------------------
  Short name Structures/NamedRegex

  Rulesets   `Suggestions`{.interpreted-text role="ref"}

  Examples   `phinx-structures-namedregex`{.interpreted-text role="ref"},
             `shopware-structures-namedregex`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Negative Power
--------------

The power operator
[\*\*](https://www.php.net/manual/en/language.operators.arithmetic.php)
has higher precedence than the sign operators + and -.

This means that -2
[\*\*](https://www.php.net/manual/en/language.operators.arithmetic.php)
2 == -4. It is in fact, -(2
[\*\*](https://www.php.net/manual/en/language.operators.arithmetic.php)
2).

When using negative power, it is clearer to add parenthesis or to use
the [pow()](https://www.php.net/pow) function, which has no such
ambiguity :

``` {.php}
<?php

// -2 to the power of 2 (a square)
pow(-2, 2) == 4;

// minus 2 to the power of 2 (a negative square)
-2 ** 2 == -(2 ** 2) == 4;

?>
```

### Suggestions

-   Avoid negative number, as operands of \*\*
-   Use parenthesis with negative numbers and \*\*

  ------------- ----------------------------------
  Short name    Structures/NegativePow

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)
  ------------- ----------------------------------

Negative Start Index In Array
-----------------------------

Negative starting index in arrays changed in PHP 8.0. Until then, they
were ignored, and automatic index started always at 0. Since PHP 8.0,
the next index is calculated.

The behavior will
[break](https://www.php.net/manual/en/control-structures.break.php) code
that relies on automatic index in arrays, when a negative index is used
for a starter.

``` {.php}
<?php

$x = [-5 => 2];
$x[] = 3;

print_r($x);

/*
PHP 7.4 and older 
Array
(
    [-5] => 2
    [0] => 3
)
*/

/*
PHP 8.0 and more recent
Array
(
    [-5] => 2
    [-4] => 3
)
*/

?>
```

See also [PHP RFC: Arrays starting with a negative
index](https://wiki.php.net/rfc/negative_array_index).

### Suggestions

-   Explicitely create the index, instead of using the automatic
    indexing
-   Add an explicit index of 0 in the initial array, to set the
    automatic process in the right track
-   Avoid using specified index in array, conjointly with automatic
    indexing.

  ------------- ----------------------------------------
  Short name    Arrays/NegativeStart

  Rulesets      `CompatibilityPHP80`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Nested Ifthen
-------------

Three levels of ifthen is too much. The method should be split into
smaller functions.

``` {.php}
<?php

function foo($a, $b) {
    if ($a == 1) {
        // Second level, possibly too much already
        if ($b == 2) {

        }
    }
}

function bar($a, $b, $c) {
    if ($a == 1) {
        // Second level. 
        if ($b == 2) {
            // Third level level. 
            if ($c == 3) {
                // Too much
            }
        }
    }
}

?>
```

  -------------- --------- --------- ---------------------------------------------
  Name           Default   Type      Description

  nestedIfthen   3         integer   Maximal number of acceptable nesting of
                                     if-then structures
  -------------- --------- --------- ---------------------------------------------

  ---------- ------------------------------------------------------------
  Short name Structures/NestedIfthen

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `livezilla-structures-nestedifthen`{.interpreted-text
             role="ref"},
             `mediawiki-structures-nestedifthen`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Nested Ternary
--------------

Ternary operators should not be nested too deep.

They are a convenient instruction to apply some condition, and avoid a
if() structure. It works best when it is simple, like in a one liner.

However, ternary operators tends to make the syntax very difficult to
read when they are nested. It is then recommended to use an if()
structure, and make the whole code readable.

``` {.php}
<?php

// Simple ternary expression
echo ($a == 1 ? $b : $c) ;

// Nested ternary expressions
echo ($a === 1 ? $d === 2 ? $b : $d : $d === 3 ? $e : $c) ;
echo ($a === 1 ? $d === 2 ? $f ===4 ? $g : $h : $d : $d === 3 ? $e : $i === 5 ? $j : $k) ;

//Previous expressions, written as a if / Then expression
if ($a === 1) {
    if ($d === 2) {
        echo $b;
    } else {
        echo $d;
    }
} else {
    if ($d === 3) {
        echo $e;
    } else {
        echo $c;
    }
}

if ($a === 1) {
    if ($d === 2) {
        if ($f === 4) {
            echo $g;
        } else {
            echo $h;
        }
    } else {
        echo $d;
    }
} else {
    if ($d === 3) {
        echo $e;
    } else {
        if ($i === 5) {
            echo $j;
        } else {
            echo $k;
        }
    }
}

?>
```

See also [Nested Ternaries are
Great](https://medium.com/javascript-scene/nested-ternaries-are-great-361bddd0f340).

### Suggestions

-   Replace ternaries by if/then structures.
-   Replace ternaries by a functioncall : this provides more
    readability, offset the actual code, and gives room for making it
    different.

  ---------- ------------------------------------------------------------------------------------------------
  Short name Structures/NestedTernary

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-nested-ternary](https://github.com/dseguy/clearPHP/tree/master/rules/no-nested-ternary.md)

  Examples   `spip-structures-nestedternary`{.interpreted-text role="ref"},
             `zencart-structures-nestedternary`{.interpreted-text role="ref"}
  ---------- ------------------------------------------------------------------------------------------------

Nested Ternary Without Parenthesis
----------------------------------

It is not allowed to nest ternary operator within itself, without
parenthesis. This has been implemented in PHP 7.4.

The reason behind this feature is to keep the code expressive. See the
Warning message for more explanations

``` {.php}
<?php

$a ? 1 : ($b ? 2 : 3);

// Still valid, as not ambiguous 
$a ? $b ? 1 : 2 : 3;

// Produces a warning
//Unparenthesized `a ? b : c ? d : e` is deprecated. Use either `(a ? b : c) ? d : e` or `a ? b : (c ? d : e)`
$a ? 1 : $b ? 2 : 3;

?>
```

See also [PHP RFC: Deprecate left-associative ternary
operator](https://wiki.php.net/rfc/ternary_associativity).

### Suggestions

-   Add parenthesis to nested ternary calls

  ------------- ----------------------------------------
  Short name    Php/NestedTernaryWithoutParenthesis

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Php Version   7.4-

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Never Used Parameter
--------------------

When a parameter is never used at calltime, it may be turned into a
local variable.

It seems that the parameter was set up initially, but never found its
practical usage. It is never mentioned, and always fall back on its
default value.

Parameter without a default value are reported by PHP, and are usually
always filled.

``` {.php}
<?php

// $b may be turned into a local var, it is unused
function foo($a, $b = 1) {
    return $a + $b;
}

// whenever foo is called, the 2nd arg is not mentionned
foo($a);
foo(3);
foo('a');
foo($c);

?>
```

### Suggestions

-   Drop the unused argument in the method definition
-   Actually use the argument when calling the method
-   Drop the default value, and check warnings that mention usage of
    this parameter

  ------------- ---------------------------------------------------------
  Short name    Functions/NeverUsedParameter

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `Suggestions`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Examples      `piwigo-functions-neverusedparameter`{.interpreted-text
                role="ref"}
  ------------- ---------------------------------------------------------

Never Used Properties
---------------------

Properties that are never used. They are defined in a class or a trait,
but they never actually used.

Properties are considered used when they are used locally, in the same
class as their definition, or in a
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
class : a
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
class is always included with the current class.

On the other hand, properties which are defined in a class, but only
used in children classes is considered unused, since children may also
avoid using it.

``` {.php}
<?php

class foo {
    public $usedProperty = 1;

    // Never used anywhere
    public $unusedProperty = 2;

    function bar() {
        // Used internally
        ++$this->usedProperty;
    }
}

class foo2  extends foo {
    function bar2() {
        // Used in child class
        ++$this->usedProperty;
    }
}

// Used externally
++$this->usedProperty;

?>
```

### Suggestions

-   Drop unused properties
-   Change the name of the unused properties
-   Move the properties to children classes
-   Find usage for unused properties

  ------------- ---------------------------------------------------------
  Short name    Classes/PropertyNeverUsed

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Examples      `wordpress-classes-propertyneverused`{.interpreted-text
                role="ref"}
  ------------- ---------------------------------------------------------

New Constants In PHP 7.2
------------------------

The following constants are now native in PHP 7.2. It is advised to
avoid using such names for constant before moving to this new version.

-   `PHP_OS_FAMILY`
-   `PHP_FLOAT_DIG`
-   `PHP_FLOAT_EPSILON`
-   `PHP_FLOAT_MAX`
-   `PHP_FLOAT_MIN`
-   `SQLITE3_DETERMINISTIC`
-   `CURLSSLOPT_NO_REVOKE`
-   `CURLOPT_DEFAULT_PROTOCOL`
-   `CURLOPT_STREAM_WEIGHT`
-   `CURLMOPT_PUSHFUNCTION`
-   `CURL_PUSH_OK`
-   `CURL_PUSH_DENY`
-   `CURL_HTTP_VERSION_2TLS`
-   `CURLOPT_TFTP_NO_OPTIONS`
-   `CURL_HTTP_VERSION_2_PRIOR_KNOWLEDGE`
-   `CURLOPT_CONNECT_TO`
-   `CURLOPT_TCP_FASTOPEN`
-   `DNS_CAA`

See also [New global constants in
7.2](https://www.php.net/manual/en/migration72.constants.php).

  ------------- ----------------------------------------
  Short name    Php/Php72NewConstants

  Rulesets      `CompatibilityPHP72`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.2 and older

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

New Constants In PHP 7.4
------------------------

The following constants are now native in PHP 7.4. It is advised to
avoid using such names for constant before moving to this new version.

-   `MB_ONIGURUMA_VERSION`
-   `SO_LABEL`
-   `SO_PEERLABEL`
-   `SO_LISTENQLIMIT`
-   `SO_LISTENQLEN`
-   `SO_USER_COOKIE`
-   `PHP_WINDOWS_EVENT_CTRL_C`
-   `PHP_WINDOWS_EVENT_CTRL_BREAK`
-   `TIDY_TAG_ARTICLE`
-   `TIDY_TAG_ASIDE`
-   `TIDY_TAG_AUDIO`
-   `TIDY_TAG_BDI`
-   `TIDY_TAG_CANVAS`
-   `TIDY_TAG_COMMAND`
-   `TIDY_TAG_DATALIST`
-   `TIDY_TAG_DETAILS`
-   `TIDY_TAG_DIALOG`
-   `TIDY_TAG_FIGCAPTION`
-   `TIDY_TAG_FIGURE`
-   `TIDY_TAG_FOOTER`
-   `TIDY_TAG_HEADER`
-   `TIDY_TAG_HGROUP`
-   `TIDY_TAG_MAIN`
-   `TIDY_TAG_MARK`
-   `TIDY_TAG_MENUITEM`
-   `TIDY_TAG_METER`
-   `TIDY_TAG_NAV`
-   `TIDY_TAG_OUTPUT`
-   `TIDY_TAG_PROGRESS`
-   `TIDY_TAG_SECTION`
-   `TIDY_TAG_SOURCE`
-   `TIDY_TAG_SUMMARY`
-   `TIDY_TAG_TEMPLATE`
-   `TIDY_TAG_TIME`
-   `TIDY_TAG_TRACK`
-   `TIDY_TAG_VIDEO`
-   `STREAM_CRYPTO_METHOD_TLSv1_3_CLIENT`
-   `STREAM_CRYPTO_METHOD_TLSv1_3_SERVER`
-   `STREAM_CRYPTO_PROTO_TLSv1_3`
-   `T_COALESCE_EQUAL`
-   `T_FN`

See also [New global constants in
7.4](https://www.php.net/manual/en/migration74.constants.php).

### Suggestions

-   Move the constants to a new namespace
-   Remove the old constants
-   Rename the old constants

  ------------- ----------------------------------------
  Short name    Php/Php74NewConstants

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.4 and older

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

New Functions In PHP 5.4
------------------------

PHP introduced new functions in PHP 5.4. If there are defined functions
with such names, there will be a conflict when upgrading. It is advised
to change those functions\' name.

  ------------- ----------------------------------------
  Short name    Php/Php54NewFunctions

  Rulesets      `CompatibilityPHP53`{.interpreted-text
                role="ref"}

  Php Version   With PHP 5.3 and older

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

New Functions In PHP 5.5
------------------------

PHP introduced new functions in PHP 5.5. If you have already defined
functions with such names, you will get a conflict when trying to
upgrade. It is advised to change those functions\' name.

  ------------- ------------------------------------------------------
  Short name    Php/Php55NewFunctions

  Rulesets      `CompatibilityPHP53`{.interpreted-text role="ref"},
                `CompatibilityPHP54`{.interpreted-text role="ref"}

  Php Version   With PHP 5.5 and older

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ------------------------------------------------------

New Functions In PHP 5.6
------------------------

PHP introduced new functions in PHP 5.6. If you have already defined
functions with such names, you will get a conflict when trying to
upgrade. It is advised to change those functions\' name.

  ---------- ------------------------------------------------------------
  Short name Php/Php56NewFunctions

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"}

  Php        With PHP 5.6 and older
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- ------------------------------------------------------------

New Functions In PHP 7.0
------------------------

The following functions are now native functions in PHP 7.0. It is
advised to change them before moving to this new version.

-   get\_resources()
-   [gc\_mem\_caches()](https://www.php.net/gc_mem_caches)
-   [preg\_replace\_callback\_array()](https://www.php.net/preg_replace_callback_array)
-   posix\_setrlimit()
-   [random\_bytes()](https://www.php.net/random_bytes)
-   [random\_int()](https://www.php.net/random_int)
-   [intdiv()](https://www.php.net/intdiv)
-   [error\_clear\_last()](https://www.php.net/error_clear_last)

  ---------- --------------------------------------------------------------
  Short name Php/Php70NewFunctions

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and older
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- --------------------------------------------------------------

New Functions In PHP 7.1
------------------------

The following functions are now native functions in PHP 7.1. It is
advised to change them before moving to this new version.

-   [curl\_share\_strerror()](https://www.php.net/curl_share_strerror)
-   [curl\_multi\_errno()](https://www.php.net/curl_multi_errno)
-   [curl\_share\_errno()](https://www.php.net/curl_share_errno)
-   [mb\_ord()](https://www.php.net/mb_ord)
-   [mb\_chr()](https://www.php.net/mb_chr)
-   [mb\_scrub()](https://www.php.net/mb_scrub)
-   [is\_iterable()](https://www.php.net/is_iterable)

  ------------- ----------------------------------------
  Short name    Php/Php71NewFunctions

  Rulesets      `CompatibilityPHP71`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.1 and older

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

New Functions In PHP 7.2
------------------------

The following functions are now native functions in PHP 7.2. It is
advised to change custom functions that are currently created, and using
those names, before moving to this new version.

-   [mb\_ord()](https://www.php.net/mb_ord)
-   [mb\_chr()](https://www.php.net/mb_chr)
-   [mb\_scrub()](https://www.php.net/mb_scrub)
-   [stream\_isatty()](https://www.php.net/stream_isatty)
-   [proc\_nice()](https://www.php.net/proc_nice) (Windows only)

### Suggestions

-   Move custom functions with the same name to a new namespace
-   Change the name of any custom functions with the same name
-   Add a condition to the functions definition to avoid conflict

  ------------- ----------------------------------------
  Short name    Php/Php72NewFunctions

  Rulesets      `CompatibilityPHP72`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.2 and older

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

New Functions In PHP 7.3
------------------------

New functions are added to new PHP version.

The following functions are now native functions in PHP 7.3. It is
compulsory to rename any custom function that was created in older
versions. One alternative is to move the function to a custom namespace,
and update the `use` list at the beginning of the script.

-   [net\_get\_interfaces](https://www.php.net/net_get_interfaces)
-   [gmp\_binomial](https://www.php.net/gmp_binomial)
-   [gmp\_lcm](https://www.php.net/gmp_lcm)
-   [gmp\_perfect\_power](https://www.php.net/gmp_perfect_power)
-   [gmp\_kronecker](https://www.php.net/gmp_kronecker)
-   [openssl\_pkey\_derive](https://www.php.net/openssl_pkey_derive)
-   [is\_countable](https://www.php.net/is_countable)
-   [ldap\_exop\_refresh](https://www.php.net/ldap_exop_refresh)

Note : At the moment of writing, all links to the manual are not
working.

  ---------- ------------------------------------------------------------------
  Short name Php/Php73NewFunctions

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"},
             `CompatibilityPHP73`{.interpreted-text role="ref"}

  Php        With PHP 7.3 and older
  Version    

  Severity   Major

  Time To    Quick (30 mins)
  Fix        
  ---------- ------------------------------------------------------------------

New Functions In PHP 7.4
------------------------

New functions are added to new PHP version.

The following functions are now native functions in PHP 7.3. It is
compulsory to rename any custom function that was created in older
versions. One alternative is to move the function to a custom namespace,
and update the `use` list at the beginning of the script.

-   [mb\_str\_split](https://www.php.net/mb_str_split)
-   [password\_algos](https://www.php.net/password_algos)

Note : At the moment of writing, all links to the manual are not
working.

  ------------- ----------------------------------------
  Short name    Php/Php74NewFunctions

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.3 and older

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

New Functions In PHP 8.0
------------------------

New functions are added to new PHP version.

The following functions are now native functions in PHP 7.3. It is
compulsory to rename any custom function that was created in older
versions. One alternative is to move the function to a custom namespace,
and update the `use` list at the beginning of the script.

-   [str\_contains](https://www.php.net/str_contains)
-   [fdiv](https://www.php.net/fdiv)
-   [preg\_last\_error\_msg](https://www.php.net/preg_last_error_msg)

Note : At the moment of writing, all links to the manual are not
working.

  ------------- ----------------------------------------
  Short name    Php/Php80NewFunctions

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Php Version   With PHP 8.0 and older

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Next Month Trap
---------------

Avoid using +1 month with [strtotime()](https://www.php.net/strtotime).

[strtotime()](https://www.php.net/strtotime) calculates the next month
by incrementing the month number. For day number that do not exist from
one month to the next, [strtotime()](https://www.php.net/strtotime)
fixes them by setting them in the next-next month.

This happens to January, March, May, July, August and October. January
is also vulnerable for 29 (not every year), 30 and 31.

Avoid using \'+1 month\', and rely on \'first day of next month\' or
\'last day of next month\' to extract the next month\'s name.

``` {.php}
<?php

// Base date is October 31 => 10/31
// +1 month adds +1 to 10 => 11/31 
// Since November 31rst doesn't exists, it is corrected to 12/01. 
echo date('F', strtotime('+1 month',mktime(0,0,0,$i,31,2017))).PHP_EOL;

// Base date is October 31 => 10/31
echo date('F', strtotime('first day of next month',mktime(0,0,0,$i,31,2017))).PHP_EOL;

?>
```

See also [It is the 31st
again](https://twitter.com/rasmus/status/925431734128197632).

### Suggestions

-   Review strtotime() usage for month additions
-   Use datetime() and other classes, not PHP native functions
-   Use a external library, like carbon, to handle dates

  ---------- ------------------------------------------------------------
  Short name Structures/NextMonthTrap

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Top10`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Instant (5 mins)
  Fix        

  Examples   `contao-structures-nextmonthtrap`{.interpreted-text
             role="ref"},
             `edusoho-structures-nextmonthtrap`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

No Append On Source
-------------------

Do not append new elements to an array in a foreach loop. Since PHP 7.0,
the array is still used as a source, and will be augmented, and used
again.

``` {.php}
<?php

// Relying on the initial copy
$a = [1];
$initial = $a;
foreach($initial as $v) {
    $a[] = $v + 1;
}

// Keep new results aside
$a = [1];
$tmp = [];
foreach($a as $v) {
    $tmp[] = $v + 1;
}
$a = array_merge($a, $tmp);
unset($tmp);

// Example, courtesy of Frederic Bouchery
// This is an infinite loop
$a = [1];
foreach($a as $v) {
    $a[] = $v + 1;
}

?>
```

Thanks to [Frederic Bouchery](https://twitter.com/FredBouchery/) for the
reminder.

See also
[foreach](https://www.php.net/manual/en/control-structures.foreach.php)
and [What will this code return?
\#PHP](https://twitter.com/FredBouchery/status/1135480412703211520).

### Suggestions

-   Use a copy of the source, to avoid modifying it during the loop
-   Store the new values in a separate storage

  ------------- -----------------------------
  Short name    Structures/NoAppendOnSource

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

No Boolean As Default
---------------------

Default values should always be set up with a constant name.

Class constants and constants improve readability when calling the
methods or comparing values and statuses.

``` {.php}
<?php

const CASE_INSENSITIVE = true;
const CASE_SENSITIVE = false;

function foo($case_insensitive = true) {
    // doSomething()
}

// Readable code 
foo(CASE_INSENSITIVE);
foo(CASE_SENSITIVE);


// unreadable code  : is true case insensitive or case sensitive ? 
foo(true);
foo(false);

?>
```

See also
[FlagArgument](https://www.martinfowler.com/bliki/FlagArgument.html) and
[Clean code: The curse of a boolean
parameter](https://medium.com/@amlcurran/clean-code-the-curse-of-a-boolean-parameter-c237a830b7a3).

### Suggestions

-   Use constants or class constants to give value to a boolean literal
-   When constants have been defined, use them when calling the code
-   Split the method into two methods, one for each case

  ------------- -----------------------------------------------------------
  Short name    Functions/NoBooleanAsDefault

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `openconf-functions-nobooleanasdefault`{.interpreted-text
                role="ref"}
  ------------- -----------------------------------------------------------

No Choice
---------

A conditional structure is being used, but both alternatives are the
same, leading to the illusion of choice.

Either the condition is useless, and may be removed, or the alternatives
need to be distinguished.

``` {.php}
<?php

if ($condition == 2) {
    doSomething();
} else {
    doSomething();
}

$condition == 2 ?     doSomething() :     doSomething();

?>
```

### Suggestions

-   Remove the conditional, and call the expression directly
-   Replace one of the alternative with a distinct call
-   Remove the whole conditional : it may end up being useless

  ----------- -----------------------------------------------------------
  Short name  Structures/NoChoice

  Rulesets    `Analyze`{.interpreted-text role="ref"},
              `Top10`{.interpreted-text role="ref"},
              `CI-checks`{.interpreted-text role="ref"}

  Severity    Major

  Time To Fix Instant (5 mins)

  Examples    `nextcloud-structures-nochoice`{.interpreted-text
              role="ref"},
              `zencart-structures-nochoice`{.interpreted-text role="ref"}
  ----------- -----------------------------------------------------------

No Class As Typehint
--------------------

Avoid using classes as typehint : always use interfaces. This way,
different classes, or versions of classes may be passed as argument. The
typehint is not linked to an implementation, but to signatures.

A class is needed when the object is with properties : interfaces do not
allow the specifications of properties.

``` {.php}
<?php

class X {
    public $p = 1;

    function foo() {}
}

interface i {
    function foo();
}

// X is a class : any update in the code requires changing / subclassing X or the rest of the code.
function bar(X $x) {
    $x->foo();
}

// I is an interface : X may implements this interface without refactoring and pass
// later, newer versions of X may get another name, but still implement I, and still pass
function bar2(I $x) {
    $x->foo();
}

function bar3(I $x) {
    echo $x->p;
}

?>
```

See also [Type hinting for
interfaces](http://phpenthusiast.com/object-oriented-php-tutorials/type-hinting-for-interfaces).

### Suggestions

-   Create an interface with the important methods, and use that
    interface
-   Create an abstract class, when public properties are also needed

  ---------- -------------------------------------------------------------
  Short name Functions/NoClassAsTypehint

  Rulesets   `Typechecks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `vanilla-functions-noclassastypehint`{.interpreted-text
             role="ref"},
             `phpmyadmin-functions-noclassastypehint`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

No Class In Global
------------------

Avoid defining structures in Global namespace. Always prefer using a
namespace. This will come handy later, either when publishing the code,
or when importing a library, or even if PHP reclaims that name.

``` {.php}
<?php

// Code prepared for later
namespace Foo {
    class Bar {}
}

// Code that may conflict with other names.
namespace {
    class Bar {}
}

?>
```

### Suggestions

-   Use a specific namespace for your classes

  ------------- -------------------------------------------------
  Short name    Php/NoClassInGlobal

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Examples      `dolphin-php-noclassinglobal`{.interpreted-text
                role="ref"}
  ------------- -------------------------------------------------

No Count With 0
---------------

Comparing [count()](https://www.php.net/count),
[strlen()](https://www.php.net/strlen) or
[mb\_strlen()](https://www.php.net/mb_strlen) to 0 is a waste of
resources. There are three distinct situations.

When comparing [count()](https://www.php.net/count) with 0, with ===,
==, !==, !=, it is more efficient to use
[empty()](https://www.php.net/empty).
[empty()](https://www.php.net/empty) is a language construct that checks
if a value is present, while [count()](https://www.php.net/count)
actually load the number of element.

``` {.php}
<?php

// Checking if an array is empty
if (count($array) == 0) {
    // doSomething();
}
// This may be replaced with 
if (empty($array)) {
    // doSomething();
}

?>
```

When comparing [count()](https://www.php.net/count) strictly with 0 and
`>`, it is more efficient to use `!(empty(  ))`

``` {.php}
<?php

// Checking if an array is empty
if (count($array) > 0) {
    // doSomething();
}
// This may be replaced with 
if (!empty($array)) {
    // doSomething();
}

Of course comparing count() with negative values, or with >= is useless.

<?php

// Checking if an array is empty
if (count($array) < 0) {
    // This never happens
    // doSomething();
}

?>
```

Comparing [count()](https://www.php.net/count),
[strlen()](https://www.php.net/strlen) or
[mb\_strlen()](https://www.php.net/mb_strlen) with other values than 0
cannot be replaced with a comparison with
[empty()](https://www.php.net/empty).

Note that this is a micro-optimisation : since PHP keeps track of the
number of elements in arrays (or number of chars in strings), the total
computing time of both operations is often lower than a ms. However,
both functions tends to be heavily used, and may even be used inside
loops.

See also [count](https://www.php.net/count),
[strlen](https://www.php.net/strlen) and
[mb\_strlen](https://www.php.net/mb_strlen).

### Suggestions

-   Use empty() on the data
-   Compare the variable with a default value, such as an empty array

  ---------- -------------------------------------------------------------
  Short name Performances/NotCountNull

  Rulesets   `Performances`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `contao-performances-notcountnull`{.interpreted-text
             role="ref"},
             `wordpress-performances-notcountnull`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

No Direct Call To Magic Method
------------------------------

PHP features magic methods, which are methods related to operators.

Magic methods, such as
[\_\_get()](https://www.php.net/manual/en/language.oop5.magic.php),
related to =, or
[\_\_clone()](https://www.php.net/manual/en/language.oop5.magic.php),
related to `clone`, are supposed to be used in an object environment,
and not with direct call.

It is recommended to use the magic method with its intended usage, and
not to call it directly. For example, typecast to `string` instead of
calling the
[\_\_toString()](https://www.php.net/manual/en/language.oop5.magic.php)
method.

``` {.php}
<?php
// Write
  print $x->a;
// instead of 
  print $x->__get('a'); 

class Foo {
    private $b = secret;

    public function __toString() {
        return strtoupper($this->b);
    }
}

$bar = new Foo();
echo (string) $bar;

?>
```

Accessing those methods in a
[static](https://www.php.net/manual/en/language.oop5.static.php) way is
also discouraged.

See also [Magic
Methods](https://www.php.net/manual/en/language.oop5.magic.php) and
[Magical PHP: ](toString()%20Throws%20Exception)call
\<<https://www.php.net/manual/en/language.oop5.magic.php>\>[\_](https://www.garfieldtech.com/blog/magical-php-call).

  ------------- ----------------------------------
  Short name    Classes/DirectCallToMagicMethod

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

No Direct Usage
---------------

The results of the following functions shouldn\'t be used directly, but
checked first.

For example, [glob()](https://www.php.net/glob) returns an array, unless
some error happens, in which case it returns a boolean (false). In such
case, however rare it is, plugging [glob()](https://www.php.net/glob)
directly in a
[foreach()](https://www.php.net/manual/en/control-structures.foreach.php)
loops will yield errors.

``` {.php}
<?php
    // Used without check : 
    foreach(glob('.') as $file) { /* do Something */ }.

    // Used without check : 
    $files = glob('.');
    if (!is_array($files)) {
        foreach($files as $file) { /* do Something */ }.
    }
?>
```

### Suggestions

-   Check the return of the function before using it, in particular for
    false, or array().

  ---------- ------------------------------------------------------------
  Short name Structures/NoDirectUsage

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Slow (1 hour)
  Fix        

  Examples   `edusoho-structures-nodirectusage`{.interpreted-text
             role="ref"},
             `xoops-structures-nodirectusage`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

No ENT\_IGNORE {#no-ent\\_ignore}
--------------

Certain characters have special significance in HTML, and should be
represented by HTML entities if they are to preserve their meanings.

ENT\_IGNORE is a configuration option for
[htmlspecialchars()](https://www.php.net/htmlspecialchars), that ignore
any needed character replacement. This mean the raw input will now be
processed by PHP, or a target browser.

It is recommended to use the other configuration options : `ENT_COMPAT`,
`ENT_QUOTES`, `ENT_NOQUOTES`, `ENT_SUBSTITUTE`, `ENT_DISALLOWED`,
`ENT_HTML401`, `ENT_XML1`, `ENT_XHTML` or `ENT_HTML5`.

``` {.php}
<?php

// This produces a valid HTML tag
$new = htmlspecialchars("<a href='test'>Test</a>", ENT_IGNORE);
echo $new; // &lt;a href=&#039;test&#039;&gt;Test&lt;/a&gt;

// This produces a valid string, without any HTML special value
$new = htmlspecialchars("<a href='test'>Test</a>", ENT_QUOTES);
echo $new; // &lt;a href=&#039;test&#039;&gt;Test&lt;/a&gt;

?>
```

See also [htmlspecialchars](https://www.php.net/htmlspecialchars) and
[Deletion of Code
Points](http://unicode.org/reports/tr36/#Deletion_of_Noncharacters).

### Suggestions

-   Use of the the other options

  ------------- ------------------------------
  Short name    Security/NoEntIgnore

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

No Empty Regex
--------------

PHP regex don\'t accept empty regex, nor regex with alphanumeric
delimiter.

Most of those errors happen at execution time, when the regex is build
dynamically, but still may end empty. At compile time, such error are
made when the code is not tested before commit.

``` {.php}
<?php

// No empty regex
preg_match('', $string, $r); 

// Delimiter must be non-alphanumerical
preg_replace('1abc1', $string, $r); 

// Delimiter must be non-alphanumerical
preg_replace('1'.$regex.'1', $string, $r); 

?>
```

See also [PCRE](https://www.php.net/pcre) and
[Delimiters](https://www.php.net/manual/en/regexp.reference.delimiters.php).

### Suggestions

-   Fix the regex by adding regex delimiters

  ------------- ------------------------------------------------------
  Short name    Structures/NoEmptyRegex

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Critical

  Time To Fix   Quick (30 mins)

  Examples      `tikiwiki-structures-noemptyregex`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------

No Hardcoded Hash
-----------------

Hash should never be hardcoded.

Hashes may be MD5, SHA1, SHA512, Bcrypt or any other. Such values must
be easily changed, for security reasons, and the source code is not the
safest place to hide it.

``` {.php}
<?php

    // Those strings may be sha512 hashes. 
    // it is recomemdned to check if they are static or should be put into configuration
    $init512 = array( // initial values for SHA512
        '6a09e667f3bcc908', 'bb67ae8584caa73b', '3c6ef372fe94f82b', 'a54ff53a5f1d36f1', 
    );

    // strings which are obvious conversion are ignored 
    $decimal = intval('87878877', 12);
?>
```

See also [Salted Password Hashing - Doing it
Right](https://crackstation.net/hashing-security.htm) and
[Hash-Buster](https://github.com/s0md3v/Hash-Buster).

### Suggestions

-   Put any hardcoded hash in a configuration file, a database or a
    environment variable. An external source.

  ---------- -------------------------------------------------------------
  Short name Structures/NoHardcodedHash

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Security`{.interpreted-text role="ref"}

  Severity   Critical

  Time To    Slow (1 hour)
  Fix        

  Examples   `shopware-structures-nohardcodedhash`{.interpreted-text
             role="ref"},
             `sugarcrm-structures-nohardcodedhash`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

No Hardcoded Ip
---------------

Do not leave hard coded IP in your code.

It is recommended to move such configuration in external files or
databases, for each update. This may also come handy when testing.

``` {.php}
<?php

// This IPv4 is hardcoded. 
$ip = '183.207.224.50';
// This IPv6 is hardcoded. 
$ip = '2001:0db8:85a3:0000:0000:8a2e:0370:7334';

// This looks like an IP
$thisIsNotAnIP = '213.187.99.50';
$thisIsNotAnIP = '2133:1387:9393:5330';

?>
```

`127.0.0.1`, `\:\:1` and `\:\:0` are omitted, and not considered as a
violation.

See also [Use of Hardcoded IPv4
Addresses](https://docs.microsoft.com/en-us/windows/desktop/winsock/use-of-hardcoded-ipv4-addresses-2)
and [Never hard code sensitive
information](https://wiki.sei.cmu.edu/confluence/display/java/MSC03-J.+Never+hard+code+sensitive+information).

### Suggestions

-   Move the hardcoded IP to an external source : environment variable,
    configuration file, database.
-   Remove the hardcoded IP and ask for it at execution.
-   Use a literal value for default messages in form.

  ---------- ------------------------------------------------------------
  Short name Structures/NoHardcodedIp

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Security`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  Examples   `openemr-structures-nohardcodedip`{.interpreted-text
             role="ref"},
             `nextcloud-structures-nohardcodedip`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

No Hardcoded Path
-----------------

It is not recommended to use hardcoded literals when designating files.
Full paths are usually tied to one file system organization. As soon as
the organisation changes or must be adapted to any external constraint,
the path is not valid anymore.

Either use
[\_\_FILE\_\_](https://www.php.net/manual/en/language.constants.predefined.php)
and
[\_\_DIR\_\_](https://www.php.net/manual/en/language.constants.predefined.php)
to make the path relative to the current file; use a `DOC_ROOT` as a
configuration constant that will allow the moving of the script to
another folder; finally functions like
[sys\_get\_temp\_dir()](https://www.php.net/sys_get_temp_dir) produce a
viable temporary folder.

Relative paths are relative to the current execution directory, and not
the current file. This means they may differ depending on the location
of the start of the application, and are sensitive to
[chdir()](https://www.php.net/chdir) and
[chroot()](https://www.php.net/chroot) usage.

``` {.php}
<?php

    // This depends on the current executed script
    file_get_contents('token.txt');

    // Exotic protocols are ignored
    file_get_contents('jackalope://file.txt');

    // Some protocols are ignored : http, https, ftp, ssh2, php (with memory)
    file_get_contents('http://www.php.net/');
    file_get_contents('php://memory/');

    // glob() with special chars * and ? are not reported
    glob('./*/foo/bar?.txt');
    // glob() without special chars * and ? are reported
    glob('/foo/bar/');

?>
```

### Suggestions

-   Add \_\_DIR\_\_ before the path to make it relative to the current
    file
-   Add a configured prefix before the path to point to any file in the
    system
-   Use sys\_get\_temp\_dir() for temporary data
-   Use `include_path` argument function, such as fie\_get\_contents(),
    to have the file located in configurable directories.

  ---------- ------------------------------------------------------------------------------------------------
  Short name Structures/NoHardcodedPath

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Slow (1 hour)
  Fix        

  ClearPHP   [no-hardcoded-path](https://github.com/dseguy/clearPHP/tree/master/rules/no-hardcoded-path.md)

  Examples   `tine20-structures-nohardcodedpath`{.interpreted-text role="ref"},
             `thelia-structures-nohardcodedpath`{.interpreted-text role="ref"}
  ---------- ------------------------------------------------------------------------------------------------

No Hardcoded Port
-----------------

When connecting to a remove server, port is an important information. It
is recommended to make this configurable (with constant or
configuration), to as to be able to change this value without changing
the code.

``` {.php}
<?php

    // Both configurable IP and hostname
    $connection = ssh2_connect($_ENV['SSH_HOST'], $_ENV['SSH_PORT'], $methods, $callbacks);

    // Both hardcoded IP and hostname
    $connection = ssh2_connect('shell.example.com', 22, $methods, $callbacks);

    if (!$connection) die('Connection failed');
?>
```

### Suggestions

-   Move the port to a configuration file, an environment variable

  ------------- ----------------------------------------------------------
  Short name    Structures/NoHardcodedPort

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `Security`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `wordpress-structures-nohardcodedport`{.interpreted-text
                role="ref"}
  ------------- ----------------------------------------------------------

No List With String
-------------------

[list()](https://www.php.net/list) can\'t be used anymore to access
particular offset in a string. This should be done with
[substr()](https://www.php.net/substr) or \$string\[\$offset\] syntax.

``` {.php}
<?php

$x = 'abc';
list($a, $b, $c) = $x;

//list($a, $b, $c) = 'abc'; Never works

print $c;
// PHP 5.6- displays 'c'
// PHP 7.0+ displays nothing

?>
```

See also [PHP 7.0 Backward incompatible
changes](https://www.php.net/manual/en/migration70.incompatible.php) :
[list()](https://www.php.net/list) can no longer unpack string variables
.

### Suggestions

-   Use str\_split() to break a string into bytes
-   Use substr() or \$string\[\$offset\] syntax to access specific bytes
    in the string

  ---------- --------------------------------------------------------------
  Short name Php/NoListWithString

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and older
  Version    

  Severity   Major

  Time To    Instant (5 mins)
  Fix        
  ---------- --------------------------------------------------------------

No Literal For Reference
------------------------

Method arguments and return values may be by reference. Then, they need
to be a valid variable.

Objects are always passed by reference, so there is no need to
explicitly declare it.

Expressions, including ternary operator, produce value, and can\'t be
used by reference directly. This is also the case for expression that
include one or more reference.

``` {.php}
<?php

// variables, properties, static properties, array items are all possible
$a = 1;
foo($a);

//This is not possible, as a literal can't be a reference
foo(1);

function foo(&$int) { return $int; }


// This is not a valid reference
function &bar() { return 2; }
function &bar2() { return 2 + $r; }

?>
```

Wrongly passing a value as a reference leads to a PHP Notice.

See also [References](https://www.php.net/references).

### Suggestions

-   Remove the reference in the method signature (argument or return
    value)
-   Make the argument an object, by using a typehint (non-scalar)
-   Put the value into a variable prior to call (or return) the method

  ------------- ----------------------------------
  Short name    Functions/NoLiteralForReference

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

No Magic Method With Array
--------------------------

Magic method `__set()` doesn\'t work for array syntax.

When overloading properties, they can only be used for scalar values,
excluding arrays. Under the hood, PHP uses `__get()` to reach for the
name of the property, and doesn\'t recognize the following index as an
array. It yields an error : Indirect modification of overloaded
property.

``` {.php}
<?php

class c {
    private $a;
    private $o = array();

    function __get($name) {
        return $this->o[$name];
    }

    function foo() {
        // property b doesn't exists
        $this->b['a'] = 3;

        print_r($this);
    }

    // This method has no impact on the issue
    function __set($name, $value) {
        $this->o[$name] = $value;
    }
}

$c = new c();
$c->foo();

?>
```

It is possible to use the array syntax with a magic property : by making
the `__get` returns an array, the syntax will actually extract the
expected item in the array.

This is not reported by linting.

In this analysis, only properties that are found to be magic are
reported. For example, using the b property outside the class scope is
not reported, as it would yield too many false-positives.

See also
[Overload](https://www.php.net/manual/en/language.oop5.overloading.php#object.get).

### Suggestions

-   Use a distinct method to append a new value to that property
-   Assign the whole array, and not just one of its elements

  ------------- ---------------------------------------------------------
  Short name    Classes/NoMagicWithArray

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)

  Precision     Medium
  ------------- ---------------------------------------------------------

No More Curly Arrays
--------------------

Only use square brackets to access array elements. The usage of curly
brackets for array access is deprecated since PHP 7.4.

``` {.php}
<?php

$array = [1,2,3];

// always valid
echo $array[1];

// deprecated in PHP 7.4
echo $array{1};

?>
```

See also [Deprecate curly brace
syntax](https://derickrethans.nl/phpinternalsnews-19.html) and
[Deprecate curly brace syntax for accessing array elements and string
offsets](https://wiki.php.net/rfc/deprecate_curly_braces_array_access).

### Suggestions

-   Always use square brackets to access particular index in an array

  ------------- ----------------------------------------
  Short name    Php/NoMoreCurlyArrays

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Php Version   8.0-

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     Very high
  ------------- ----------------------------------------

No Need For Else
----------------

Else is not needed when the Then ends with a
[break](https://www.php.net/manual/en/control-structures.break.php). A
[break](https://www.php.net/manual/en/control-structures.break.php) may
be the following keywords :
[break](https://www.php.net/manual/en/control-structures.break.php),
[continue](https://www.php.net/manual/en/control-structures.continue.php),
return, goto. Any of these send the execution somewhere in the code. The
else block is then executed as the main sequence, only if the condition
fails.

``` {.php}
<?php

function foo() {
    // Else may be in the main sequence.
    if ($a1) {
        return $a1;
    } else {
        $a++;
    }

    // Same as above, but negate the condition : if (!$a2) { return $a2; }
    if ($a2) {
        $a++;
    } else {
        return $a2;
    }

    // This is OK
    if ($a3) {
        return;
    }

    // This has no break
    if ($a4) {
        $a++;
    } else {
        $b++;
    }

    // This has no else
    if ($a5) {
        $a++;
    }
}
?>
```

See also [Object Calisthenics, rule \#
2](http://williamdurand.fr/2013/06/03/object-calisthenics/).

### Suggestions

-   Remove else block, but keep the code

  ---------- ------------------------------------------------------------
  Short name Structures/NoNeedForElse

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `thelia-structures-noneedforelse`{.interpreted-text
             role="ref"},
             `thinkphp-structures-noneedforelse`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

No Need For Triple Equal
------------------------

There is no need for the identity comparison when the methods returns
the proper type.

``` {.php}
<?php

// foo() returns a string. 
if ('a' === foo()) {
    // doSomething()
}


function foo() : string { 
    return 'a';
}

?>
```

### Suggestions

-   

  ------------- -----------------------------
  Short name    Structures/NoNeedForTriple

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

No Need For get\_class() {#no-need-for-get\\_class()}
------------------------

There is no need to call [get\_class()](https://www.php.net/get_class)
to build a
[static](https://www.php.net/manual/en/language.oop5.static.php) call.
The argument of [get\_class()](https://www.php.net/get_class) may be
used directly.

``` {.php}
<?php

// 
$a->b::$c

// This is too much code
get_class($a->b)::$c

?>
```

See also [Scope Resolution Operator
(::)](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php).

### Suggestions

-   Use get\_called\_class(), which may carry different class names
-   Use self, static or parent keywords, if you are already in the
    current class
-   Use the argument of get\_class() directly

  ------------- ---------------------------------
  Short name    Structures/NoNeedGetClass

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

No Net For Xml Load
-------------------

Simplexml and ext/DOM load all external entities from the web, by
default. This is dangerous, in particular when loading unknown XML code.

Look at this XML code below : it is valid. It defines an entity `xxe`,
that is filled with a file, read on the system and base64 encoded.:

    &lt;!DOCTYPE replace [&lt;!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php"&gt; ]&gt;
    <replace>&xxe;</replace>

This file could be processed with the following code : note, you can
replace \'index.php\' in the above entity by any valid filepath.

``` {.php}
<?php 
    $dom = new DOMDocument();
    $dom->loadXML($xml, LIBXML_NOENT | LIBXML_DTDLOAD);
    $info = simplexml_import_dom($dom);

    print base64_decode($info[0]);
?>
```

Here, PHP tries to load the XML file, finds the entity, then solves the
entity by encoding a file called `index.php`. The source code of the
file is not used as data in the XML file.

At that point, the example illustrates how a XXE works : by using the
XML engine to load external resources, and preprocessing the XML code.
in fact, there is only one change to make this XML code arbitrarily
injected ::

    &lt;!DOCTYPE replace [&lt;!ENTITY writer SYSTEM https://www.example.com/entities.dtd&gt; ]&gt;
    <replace>&xxe;</replace>

With the above example, the XML code is
[static](https://www.php.net/manual/en/language.oop5.static.php) (as, it
never changes), but the \'xxe\' definitions are loaded from a remove
website, and are completely under the attacker control.

See also [XML External
Entity](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection),
[XML External Entity (XXE)
Processing](https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing)
and [Detecting and exploiting XXE in SAML
Interfaces](https://web-in-security.blogspot.nl/2014/11/detecting-and-exploiting-xxe-in-saml.html).

### Suggestions

-   Strip out any entity when using external XML
-   Forbid any network to the XML engine, by configuring the XML engine
    without network access

  ------------- ------------------------------
  Short name    Security/NoNetForXmlLoad

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ------------------------------

No Parenthesis For Language Construct
-------------------------------------

Some PHP language constructs, such are `include`, `print`, `echo` don\'t
need parenthesis. They accept parenthesis, but it is may lead to strange
situations.

``` {.php}
<?php

// This is an attempt to load 'foo.inc', or kill the script
include('foo.inc') or die();
// in fact, this is read by PHP as : include 1 
// include  'foo.inc' or die();

?>
```

It it better to avoid using parenthesis with `echo`, `print`, `return`,
`throw`, `yield`, `yield from`, `include`, `require`, `include_once`,
`require_once`.

See also [include](https://www.php.net/manual/en/function.include.php).

### Suggestions

-   Remove parenthesis

  ---------- ----------------------------------------------------------------------------------------------------------------------------------------
  Short name Structures/NoParenthesisForLanguageConstruct

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `Suggestions`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-parenthesis-for-language-construct](https://github.com/dseguy/clearPHP/tree/master/rules/no-parenthesis-for-language-construct.md)

  Examples   `phpdocumentor-structures-noparenthesisforlanguageconstruct`{.interpreted-text role="ref"},
             `phpmyadmin-structures-noparenthesisforlanguageconstruct`{.interpreted-text role="ref"}
  ---------- ----------------------------------------------------------------------------------------------------------------------------------------

No Plus One
-----------

Incrementing a variable should be done with the ++ or \-- operators. Any
other way, may be avoided.

``` {.php}
<?php

// Best way to increment
++$x; --$y;

// Second best way to increment, if the current value is needed :
echo $x++, $y--;

// Good but slow 
$x += 1; 
$x -= -1; 

$y += -1;
$y -= 1;

// even slower
$x = $x + 1; 
$y = $y - 1; 

?>
```

  ------------- -------------------------------------------------------------
  Short name    Structures/PlusEgalOne

  Rulesets      `Coding Conventions <coding-conventions>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------------------------------------

No Public Access
----------------

The properties below are declared with public access, but are never used
publicly. They can be made protected or private.

``` {.php}
<?php

class foo {
    public $bar = 1;            // Public, and used in public space
    public $neverInPublic = 3;  // Public, but never used in outside the class

    function bar() {
        $neverInPublic++;
    }
}

$x = new foo();
$x->bar = 3;
$x->bar();

?>
```

  ------------- -----------------------------
  Short name    Classes/NoPublicAccess

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

No Real Comparison
------------------

Avoid comparing decimal numbers with ==, ===, !==, !=. Real numbers have
an error margin which is random, and makes it very difficult to match
even if the compared value is a literal.

PHP uses an internal representation in base 2 : any number difficult to
represent with this base (like 0.1 or 0.7) will have a margin of error.

``` {.php}
<?php

$a = 1/7;
$b = 2.0;

// 7 * $a is a real, not an integer
var_dump( 7 * $a === 1);

// rounding error leads to wrong comparison
var_dump( (0.1 + 0.7) * 10 == 8);
// although
var_dump( (0.1 + 0.7) * 10);
// displays 8

// precision formula to use with reals. Adapt 0.0001 to your precision needs
var_dump( abs(((0.1 + 0.7) * 10) - 8) < 0.0001); 

?>
```

Use precision formulas with [abs()](https://www.php.net/abs) to
approximate values with a given precision, or avoid reals altogether.

See also [Floating point
numbers](https://www.php.net/manual/en/language.types.float.php#language.types.float).

### Suggestions

-   Cast the values to integer before comparing
-   Compute the difference, and keep it below a threshold
-   Use the gmp or the bc extension to handle high precision numbers
-   Change the \'precision\' directive of PHP :
    ini\_set(\'precision\', 30) to make number larger
-   Multiply by a power of ten, before casting to integer for the
    comparison
-   Use floor(), ceil() or round() to compare the numbers, with a
    specific precision

  ---------- --------------------------------------------------------------------------------------------------
  Short name Type/NoRealComparison

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `Top10`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-real-comparison](https://github.com/dseguy/clearPHP/tree/master/rules/no-real-comparison.md)

  Examples   `magento-type-norealcomparison`{.interpreted-text role="ref"},
             `spip-type-norealcomparison`{.interpreted-text role="ref"}
  ---------- --------------------------------------------------------------------------------------------------

No Reference For Static Property
--------------------------------

[Static](https://www.php.net/manual/en/language.oop5.static.php)
properties used to behave independently when set to a reference value.
This was fixed in PHP 7.3.

According to the PHP 7.3 changelog :
`` In PHP, `static <https://www.php.net/manual/en/language.oop5.static.php>`_ properties are shared between inheriting classes, unless the `static <https://www.php.net/manual/en/language.oop5.static.php>`_ property is explicitly overridden in a child class. However, due to an implementation artifact it was possible to separate the `static <https://www.php.net/manual/en/language.oop5.static.php>`_ properties by assigning a reference. This loophole has been fixed. ``.

``` {.php}
<?php

        class Test {
            public static $x = 0;
        }
        class Test2 extends Test { }

        Test2::$x = &$x;
        $x = 1;

        var_dump(Test::$x, Test2::$x);
        // Previously: int(0), int(1)
        // Now: int(1), int(1)

?>
```

See also [PHP 7.3 UPGRADE
NOTES](https://github.com/php/php-src/blob/3b6e1ee4ee05678b5d717cd926a35ffdc1335929/UPGRADING#L66-L81).

  ---------- ------------------------------------------------------------------
  Short name Php/NoReferenceForStaticProperty

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.3 and older
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- ------------------------------------------------------------------

No Reference For Ternary
------------------------

The ternary operator and the null coalescing operator are both
expressions that only return values, and not a variable.

This means that any provided reference will be turned into its value.
While this is usually invisible, it will raise a warning when a
reference is expected. This is the case with methods returning a
reference.

A PHP notice is generated when using a ternary operator or the null
coalesce operator :
`Only variable references should be returned by reference`. The notice
is also emitted when returning objects.

This applies to methods, functions and closures.

``` {.php}
<?php

// This works
function &foo($a, $b) { 
    if ($a === 1) {
        return $b; 
    } else {
        return $a; 
    }
}

// This raises a warning, as the operator returns a value
function &foo($a, $b) { return $a === 1 ? $b : $a; }

?>
```

See also [Null Coalescing
Operator](https://www.php.net/manual/en/language.operators.comparison.php#language.operators.comparison.coalesce),
[Ternary
Operator](https://www.php.net/manual/en/language.operators.comparison.php#language.operators.comparison.ternary).

### Suggestions

-   Drop the reference at assignation time
-   Drop the reference in the argument definition
-   Drop the reference in the function return definition

  ------------- ---------------------------------------------------------
  Short name    Php/NoReferenceForTernary

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)

  Examples      `phpadsnew-php-noreferenceforternary`{.interpreted-text
                role="ref"}
  ------------- ---------------------------------------------------------

No Reference On Left Side
-------------------------

Do not use references as the right element in an assignation.

``` {.php}
<?php

$b = 2;
$c = 3;

$a = &$b + $c;
// $a === 2 === $b;

$a = $b + $c;
// $a === 5

?>
```

This is the case for most situations : addition, multiplication,
bitshift, logical, power, concatenation. Note that PHP won\'t compile
the code if the operator is a short operator (+=, .=, etc.), nor if the
& is on the right side of the operator.

  ------------- ----------------------------------
  Short name    Structures/NoReferenceOnLeft

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

No Return For Generator
-----------------------

Return is not allowed in generator. In PHP versions older than 5.6 and
older, they yield a fatal Error.

``` {.php}
<?php

function generatorWithReturn() {
    yield 1;
    return 2;
}

?>
```

See also [Generators
overview](https://www.php.net/manual/en/language.generators.overview.php).

  ---------- --------------------------------------------------------------
  Short name Php/NoReturnForGenerator

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and more recent
  Version    

  Severity   Critical

  Time To    Quick (30 mins)
  Fix        
  ---------- --------------------------------------------------------------

No Return Or Throw In Finally
-----------------------------

Avoid using return and throw in a finally block. Both command will
interrupt the processing of the try catch block, and any exception that
was emitted will not be processed. This leads to unprocessed exceptions,
leaving the application in an unstable state.

Note that PHP prevents the usage of goto,
[break](https://www.php.net/manual/en/control-structures.break.php) and
[continue](https://www.php.net/manual/en/control-structures.continue.php)
within the finally block at linting phase. This is categorized as a
Security problem.

``` {.php}
<?php
function foo() {
        try {
            // Exception is thrown here 
            throw new \Exception();
        } catch (Exception $e) {
            // This is executed AFTER finally
            return 'Exception';
        } finally {
            // This is executed BEFORE catch
            return 'Finally';
        }
    }
}

// Displays 'Finally'. No exception
echo foo();

function bar() {
        try {
            // Exception is thrown here 
            throw new \Exception();
        } catch (Exception $e) {
            // Process the exception. 
            return 'Exception';
        } finally {
            // clean the current situation
            // Keep running the current function
        }
        return 'Finally';
    }
}

// Displays 'Exception', with processed Exception
echo bar();

?>
```

See also [Return Inside Finally
Block](https://www.owasp.org/index.php/Return_Inside_Finally_Block).

### Suggestions

-   Move the return right after the try/catch/finally call

  ------------- ------------------------------
  Short name    Structures/NoReturnInFinally

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

No Return Used
--------------

The return value of the following functions are never used. The return
argument may be dropped from the code, as it is dead code.

This analysis supports functions and
[static](https://www.php.net/manual/en/language.oop5.static.php)
methods, when a definition may be found. It doesn\'t support method
calls.

``` {.php}
<?php

function foo($a = 1;) { return 1; }
foo();
foo();
foo();
foo();
foo();
foo();

// This function doesn't return anything. 
function foo2() { }

// The following function are used in an expression, thus the return is important
function foo3() {  return 1;}
function foo4() {  return 1;}
function foo5() {  return 1;}

foo3() + 1; 
$a = foo4();
foo(foo5());

?>
```

### Suggestions

-   Remove the return statement in the function
-   Actually use the value returned by the method, for test or
    combination with other values

  ---------- ------------------------------------------------------------
  Short name Functions/NoReturnUsed

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Suggestions`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  Examples   `spip-functions-noreturnused`{.interpreted-text role="ref"},
             `livezilla-functions-noreturnused`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

No Self Referencing Constant
----------------------------

It is not possible to use a constant to define itself in a class. It
yields a fatal error at runtime.

The PHP error reads :
`` Cannot declare `self <https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php>`_-referencing constant '`self <https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php>`_\:\:C2' ``.
Unlike PHP which is
[self](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)-referencing,
[self](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
referencing variables can\'t have a value : just don\'t use that.

``` {.php}
<?php
    class a { 
        const C1 = 1;         // fully defined constant
        const C2 = self::C2;  // self referencing constant
        const C3 = a::C3 + 2; // self referencing constant
    }
?>
```

The code may access an already declared constant with
[self](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
or with its class name.

``` {.php}
<?php
    class a { 
        const C1 = 1; 
        const C2 = a::C1; 
    }
?>
```

This error is not detected by linting. It is only detected at
instantiation time : if the class is not used, it won\'t appear.

### Suggestions

-   Give a literal value to this constant
-   Give a constant value to this constant : other class constants or
    constant are allowed here.

  ------------- ---------------------------------------------------------
  Short name    Classes/NoSelfReferencingConstant

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text role="ref"},
                `ClassReview`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------------------------------

No Spread For Hash
------------------

The spread operator `...` only works on integer-indexed arrays.

``` {.php}
<?php

// This is valid, as ``-33`` is cast to integer by PHP automagically
var_dump(...[1,-33 => 2, 3]);

// This is not valid
var_dump(...[1,C => 2, 3]);

?>
```

See also [Variable-length argument
lists](https://www.php.net/manual/en/functions.arguments.php#functions.variable-arg-list).

### Suggestions

-   Add a call to array\_values() instead of the hash

  ------------- -----------------------------
  Short name    Arrays/NoSpreadForHash

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

No String With Append
---------------------

PHP 7 doesn\'t allow the usage of \[\] with strings. \[\] is an
array-only operator.

``` {.php}
<?php

$string = 'abc';

// Not possible in PHP 7
$string[] = 'd';

?>
```

This was possible in PHP 5, but is now forbidden in PHP 7.

### Suggestions

-   Use the concatenation operator `.` to append strings.
-   Use the concatenation short assignement `.=` to append strings.

  ---------- --------------------------------------------------------------
  Short name Php/NoStringWithAppend

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and more recent
  Version    

  Severity   Major

  Time To    Quick (30 mins)
  Fix        
  ---------- --------------------------------------------------------------

No Substr Minus One
-------------------

Negative index were introduced in PHP 7.1. This syntax is not compatible
with PHP 7.0 and older.

``` {.php}
<?php
$string = 'abc';

echo $string[-1]; // c

echo $string[1]; // a

?>
```

See also [Generalize support of negative string
offsets](https://wiki.php.net/rfc/negative-string-offsets).

### Suggestions

-   Use the -1 index in a string, instead of a call to substr()

  ---------- ----------------------------------------------------------------
  Short name Php/NoSubstrMinusOne

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.1 and more recent
  Version    

  Severity   Major

  Time To    Quick (30 mins)
  Fix        
  ---------- ----------------------------------------------------------------

No Weak SSL Crypto
------------------

When enabling PHP\'s stream SSL, it is important to use a safe protocol.

All the SSL protocols (1.0, 2.0, 3.0), and TLS (1.0 are unsafe. The best
is to use the most recent TLS, version 1.2.

stream\_socket\_enable\_crypto() and
[curl\_setopt()](https://www.php.net/curl_setopt) are checked.

``` {.php}
<?php

// This socket will use SSL v2, which 
$socket = 'sslv2://www.example.com';
$fp = fsockopen($socket, 80, $errno, $errstr, 30);

?>
```

Using the TLS transport protocol of PHP will choose the version by
itself.

See also [Insecure Transportation Security Protocol Supported (TLS
1.0)](https://www.netsparker.com/web-vulnerability-scanner/vulnerabilities/insecure-transportation-security-protocol-supported-tls-10/),
[The 2018 Guide to Building Secure PHP
Software](https://paragonie.com/blog/2017/12/2018-guide-building-secure-php-software)
and [Internet Domain: TCP, UDP, SSL, and
TLS](https://www.php.net/manual/en/transports.inet.php).

### Suggestions

-   Use TLS transport, with version 1.2

  ------------- ------------------------------
  Short name    Security/NoWeakSSLCrypto

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

No array\_merge() In Loops {#no-array\\_merge()-in-loops}
--------------------------

[array\_merge()](https://www.php.net/array_merge) is memory intensive :
every call will duplicate the arguments in memory, before merging them.

To handle arrays that may be quite big, it is recommended to avoid using
[array\_merge()](https://www.php.net/array_merge) in a loop. Instead,
one should use [array\_merge()](https://www.php.net/array_merge) with as
many arguments as possible, making the merge a on time call.

``` {.php}
<?php

// A large multidimensional array
$source = ['a' => ['a', 'b', /*...*/],
           'b' => ['b', 'c', 'd', /*...*/],
           /*...*/
           ];

// Faster way
$b = array();
foreach($source as $key => $values) {
    //Collect in an array
    $b[] = $values;
}

// One call to array_merge
$b = call_user_func_array('array_merge', $b);
// or with variadic
$b = call_user_func('array_merge', ..$b);

// Fastest way (with above example, without checking nor data pulling)
$b = call_user_func_array('array_merge', array_values($source))
// or
$b = call_user_func('array_merge', ...array_values($source))

// Slow way to merge it all
$b = array();
foreach($source as $key => $values) {
    $b = array_merge($b, $values);
}

?>
```

Note that
[array\_merge\_recursive()](https://www.php.net/array_merge_recursive)
and [file\_put\_contents()](https://www.php.net/file_put_contents) are
affected and reported the same way.

### Suggestions

-   Store all intermediate arrays in a temporary variable, and use
    array\_merge() once, with ellipsis or call\_user\_func\_array().

  ---------- -----------------------------------------------------------------------------------------------------------
  Short name Performances/ArrayMergeInLoops

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `Performances`{.interpreted-text role="ref"},
             `Top10`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-array\_merge-in-loop](https://github.com/dseguy/clearPHP/tree/master/rules/no-array_merge-in-loop.md)

  Examples   `tine20-performances-arraymergeinloops`{.interpreted-text role="ref"}
  ---------- -----------------------------------------------------------------------------------------------------------

No get\_class() With Null {#no-get\\_class()-with-null}
-------------------------

It is not possible to pass explicitly null to
[get\_class()](https://www.php.net/get_class) to get the current\'s
class name. Since PHP 7.2, one must call
[get\_class()](https://www.php.net/get_class) without arguments to
achieve that result.

``` {.php}
<?php

class A {
  public function f() {
    // Gets the classname
    $classname = get_class();

    // Gets the classname and a warning
    $classname = get_class(null);
  }
}

$a = new A();
$a->f('get_class');

?>
```

  ---------- ------------------------------------------------------------------
  Short name Structures/NoGetClassNull

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Instant (5 mins)
  Fix        
  ---------- ------------------------------------------------------------------

No isset() With empty() {#no-isset()-with-empty()}
-----------------------

[empty()](https://www.php.net/empty) actually does the job of
[isset()](https://www.www.php.net/isset) too.

From the manual :
`` No warning is generated if the variable does not exist. That means `empty() <https://www.php.net/empty>`_ is essentially the concise equivalent to !`isset( <https://www.www.php.net/isset>`_$var) || $var == false. ``
The main difference is that [isset()](https://www.www.php.net/isset)
only works with variables, while [empty()](https://www.php.net/empty)
works with other structures, such as constants.

``` {.php}
<?php


// Enough validation
if (!empty($a)) {
    doSomething();
}

// Too many tests
if (isset($a) && !empty($a)) {
    doSomething();
}

?>
```

See also
[Isset](http://www.php.net/%60isset%20%3Chttps://www.www.php.net/isset)\>[\_
and \`empty \<http://www.php.net/empty\>]{.title-ref}\_.

### Suggestions

-   Only use isset(), just drop the empty()
-   Only use empty(), just drop the empty()
-   Use a null value, so the variable is always set

  ------------- -------------------------------------------------------
  Short name    Structures/NoIssetWithEmpty

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)

  Examples      `xoops-structures-noissetwithempty`{.interpreted-text
                role="ref"}
  ------------- -------------------------------------------------------

No mb\_substr In Loop {#no-mb\\_substr-in-loop}
---------------------

Do not use loops on [mb\_substr()](https://www.php.net/mb_substr).

[mb\_substr()](https://www.php.net/mb_substr) always starts at the
beginning of the string ot search for the nth char, and recalculate
everything. This means that the first iterations are as fast as
[substr()](https://www.php.net/substr) (for comparison), while the
longer the string, the slower
[mb\_substr()](https://www.php.net/mb_substr).

The recommendation is to use
[preg\_split()](https://www.php.net/preg_split) with the [u]{.title-ref}
option, to split the string into an array. This save multiple
recalculations.

``` {.php}
<?php

// Split the string by characters
$array = preg_split('//u', $string, -1, PREG_SPLIT_NO_EMPTY);
foreach($array as $c) {
    doSomething($c);
}

// Slow version
$nb = mb_strlen($mb);
for($i = 0; $i < $nb; ++$i) {
    // Fetch a character
    $c = mb_substr($string, $i, 1);
    doSomething($c);
}

?>
```

See also [Optimization: How I made my PHP code run 100 times
faster](https://mike42.me/blog/2018-06-how-i-made-my-php-code-run-100-times-faster)
and [How to iterate UTF-8 string in
PHP?](https://stackoverflow.com/questions/3666306/how-to-iterate-utf-8-string-in-php).

### Suggestions

-   Use preg\_split() and loop on its results.

  ------------- ----------------------------------
  Short name    Performances/MbStringInLoop

  Rulesets      `Performances`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Non Ascii Variables
-------------------

PHP allows certain characters in variable names. The variable name must
only include letters, figures, underscores and ASCII characters from 128
to 255.

In practice, letters outside the scope of `a-zA-Z0-9` are rare, and
require more care when editing the code or passing it from OS to OS.

``` {.php}
<?php

class 人 {
    // An actual working class in PHP.
    public function __construct() {
        echo __CLASS__;
    }
}

$人民 = new 人();

?>
```

See also
[Variables](https://www.php.net/manual/en/language.variables.basics.php).

### Suggestions

-   Make sure those special chars have actual meaning.

  ------------- --------------------------------------------------------
  Short name    Variables/VariableNonascii

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Examples      `magento-variables-variablenonascii`{.interpreted-text
                role="ref"}
  ------------- --------------------------------------------------------

Non Nullable Getters
--------------------

A getter needs to be nullable when a property is injected.

In particular, if the injection happens with a separate method, there is
a time where the object is not consistent, and the property holds a
default non-object value.

``` {.php}
<?php

class Consistent {
    private $db = null;

    function __construct(Db $db) { 
        $this->db = $db;
        // Object is immediately consistent 
    }

    // Db might be null
    function getDb() {
        return $this->db;
    }
}

class Inconsistent {
    private $db = null;

    function __construct() { 
        // No initialisation
    }

    // This might be called on time, or not
    // This typehint cannot be nullable, nor use null as default 
    function setDb(DB $db) {
        return $this->db;
    }

    // Db might be null
    function getDb() {
        return $this->db;
    }
}
?>
```

### Suggestions

-   Remove the nullable option and the tests on `null`.

  ------------- ------------------------------------
  Short name    Classes/NonNullableSetters

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------

Non Static Methods Called In A Static
-------------------------------------

[Static](https://www.php.net/manual/en/language.oop5.static.php) methods
have to be declared as such (using the
[static](https://www.php.net/manual/en/language.oop5.static.php)
keyword). Then, one may call them without instantiating the object.

PHP 7.0, and more recent versions, yield a deprecated error :
`` Non-`static <https://www.php.net/manual/en/language.oop5.static.php>`_ method A\:\:B() should not be called statically ``.

PHP 5 and older doesn\'t check that a method is
[static](https://www.php.net/manual/en/language.oop5.static.php) or not
: at any point, the code may call one method statically.

``` {.php}
<?php
    class x {
        static public function sm( ) { echo __METHOD__.\n; }
        public public sm( ) { echo __METHOD__.\n; }
    } 

    x::sm( ); // echo x::sm 

    // Dynamic call
    ['x', 'sm']();
    [\x::class, 'sm']();

    $s = 'x::sm';
    $s();

?>
```

It is a bad idea to call
non-[static](https://www.php.net/manual/en/language.oop5.static.php)
method statically. Such method may make use of special variable
[\$this](https://www.php.net/manual/en/language.oop5.basic.php), which
will be undefined. PHP will not check those calls at compile time, nor
at running time.

It is recommended to update this situation : make the method actually
[static](https://www.php.net/manual/en/language.oop5.static.php), or use
it only in object context.

Note that this analysis reports all
[static](https://www.php.net/manual/en/language.oop5.static.php) method
call made on a
non-[static](https://www.php.net/manual/en/language.oop5.static.php)
method, even within the same class or class hierarchy. PHP silently
accepts [static](https://www.php.net/manual/en/language.oop5.static.php)
call to any in-family method.

``` {.php}
<?php
    class x {
        public function foo( ) { self::bar() }
        public function bar( ) { echo __METHOD__.\n; }
    } 
?>
```

See also [Static
Keyword](https://www.php.net/manual/en/language.oop5.%60static%20%3Chttps://www.php.net/manual/en/language.oop5.static.php).php\>\`\_.

### Suggestions

-   Call the method the correct way
-   Define the method as static

  ----------- ------------------------------------------------------------------
  Short name  Classes/NonStaticMethodsCalledStatic

  Rulesets    `Analyze`{.interpreted-text role="ref"},
              `CompatibilityPHP56`{.interpreted-text role="ref"},
              `CompatibilityPHP53`{.interpreted-text role="ref"},
              `CompatibilityPHP54`{.interpreted-text role="ref"},
              `CompatibilityPHP55`{.interpreted-text role="ref"},
              `CI-checks`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Quick (30 mins)

  Precision   Medium

  Examples    `dolphin-classes-nonstaticmethodscalledstatic`{.interpreted-text
              role="ref"},
              `magento-classes-nonstaticmethodscalledstatic`{.interpreted-text
              role="ref"}
  ----------- ------------------------------------------------------------------

Non-constant Index In Array
---------------------------

Undefined constants revert as strings in Arrays. They are also called
`barewords`.

In `$array[index]`, PHP cannot find index as a constant, but, as a
default behavior, turns it into the string `index`.

This default behavior raise concerns when a corresponding constant is
defined, either using [define()](https://www.php.net/define) or the
const keyword (outside a class). The definition of the index constant
will modify the behavior of the index, as it will now use the constant
definition, and not the \'index\' string.

``` {.php}
<?php

// assign 1 to the element index in $array
// index will fallback to string
$array[index] = 1; 
//PHP Notice:  Use of undefined constant index - assumed 'index'

echo $array[index];      // display 1 and the above error
echo "$array[index]";    // display 1
echo "$array['index']";  // Syntax error


define('index', 2);

 // now 1 to the element 2 in $array
 $array[index] = 1;

?>
```

It is recommended to make index a real string (with \' or \"), or to
define the corresponding constant to avoid any future surprise.

Note that PHP 7.2 removes the support for this feature.

See also [PHP RFC: Deprecate and Remove Bareword (Unquoted)
Strings](https://wiki.php.net/rfc/deprecate-bareword-strings) and
[Syntax](https://www.php.net/manual/en/language.constants.syntax.php).

### Suggestions

-   Declare the constant to give it an actual value
-   Turn the constant name into a string

  ---------- ------------------------------------------------------------
  Short name Arrays/NonConstantArray

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `dolibarr-arrays-nonconstantarray`{.interpreted-text
             role="ref"},
             `zencart-arrays-nonconstantarray`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Non-lowercase Keywords
----------------------

The usual convention is to write PHP keywords (like `as`, `foreach`,
`switch`, `case`, `break`, etc.) all in lowercase.

``` {.php}
<?php

// usual PHP convention
foreach($array as $element) {
    echo $element;
}

// unusual PHP conventions
Foreach($array AS $element) {
    eCHo $element;
}

?>
```

PHP understands them in lowercase, UPPERCASE or WilD Case, so there is
nothing compulsory here. Although, it will look strange to many.

Some keywords are missing from this analysis : `extends`, `implements`,
`as`. This is due to the internal engine, which doesn\'t keep track of
them in its AST representation.

### Suggestions

-   Use lowercase only PHP keywords, except for constants such as
    \_\_CLASS\_\_.

  ------------- -------------------------------------------------------------
  Short name    Php/UpperCaseKeyword

  Rulesets      `Coding Conventions <coding-conventions>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- -------------------------------------------------------------

Not A Scalar Type
-----------------

`int` is the actual PHP scalar type, not `integer`.

PHP 7 introduced several scalar types, in particular `int`, `bool` and
`float`. Those three types are easily mistaken with `integer`,
`boolean`, `real` and `double`.

Unless those classes actually exists, PHP emits some strange error
messages.

``` {.php}
<?php

// This expects a scalar of type 'integer'
function foo(int $i) {}

// This expects a object of class 'integer'
function abr(integer $i) {}

?>
```

Thanks to `Benoit Viguier` for the [original
idea](https://twitter.com/b_viguier/status/940173951908700161) for this
analysis.

See also [Type
declarations](https://www.php.net/manual/en/functions.arguments.php#functions.arguments.type-declaration).

### Suggestions

-   Do not use `int` as a class name, an interface name or a trait name.

  ------------- --------------------------------
  Short name    Php/NotScalarType

  Rulesets      `Typechecks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)
  ------------- --------------------------------

Not Equal Is Not !== {#not-equal-is-not-!==}
--------------------

Not and Equal operators, used separately, don\'t amount to the different
operator `!==`.

`!$a == $b` first turns `$a`into the opposite boolean, then compares
this boolean value to `$b`. On the other hand, `$a !== $b` compares the
two variables for type and value, and returns a boolean.

``` {.php}
<?php

if ($string != 'abc') {
    // doSomething()
}

// Here, string will be an boolean, leading 
if (!$string == 'abc') {
    // doSomething()
}

// operator priority may be confusing
if (!$object instanceof OneClass) {
    // doSomething()
}
?>
```

Note that the `instanceof` operator may be use with this syntax, due to
operator precedence.

See also [Operator
Precedence](https://www.php.net/manual/en/language.operators.precedence.php).

### Suggestions

-   Use the != or !==
-   Use parenthesis

  ------------- ----------------------------------
  Short name    Structures/NotEqual

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Not Not
-------

Double not makes a boolean, not a `true`.

This is a wrong casting to boolean. PHP supports `(boolean)` to do the
same, faster and cleaner.

``` {.php}
<?php
    // Explicit code
    $b = (boolean) $x; 
    $b = (bool) $x; 

    // Wrong type casting
    $b = !!$x; 

?>
```

See also [Logical
Operators](https://www.php.net/manual/en/language.operators.logical.php)
and [Type
Juggling](https://www.php.net/manual/en/language.types.type-juggling.php).

### Suggestions

-   Use `(bool)` casting operator for that
-   Don\'t typecast, and let PHP handle it. This works in situations
    where the boolean is immediately used.

  ---------- --------------------------------------------------------------------------------------------
  Short name Structures/NotNot

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [no-implied-cast](https://github.com/dseguy/clearPHP/tree/master/rules/no-implied-cast.md)

  Examples   `cleverstyle-structures-notnot`{.interpreted-text role="ref"},
             `tine20-structures-notnot`{.interpreted-text role="ref"}
  ---------- --------------------------------------------------------------------------------------------

Null On New
-----------

Until PHP 7, some classes instantiation could yield null, instead of
throwing an exception.

After issuing a \'new\' with those classes, it was important to check if
the returned object were null or not. No exception were thrown.

``` {.php}
<?php

// Example extracted from the wiki below
$mf = new MessageFormatter('en_US', '{this was made intentionally incorrect}');
if ($mf === null) {
    echo 'Surprise!';
}

?>
```

This inconsistency has been cleaned in PHP 7 : see See [Internal
Constructor
Behavior](https://wiki.php.net/rfc/internal_constructor_behaviour)

See also [PHP RFC: Constructor behaviour of internal
classes](https://wiki.php.net/rfc/internal_constructor_behaviour).

### Suggestions

-   Remove the check on null after a new instantiation

  ---------- --------------------------------------------------------------
  Short name Classes/NullOnNew

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and older
  Version    

  Severity   Major

  Time To    Instant (5 mins)
  Fix        
  ---------- --------------------------------------------------------------

Null Or Boolean Arrays
----------------------

Null and booleans are valid PHP array base. Yet, they only produces
`null` values. They also did not emits any warning until PHP 7.4.

This analysis has been upgraded to cover int and float types too.

``` {.php}
<?php

// outputs NULL
var_dump(null[0]);

const MY_CONSTANT = true;
// outputs NULL
var_dump(MY_CONSTANT[10]);

?>
```

See also [Null and
True](https://twitter.com/Chemaclass/status/1144588647464951808).

### Suggestions

-   Avoid using the array syntax on null and boolean
-   Avoid using null and boolean on constant that are expecting arrays

  ------------- -----------------------------
  Short name    Arrays/NullBoolean

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Nullable With Constant
----------------------

Arguments are automatically nullable with a literal null. They used to
also be nullable with a constant null, before PHP 8.0.

``` {.php}
<?php

// Extracted from https://github.com/php/php-src/blob/master/UPGRADING

// Replace
function test(int $arg = CONST_RESOLVING_TO_NULL) {}
// With
function test(?int $arg = CONST_RESOLVING_TO_NULL) {}
// Or
function test(int $arg = null) {}

?>
```

### Suggestions

-   Use the valid syntax

  ------------- ----------------------------------------
  Short name    Functions/NullableWithConstant

  Rulesets      `CompatibilityPHP80`{.interpreted-text
                role="ref"}

  Php Version   8.0-

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- ----------------------------------------

Nullable Without Check
----------------------

Nullable typehinted argument should be checked before usage.

``` {.php}
<?php

// This will emit a fatal error when $a = null
function foo(?A $a) {
    return $a->m();
}

// This is stable
function foo(?A $a) {
    if ($a === null) {
        return 42;
    } else {
        return $a->m();
    }
}

?>
```

### Suggestions

-   

  ------------- ---------------------------------
  Short name    Functions/NullableWithoutCheck

  Rulesets      `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Numeric Literal Separator
-------------------------

Integer and floats may be written with internal underscores. This way,
it is possible to separate large number into smaller groups, and make
them more readable.

Numeric Literal Separators were introduced in PHP 7.4 and are not
backward compatible.

``` {.php}
<?php
$a = 1_000_000_000;   // A billion
$a = 1000000000;      // A billion too...

$b = 107_925_284.88;‬ // 6 light minute to kilometers = 107925284.88 kilometers
$b = 107925284.88;‬   // Same as above
?>
```

See also [PHP RFC: Numeric Literal
Separator](https://wiki.php.net/rfc/numeric_literal_separator).

### Suggestions

-   

  ------------- ----------------------------------------
  Short name    Php/IntegerSeparatorUsage

  Rulesets      `CompatibilityPHP73`{.interpreted-text
                role="ref"}

  Php Version   7.4+

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Objects Don\'t Need References {#objects-don't-need-references}
------------------------------

There is no need to create references for objects, as those are always
passed by reference when used as arguments.

Note that when the argument is assigned another value, including another
object, then the reference is needed : PHP forgets about reference when
they are replaced.

``` {.php}
<?php

    $object = new stdClass();
    $object->name = 'a';

    foo($object);
    print $object->name; // Name is 'b'

    // No need to make $o a reference
    function foo(&$o) {
        $o->name = 'b';
    }


    // $o is assigned inside the function : it must be called with a &, or the object won't make it out of the foo3 scope
    function foo3(&$o) {
        $o = new stdClass;
    }

    $array = array($object);
    foreach($array as &$o) { // No need to make this a reference
        $o->name = 'c';
    }

?>
```

See also [Passing by
reference](https://www.php.net/manual/en/language.references.pass.php).

### Suggestions

-   Remove the reference
-   Assign the argument with a new value

  ---------- --------------------------------------------------------------------------------------------------------------
  Short name Structures/ObjectReferences

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `Top10`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text
             role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [no-references-on-objects](https://github.com/dseguy/clearPHP/tree/master/rules/no-references-on-objects.md)

  Examples   `zencart-structures-objectreferences`{.interpreted-text role="ref"},
             `xoops-structures-objectreferences`{.interpreted-text role="ref"}
  ---------- --------------------------------------------------------------------------------------------------------------

Old Style Constructor
---------------------

PHP classes used to have the method bearing the same name as the class
acts as the constructor. That was PHP 4, and early PHP 5.

The manual issues a warning about this syntax :
`` Old style constructors are DEPRECATED in PHP 7.0, and will be removed in a future version. You should always use `__construct() <https://www.php.net/manual/en/language.oop5.decon.php>`_ in new code. ``

``` {.php}
<?php

namespace {
    // Global namespace is important
    class foo {
        function foo() {
            // This acts as the old-style constructor, and is reported by PHP
        }
    }

    class bar {
        function __construct() { }
        function bar() {
            // This doesn't act as constructor, as bar has a __construct() method
        }
    }
}

namespace Foo\Bar{
    class foo {
        function foo() {
            // This doesn't act as constructor, as bar is not in the global namespace
        }
    }
}

?>
```

This is no more the case in PHP 5, which relies on `__construct()` to do
so. Having this old style constructor may bring in confusion, unless you
are also supporting old time PHP 4.

Note that classes with methods bearing the class name, but inside a
namespace are not following this convention, as this is not breaking
backward compatibility. Those are excluded from the analyze.

See also [Constructors and
Destructors](https://www.php.net/manual/en/language.oop5.decon.php).

### Suggestions

-   Remove old style constructor and make it `__construct()`
-   Remove old libraries and use a modern component

  ---------- ------------------------------------------------------------------------------------------------------
  Short name Classes/OldStyleConstructor

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CompatibilityPHP80`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-php4-class-syntax](https://github.com/dseguy/clearPHP/tree/master/rules/no-php4-class-syntax.md)
  ---------- ------------------------------------------------------------------------------------------------------

Old Style \_\_autoload() {#old-style-\\_\\_autoload()}
------------------------

Avoid \_\_autoload(), only use spl\_register\_autoload().

On the other hand, spl\_register\_autoload() allows registering and
de-registering multiple autoloading functions or methods.

``` {.php}
<?php

// Modern autoloading.
function myAutoload($class){}
spl_register_autoload('myAutoload');

// Old style autoloading.
function __autoload($class){}

?>
```

Do not use the old \_\_autoload() function, but rather the new
spl\_register\_autoload() function.

See also [Autoloading
Classe](https://www.php.net/manual/en/language.oop5.autoload.php).

### Suggestions

-   Move to spl\_register\_autoload()
-   Remove usage of the old \_\_autoload() function
-   Modernize usage of old libraries

  ---------- --------------------------------------------------------------------------------------------------
  Short name Php/oldAutoloadUsage

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [use-smart-autoload](https://github.com/dseguy/clearPHP/tree/master/rules/use-smart-autoload.md)

  Examples   `piwigo-php-oldautoloadusage`{.interpreted-text role="ref"}
  ---------- --------------------------------------------------------------------------------------------------

One If Is Sufficient
--------------------

Nested conditions may be written another way, and reduce the amount of
code.

Nested conditions are equivalent to a `&&` condition. As such, they may
be switched. When one of the condition has no explicit else, then it is
lighter to write it as the first condition. This way, it is written
once, and not repeated.

``` {.php}
<?php

// Less conditions are written here.
     if($b == 2) {
        if($a == 1) {
         ++$c;
     }
        else {
         ++$d;
     }
    }

// ($b == 2) is double here
    if($a == 1) {
     if($b == 2) {
         ++$c;
     }
    }
    else {
     if($b == 2) {
         ++$d;
     }
    }
?>
```

### Suggestions

-   Switch the if\...then conditions, to reduce the amount of conditions
    to read.

  ------------- -----------------------------------------------------------
  Short name    Structures/OneIfIsSufficient

  Rulesets      `Suggestions`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `tikiwiki-structures-oneifissufficient`{.interpreted-text
                role="ref"}
  ------------- -----------------------------------------------------------

One Letter Functions
--------------------

One letter functions seems to be really short for a meaningful name.
This may happens for very high usage functions, so as to keep code
short, but such functions should be rare.

``` {.php}
<?php

// Always use a meaningful name 
function addition($a, $b) {
    return $a + $b;
}

// One letter functions are rarely meaningful
function f($a, $b) {
    return $a + $b;
}

?>
```

### Suggestions

-   Use full names for functions
-   Remove the function name altogether : use a closure

  ---------- --------------------------------------------------------------
  Short name Functions/OneLetterFunctions

  Rulesets   `Coding Conventions <coding-conventions>`{.interpreted-text
             role="ref"}, `Semantics`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `thinkphp-functions-oneletterfunctions`{.interpreted-text
             role="ref"},
             `cleverstyle-functions-oneletterfunctions`{.interpreted-text
             role="ref"}
  ---------- --------------------------------------------------------------

One Variable String
-------------------

These strings only contains one variable or property or array.

``` {.php}
<?php

$a = 0;
$b = "$a"; // This is a one-variable string

// Better way to write the above
$b = (string) $a;

// Alternatives : 
$b2 = "$a[1]"; // This is a one-variable string
$b3 = "$a->b"; // This is a one-variable string
$c = "d";
$d = "D";
$b4 = "{$$c}";
$b5 = "{$a->foo()}";

?>
```

When the goal is to convert a variable to a string, it is recommended to
use the type casting (string) operator : it is then clearer to
understand the conversion. It is also marginally faster, though very
little.

See also
[Strings](https://www.php.net/manual/en/language.types.string.php) and
[Type
Juggling](https://www.php.net/manual/en/language.types.type-juggling.php).

### Suggestions

-   Drop the surrounding string, keep the variable (or property\...)
-   Include in the string any concatenation that comes unconditionaly
    after or before
-   Convert the variable to a string with the (type) operator

  ---------- ------------------------------------------------------------
  Short name Type/OneVariableStrings

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `tikiwiki-type-onevariablestrings`{.interpreted-text
             role="ref"},
             `nextcloud-type-onevariablestrings`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Only Variable For Reference
---------------------------

When a method is requesting an argument to be a reference, it cannot be
called with a literal value.

The call must be made with a variable, or any assimilated data container
: array, property or
[static](https://www.php.net/manual/en/language.oop5.static.php)
property.

``` {.php}
<?php

// This is not possible
foo(1,2);

// This is working
foo($a, $b);

function foo($a, &$b) {}

?>
```

Note that PHP may detect this error at linting time, if the method is
defined after being called : at that point, PHP will only check the
problem during execution. This is definitely the case for methods,
compared to functions or
[static](https://www.php.net/manual/en/language.oop5.static.php)
methods.

See also [Passing arguments by
reference](https://www.php.net/manual/en/functions.arguments.php#functions.arguments.by-reference).

### Suggestions

-   Put the literal value in a variable before calling the method.
-   Put the literal value in the default value of the reference
    argument.

  ------------- ----------------------------------------
  Short name    Functions/OnlyVariableForReference

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Quick (30 mins)

  Precision     Medium
  ------------- ----------------------------------------

Only Variable Passed By Reference
---------------------------------

When an argument is expected by reference, it is compulsory to provide a
container. A container may be a variable, an array, a property or a
[static](https://www.php.net/manual/en/language.oop5.static.php)
property.

This may be linted by PHP, when the function definition is in the same
file as the function usage. This is silently linted if definition and
usage are separated, if the call is dynamical or made as a method.

``` {.php}
<?php

function foo(&$bar) { /**/ }

function &bar() { /**/ }

// This is not possible : strtolower() returns a value
foo(strtolower($string));

// This is valid : bar() returns a reference
foo(bar($string));

?>
```

This analysis currently covers functioncalls and
[static](https://www.php.net/manual/en/language.oop5.static.php)
methodcalls, but omits methodcalls.

### Suggestions

-   Store the previous result in a variable, and then call the function.

  ---------- ---------------------------------------------------------------------
  Short name Functions/OnlyVariablePassedByReference

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Critical

  Time To    Slow (1 hour)
  Fix        

  Examples   `dolphin-functions-onlyvariablepassedbyreference`{.interpreted-text
             role="ref"},
             `phpipam-functions-onlyvariablepassedbyreference`{.interpreted-text
             role="ref"}
  ---------- ---------------------------------------------------------------------

Only Variable Returned By Reference
-----------------------------------

Function can\'t return literals by reference.

When a function returns a reference, it is only possible to return
variables, properties or
[static](https://www.php.net/manual/en/language.oop5.static.php)
properties.

Anything else, like literals or
[static](https://www.php.net/manual/en/language.oop5.static.php)
expressions, yield a warning at execution time.

``` {.php}
<?php

// Can't return a literal number
function &foo() {
    return 3 + rand();
}

// bar must return values that are stored in a 
function &bar() {
    $a = 3 + rand();
    return $a;
}

?>
```

  ------------- --------------------------------------------
  Short name    Structures/OnlyVariableReturnedByReference

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- --------------------------------------------

Optimize Explode() {#optimize-explode()}
------------------

Limit [explode()](https://www.php.net/explode) results at call time.
[explode()](https://www.php.net/explode) returns a string, after
breaking it into smaller strings, with a delimiter.

By default, [explode()](https://www.php.net/explode) breaks the whole
string into smaller strings, and returns the array. When not all the
elements of the returned array are necessary, using the third argument
of [explode()](https://www.php.net/explode) speeds up the process, by
removing unnecessary work.

``` {.php}
<?php

$string = '1,2,3,4,5,';

// explode() returns 2 elements, which are then assigned to the list() call.
list($a, $b) = explode(',', $string, 2);

// explode() returns 6 elements, only two of which are then assigned to the list() call. The rest are discarded.
list($a, $b) = explode(',', $string, 2);

// it is not possible to skip the first elements, but it is possible to skip the last ones. 
echo explode(',', $string, 2)[1];

// This protects PHP, in case $string ends up with a lot of commas
$string = foo(); // usually '1,2' but not known
list($a, $b) = explode(',', $string, 2);
?>
```

Limiting [explode()](https://www.php.net/explode) has no effect when the
operation is already exact : it simply prevents
[explode()](https://www.php.net/explode) to cut more than needed if the
argument is unexpectedly large.

This optimisation applies to
[preg\_split()](https://www.php.net/preg_split) and
[mb\_split()](https://www.php.net/mb_split) too.

This is a micro optimisation, unless the exploded string is large.

### Suggestions

-   Add a limit to explode() call

  ------------- ----------------------------------
  Short name    Performances/OptimizeExplode

  Rulesets      `Performances`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     Very high
  ------------- ----------------------------------

Or Die
------

Classic old style failed error management.

``` {.php}
<?php

// In case the connexion fails, this kills the current script
mysql_connect('localhost', $user, $pass) or die();

?>
```

Interrupting a script will leave the application with a blank page, will
make your life miserable for testing. Just don\'t do that.

See also
[pg\_last\_error](https://www.php.net/manual/en/function.pg-last-error.php)
or [PDO::exec](https://www.php.net/manual/en/pdo.exec.php).

### Suggestions

-   Throw an exception
-   Trigger an error with trigger\_error()
-   Use your own error mechanism

  ---------- ----------------------------------------------------------------------------------------
  Short name Structures/OrDie

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-implied-if](https://github.com/dseguy/clearPHP/tree/master/rules/no-implied-if.md)

  Examples   `tine20-structures-ordie`{.interpreted-text role="ref"},
             `openconf-structures-ordie`{.interpreted-text role="ref"}
  ---------- ----------------------------------------------------------------------------------------

Order Of Declaration
--------------------

The order used to declare members and methods has a great impact on
readability and maintenance. However, practices varies greatly. As
usual, being consistent is the most important and useful.

The suggested order is the following : traits, constants, properties,
methods. Optional characteristics, like final,
[static](https://www.php.net/manual/en/language.oop5.static.php)\... are
not specified. Special methods names are not specified.

``` {.php}
<?php

class x {
    use traits;

    const CONSTANTS = 1;
    const CONSTANTS2 = 1;
    const CONSTANTS3 = 1;

    private $property = 2;
    private $property2 = 2;
    private $property3 = 2;

    public function foo() {}
    public function foo2() {}
    public function foo3() {}
    public function foo4() {}
}

?>
```

  ------------ -------------------------------------------------------------
  Short name   Classes/OrderOfDeclaration

  Rulesets     `Coding Conventions <coding-conventions>`{.interpreted-text
               role="ref"}
  ------------ -------------------------------------------------------------

Overwritten Exceptions
----------------------

In catch blocks, it is good practice to avoid overwriting the incoming
exception, as information about the exception will be lost.

``` {.php}
<?php

try {
    doSomething();
} catch (SomeException $e) { 
    // $e is overwritten 
    $e = new anotherException($e->getMessage()); 
    throw $e;
} catch (SomeOtherException $e) { 
    // $e is chained with the next exception 
    $e = new Exception($e->getMessage(), 0, $e); 
    throw $e;
}

?>
```

### Suggestions

-   Use another variable name to create new values inside the catch
-   Use anonymous catch clause (no variable caught) in PHP 8.0, to make
    this explicit

  ------------- ------------------------------------------------------
  Short name    Exceptions/OverwriteException

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `Suggestions`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------------------------

Overwritten Literals
--------------------

The same variable is assigned a literal twice. It is possible that one
of the assignation is too much.

This analysis doesn\'t take into account the distance between two
assignations : it may report false positives when the variable is
actually used for several purposes, and, as such, assigned twice with
different values.

``` {.php}
<?php

function foo() {
    // Two assignations in a short sequence : one is too many.
    $a = 1;
    $a = 2;

    for($i = 0; $i < 10; $i++) {
        $a += $i;
    }
    $b = $a;

    // New assignation. $a is now used as an array. 
    $a = array(0);
}

?>
```

  ------------- -------------------------------
  Short name    Variables/OverwrittenLiterals

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)
  ------------- -------------------------------

Overwritten Source And Value
----------------------------

In a
[foreach()](https://www.php.net/manual/en/control-structures.foreach.php),
it is best to keep source and values distinct. Otherwise, they overwrite
each other.

Since PHP 7.0, PHP makes a copy of the original source, then works on
it. This makes possible to use the same name for the source and the
values.

``` {.php}
<?php

// displays 0-1-2-3-3
$array = range(0, 3);
foreach($array as $array) {
    print $array . '-';
}
print_r($array);


/* displays 0-1-2-3-Array
(
    [0] => 0
    [1] => 1
    [2] => 2
    [3] => 3
)
*/
$array = range(0, 3);
foreach($array as $v) {
    print $v . '-';
}
print_r($array);

?>
```

When the source is used as the value, the elements in the array are
successively assigned to itself. After the loop, the original array has
been replaced by its last element.

The same applies to the index, or to any variable in a
[list()](https://www.php.net/list) structure, used in a
[foreach()](https://www.php.net/manual/en/control-structures.foreach.php).

### Suggestions

-   Keep the source, the index and the values distinct

  ---------- --------------------------------------------------------------------
  Short name Structures/ForeachSourceValue

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `churchcrm-structures-foreachsourcevalue`{.interpreted-text
             role="ref"},
             `expressionengine-structures-foreachsourcevalue`{.interpreted-text
             role="ref"}
  ---------- --------------------------------------------------------------------

PHP 7.0 New Classes
-------------------

Those classes are now declared natively in PHP 7.0 and should not be
declared in custom code.

There are 8 new classes :

-   `Error`
-   `ParseError`
-   `TypeError`
-   `ArithmeticError`
-   `DivisionByZeroError`
-   `ClosedGeneratorException`
-   `ReflectionGenerator`
-   `ReflectionType`
-   `AssertionError`

``` {.php}
<?php

namespace {
    // Global namespace
    class Error {
        // Move to a namespace
        // or, remove this class
    }
}

namespace B {
    class Error {
        // This is OK : in a namespace
    }
}

?>
```

See also [New Classes and
Interfaces](https://www.php.net/manual/en/migration70.classes.php).

  ---------- --------------------------------------------------------------
  Short name Php/Php70NewClasses

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and older
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- --------------------------------------------------------------

PHP 7.0 New Interfaces
----------------------

The following interfaces are introduced in PHP 7.0. They shouldn\'t be
defined in custom code.

  ---------- --------------------------------------------------------------
  Short name Php/Php70NewInterfaces

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and older
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- --------------------------------------------------------------

PHP 7.0 Removed Directives
--------------------------

List of directives that are removed in PHP 7.0.

  ------------- ------------------------------------------------------
  Short name    Php/Php70RemovedDirective

  Rulesets      `CompatibilityPHP70`{.interpreted-text role="ref"},
                `CompatibilityPHP71`{.interpreted-text role="ref"}

  Php Version   With PHP 7.0 and more recent

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ------------------------------------------------------

PHP 7.0 Removed Functions
-------------------------

The following PHP native functions were removed in PHP 7.0.

-   [ereg()](https://www.php.net/ereg)
-   [ereg\_replace()](https://www.php.net/ereg_replace)
-   [eregi()](https://www.php.net/eregi)
-   [eregi\_replace()](https://www.php.net/eregi_replace)
-   [split()](https://www.php.net/split)
-   [spliti()](https://www.php.net/spliti)
-   [sql\_regcase()](https://www.php.net/sql_regcase)
-   [magic\_quotes\_runtime()](https://www.php.net/magic_quotes_runtime)
-   [set\_magic\_quotes\_runtime()](https://www.php.net/set_magic_quotes_runtime)
-   [call\_user\_method()](https://www.php.net/call_user_method)
-   [call\_user\_method\_array()](https://www.php.net/call_user_method_array)
-   [set\_socket\_blocking()](https://www.php.net/set_socket_blocking)
-   [mcrypt\_ecb()](https://www.php.net/mcrypt_ecb)
-   [mcrypt\_cbc()](https://www.php.net/mcrypt_cbc)
-   [mcrypt\_cfb()](https://www.php.net/mcrypt_cfb)
-   [mcrypt\_ofb()](https://www.php.net/mcrypt_ofb)
-   datefmt\_set\_timezone\_id()
-   [imagepsbbox()](https://www.php.net/imagepsbbox)
-   [imagepsencodefont()](https://www.php.net/imagepsencodefont)
-   [imagepsextendfont()](https://www.php.net/imagepsextendfont)
-   [imagepsfreefont()](https://www.php.net/imagepsfreefont)
-   [imagepsloadfont()](https://www.php.net/imagepsloadfont)
-   [imagepsslantfont()](https://www.php.net/imagepsslantfont)
-   [imagepstext()](https://www.php.net/imagepstext)

This analysis skips redefined PHP functions : when a replacement for a
removed PHP function was created, with condition on the PHP version,
then its usage is considered valid.

See also [PHP 7.0 Removed
Functions](https://www.php.net/manual/en/migration70.incompatible.php#migration70.incompatible.removed-functions).

### Suggestions

-   Replace the old functions with modern functions
-   Remove the usage of the old functions
-   Create an alternative function by wiring the old name to a new
    feature

  ------------- ------------------------------------------------------
  Short name    Php/Php70RemovedFunctions

  Rulesets      `CompatibilityPHP70`{.interpreted-text role="ref"},
                `CompatibilityPHP71`{.interpreted-text role="ref"}

  Php Version   With PHP 7.0 and older

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ------------------------------------------------------

PHP 7.0 Scalar Typehints
------------------------

New scalar typehints were introduced : `bool`, `int`, `float`, `string`.

They cannot be used before PHP 7.0, and will be confused with classes or
interfaces.

``` {.php}
<?php

function foo(string $name) {
    print Hello $name;
}

foo(Damien); 
// display 'Hello Damien'

foo(33); 
// displays an error

?>
```

See also [Scalar type
declarations](https://www.php.net/manual/en/migration70.new-features.php#migration70.new-features.scalar-type-declarations),
and [PHP 7 SCALAR TYPE
DECLARATIONS](https://tutorials.kode-blog.com/php-7-scalar-type-declarations).

  ---------- --------------------------------------------------------------
  Short name Php/PHP70scalartypehints

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and more recent
  Version    

  Severity   Critical

  Time To    Quick (30 mins)
  Fix        
  ---------- --------------------------------------------------------------

PHP 7.1 Microseconds
--------------------

PHP supports microseconds in `DateTime` class and
[date\_create()](https://www.php.net/date_create) function. This was
introduced in PHP 7.1.

In previous PHP versions, those dates only used seconds, leading to lazy
comparisons :

``` {.php}
<?php

$now = date_create();
usleep(10);              // wait for 0.001 ms
var_dump($now == date_create());

?>
```

This code displays true in PHP 7.0 and older, (unless the code was run
too close from the next second). In PHP 7.1, this is always false.

This is also true with `DateTime` :

``` {.php}
<?php

$now = new DateTime();
usleep(10);              // wait for 0.001 ms
var_dump((new DateTime())->format('u') == $now->format('u'));

?>
```

This evolution impacts mostly exact comparisons (== and ===).
Non-equality (!= and !==) will probably be always true, and should be
reviewed.

See also [Backward incompatible
changes](https://www.php.net/manual/en/migration71.incompatible.php).

  ------------- ----------------------------------------
  Short name    Php/Php71microseconds

  Rulesets      `CompatibilityPHP71`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

PHP 7.1 Removed Directives
--------------------------

List of directives that are removed in PHP 7.1.

  ------------- ----------------------------------------
  Short name    Php/Php71RemovedDirective

  Rulesets      `CompatibilityPHP71`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.1 and more recent

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

PHP 7.1 Scalar Typehints
------------------------

A new scalar typehint was introduced : iterable.

It can\'t be used before PHP 7.1, and will be confused with classes or
interfaces.

``` {.php}
<?php

function foo(iterable $iterable) {
    foreach ($iterable as $value) {
        echo $value.PHP_EOL;
    }
}

foo(range(1,20)); 
// works with array

foo(new ArrayIterator([1, 2, 3])); 
// works with an iterator

foo((function () { yield 1; })() ); 
// works with a generator 

?>
```

See also [iterable
pseudo-type](https://www.php.net/manual/en/migration71.new-features.php#migration71.new-features.iterable-pseudo-type),
and [The iterable
Pseudo-Type](https://knpuniversity.com/screencast/php7/iterable-type).

  ---------- ----------------------------------------------------------------
  Short name Php/PHP71scalartypehints

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.1 and more recent
  Version    

  Severity   Critical

  Time To    Quick (30 mins)
  Fix        
  ---------- ----------------------------------------------------------------

PHP 7.2 Deprecations
--------------------

Several functions are deprecated in PHP 7.2.

-   [parse\_str()](https://www.php.net/parse_str) with no second
    argument
-   [assert()](https://www.php.net/assert) on strings
-   Usage of [gmp\_random()](https://www.php.net/gmp_random),
    [create\_function()](https://www.php.net/create_function),
    [each()](https://www.php.net/each)
-   Usage of (unset)
-   Usage of `$php_errormsg`
-   directive `mbstring.func_overload` (not supported yet)

Deprecated functions and extensions are reported in a separate analysis.

See also [Deprecations for PHP
7.2](https://wiki.php.net/rfc/deprecations_php_7_2).

### Suggestions

-   Remove the deprecated functions, and replace them with a new feature
-   Use a replacement function to emulate this old behavior

  ------------- ----------------------------------------
  Short name    Php/Php72Deprecation

  Rulesets      `CompatibilityPHP72`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.2 and older

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

PHP 7.2 Object Keyword
----------------------

\'object\' is a PHP keyword. It can\'t be used for class, interface or
trait name.

This is the case since PHP 7.2.

``` {.php}
<?php

// Valid until PHP 7.2
class object {}

// Altough it is really weird anyway...

?>
```

See also [List of
Keywords](https://www.php.net/manual/en/reserved.keywords.php).

  ------------- ----------------------------------------
  Short name    Php/Php72ObjectKeyword

  Rulesets      `CompatibilityPHP72`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.2 and older

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

PHP 7.2 Removed Functions
-------------------------

The following PHP native functions were removed in PHP 7.2.

-   [png2wbmp()](https://www.php.net/png2wbmp)
-   [jpeg2wbmp()](https://www.php.net/jpeg2wbmp)
-   [create\_function()](https://www.php.net/create_function)
-   [gmp\_random()](https://www.php.net/gmp_random)
-   [each()](https://www.php.net/each)

This analysis skips redefined PHP functions : when a replacement for a
removed PHP function was created, with condition on the PHP version,
then its usage is considered valid.

See also [Deprecated features in PHP
7.2.x](https://www.php.net/manual/en/migration72.deprecated.php).

  ------------- ----------------------------------------
  Short name    Php/Php72RemovedFunctions

  Rulesets      `CompatibilityPHP72`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.2 and older

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

PHP 7.2 Scalar Typehints
------------------------

A new scalar typehint was introduced : object.

It can\'t be used before PHP 7.2, and will be confused with classes or
interfaces.

``` {.php}
<?php

function test(object $obj) : object
{
    return new SplQueue();
}

test(new StdClass());

?>
```

See also [New object
type](https://www.php.net/manual/en/migration72.new-features.php#migration72.new-features.iterable-pseudo-type),
and [PHP 7.2 and Object
Typehint](http://blog.tekmi.nl/php-7-2-and-object-typehint/).

  ---------- -----------------------------------------------------------------
  Short name Php/PHP72scalartypehints

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.2 and more recent
  Version    

  Severity   Critical

  Time To    Quick (30 mins)
  Fix        
  ---------- -----------------------------------------------------------------

PHP 7.3 Last Empty Argument
---------------------------

PHP allows the last element of any functioncall to be empty. The
argument is then not send.

This was introduced in PHP 7.3, and is not backward compatible.

The last empty line is easier on the VCS, allowing clearer text diffs.

``` {.php}
<?php

function foo($a, $b) {
    print_r(func_get_args());
}


foo(1, 
    2, 
    );

foo(1);


?>
```

See also [Allow a trailing comma in function
calls](https://wiki.php.net/rfc/trailing-comma-function-calls) and
[Trailing
commas](https://www.puppetcookbook.com/posts/trailing-commas.html).

  ---------- ------------------------------------------------------------------
  Short name Php/PHP73LastEmptyArgument

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.3 and more recent
  Version    

  Severity   Critical

  Time To    Quick (30 mins)
  Fix        
  ---------- ------------------------------------------------------------------

PHP 7.3 Removed Functions
-------------------------

The following PHP native functions were removed in PHP 7.3.

-   [image2wbmp()](https://www.php.net/image2wbmp)

This analysis skips redefined PHP functions : when a replacement for a
removed PHP function was created, with condition on the PHP version,
then its usage is considered valid.

See also [PHP 7.3 Removed
Functions](https://www.php.net/manual/en/migration73.incompatible.php#migration70.incompatible.removed-functions).

  ------------- ----------------------------------------
  Short name    Php/Php73RemovedFunctions

  Rulesets      `CompatibilityPHP73`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.3 and older

  Severity      Critical

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

PHP 7.4 Constant Deprecation
----------------------------

One constant is deprecated in PHP 7.4.

-   CURLPIPE\_HTTP1

See also [Deprecations for PHP
7.2](https://wiki.php.net/rfc/deprecations_php_7_2).

### Suggestions

-   Use CURLPIPE\_MULTIPLEX or CURLPIPE\_NOTHING

  ------------- ----------------------------------------
  Short name    Php/Php74Deprecation

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.4 and older

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

PHP 7.4 Removed Directives
--------------------------

List of directives that are removed in PHP 7.4.

-   allow\_url\_include

See [Deprecation
allow\_url\_include](https://wiki.php.net/rfc/deprecations_php_7_4#allow_url_include).

### Suggestions

-   Stop using this directive

  ------------- ----------------------------------------
  Short name    Php/Php74RemovedDirective

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Php Version   7.4+

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

PHP 7.4 Removed Functions
-------------------------

The following PHP native functions were deprecated in PHP 7.4.

-   [hebrevc()](https://www.php.net/hebrevc)
-   [convert\_cyr\_string()](https://www.php.net/convert_cyr_string)
-   [ezmlm\_hash()](https://www.php.net/ezmlm_hash)
-   [money\_format()](https://www.php.net/money_format)
-   [restore\_include\_path()](https://www.php.net/restore_include_path)
-   [get\_magic\_quotes\_gpc()](https://www.php.net/get_magic_quotes_gpc)
-   [get\_magic\_quotes\_runtime()](https://www.php.net/get_magic_quotes_runtime)

This analysis skips redefined PHP functions : when a replacement for a
removed PHP function was created, with condition on the PHP version,
then its usage is considered valid.

See also [PHP 7.4 Removed
Functions](https://www.php.net/manual/en/migration74.incompatible.php#migration70.incompatible.removed-functions)
and [PHP 7.4 Deprecations :
Introduction](https://wiki.php.net/rfc/deprecations_php_7_4#introduction).

### Suggestions

-   

  ------------- ----------------------------------------
  Short name    Php/Php74RemovedFunctions

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.3 and older

  Severity      Critical

  Time To Fix   Slow (1 hour)

  Precision     Very high
  ------------- ----------------------------------------

PHP 7.4 Reserved Keyword
------------------------

`fn` is a new PHP keyword. In PHP 7.4, it is used to build the arrow
functions. When used at an illegal position, `fn` generates a Fatal
error at compile time.

As a key word, `fn` is not allowed as constant name, function name,
class name or inside namespaces.

``` {.php}
<?php

// PHP 7.4 usage of fn
function array_values_from_keys($arr, $keys) {
    return array_map(fn($x) => $arr[$x], $keys);
}

// PHP 7.3 usage of fn
const fn = 1;

function fn() {}

class x {
    // This is valid in PHP 7.3 and 7.4
    function fn() {}
}

?>
```

`fn` is fine for method names. It may also be used for constants with
[define()](https://www.php.net/define), and
[constant()](https://www.php.net/constant) but it is not recommended.

See also [PHP RFC: Arrow
Functions](https://wiki.php.net/rfc/arrow_functions).

### Suggestions

-   

  ------------- ----------------------------------------
  Short name    Php/Php74ReservedKeyword

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Php Version   7.4-

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

PHP 74 New Directives
---------------------

List of directives that are new in PHP 7.4.

-   `zend.exception_ignore_args` : From the php.ini :
    `Allows to include or exclude arguments from stack traces generated for exceptions. Default: Off`
-   `opcache.preload_user`

See [RFC Preload](https://wiki.php.net/rfc/preload).

### Suggestions

-   Do not use those directives with PHP before version 7.4

  ------------- ----------------------------------------
  Short name    Php/Php74NewDirective

  Rulesets      `CompatibilityPHP73`{.interpreted-text
                role="ref"}

  Php Version   7.4-

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

PHP 8.0 Removed Constants
-------------------------

The following PHP native constants were removed in PHP 8.0.

-   INTL\_IDNA\_VARIANT\_2003 (See [Deprecate and remove
    INTL\_IDNA\_VARIANT\_2003](https://wiki.php.net/rfc/deprecate-and-remove-intl_idna_variant_2003))

### Suggestions

-   Remove usage of INTL\_IDNA\_VARIANT\_2003 and use

  ------------- ----------------------------------------
  Short name    Php/Php80RemovedConstant

  Rulesets      `CompatibilityPHP80`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

PHP 8.0 Removed Directives
--------------------------

List of directives that are removed in PHP 8.0.

In PHP 8.0, [track\_errors]{.title-ref} was removed.

You can detect valid directives with
[ini\_get()](https://www.php.net/ini_get). This native function will
return false, when the directive doesn\'t exist, while actual directive
values will be returned as a string.

### Suggestions

-   Remove usage of [track\_errors]{.title-ref}.

  ------------- ----------------------------------------
  Short name    Php/Php80RemovedDirective

  Rulesets      `CompatibilityPHP80`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

PHP 8.0 Removed Functions
-------------------------

The following PHP native functions were removed in PHP 8.0.

-   [image2wbmp()](https://www.php.net/image2wbmp)
-   [png2wbmp()](https://www.php.net/png2wbmp)
-   [jpeg2wbmp()](https://www.php.net/jpeg2wbmp)
-   [ldap\_sort()](https://www.php.net/ldap_sort)
-   [hebrevc()](https://www.php.net/hebrevc)
-   [convert\_cyr\_string()](https://www.php.net/convert_cyr_string)
-   [ezmlm\_hash()](https://www.php.net/ezmlm_hash)
-   [money\_format()](https://www.php.net/money_format)
-   [get\_magic\_quotes\_gpc()](https://www.php.net/get_magic_quotes_gpc)
-   get\_magic\_quotes\_gpc\_runtime()
-   [create\_function()](https://www.php.net/create_function)
-   [each()](https://www.php.net/each)
-   [read\_exif\_data()](https://www.php.net/read_exif_data)
-   [gmp\_random()](https://www.php.net/gmp_random)
-   [fgetss()](https://www.php.net/fgetss)
-   [restore\_include\_path()](https://www.php.net/restore_include_path)
-   [gzgetss()](https://www.php.net/gzgetss)

  ------------- ----------------------------------------
  Short name    Php/Php80RemovedFunctions

  Rulesets      `CompatibilityPHP80`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.0 and older

  Severity      Major

  Time To Fix   Slow (1 hour)

  Precision     High
  ------------- ----------------------------------------

PHP 80 Named Parameter Variadic
-------------------------------

Named parameter with variadic have been renamed from 0 to \'parameter
name\' in PHP 8.0

``` {.php}
<?php

function foo($a, ...$b) {
    print_r($b);
}

foo(3, 4);
foo(3, b: 4);              // PHP 8 only 
foo(...[2, b=> [3, 4]]); // PHP 8 only 

?>
```

In PHP 7.0, with positional argument only, the content of \$b is in an
array, index 0. This is also true with PHP 8.0.

In PHP 8.0, with named arguments, the content of \$b is in an array,
index \'b\';

Since the behavior of the variadic depends on the calling syntax (with
or without named parameter), the receiving must ensure the correct
reception, and handle both cases.

### Suggestions

-   Apply array\_values() to the variadic arguments.

  ------------- ----------------------------------------
  Short name    Php/Php80NamedParameterVariadic

  Rulesets      `CompatibilityPHP80`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     Medium
  ------------- ----------------------------------------

PHP Keywords As Names
---------------------

PHP has a set of reserved keywords. It is recommended not to use those
keywords for names structures.

PHP does check that a number of structures, such as classes, methods,
interfaces\... can\'t be named or called using one of the keywords.
However, in a few other situations, no check are enforced. Using
keywords in such situation is confusing.

``` {.php}
<?php

// This keyword is reserved since PHP 7.2
class object {
    // _POST is used by PHP for the $_POST variable
    // This methods name is probably confusing, 
    // and may attract more than its share of attention
    function _POST() {

    }
}

?>
```

See also [List of
Keywords](https://www.php.net/manual/en/reserved.keywords.php),
[Predefined
Classes](https://www.php.net/manual/en/reserved.classes.php),
[Predefined
Constants](https://www.php.net/manual/en/reserved.constants.php), [List
of other reserved
words](https://www.php.net/manual/en/reserved.other-reserved-words.php)
and [Predefined
Variables](https://www.php.net/manual/en/reserved.variables.php).

### Suggestions

-   Rename the structure
-   Choose another naming convention to avoid conflict and rename the
    current structures

  --------------- --------- -------- --------------------------------------------------
  Name            Default   Type     Description

  reservedNames             string   Other reserved names : all in a string, comma
                                     separated.

  allowedNames              string   PHP reserved names that can be used in the code.
                                     All in a string, comma separated.
  --------------- --------- -------- --------------------------------------------------

  ----------- -----------------------------------------------------------
  Short name  Php/ReservedNames

  Rulesets    `Analyze`{.interpreted-text role="ref"}

  Severity    Major

  Time To Fix Quick (30 mins)

  Examples    `churchcrm-php-reservednames`{.interpreted-text
              role="ref"}, `xataface-php-reservednames`{.interpreted-text
              role="ref"}
  ----------- -----------------------------------------------------------

PHP Resources Turned Into Objects
---------------------------------

Multiple PHP native functions now return objects, not resources. Any
check on those values with
[is\_resource()](https://www.php.net/is_resource) is now going to fail.

The affected functions are the following :

-   [curl\_init()](https://www.php.net/curl_init)
-   [curl\_multi\_init()](https://www.php.net/curl_multi_init)
-   [curl\_share\_init()](https://www.php.net/curl_share_init)
-   deflate\_init()
-   [enchant\_broker\_init()](https://www.php.net/enchant_broker_init)
-   [enchant\_broker\_request\_dict()](https://www.php.net/enchant_broker_request_dict)
-   [enchant\_broker\_request\_pwl\_dict()](https://www.php.net/enchant_broker_request_pwl_dict)
-   inflate\_init()
-   [msg\_get\_queue()](https://www.php.net/msg_get_queue)
-   [openssl\_csr\_new()](https://www.php.net/openssl_csr_new)
-   [openssl\_csr\_sign()](https://www.php.net/openssl_csr_sign)
-   [openssl\_pkey\_new()](https://www.php.net/openssl_pkey_new)
-   [openssl\_x509\_read()](https://www.php.net/openssl_x509_read)
-   [sem\_get()](https://www.php.net/sem_get)
-   [shm\_attach()](https://www.php.net/shm_attach)
-   [shmop\_open()](https://www.php.net/shmop_open)
-   [socket\_accept()](https://www.php.net/socket_accept)
-   [socket\_addrinfo\_bind()](https://www.php.net/socket_addrinfo_bind)
-   [socket\_addrinfo\_connect()](https://www.php.net/socket_addrinfo_connect)
-   [socket\_create\_listen()](https://www.php.net/socket_create_listen)
-   [socket\_create()](https://www.php.net/socket_create)
-   [socket\_import\_stream()](https://www.php.net/socket_import_stream)
-   socket\_wsaprotocol\_info\_import()
-   [xml\_parser\_create\_ns()](https://www.php.net/xml_parser_create_ns)
-   [xml\_parser\_create()](https://www.php.net/xml_parser_create)

See also [UPGRADING PHP
8.0](https://github.com/php/php-src/blob/master/UPGRADING).

### Suggestions

-   Change the condition from is\_resource to instanceof

  ------------- ----------------------------------------
  Short name    Php/Php80RemovesResources

  Rulesets      `CompatibilityPHP80`{.interpreted-text
                role="ref"}

  Php Version   8.0+

  Severity      Major

  Time To Fix   Quick (30 mins)

  Precision     Medium
  ------------- ----------------------------------------

PHP5 Indirect Variable Expression
---------------------------------

Indirect variable expressions changes between PHP 5 an 7.

The following structures are evaluated differently in PHP 5 and 7. It is
recommended to review them or switch to a less ambiguous syntax.

``` {.php}
<?php

// PHP 7 
$foo = 'bar';
$bar['bar']['baz'] = 'foobarbarbaz';
echo $$foo['bar']['baz'];
echo ($$foo)['bar']['baz'];

// PHP 5
$foo['bar']['baz'] = 'bar';
$bar = 'foobarbazbar';
echo $$foo['bar']['baz'];
echo ${$foo['bar']['baz']};

?>
```

See [Backward incompatible changes PHP
7.0](https://www.php.net/manual/en/migration70.incompatible.php)

  ------------------------------- --------------------------------- ---------------------------------
  Expression                      PHP 5 interpretation              PHP 7 interpretation

  \$\$foo\[\'bar\'\]\[\'baz\'\]   \${\$foo\[\'bar\'\]\[\'baz\'\]}   (\$\$foo)\[\'bar\'\]\[\'baz\'\]
  \$foo-\>\$bar\[\'baz\'\]        \$foo-\>{\$bar\[\'baz\'\]}        (\$foo-\>\$bar)\[\'baz\'\]
  \$foo-\>\$bar\[\'baz\'\]()      \$foo-\>{\$bar\[\'baz\'\]}()      (\$foo-\>\$bar)\[\'baz\'\]()
  Foo::\$bar\[\'baz\'\]()         Foo::{\$bar\[\'baz\'\]}()         (Foo::\$bar)\[\'baz\'\]()
  ------------------------------- --------------------------------- ---------------------------------

### Suggestions

-   Avoid using complex expressions, mixing `$$\`, `[0]` and `->` in the
    same expression
-   Add curly braces {} to ensure that the precedence is the same
    between PHP 5 and 7. For example, `$$v` becomes `${$v}`

  ---------- --------------------------------------------------------------
  Short name Variables/Php5IndirectExpression

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and older
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- --------------------------------------------------------------

PHP7 Dirname
------------

With PHP 7, [dirname()](https://www.php.net/dirname) has a second
argument that represents the number of
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
folder to follow. This prevent us from using nested
[dirname()](https://www.php.net/dirname) calls to reach an
grand-[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
direct.

``` {.php}
<?php
$path = '/a/b/c/d/e/f';

// PHP 7 syntax
$threeFoldersUp = dirname($path, 3);

// PHP 5 syntax
$threeFoldersUp = dirname(dirname(dirname($path)));

?>
```

See also [dirname](https://www.php.net/dirname).

### Suggestions

-   Use dirname()\'s second argument

  ---------- -----------------------------------------------------------------
  Short name Structures/PHP7Dirname

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"},
             `Suggestions`{.interpreted-text role="ref"},
             `php-cs-fixable`{.interpreted-text role="ref"}

  Php        7.0+
  Version    

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `openconf-structures-php7dirname`{.interpreted-text role="ref"},
             `mediawiki-structures-php7dirname`{.interpreted-text role="ref"}
  ---------- -----------------------------------------------------------------

Parameter Hiding
----------------

When a parameter is set to another variable, and never used.

While this is a legit syntax, parameter hiding tends to make the code
confusing. The parameter itself seems to be unused, while some extra
variable appears.

Keep this code simple by removing the hiding parameter.

``` {.php}
<?php

function substract($a, $b) {
    // $b is given to $c;
    $c = $b; 

    $c is used, but $b would be the same
    return $a - $c;
}

?>
```

### Suggestions

-   Remove the hiding parameter

  ------------- -------------------------------
  Short name    Functions/ParameterHiding

  Rulesets      `Semantics`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------

Parent First
------------

When calling
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
constructor, always put it first in the `__construct` method. It ensures
the
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
is correctly build before the child start using values.

``` {.php}
<?php

class father {
    protected $name = null;

    function __construct() {
        $this->name = init();
    }
}

class goodSon {
    function __construct() {
        // parent is build immediately, 
        parent::__construct();
        echo my name is.$this->name;
    }
}

class badSon {
    function __construct() {
        // This will fail.
        echo my name is.$this->name;

        // parent is build later, 
        parent::__construct();
    }
}

?>
```

This analysis doesn\'t apply to Exceptions.

### Suggestions

-   Use `parent\:\:__construct` as the first call in the constructor.

  ---------- ------------------------------------------------------------
  Short name Classes/ParentFirst

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Suggestions`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `shopware-classes-parentfirst`{.interpreted-text
             role="ref"},
             `prestashop-classes-parentfirst`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Parent, Static Or Self Outside Class {#parent,-static-or-self-outside-class}
------------------------------------

[Parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php),
[static](https://www.php.net/manual/en/language.oop5.static.php) and
[self](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
keywords must be used within a class or a trait. They make no sens
outside a class or trait scope, as
[self](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
and [static](https://www.php.net/manual/en/language.oop5.static.php)
refers to the current class and
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
refers to one of
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
above.

PHP 7.0 and later detect their usage at compile time, and emits a fatal
error.

``` {.php}
<?php

class x {
    const Y = 1;

    function foo() {
        // self is \x
        echo self::Y;
    }
}

const Z = 1;
// This lint but won't anymore
echo self::Z;

?>
```

[Static](https://www.php.net/manual/en/language.oop5.static.php) may be
used in a function or a closure, but not globally.

  ------------- -----------------------------
  Short name    Classes/PssWithoutClass

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Parenthesis As Parameter
------------------------

Using parenthesis around parameters used to silent some internal check.
This is not the case anymore in PHP 7, and should be fixed by removing
the parenthesis and making the value a real reference.

``` {.php}
<?php

// PHP 7 sees through parenthesis
$d = foo(1, 2, $c);

// Avoid parenthesis in arguments
$d = foo(1, 2, ($c));

?>
```

### Suggestions

-   Remove the parenthesis when they are only encapsulating an argument

  ---------- --------------------------------------------------------------
  Short name Php/ParenthesisAsParameter

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        
  ---------- --------------------------------------------------------------

Pathinfo() Returns May Vary {#pathinfo()-returns-may-vary}
---------------------------

[pathinfo()](https://www.php.net/pathinfo) function returns an array
whose content may vary. It is recommended to collect the values after
check, rather than directly.

``` {.php}
<?php

$file = '/a/b/.c';
//$extension may be missing, leading to empty $filename and filename in $extension
list( $dirname, $basename, $extension, $filename ) = array_values( pathinfo($file) );

//Use PHP 7.1 list() syntax to assign correctly the values, and skip array_values()
//This emits a warning in case of missing index
['dirname'   => $dirname, 
 'basename'  => $basename, 
 'extension' => $extension, 
 'filename'  => $filename ] = pathinfo($file);

//This works without warning
$details = pathinfo($file);
$dirname   = $details['dirname'] ?? getpwd();
$basename  = $details['basename'] ?? '';
$extension = $details['extension'] ?? '';
$filename  = $details['filename'] ?? '';

?>
```

The same applies to [parse\_url()](https://www.php.net/parse_url), which
returns an array with various index.

### Suggestions

-   Add a check on the return value of pathinfo() before using it.

  ------------- ---------------------------------------------------
  Short name    Php/PathinfoReturns

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `nextcloud-php-pathinforeturns`{.interpreted-text
                role="ref"}
  ------------- ---------------------------------------------------

Php 7 Indirect Expression
-------------------------

Those are variable indirect expressions that are interpreted differently
in PHP 5 and PHP 7.

You should check them so they don\'t behave strangely.

``` {.php}
<?php

// Ambiguous expression : 
$b = $$foo['bar']['baz'];
echo $b;

$foo = array('bar' => array('baz' => 'bat'));
$bat = 'PHP 5.6';

// In PHP 5, the expression above means : 
$b = $\{$foo['bar']['baz']};
$b = 'PHP 5.6';

$foo = 'a';
$a = array('bar' => array('baz' => 'bat'));

// In PHP 7, the expression above means : 
$b = ($$foo)['bar']['baz'];
$b = 'bat';

?>
```

See also [Changes to variable
handling](https://www.php.net/manual/en/migration70.incompatible.php).

### Suggestions

-   Avoid using complex expressions, mixing \$\$, \[0\] and -\> in the
    same expression
-   Add curly braces {} to ensure that the precedence is the same
    between PHP 5 and 7. For example, `$$v` becomes `${$v}`

  ---------- ----------------------------------------------------------------
  Short name Variables/Php7IndirectExpression

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and more recent
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- ----------------------------------------------------------------

Php 7.1 New Class
-----------------

New classes, introduced in PHP 7.1. If classes where created with the
same name, in current code, they have to be moved in a namespace, or
removed from code to migrate safely to PHP 7.1.

The new class is : ReflectionClassConstant. The other class is \'Void\'
: this is forbidden as a class name, as Void is used for return type
hint.

``` {.php}
<?php

class ReflectionClassConstant {
    // Move to a namespace, do not leave in global
    // or, remove this class
}

?>
```

  ---------- ----------------------------------------------------------------
  Short name Php/Php71NewClasses

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.1 and older
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- ----------------------------------------------------------------

Php 7.2 New Class
-----------------

New classes, introduced in PHP 7.2. If classes where created with the
same name, in current code, they have to be moved in a namespace, or
removed from code to migrate safely to PHP 7.2.

The new class is : HashContext.

``` {.php}
<?php

namespace {
    // Global namespace
    class HashContext {
        // Move to a namespace
        // or, remove this class
    }
}

namespace B {
    class HashContext {
        // This is OK : in a namespace
    }
}

?>
```

  ---------- ------------------------------------------------------------------
  Short name Php/Php72NewClasses

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"}

  Php        With PHP 7.2 and older
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- ------------------------------------------------------------------

Php 7.4 New Class
-----------------

New classes, introduced in PHP 7.4. If classes where created with the
same name, in current code, they have to be moved in a namespace, or
removed from code to migrate safely to PHP 7.4.

The new classes are :

-   `ReflectionReference`
-   `WeakReference`

``` {.php}
<?php

namespace {
    // Global namespace
    class WeakReference {
        // Move to a namespace
        // or, remove this class
    }
}

namespace B {
    class WeakReference {
        // This is OK : in a namespace
    }
}

?>
```

### Suggestions

-   Move the current classes with the same names into a distinct domain
    name

  ------------- ----------------------------------------
  Short name    Php/Php74NewClasses

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.2 and older

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

Php 8.0 Only TypeHints
----------------------

Two scalar typehints are introduced in version 8. They are `false` and
`null`. In PHP 7.0, both those values could not be used as a class or
interface name, to avoid confusion with the actual booleans, nor `null`
value.

`false` represents a false boolean, and nothing else. It is more
restrictive than a boolean, which accepts true too. `null` is an
alternative syntax to `?` : it allows the type to be `null`.

Both the above typehints are to be used in cunjunction with other types
: they can\'t be used alone.

``` {.php}
<?php

// function accepts an A object, or null. 
function foo(A|null $x) {}

// same as above
function foo2(A|null $x) {}

// returns an object of class B, or false
function bar($x) : false|B {}

?>
```

See also [PHP RFC: Union Types
2.0](https://wiki.php.net/rfc/union_types_v2).

### Suggestions

-   

  ---------- -----------------------------------------------------------------
  Short name Php/Php80OnlyTypeHints

  Rulesets   `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"},
             `CompatibilityPHP73`{.interpreted-text role="ref"},
             `CompatibilityPHP74`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        
  ---------- -----------------------------------------------------------------

Php 8.0 Variable Syntax Tweaks
------------------------------

Several variable syntaxes are added in version 8.0. They extends the PHP
7.0 syntax updates, and fix a number of edges cases.

In particular, `new`and `instanceof` now support a way to inline the
expression, rather than use a temporary variable.

Magic constants are now accessible with array notation, just like
another constant. It is also possible to use method calls : although
this is Syntacticly correct for PHP, this won\'t be executed, as the
left operand is a string, and not an object.

``` {.php}
<?php

 // array name is dynamically build
 echo foo$bar[0];
 // static method
 foo$bar::baz();
 // static property 
 foo$bar::$baz;

 // Syntactly correct, but not executable
 foo$bar->baz();

 // expressions with instanceof and new
    $object = new (class_.$name);
    $x instanceof (class_$name);

    // PHP 7.0 style
    $className = class_.$name;
    $object = new $className;

?>
```

See also [PHP RFC: Variable Syntax
Tweaks](https://wiki.php.net/rfc/variable_syntax_tweaks) and
[scalar\_objects in PHP](https://github.com/nikic/scalar_objects).

  ------------- ----------------------------------------
  Short name    Php/Php80VariableSyntax

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Php Version   8.0+

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Php/UseMatch {#php/usematch}
------------

### Suggestions

-   

  ------------- ----------------------------------------
  Short name    Php/UseMatch

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Php Version   8.0+

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Php7 Relaxed Keyword
--------------------

Most of the traditional PHP keywords may be used inside classes, trait
or interfaces.

``` {.php}
<?php

// Compatible with PHP 7.0 + 
class foo {
    // as is a PHP 5 keyword
    public function as() {

    }
}

?>
```

This was not the case in PHP 5, and will yield parse errors.

See also [Loosening Reserved Word
Restrictions](https://www.php.net/manual/en/migration70.other-changes.php#migration70.other-changes.loosening-reserved-words).

  ---------- --------------------------------------------------------------
  Short name Php/Php7RelaxedKeyword

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and more recent
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- --------------------------------------------------------------

Phpinfo
-------

[phpinfo()](https://www.php.net/phpinfo) is a great function to learn
about the current configuration of the server.

``` {.php}
<?php

if (DEBUG) {
    phpinfo();
}

?>
```

If left in the production code, it may lead to a critical leak, as any
attacker gaining access to this data will know a lot about the server
configuration.

It is advised to never leave that kind of instruction in a production
code.

[phpinfo()](https://www.php.net/phpinfo) may be necessary to access some
specific configuration of the server : for example, `Apache` module list
are only available via [phpinfo()](https://www.php.net/phpinfo), and
apache\_get(), when they are loaded.

### Suggestions

-   Remove all usage of phpinfo()
-   Add one or more constant to fine-tune the phpinfo(), and limit the
    amount of displayed information
-   Replace phpinfo() with a more adapted method :
    get\_loaded\_extensions() to access the list of loaded extensions

  ------------- -----------------------------------------------------
  Short name    Structures/PhpinfoUsage

  Rulesets      `Security`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Examples      `dolphin-structures-phpinfousage`{.interpreted-text
                role="ref"}
  ------------- -----------------------------------------------------

Possible Alias Confusion
------------------------

An alias is used for a class that doesn\'t belong to the current
namespace, while there is such a class. This also applies to traits and
interfaces.

When no alias is used, PHP will search for a class in the local space.
Since classes, traits and interfaces are usually stored one per file, it
is a valid syntax to create an alias, even if this alias name is the
name of a class in the same namespace.

Yet, with an alias refering to a remote class, while a local one is
available, it is possible to generate confusion.

``` {.php}
<?php

// This should be in a separate file, but has been merged here, for display purposes.
namespace A {
    //an alias from a namespace called C
    use C\A as C_A;

    //an alias from a namespace called C, which will superseed the local A\B class (see below)
    use C\D as B;
}

namespace A {
    // There is a class B in the A namespace
    class B {}
}

?>
```

### Suggestions

-   Avoid using existing classes names for alias
-   Use a coding convention to distinguish alias from names

  ------------- ---------------------------------
  Short name    Namespaces/AliasConfusion

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Possible Increment
------------------

This expression looks like a typo : a missing + would change the
behavior.

The same pattern is not reported with -, as it is legit expression. +
sign is usually understated, rather than explicit.

``` {.php}
<?php

// could it be a ++$b ? 
$a = +$b;

?>
```

See also [Incrementing/Decrementing
Operators](https://www.php.net/manual/en/language.operators.increment.php)
and [Arithmetic
Operators](https://www.php.net/manual/en/language.operators.arithmetic.php).

### Suggestions

-   Drop the whole assignation
-   Complete the addition with another value : \$a = 1 + \$b
-   Make this a ++ operator : ++\$b
-   Make this a negative operator : -\$b
-   Make the casting explicit : (int) \$b

  ---------- -------------------------------------------------------------
  Short name Structures/PossibleIncrement

  Rulesets   `Suggestions`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `zurmo-structures-possibleincrement`{.interpreted-text
             role="ref"},
             `mediawiki-structures-possibleincrement`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Possible Infinite Loop
----------------------

Loops on files that can\'t be open results in infinite loop.

[fgets()](https://www.php.net/fgets), and functions like
[fgetss()](https://www.php.net/fgetss),
[fgetcsv()](https://www.php.net/fgetcsv),
[fread()](https://www.php.net/fread), return false when they finish
reading, or can\'t access the file.

In case the file is not accessible, comparing the result of the reading
to something that is falsy, leads to a permanent valid condition. The
execution will only finish when the `max_execution_time` is reached.

``` {.php}
<?php

$file = fopen('/path/to/file.txt', 'r');
// when fopen() fails, the next loops is infinite
// fgets() will always return false, and while will always be true. 
while($line = fgets($file) != 'a') {
    doSomething();
}

?>
```

It is recommended to check the file resources when they are opened, and
always use === or !== to compare readings.
[feof()](https://www.php.net/feof) is also a reliable function here.

  ------------- ---------------------------------
  Short name    Structures/PossibleInfiniteLoop

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Possible Missing Subpattern
---------------------------

When capturing subpatterns are the last ones in a regex, PHP doesn\'t
fill their spot in the resulting array. This leads to a possible missing
index in the result array.

``` {.php}
<?php

// displays a partial array, from 0 to 1
preg_match('/(a)(b)?/', 'adc', $r);
print_r($r);
/*
Array
(
    [0] => a
    [1] => a
)
*/

// displays a full array, from 0 to 2
preg_match('/(a)(b)?/', 'abc', $r);
print_r($r);

/*
Array
(
    [0] => ab
    [1] => a
    [2] => b
)
*/

// double 'b' when it is found
print preg_replace(',^a(b)?,', './$1$1', 'abc'); // prints ./abbc
print preg_replace(',^a(b)?,', './$1$1', 'adc'); // prints ./dc

?>
```

?\>

The same applies to [preg\_replace()](https://www.php.net/preg_replace)
: the pattern may match the string, but no value is available is the
corresponding sub-pattern.

In PHP 7.4, a new option was added : PREG\_UNMATCHED\_AS\_NULL, which
always provides a value for the subpatterns.

See also [Bug \#50887 preg\_match , last optional sub-patterns ignored
when empty](https://bugs.php.net/bug.php?id=50887) and [Bug \#73948
Preg\_match\_all should return NULLs on trailing optional capture
groups.](https://bugs.php.net/bug.php?id=73948).

### Suggestions

-   Add an always capturing subpatterns after the last ?
-   Move the ? inside the parenthesis, so the parenthesis is always on,
    but the content may be empty
-   Add a test on the last index of the resulting array, to ensure it is
    available when needed
-   Use the PREG\_UNMATCHED\_AS\_NULL option (PHP 7.4+)

  ---------- ------------------------------------------------------------
  Short name Php/MissingSubpattern

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Top10`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `phpmyadmin-php-missingsubpattern`{.interpreted-text
             role="ref"}, `spip-php-missingsubpattern`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Pre-increment
-------------

When possible, use the pre-increment operator (`++$i` or `--$i`) instead
of the post-increment operator (`$i++` or `$i--`).

The latter needs an extra memory allocation that costs about 10% of
performances.

``` {.php}
<?php

// ++$i should be preferred over $i++, as current value is not important
for($i = 0; $i <10; ++$i) {
    // do Something
}

// ++$b and $b++ have different impact here, since $a will collect $b + 1 or $b, respectively.
$a = $b++;

?>
```

This is a micro-optimisation. However, its usage is so widespread,
including within loops, that it may eventually have an significant
impact on execution time. As such, it is recommended to adopt this rule,
and only consider changing legacy code as they are refactored for other
reasons.

### Suggestions

-   Use the pre increment when the new value is not reused.

  ----------- --------------------------------------------------------------------
  Short name  Performances/PrePostIncrement

  Rulesets    `Analyze`{.interpreted-text role="ref"},
              `Performances`{.interpreted-text role="ref"},
              `CI-checks`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Quick (30 mins)

  Precision   Very high

  Examples    `expressionengine-performances-prepostincrement`{.interpreted-text
              role="ref"}, `traq-performances-prepostincrement`{.interpreted-text
              role="ref"}
  ----------- --------------------------------------------------------------------

Prefix And Suffixes With Typehint
---------------------------------

This analysis checks the relationship between methods prefixes and
suffixes, with their corresponding return typehint.

For example, a method with the signature `function isACustomer() {}`
should return a boolean. That boolean can then be read when calling the
method : `if ($user->isACustomer()) {}`.

There are multiple such convention that may be applied. For example,
`has*` should return a boolean, `set*` should return nothing (a.k.a
`void`), and `get*`shall return any kind of type.

``` {.php}
<?php

class x  {
    // Easy to read convention
    function isAUser() : bool {}

    // shall return a boolean
    function isACustomer() {}

    // shall return a string, based on suffix 'name => string'
    function getName() {}

    // shall return a string, based on suffix 'name => string'
    function getUsername() {}

    // shall return \Uuid, based on prefix 'uuid => \Uuid'
    function getUuid() {}

    // shall return anything, based on no prefix nor suffix
    function getBirthday() {}

}

?>
```

There are 2 parameters for this analysis. It is recommended to customize
them to get an better results, related to the naming conventions used in
the code.

`prefixedType` is used for prefix in method names, which is the
beginning of the name. `suffixedType` is used for suffixes : the ending
part of the name. Matching is case insensitive.

The prefix is configured as the index of the map, while the related type
is configured as the value of the map.

`prefixToType['is'] = 'bool';` will be use as `is*` shall use the `bool`
typehint.

Multiple typehints may be used at the same time. PHP supports multiple
types since PHP 8.0, and Exakat will support them with any PHP version.
Specify multiple types by separating them with comma. Any typehint not
found in this list will be reported, including `null`.

PHP scalar types are available : `string`, `int`, `void`, etc. Explicit
types, based on classes or interfaces, must use the fully qualified
name, not the short name. `suffixToType['uuid'] = '\Uuid';` will be use
as `*uuid` shall use the `\Uuid` typehint.

When multiple rules applies, only one is reported.

### Suggestions

-   

  -------------- --------------------------------- ----------- -----------------------------
  Name           Default                           Type        Description

  prefixedType   prefixedType\[\'is\'\] =          ini\_hash   List of prefixes and their
                 \'bool\'; prefixedType\[\'has\'\]             expected returntype
                 = \'bool\';                                   
                 prefixedType\[\'set\'\] =                     
                 \'void\';                                     
                 prefixedType\[\'list\'\] =                    
                 \'array\';                                    

  suffixedType   prefixedType\[\'list\'\] =        ini\_hash   List of suffixes and their
                 \'bool\'; prefixedType\[\'int\'\]             expected returntype
                 = \'int\';                                    
                 prefixedType\[\'string\'\] =                  
                 \'string\';                                   
                 prefixedType\[\'name\'\] =                    
                 \'string\';                                   
                 prefixedType\[\'description\'\] =             
                 \'string\';                                   
                 prefixedType\[\'id\'\] = \'int\';             
                 prefixedType\[\'uuid\'\] =                    
                 \'Uuid\';                                     
  -------------- --------------------------------- ----------- -----------------------------

  ------------- -------------------------------
  Short name    Functions/PrefixToType

  Rulesets      `Semantics`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------

Preprocess Arrays
-----------------

Using long list of assignations for initializing arrays is significantly
slower than the declaring them as an array.

``` {.php}
<?php

// Slow way
$a = []; // also with $a = array();
$a[1] = 2;
$a[2] = 3;
$a[3] = 5;
$a[4] = 7;
$a[5] = 11;

// Faster way
$a = [1 => 2, 
      2 => 3,
      3 => 5,
      4 => 7,
      5 => 11];

// Even faster way if indexing is implicit
$a = [2, 3, 5, 7, 11];

?>
```

If the array has to be completed rather than created, it is also faster
to use += when there are more than ten elements to add.

``` {.php}
<?php

// Slow way
$a = []; // also with $a = array();
$a[1] = 2;
$a[2] = 3;
$a[3] = 5;
// some expressions to get $seven and $eleven
$a[4] = $seven;
$a[5] = $eleven;

// Faster way
$a = [1 => 2, 
      2 => 3,
      3 => 5];
// some expressions to get $seven and $eleven
$a += [4 => $seven, 
       5 => $eleven];

// Even faster way if indexing is implicit
$a = [2, 3, 5];
// some expressions to get $seven and $eleven
$a += [$seven, $eleven];

?>
```

### Suggestions

-   Preprocess the code so PHP doesn\'t do it. Keep the detailed version
    into comments.

  ------------- -------------------------
  Short name    Arrays/ShouldPreprocess

  Rulesets      none

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------

Preprocessable
--------------

The following expression are made of literals or already known values :
they may be fully calculated before running PHP.

``` {.php}
<?php

// Building an array from a string
$name = 'PHP'.' '.'7.2';

// Building an array from a string
$list = explode(',', 'a,b,c,d,e,f');

// Calculating a power
$kbytes = $bytes / pow(2, 10);

// This will never change
$name = ucfirst(strtolower('PARIS'));

?>
```

By doing so, this will reduce the amount of work of PHP.

### Suggestions

-   Do the work yourself, instead of giving it to PHP

  ----------- -----------------------------------------------------------
  Short name  Structures/ShouldPreprocess

  Rulesets    `Analyze`{.interpreted-text role="ref"},
              `Suggestions`{.interpreted-text role="ref"},
              `Suggestions`{.interpreted-text role="ref"},
              `Rector`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Instant (5 mins)

  Examples    `phpadsnew-structures-shouldpreprocess`{.interpreted-text
              role="ref"}
  ----------- -----------------------------------------------------------

Print And Die
-------------

[Die()](https://www.php.net/%60die%20%3Chttps://www.php.net/die)\>\`\_
also prints.

When stopping a script with
[die()](https://www.php.net/%60die%20%3Chttps://www.php.net/die)\>\`\_,
it is possible to provide a message as first argument, that will be
displayed at execution. There is no need to make a specific call to
print or echo.

``` {.php}
<?php

//  die may do both print and die.
echo 'Error message';
die();

//  exit may do both print and die.
print 'Error message';
exit;

//  exit cannot print integers only : they will be used as status report to the system.
print 'Error message';
exit 1;

?>
```

  ------------- ----------------------------------
  Short name    Structures/PrintAndDie

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ----------------------------------

Printf Number Of Arguments
--------------------------

The number of arguments provided to
[printf()](https://www.php.net/printf) or
[vprintf()](https://www.php.net/vprintf) doesn\'t match the format
string.

Extra arguments are ignored, and are dead code as such. Missing
arguments are reported with a warning, and nothing is displayed.

Omitted arguments produce an error.

``` {.php}
<?php

// not enough
printf(' a %s ', $a1); 
// OK
printf(' a %s ', $a1, $a2); 
// too many
printf(' a %s ', $a1, $a2, $a3); 

// not enough
sprintf(' a %s ', $a1); 
// OK
\sprintf(' a %s ', $a1, $a2); 
// too many
sprintf(' a %s ', $a1, $a2, $a3); 

?>
```

See also [printf](https://www.php.net/printf) and
[sprintf](https://www.php.net/sprintf).

### Suggestions

-   Sync the number of argument with the format command

  ------------- --------------------------------------------------------
  Short name    Structures/PrintfArguments

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)

  Precision     Medium

  Examples      `phpipam-structures-printfarguments`{.interpreted-text
                role="ref"}
  ------------- --------------------------------------------------------

Processing Collector
--------------------

When accumulating data in a variable, within a loop, it is slow to apply
repeatedly a function to the variable.

The example below illustrate the problem : `$collector` is build with
element from `$array`. `$collector` actually gets larger and larger,
slowing the [in\_array()](https://www.php.net/in_array) call each time.

It is better to apply the
[preg\_replace()](https://www.php.net/preg_replace) to `$a`, a short
variable, and then, add `$a` to the collector.

``` {.php}
<?php

// Fast way
$collector = '';
foreach($array as $a){
    $a = preg_replace('/__(.*?)__/', '<b>$1</b>', $a);
    $collector .= $a;
}

// Slow way
$collector = '';
foreach($array as $a){
    $collector .= $a;
    $collector = preg_replace('/__(.*?)__/', '<b>$1</b>', $collector);
}

?>
```

### Suggestions

-   Avoid applying the checks on the whole data, rather on the diff
    only.

  ------------- ----------------------------------
  Short name    Performances/RegexOnCollector

  Rulesets      `Performances`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------

Property Could Be Local
-----------------------

A property only used in one method may be turned into a local variable.

Public an protected properties are omitted here : they may be modified
somewhere else, in the code. This analysis may be upgraded to support
those properties, when tracking of such properties becomes available.

Classes where only one non-magic method is available are omitted.

Traits with private properties are processed the same way.

``` {.php}
<?php

class x {
    private $foo = 1;

    // Magic method, and constructor in particular, are omitted.
    function __construct($foo) {
        $this->foo = $foo;
    }

    function bar() {
        $this->foo++;

        return $this->foo;
    }

    function barbar() {}
}

?>
```

### Suggestions

-   Remove the property and make it an argument in the method
-   Use that property elsewhere

  ---------- -------------------------------------------------------------
  Short name Classes/PropertyCouldBeLocal

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `ClassReview`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  Examples   `mautic-classes-propertycouldbelocal`{.interpreted-text
             role="ref"},
             `typo3-classes-propertycouldbelocal`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Property Could Be Private Property
----------------------------------

The following properties are never used outside their class of
definition Given the analyzed code, they could be set as private.

``` {.php}
<?php

class foo {
    public $couldBePrivate = 1;
    public $cantdBePrivate = 1;

    function bar() {
        // couldBePrivate is used internally. 
        $this->couldBePrivate = 3;
    }
}

class foo2 extends foo {
    function bar2() {
        // cantdBePrivate is used in a child class. 
        $this->cantdBePrivate = 3;
    }
}

//$couldBePrivate is not used outside 
$foo = new foo();

//$cantdBePrivate is used outside the class
$foo->cantdBePrivate = 2;

?>
```

Note that dynamic properties (such as \$x-\>\$y) are not taken into
account.

### Suggestions

-   Remove the unused property
-   Use the private property
-   Change the visibility to allow access the property from other part
    of the code

  ------------- ---------------------------------
  Short name    Classes/CouldBePrivate

  Rulesets      `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- ---------------------------------

Property Used In One Method Only
--------------------------------

Properties should be used in several methods. When a property is used in
only one method, this should have be of another shape.

Properties used in one method only may be used several times, and read
only. This may be a class constant. Such properties are meant to be
overwritten by an extending class, and that\'s possible with class
constants.

Properties that read and written may be converted into a variable,
[static](https://www.php.net/manual/en/language.oop5.static.php) to the
method. This way, they are kept close to the method, and do not pollute
the object\'s properties.

``` {.php}
<?php

class foo {
    private $once = 1;
    const ONCE = 1;
    private $counter = 0;

    function bar() {
        // $this->once is never used anywhere else. 
        someFunction($this->once);
        someFunction(self::ONCE);   // Make clear that it is a 
    }

    function bar2() {
        static $localCounter = 0;
        $this->counter++;

        // $this->once is only used here, for distinguising calls to someFunction2
        if ($this->counter > 10) { // $this->counter is used only in bar2, but it may be used several times
            return false;
        }
        someFunction2($this->counter);

        // $localCounter keeps track for all the calls
        if ($localCounter > 10) { 
            return false;
        }
        someFunction2($localCounter);
    }
}

?>
```

Note : properties used only once are not returned by this analysis. They
are omitted, and are available in the analysis [Used Once
Property](#used-once-property).

### Suggestions

-   Drop the property, and inline the value
-   Drop the property, and make the property a local variable
-   Use the property in another method

  ------------- ----------------------------------------------------------------
  Short name    Classes/PropertyUsedInOneMethodOnly

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Examples      `contao-classes-propertyusedinonemethodonly`{.interpreted-text
                role="ref"}
  ------------- ----------------------------------------------------------------

Property Variable Confusion
---------------------------

Within a class, there is both a property and variables bearing the same
name.

``` {.php}
<?php
class Object {
    private $x;

    function SetData( ) {
        $this->x = $x + 2;
    }
}
?>
```

The property and the variable may easily be confused one for another and
lead to a bug.

Sometimes, when the property is going to be replaced by the incoming
argument, or data based on that argument, this naming schema is made on
purpose, indicating that the current argument will eventually end up in
the property. When the argument has the same name as the property, no
warning is reported.

### Suggestions

-   Use different names for the properties and variables
-   Adopt and apply a naming convention for variables and properties.

  ------------- ------------------------------------------------------------------
  Short name    Structures/PropertyVariableConfusion

  Rulesets      `Semantics`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Examples      `phpipam-structures-propertyvariableconfusion`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------------------

Queries In Loops
----------------

Avoid querying databases in a loop.

Querying an external database in a loop usually leads to performances
problems. This is also called the \'n + 1 problem\'.

This problem applies also to prepared statement : when such statement
are called in a loop, they are slower than one-time large queries.

It is recommended to reduce the number of queries by making one query,
and dispatching the results afterwards. This is true with SQL databases,
graph queries, LDAP queries, etc.

``` {.php}
<?php

// Typical N = 1 problem : there will be as many queries as there are elements in $array
$ids = array(1,2,3,5,6,10);

$db = new SQLite3('mysqlitedb.db');

// all the IDS are merged into the query at once
$results = $db->query('SELECT bar FROM foo WHERE id  in ('.implode(',', $id).')');
while ($row = $results->fetchArray()) {
    var_dump($row);
}


// Typical N = 1 problem : there will be as many queries as there are elements in $array
$ids = array(1,2,3,5,6,10);

$db = new SQLite3('mysqlitedb.db');

foreach($ids as $id) {
    $results = $db->query('SELECT bar FROM foo WHERE id = '.$id);
    while ($row = $results->fetchArray()) {
        var_dump($row);
    }
}

?>
```

This optimisation is not always possible : for example, some SQL queries
may not be prepared, like `DROP TABLE` or `DESC`. `UPDATE` commands
often update one row at a time, and grouping such queries may be
counter-productive or unsafe.

### Suggestions

-   Batch calls by using WHERE clauses and applying the same operation
    to all similar data
-   Use native commands to avoid double query : REPLACE instead of
    SELECT-(UPDATE/INSERT), or UPSERT, for example

  ---------- ------------------------------------------------------------
  Short name Structures/QueriesInLoop

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Top10`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Slow (1 hour)
  Fix        

  Examples   `teampass-structures-queriesinloop`{.interpreted-text
             role="ref"},
             `openemr-structures-queriesinloop`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Raised Access Level
-------------------

A property\'s visibility may be lowered, but not raised.

This error may be detected when the classes are all in the same file :
then, PHP reports the problem. However, when the classes are separated
in different files, as it is customary, PHP won\'t check this at linting
time, yielding a fatal error at execution time.

First file.

``` {.php}
<?php

class Foo {
    public $publicProperty;
    protected $protectedProperty;
    private $privateProperty;
}
?>
```

Second file.

``` {.php}
<?php

class Bar extends Foo {
    private $publicProperty;
    private $protectedProperty;
    private $privateProperty;   // This one is OK
}
?>
```

See also
[Visibility](https://www.php.net/manual/en/language.oop5.visibility.php)
and [Understanding the concept of visibility in object oriented
php](https://torquemag.io/2016/05/understanding-concept-visibility-object-oriented-php/).

### Suggestions

-   Lower the visibility in the child class
-   Raise the visibility in the parent class

  ------------- --------------------------------------------
  Short name    Classes/RaisedAccessLevel

  Rulesets      `ClassReview`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Quick (30 mins)
  ------------- --------------------------------------------

Random Without Try
------------------

[random\_int()](https://www.php.net/random_int) and
[random\_bytes()](https://www.php.net/random_bytes) require a try/catch
structure around them.

[random\_int()](https://www.php.net/random_int) and
[random\_bytes()](https://www.php.net/random_bytes) emit Exceptions if
they meet a problem. This way, failure can\'t be mistaken with returning
an empty value, which leads to lower security.

``` {.php}
<?php

try {
    $salt = random_bytes($length);
} catch (TypeError $e) {
    // Error while reading the provided parameter
} catch (Exception $e) {
    // Insufficient random data generated
} catch (Error $e) {
    // Error with the provided parameter : <= 0
}

?>
```

Since PHP 7.4,
[openssl\_random\_pseudo\_bytes()](https://www.php.net/openssl_random_pseudo_bytes)
has adopted the same behavior. It is included in this analysis : check
your PHP version for actual application.

### Suggestions

-   Add a try/catch structure around calls to random\_int() and
    random\_bytes().

  ------------- ------------------------------
  Short name    Structures/RandomWithoutTry

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.0 and more recent

  Severity      Critical

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

Randomly Sorted Arrays
----------------------

Those literal arrays are written in several places, but their items are
in various orders.

This may reduce the reading and proofing of the arrays, and induce
confusion. The random order may also be a residue of development : both
arrays started with different values, but they grew overtime to handle
the same items. The way they were written lead to the current order.

Unless order is important, it is recommended to always use the same
order when defining literal arrays. This makes it easier to match
different part of the code by recognizing one of its literal.

``` {.php}
<?php

// an array
$set = [1,3,5,9,10];

function foo() {
    // an array, with the same values but different order, in a different context
    $list = [1,3,5,10,9,];
}

// an array, with the same order than the initial one
$inits = [1,3,5,9,10];

?>
```

### Suggestions

-   Match the sorting order of the arrays. Choose any of them.
-   Configure a constant and use it as a replacement for those arrays.
-   Leave the arrays intact : the order may be important.
-   For hash arrays, consider turning the array in a class.

  ---------- -------------------------------------------------------------
  Short name Arrays/RandomlySortedLiterals

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Suggestions`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  Examples   `contao-arrays-randomlysortedliterals`{.interpreted-text
             role="ref"},
             `vanilla-arrays-randomlysortedliterals`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Redeclared PHP Functions
------------------------

Function that bear the same name as a PHP function, and that are
declared.

This is useful when managing backward compatibility, like emulating an
old function, or preparing for newer PHP versions, like emulating new
upcoming function.

``` {.php}
<?php

if (version_compare(PHP_VERSION, 7.0) > 0) {
    function split($separator, $string) {
        return explode($separator, $string);
    }
}

print_r( split(' ', '2 3'));

?>
```

### Suggestions

-   Check if it is still worth emulating that function

  ------------- ----------------------------------
  Short name    Functions/RedeclaredPhpFunction

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------

Redefined Class Constants
-------------------------

Redefined class constants.

Class constants may be redefined, though it is prone to errors when
using them, as it is now crucial to use the right class name to access
the right value.

``` {.php}
<?php

class a {
    const A = 1;
}

class b extends a {
    const A = 2;
}

class c extends c { }

echo a::A, ' ', b::A, ' ', c::A;
// 1 2 2

?>
```

It is recommended to use distinct names.

  ------------- ----------------------------------
  Short name    Classes/RedefinedConstants

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------

Redefined Default
-----------------

Classes allows properties to be set with a default value. When those
properties get, unconditionally, another value at constructor time, then
one of the default value are useless. One of those definition should go
: it is better to define properties outside the constructor.

``` {.php}
<?php

class foo {
    public $redefined = 1;

    public function __construct( ) {
        $this->redefined = 2;
    }
}

?>
```

### Suggestions

-   Move the default assignation to the property definition
-   Drop the reassignation in the constructor

  ------------- -----------------------------------------------------
  Short name    Classes/RedefinedDefault

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)

  Examples      `piwigo-classes-redefineddefault`{.interpreted-text
                role="ref"}
  ------------- -----------------------------------------------------

Redefined Private Property
--------------------------

Private properties are local to their defined class. PHP doesn\'t forbid
the re-declaration of a private property in a child class.

However, having two or more properties with the same name, in the class
hierarchy tends to be error prone.

``` {.php}
<?php

class A {
    private $isReady = true;
}

class B {
    private $isReady = false;
}

?>
```

  ------------- ------------------------------------------------------------
  Short name    Classes/RedefinedPrivateProperty

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)

  Precision     High

  Examples      `zurmo-classes-redefinedprivateproperty`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------------

Redefined Property
------------------

Property redefined in a
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
class.

Using heritage, it is possible to define several times the same
property, at different levels of the hierarchy.

``` {.php}
<?php

class foo {
    protected $aProperty = 1;
}

class bar extends foo {
    // This property is redefined in the parent class, leading to potential confusion
    protected $aProperty = 1;
}

?>
```

When this is the case, it is difficult to understand which class will
actually handle the property.

In the case of a private property, the different instances will stay
distinct. In the case of protected or public properties, they will all
share the same value.

It is recommended to avoid redefining the same property in a hierarchy.

  ------------- ---------------------------------
  Short name    Classes/RedefinedProperty

  Rulesets      `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Reflection Export() Is Deprecated {#reflection-export()-is-deprecated}
---------------------------------

export() method in Reflection classes is now deprecated. It is obsolete
since PHP 7.4 and will disappear in PHP 8.0.

The Reflector interface, which is implemented by all reflection classes,
specifies two methods:
[\_\_toString()](https://www.php.net/manual/en/language.oop5.magic.php)
and export().

``` {.php}
<?php

ReflectionFunction::export('foo');
// same as
echo new ReflectionFunction('foo'), \n;

$str = ReflectionFunction::export('foo', true);
// same as
$str = (string) new ReflectionFunction('foo');

?>
```

See also [Reflection export()
methods](https://wiki.php.net/rfc/deprecations_php_7_4#reflection_export_methods)
and [Reflection](https://www.php.net/manual/en/book.reflection.php).

### Suggestions

-   Cast the object to string
-   Remove the call to export()

  ------------- ----------------------------------------
  Short name    Php/ReflectionExportIsDeprecated

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Regex On Arrays
---------------

Avoid using a loop with arrays of regex or values. There are several PHP
function which work directly on arrays, and much faster.

[preg\_grep()](https://www.php.net/preg_grep) is able to extract all
matching strings from an array, or non-matching strings. This usually
saves a loop over the strings.

[preg\_filter()](https://www.php.net/preg_filter) is able to extract all
strings from an array, matching at least one regex in an array. This
usually saves a double loop over the strings and the regex. The trick
here is to provide \'\$0\' as replacement, leading
[preg\_filter()](https://www.php.net/preg_filter) to replace the found
string by itself.

Finally,
[preg\_replace\_callback()](https://www.php.net/preg_replace_callback)
an
[preg\_replace\_callback\_array()](https://www.php.net/preg_replace_callback_array)
are also able to apply an array of regex to an array of strings, and
then, apply callbacks to the found values.

``` {.php}
<?php

$regexs = ['/ab+c/', '/abd+/', '/abe+/'];
$strings = ['/abbbbc/', '/abd/', '/abeee/'];

// Directly extract all strings that match one regex
foreach($regexs as $regex) {
    $results[] = preg_grep($regex, $strings);
}

// extract all matching regex, by string
foreach($strings as $string) {
    $results[] = preg_filter($regexs, array_fill(0, count($regexs), '$0'), $string);
}

// very slow way to get all the strings that match a regex
foreach($regexs as $regex) {
    foreach($strings as $string) {
        if (preg_match($regex, $string)) {
            $results[] = $string;
        }
    }
}

?>
```

See also [preg\_filter](https://php.net/preg_filter).

### Suggestions

-   Apply preg\_match() to an array of string or regex, via
    preg\_filter() or preg\_grep().
-   Apply preg\_match() to an array of string or regex, via
    preg\_replace\_callback() or preg\_replace\_callback\_array().

  ------------- ----------------------------------
  Short name    Performances/RegexOnArrays

  Rulesets      `Performances`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Register Globals
----------------

`register_globals` was a PHP directive that dumped all incoming
variables from GET, POST, COOKIE and FILES as global variables in the
called scripts. This lead to security failures, as the variables were
often used but not filtered.

Though it is less often found in more recent code, `register_globals` is
sometimes needed in legacy code, that haven\'t made the move to
eradicate this style of coding. Backward compatible pieces of code that
mimic the `register_globals` features usually create even greater
security risks by being run after scripts startup. At that point, some
important variables are already set, and may be overwritten by the
incoming call, creating confusion in the script.

Mimicking `register_globals` is achieved with variables variables,
[extract()](https://www.php.net/extract),
[parse\_str()](https://www.php.net/parse_str) and
[import\_request\_variables()](https://www.php.net/import_request_variables)
(Up to PHP 5.4).

``` {.php}
<?php

// Security warning ! This overwrites existing variables. 
extract($_POST);

// Security warning ! This overwrites existing variables. 
foreach($_REQUEST as $var => $value) {
    $$var = $value;
}

?>
```

### Suggestions

-   Avoid reimplementing register\_globals
-   Use a container to store and access commonly used values

  ---------- ------------------------------------------------------------
  Short name Security/RegisterGlobals

  Rulesets   `Security`{.interpreted-text role="ref"}

  Severity   Critical

  Time To    Slow (1 hour)
  Fix        

  Examples   `teampass-security-registerglobals`{.interpreted-text
             role="ref"},
             `xoops-security-registerglobals`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Relay Function
--------------

Relay function only delegate workload to another one.

Relay functions and methods are delegating the actual work to another
function or method. They do not have any impact on the results, besides
exposing another name for the same feature.

``` {.php}
<?php

function myStrtolower($string) {
    return \strtolower($string);
}

?>
```

Relay functions are typical of transition API, where an old API have to
be preserved until it is fully migrated. Then, they may be removed, so
as to reduce confusion, and simplify the API.

### Suggestions

-   Remove relay function, call directly the final function
-   Remove the target function, and move the code here
-   Add more logic to that function, like conditions or cache

  ---------- ------------------------------------------------------------
  Short name Functions/RelayFunction

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `teampass-functions-relayfunction`{.interpreted-text
             role="ref"},
             `spip-functions-relayfunction`{.interpreted-text role="ref"}
  ---------- ------------------------------------------------------------

Repeated Interface
------------------

A class should implements only once an interface. An interface can only
extends once another interface. In both cases,
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
classes or interfaces must be checked.

PHP accepts multiple times the same interface in the `implements`
clause. In fact, it doesn\'t do anything beyond the first implement.

``` {.php}
<?php

use i as j;

interface i {}

// Multiple ways to reference an interface
class foo implements i, \i, j {}

// This applies to interfaces too
interface bar extends i, \i, j {}

?>
```

This code may compile, but won\'t execute.

See also [Object
Interfaces](https://www.php.net/manual/en/language.oop5.interfaces.php)
and [The Basics](https://www.php.net/manual/en/language.oop5.basic.php).

### Suggestions

-   Remove the interface usage at the lowest class or interface

  ------------- ----------------------------------------
  Short name    Interfaces/RepeatedInterface

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ----------------------------------------

Repeated Regex
--------------

Repeated regex should be centralized.

When a regex is repeatedly used in the code, it is getting harder to
update.

``` {.php}
<?php

// Regex used several times, at least twice.
preg_match('/^abc_|^square$/i', $_GET['x']);

//.......

preg_match('/^abc_|^square$/i', $row['name']);

// This regex is dynamically built, so it is not reported.
preg_match('/^circle|^'.$x.'$/i', $string);

// This regex is used once, so it is not reported.
preg_match('/^circle|^square$/i', $string);

?>
```

Regex that are repeated at least once (aka, used twice or more) are
reported. Regex that are dynamically build are not reported.

### Suggestions

-   Create a central library of regex
-   Use the regex inventory to spot other regex that are close, and
    should be identical.

  ---------- ------------------------------------------------------------
  Short name Structures/RepeatedRegex

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `vanilla-structures-repeatedregex`{.interpreted-text
             role="ref"},
             `tikiwiki-structures-repeatedregex`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Repeated print() {#repeated-print()}
----------------

Always merge several print or echo in one call.

It is recommended to use echo with multiple arguments, or a
concatenation with print, instead of multiple calls to print echo, when
outputting several blob of text.

``` {.php}
<?php

//Write : 
  echo 'a', $b, 'c';
  print 'a' . $b . 'c';

//Don't write :  
  print 'a';
  print $b;
  print 'c';
?>
```

### Suggestions

-   Merge all prints into one echo call, separating arguments by commas.
-   Collect all values in one variable, and do only one call to print or
    echo.

  ---------- ------------------------------------------------------------------------------------------------
  Short name Structures/RepeatedPrint

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `Suggestions`{.interpreted-text role="ref"},
             `Top10`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-repeated-print](https://github.com/dseguy/clearPHP/tree/master/rules/no-repeated-print.md)

  Examples   `edusoho-structures-repeatedprint`{.interpreted-text role="ref"},
             `humo-gen-structures-repeatedprint`{.interpreted-text role="ref"}
  ---------- ------------------------------------------------------------------------------------------------

Reserved Keywords In PHP 7
--------------------------

PHP reserved names for class/trait/interface. They won\'t be available
anymore in user space starting with PHP 7.

For example, string, float, false, true, null,
resource,[\...](https://www.php.net/manual/en/functions.arguments.php#functions.variable-arg-list)
are not acceptable as class name.

``` {.php}
<?php

// This doesn't compile in PHP 7.0 and more recent
class null { }

?>
```

See also [List of other reserved
words](https://www.php.net/manual/en/reserved.other-reserved-words.php).

### Suggestions

-   Avoid using PHP reserved keywords

  ------------- ----------------------------------------
  Short name    Php/ReservedKeywords7

  Rulesets      `CompatibilityPHP70`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.0 and older

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

Results May Be Missing
----------------------

[preg\_match()](https://www.php.net/preg_match) may return empty values,
if the search fails. It is important to check for the existence of
results before assigning them to another variable, or using it.

``` {.php}
<?php
    preg_match('/PHP ([0-9\.]+) /', $res, $r);
    $s = $r[1];
    // $s may end up null if preg_match fails.
?>
```

  ------------- ----------------------------------
  Short name    Structures/ResultMayBeMissing

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Rethrown Exceptions
-------------------

Throwing a caught exception is usually useless and dead code.

When exceptions are caught, they should be processed or transformed, but
not rethrown as is.

Those issues often happen when a catch structure was positioned for
debug purposes, but lost its usage later.

``` {.php}
<?php

try {
    doSomething();
} catch (Exception $e) {
    throw $e;
}

?>
```

See also [What are the best practices for catching and re-throwing
exceptions?](https://stackoverflow.com/questions/5551668/what-are-the-best-practices-for-catching-and-re-throwing-exceptions)
and [Exception
chaining](https://www.php.net/manual/en/exception.construct.php).

### Suggestions

-   Log the message of the exception for later usage.
-   Remove the try/catch and let the rest of the application handle this
    exception.
-   Chain the exception, by throwing a new exception, including the
    caught exception.

  ------------- ----------------------------------------------------
  Short name    Exceptions/Rethrown

  Rulesets      `Dead code <dead-code>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `prestashop-exceptions-rethrown`{.interpreted-text
                role="ref"}
  ------------- ----------------------------------------------------

Return True False
-----------------

These conditional expressions return true/false, depending on the
condition. This may be simplified by dropping the control structure
altogether.

``` {.php}
<?php

if (version_compare($a, $b) >= 0) {
    return true;
} else {
    return false;
}

?>
```

This may be simplified with :

``` {.php}
<?php

return version_compare($a, $b) >= 0;

?>
```

This may be applied to assignations and ternary operators too.

``` {.php}
<?php

if (version_compare($a, $b) >= 0) {
    $a = true;
} else {
    $a = false;
}

$a = version_compare($a, $b) >= 0 ? false : true;

?>
```

### Suggestions

-   Return directly the comparison, without using the if/then structure
-   Cast the value to (boolean) and use it instead of the ternary

  ---------- -------------------------------------------------------------
  Short name Structures/ReturnTrueFalse

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `mautic-structures-returntruefalse`{.interpreted-text
             role="ref"},
             `fuelcms-structures-returntruefalse`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Return With Parenthesis
-----------------------

return statement doesn\'t need parenthesis. PHP tolerates them with
return statement, but it is recommended not to use them.

From the PHP Manual : \'Note: Note that since return is a language
construct and not a function, the parentheses surrounding its argument
are not required and their use is discouraged.\'.

``` {.php}
<?php

function foo() {
    $a = rand(0, 10);

    // No need for parenthesis
    return $a;

    // Parenthesis are useless here
    return ($a);

    // Parenthesis are useful here: they are needed by the multplication.
    return ($a + 1) * 3;
}

?>
```

See also [PHP return(value); vs return
value;](https://stackoverflow.com/questions/2921843/php-returnvalue-vs-return-value)
and [return](https://www.php.net/manual/en/function.return.php).

### Suggestions

-   Remove the parenthesis

  ----------- -------------------------------------------------------------
  Short name  Php/ReturnWithParenthesis

  Rulesets    `Coding Conventions <coding-conventions>`{.interpreted-text
              role="ref"}, `Suggestions`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Instant (5 mins)
  ----------- -------------------------------------------------------------

Reuse Variable
--------------

A variable is already holding the content that is calculated multiple
times over.

It is recommended to use the cached value. This saves some computation,
in particular when used in a loop, and speeds up the process.

``` {.php}
<?php

function foo($a) {
    $b = strtolower($a);

    // strtolower($a) is already calculated in $b. Just reuse the value.
    if (strtolower($a) === 'c') {
        doSomething();
    }
}

?>
```

### Suggestions

-   Reuse the already created variable

  ------------- ---------------------------------
  Short name    Structures/ReuseVariable

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Precision     Medium
  ------------- ---------------------------------

Safe Curl Options
-----------------

It is advised to always use `CURLOPT_SSL_VERIFYPEER` and
`CURLOPT_SSL_VERIFYHOST` when requesting a SSL connection.

With those tests, the certificate is verified, and if it isn\'t valid,
the connection fails : this is a safe behavior.

``` {.php}
<?php
$ch = curl_init();

curl_setopt($ch, CURLOPT_URL, https://www.php.net/);

// To be safe, always set this to true
curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, true);

curl_exec($ch);
curl_close($ch);
?>
```

See also [Don't turn off CURLOPT\_SSL\_VERIFYPEER, fix your PHP
configuration](https://www.saotn.org/dont-turn-off-curlopt_ssl_verifypeer-fix-php-configuration/),
[Certainty: Automated CACert.pem Management for PHP
Software](https://paragonie.com/blog/2017/10/certainty-automated-cacert-pem-management-for-php-software)
and [Server-Side HTTPS
Requests](https://paragonie.com/blog/2017/12/2018-guide-building-secure-php-software#secure-server-side-https).

### Suggestions

-   Always use CURLOPT\_SSL\_VERIFYPEER and HTTPS for communication with
    other servers

  ------------- ---------------------------------------------------
  Short name    Security/CurlOptions

  Rulesets      `Security`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Examples      `openconf-security-curloptions`{.interpreted-text
                role="ref"}
  ------------- ---------------------------------------------------

Safe HTTP Headers
-----------------

Avoid configuring HTTP headers with lax restriction from within PHP.

There are a lot of HTTP headers those days, targeting various
vulnerabilities. To ensure backward compatibility, those headers have a
default mode that is lax and permissive. It is recommended to avoid
using those from within the code.

``` {.php}
<?php

//Good configuration, limiting access to origin
header('Access-Control-Allow-Origin: https://www.exakat.io');

//Configuration is present, but doesn't restrict anything : any external site is a potential source
header('Access-Control-Allow-Origin: *');

?>
```

See also [Hardening Your HTTP Security
Headers](https://www.keycdn.com/blog/http-security-headers), [How To
Secure Your Web App With HTTP
Headers](https://www.smashingmagazine.com/2017/04/secure-web-app-http-headers/)
and [SecurityHeaders](https://securityheaders.com/).

### Suggestions

-   Remove usage of those headers

  ------------- ------------------------------
  Short name    Security/SafeHttpHeaders

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

Same Conditions In Condition
----------------------------

At least two consecutive if/then structures use identical conditions.
The latter will probably be ignored.

This analysis returns false positive when there are attempt to fix a
situation, or to call an alternative solution.

Conditions that are shared between if structures, but inside a logical
OR expression are also detected.

``` {.php}
<?php

if ($a == 1) { doSomething(); }
elseif ($b == 1) { doSomething(); }
elseif ($c == 1) { doSomething(); }
elseif ($a == 1) { doSomething(); }
else {}

// Also works on if then else if chains
if ($a == 1) { doSomething(); }
else if ($b == 1) { doSomething(); }
else if ($c == 1) { doSomething(); }
else if ($a == 1) { doSomething(); }
else {}

// Also works on if then else if chains
// Here, $a is common and sufficient in both conditions
if ($a || $b) { doSomething(); } 
elseif ($a || $c) { doSomethingElse(); } 

// This sort of situation generate false postive. 
$config = load_config_from_commandline();
if (empty($config)) {
    $config = load_config_from_file();
    if (empty($config)) {
        $config = load_default_config();
    }
}

?>
```

### Suggestions

-   Merge the two conditions into one
-   Make the two conditions different

  ---------- ------------------------------------------------------------
  Short name Structures/SameConditions

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Critical

  Time To    Quick (30 mins)
  Fix        

  Examples   `teampass-structures-sameconditions`{.interpreted-text
             role="ref"},
             `typo3-structures-sameconditions`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Same Variable Foreach
---------------------

A foreach which uses its own source as a blind variable is actually
broken.

Actually, PHP makes a copy of the source before it starts the loop. As
such, the same variable may be used for both source and blind value.

Of course, this is very confusing, to see the same variables used in
very different ways.

The source will also be destroyed immediately after the blind variable
has been turned into a reference.

``` {.php}
<?php

$array = range(0, 10);
foreach($array as $array) {
    print $array.PHP_EOL;
}

print_r($array); // display number from 0 to 10.

$array = range(0, 10);
foreach($array as &$array) {
    print $array.PHP_EOL;
}

print_r($array); // display 10

?>
```

  ------------- ----------------------------------
  Short name    Structures/AutoUnsetForeach

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Scalar Are Not Arrays
---------------------

It is wrong to use a scalar as an array, a Warning is emitted. PHP 7.4
emits a Warning in such situations.

``` {.php}
<?php

// Here, $x may be null, and in that case, the echo will fail.
function foo(?A $x) { 
    echo $x[2]; 
}

?>
```

Typehinted argument with a scalar are reported by this analysis. Also,
nullable arguments, both with typehint and return type hint.

See also [E\_WARNING for invalid container read
array-access](https://wiki.php.net/rfc/notice-for-non-valid-array-container).

### Suggestions

-   Update type hints to avoid scalar values
-   Remove the array syntax in the code using the results
-   Cast to string type, so the array notation is accessible

  ------------- ---------------------------------------------------------
  Short name    Php/ScalarAreNotArrays

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CompatibilityPHP74`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- ---------------------------------------------------------

Scalar Or Object Property
-------------------------

Property shouldn\'t use both object and scalar syntaxes. When a property
may be an object, it is recommended to implement the Null Object pattern
: instead of checking if the property is scalar, make it always object.

``` {.php}
<?php

class x {
    public $display = 'echo';

    function foo($string) {
        if (is_string($this->display)) {
            echo $this->string;
        } elseif ($this->display instanceof myDisplayInterface) {
            $display->display();
        } else {
            print Error when displaying\n;
        }
    }
}

interface myDisplayInterface {
    public function display($string); // does the display in its own way
}

class nullDisplay implements myDisplayInterface {
    // implements myDisplayInterface but does nothing
    public function display($string) {}
}

class x2 {
    public $display = null;

    public function __construct() {
        $this->display = new nullDisplay();
    }

    function foo($string) {
        // Keep the check, as $display is public, and may get wrong values
        if ($this->display instanceof myDisplayInterface) {
            $display->display();
        } else {
            print Error when displaying\n;
        }
    }
}

// Simple class for echo
class echoDisplay implements myDisplayInterface {
    // implements myDisplayInterface but does nothing
    public function display($string) {
        echo $string;
    }
}

?>
```

See also [Null Object
Pattern](https://en.wikipedia.org/wiki/Null_Object_pattern#PHP). and
[The Null Object
Pattern](https://www.sitepoint.com/the-null-object-pattern-polymorphism-in-domain-models/).

### Suggestions

-   Only use one type of syntax with your properties.

  ------------- -------------------------------------------------------------
  Short name    Classes/ScalarOrObjectProperty

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Examples      `sugarcrm-classes-scalarorobjectproperty`{.interpreted-text
                role="ref"}
  ------------- -------------------------------------------------------------

Self Using Trait
----------------

Trait uses itself : this is unnecessary. Traits may use themselves, or
be used by other traits, that are using the initial trait itself.

PHP handles the situation quietly, by ignoring all extra use of the same
trait, keeping only one valid version.

``` {.php}
<?php

// empty, but valid
trait a {} 

// obvious self usage
trait b { use b; }

// less obvious self usage
trait c { use d, e, f, g, h, c; }

// level 2 self usage
trait i { use j; }
trait j { use i; }

?>
```

See also
[Traits](https://www.php.net/manual/en/language.oop5.traits.php).

### Suggestions

-   Remove the extra usage of the trait.

  ------------- --------------------------------------------------
  Short name    Traits/SelfUsingTrait

  Rulesets      `Dead code <dead-code>`{.interpreted-text
                role="ref"}, `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- --------------------------------------------------

Semantic Typing
---------------

Arguments names are only useful inside the method\'s body. They are not
actual type.

``` {.php}
<?php

// arguments should be a string and an array
function foo($array, $str) {
    // more code
    return $boolean;
}

// typehint is actually checking the values
function bar(iterable $closure) : bool {
    // more code
    return true;
}

?>
```

### Suggestions

-   Use a typehint to make sure the argument is of the expected type.

  ------------- -------------------------------
  Short name    Functions/SemanticTyping

  Rulesets      `Semantics`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------

Session Lazy Write
------------------

Classes that implements SessionHandlerInterface must also implements
SessionUpdateTimestampHandlerInterface.

The two extra methods are used to help lazy loading : the first actually
checks if a sessionId is available, and the seconds updates the time of
last usage of the session data in the session storage.

This was spotted by `Nicolas Grekas`, and fixed in Symfony
[\[HttpFoundation\] Make sessions secure and lazy
\#24523](https://github.com/symfony/symfony/pull/24523).

``` {.php}
<?php

interface SessionUpdateTimestampHandlerInterface {
    // returns a boolean to indicate that valid data is available for this sessionId, or not.
    function validateId($sessionId);

    //called to change the last time of usage for the session data.
    //It may be a file's touch or full write, or a simple update on the database
    function updateTimestamp($sessionId, $sessionData);
}

?>
```

See also [Sessions: Improve original RFC about
lazy\_write](https://wiki.php.net/rfc/session-read_only-lazy_write) and
the [Sessions](https://www.php.net/manual/en/book.session.php).

### Suggestions

-   Implements the SessionUpdateTimestampHandlerInterface interface

  ------------- ------------------------------
  Short name    Security/SessionLazyWrite

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ------------------------------

Set Aside Code
--------------

Setting aside code should be made into a method.

Setting aside code happens when one variable or member is stored
locally, to be temporarily replaced by another value. Once the new value
has been processed, the original value is reverted.

The temporary change of the value makes the code hard to read.

It is a good example of a piece of code that could be moved to a
separate method or function. Using the temporary value as a parameter
makes the change visible, and avoid local pollution.

``` {.php}
<?php

// Setting aside database
class cache extends Storage {
    private $database = null;

    function __construct($database) {
        $this->database = $database;
    }

    function foo($values) {
        // handling storage with sqlite3 
        $secondary = new cache(new Sqlite3(':memory:'));
        $secondary->store($values);

        $this->store($values);      // handling storage with injection 
    }
}

// Setting aside database to cache data in two distinct backend
class cache extends Storage {
    private $database = null;

    function __construct(\Pdo $database) {
        $this->database = $database;
    }

    function foo($values) {
        // $this->database is set aside for secondary configuration
        $side = $this->database;
        $this->database = new Sqlite3(':memory:');
        $this->store($values);      // handling storage with sqlite3 
        $this->database = $side;
        // $this->database is restored
        $this->store($values);      // handling storage with injection 
    }
}

?>
```

### Suggestions

-   Extract the code that run with the temporary value to a separate
    method.

  ------------- ---------------------------------
  Short name    Structures/SetAside

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Set Cookie Safe Arguments
-------------------------

The last five arguments of [setcookie()](https://www.php.net/setcookie)
and [setrawcookie()](https://www.php.net/setrawcookie) are for security.
Use them anytime you can.

`setcookie ( string $name [, string $value =  [, int $expire = 0 [, string $path =  [, string $domain =  [, bool $secure = false [, bool $httponly = false ]]]]]] )`

The `$expire` argument sets the date of expiration of the cookie. It is
recommended to make it as low as possible, to reduce its chances to be
captured. Sometimes, low expiration date may be several days (for
preferences), and other times, low expiration date means a few minutes.

The `$path` argument limits the transmission of the cookie to URL whose
path matches the one mentioned here. By default, it is `'/'`, which
means the whole server. If a cookie usage is limited to a part of the
application, use it here.

The `$domain` argument limits the transmission of the cookie to URL
whose domain matches the one mentioned here. By default, it is `''`,
which means any server on the internet. At worse, you may use
`mydomain.com` to cover your whole domain, or better, refine it with the
actual subdomain of usage.

The `$secure` argument limits the transmission of the cookie over HTTP
(by default) or HTTPS. The second is better, as the transmission of the
cookie is crypted. In case HTTPS is still at the planned stage, use
\'\$\_SERVER\[HTTPS\]\'. This environment variable is false on HTTP, and
true on HTTPS.

The `$httponly` argument limits the access of the cookie to JavaScript.
It is only transmitted to the browser, and retransmitted. This helps
reducing XSS and CSRF attacks, though it is disputed.

The `$samesite` argument limits the sending of the cookie to the domain
that initiated the request. It is by default `Lax` but should be
upgraded to `Strict` whenever possible. This feature is available as PHP
7.3.

``` {.php}
<?php

//admin cookie, available only on https://admin.my-domain.com/system/, for the next minute, and not readable by javascript
setcookie(admin, $login, time()+60, /system/, admin.my-domain.com, $_SERVER['HTTPS'], 1);

//login cookie, available until the browser is closed, over http or https
setcookie(login, $login);

//removing the login cookie : Those situations are omitted by the analysis
setcookie(login, '');

?>
```

See also [setcookie](http://www.php.net/setcookie) and [\'SameSite\'
cookie
attribute](https://www.chromestatus.com/feature/4672634709082112).

### Suggestions

-   Use all the argument when setting cookies with PHP functions

  ------------- ------------------------------
  Short name    Security/SetCookieArgs

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)
  ------------- ------------------------------

Setlocale() Uses Constants {#setlocale()-uses-constants}
--------------------------

[setlocale()](https://www.php.net/setlocale) don\'t use strings but
constants.

The first argument of [setlocale()](https://www.php.net/setlocale) must
be one of the valid constants, `LC_ALL`, `LC_COLLATE`, `LC_CTYPE`,
`LC_MONETARY`, `LC_NUMERIC`, `LC_TIME, LC_MESSAGES`.

``` {.php}
<?php

// Use constantes for setlocale first argument
setlocale(LC_ALL, 'nl_NL');
setlocale(\LC_ALL, 'nl_NL');

// Don't use string for setlocale first argument
setlocale('LC_ALL', 'nl_NL');
setlocale('LC_'.'ALL', 'nl_NL');

?>
```

The PHP 5 usage of strings (same name as above, enclosed in \' or \") is
not legit anymore in PHP 7 and later.

See also [setlocale](https://www.php.net/setlocale).

### Suggestions

-   Use setlocale() constants

  ------------- ----------------------------------------
  Short name    Structures/SetlocaleNeedsConstants

  Rulesets      `CompatibilityPHP70`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)

  Precision     High
  ------------- ----------------------------------------

Several Instructions On The Same Line
-------------------------------------

Usually, instructions do not share their line : one instruction, one
line.

This is good for readability, and help at understanding the code. This
is especially important when fast-reading the code to find some special
situation, where such double-meaning line way have an impact.

``` {.php}
<?php

switch ($x) {
    // Is it a fallthrough or not ? 
    case 1:
        doSomething(); break;

    // Easily spotted break.
    case 1:
        doSomethingElse(); 
        break;

    default : 
        doDefault(); 
        break;
}

?>
```

See also [Object Calisthenics, rule \#
5](http://williamdurand.fr/2013/06/03/object-calisthenics/#one-dot-per-line).

  ---------- --------------------------------------------------------------
  Short name Structures/OneLineTwoInstructions

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Instant (5 mins)
  Fix        

  Examples   `piwigo-structures-onelinetwoinstructions`{.interpreted-text
             role="ref"},
             `tine20-structures-onelinetwoinstructions`{.interpreted-text
             role="ref"}
  ---------- --------------------------------------------------------------

Short Open Tags
---------------

Usage of short open tags is discouraged. The following files were found
to be impacted by the short open tag directive at compilation time. They
must be reviewed to ensure no &lt;? tags are found in the code.

  ------------- -----------------------------
  Short name    Php/ShortOpenTagRequired

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Short Syntax For Arrays
-----------------------

Arrays written with the new short syntax.

PHP 5.4 introduced the new short syntax, with square brackets. The
previous syntax, based on the [array()](https://www.php.net/array)
keyword is still available.

``` {.php}
<?php

// All PHP versions array
$a = array(1, 2, 3);

// PHP 5.4+ arrays
$a = [1, 2, 3];

?>
```

See also
[Array](https://www.php.net/manual/en/language.types.array.php).

  ------------- ----------------------------------------
  Short name    Arrays/ArrayNSUsage

  Rulesets      `CompatibilityPHP53`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Should Be Single Quote
----------------------

Use single quote for simple strings.

[Static](https://www.php.net/manual/en/language.oop5.static.php) content
inside a string, that has no single quotes nor escape sequence (such as
n or t), should be using single quote delimiter, instead of double
quote.

``` {.php}
<?php

$a = abc;

// This one is using a special sequence
$b = cde\n;

// This one is using two special sequences
$b = \x03\u{1F418};

?>
```

If you have too many of them, don\'t loose your time switching them all.
If you have a few of them, it may be good for consistence.

  ---------- --------------------------------------------------------------------------------------------
  Short name Type/ShouldBeSingleQuote

  Rulesets   `Coding Conventions <coding-conventions>`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [no-double-quote](https://github.com/dseguy/clearPHP/tree/master/rules/no-double-quote.md)
  ---------- --------------------------------------------------------------------------------------------

Should Chain Exception
----------------------

Chain exception to provide more context.

When catching an exception and rethrowing another one, it is recommended
to chain the exception : this means providing the original exception, so
that the final recipient has a chance to track the origin of the
problem. This doesn\'t change the thrown message, but provides more
information.

Note : Chaining requires PHP \> 5.3.0.

``` {.php}
<?php
    try {
        throw new Exception('Exception 1', 1);
    } catch (\Exception $e) {
        throw new Exception('Exception 2', 2, $e); 
        // Chaining here. 

    }
?>
```

See also [Exception::]{.title-ref}\_\_construct
\<<https://www.php.net/manual/en/language.oop5.decon.php>\>[\_](https://www.php.net/manual/en/exception.construct.php)
and [What are the best practices for catching and re-throwing
exceptions?](https://stackoverflow.com/questions/5551668/what-are-the-best-practices-for-catching-and-re-throwing-exceptions/5551828).

### Suggestions

-   Add the incoming exception to the newly thrown exception

  ---------- -------------------------------------------------------------
  Short name Structures/ShouldChainException

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `magento-structures-shouldchainexception`{.interpreted-text
             role="ref"},
             `tine20-structures-shouldchainexception`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Should Deep Clone
-----------------

By default, PHP makes a shallow clone. It only clone the scalars, and
keep the reference to any object already referenced. This means that the
cloned object and its original share any object they hold as property.

This is where the magic method
[\_\_clone()](https://www.php.net/manual/en/language.oop5.magic.php)
comes into play. It is called, when defined, at clone time, so that the
cloned object may clone all the needed sub-objects.

It is recommended to use the
[\_\_clone()](https://www.php.net/manual/en/language.oop5.magic.php)
method whenever the objects hold objects.

``` {.php}
<?php

class a {
    public $b = null;

    function __construct() {
        $this->b =  new Stdclass();
        $this->b->c = 1;
    }
}

class ab extends a {
    function __clone() {
        $this->b = clone $this->b;
    }
}

// class A is shallow clone, so $a->b is not cloned
$a = new a();
$b = clone $a;
$a->b->c = 3;
echo $b->b->c;
// displays 3

// class Ab is deep clone, so $a->b is cloned
$a = new ab();
$b = clone $a;
$a->b->c = 3;
echo $b->b->c;
// displays 1

?>
```

See also [PHP Clone and Shallow vs Deep
Copying](http://jacob-walker.com/blog/php-clone-and-shallow-vs-deep-copying.html)
and [Cloning
objects](https://www.php.net/manual/en/language.oop5.cloning.php).

### Suggestions

-   

  ------------- ---------------------------------
  Short name    Classes/ShouldDeepClone

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Should Have Destructor
----------------------

PHP destructors are called when the object has to be destroyed. By
default, PHP calls recursively the destructor on internal objects, until
everything is unset.

Unsetting objects and resources explicitly in the destructor is a good
practice to reduce the amount of memory in use. It helps PHP resource
counter to keep the numbers low, and easier to clean. This is a major
advantage for long running scripts.

``` {.php}
<?php

class x {
    function __construct() {
        $this->p = new y();
    }

    function __destruct() {
        print __METHOD__.PHP_EOL;
        unset($this->p);
    }
}

class y {
    function __construct() {
        print __METHOD__.PHP_EOL;
        $this->p = new y();
    }

    function __destruct() {
        print __METHOD__.PHP_EOL;
        unset($this->p);
    }
}

$a = (new x);
sleep(1);

// This increment the resource counter by one for the property.
$p = $a->p;
unset($a);
sleep(3);

print 'end'.PHP_EOL;
// Y destructor is only called here, as the object still exists in $p.

?>
```

See also
[Destructor](https://www.php.net/manual/en/language.oop5.decon.php#language.oop5.decon.destructor),
and [Php
Destructors](https://stackoverflow.com/questions/3566155/php-destructors).

### Suggestions

-   Add a destruct method to the class to help clean at destruction
    time.

  ------------- ---------------------------------
  Short name    Classes/ShouldHaveDestructor

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- ---------------------------------

Should Make Alias
-----------------

Long names should be aliased.

Aliased names are easy to read at the beginning of the script; they may
be changed at one point, and update the whole code at the same time.
Finally, short names makes the rest of the code readable.

``` {.php}
<?php

namespace x\y\z;

use a\b\c\d\e\f\g as Object;

// long name, difficult to read, prone to change.
new a\b\c\d\e\f\g();

// long name, difficult to read, prone to silent dead code if namespace change.
if ($o instanceof a\b\c\d\e\f\g) {

}

// short names Easy to update all at once.
new Object();
if ($o instanceof Object) {

}

?>
```

  ------------- ----------------------------------
  Short name    Namespaces/ShouldMakeAlias

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Should Make Ternary
-------------------

Ternary operators are the best when assigning values to a variable.

This way, they are less verbose, compatible with assignation and easier
to read.

``` {.php}
<?php
    // verbose if then structure
    if ($a == 3) {
        $b = 2;
    } else {
        $b = 3;
    }

    // compact ternary call
    $b = ($a == 3) ? 2 : 3;

    // verbose if then structure
    // Works with short assignations and simple expressions
    if ($a != 3) {
        $b += 2 - $a * 4;
    } else {
        $b += 3;
    }

    // compact ternary call
    $b += ($a != 3) ? 2 - $a * 4 : 3;

?>
```

See also [Ternary
Operator](https://www.php.net/manual/en/language.operators.comparison.php#language.operators.comparison.ternary)
and [Shorthand comparisons in
PHP](https://stitcher.io/blog/shorthand-comparisons-in-php).

  ------------- ------------------------------------------------------------
  Short name    Structures/ShouldMakeTernary

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)

  Precision     High

  Examples      `churchcrm-structures-shouldmaketernary`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------------

Should Preprocess Chr() {#should-preprocess-chr()}
-----------------------

Replace literal [chr()](https://www.php.net/chr) calls with their escape
sequence.

[chr()](https://www.php.net/chr) is a functioncall, that cannot be
cached. It is only resolved at execution time. On the other hand,
literal values are preprocessed by PHP and may be cached.

``` {.php}
<?php

// This is easier on PHP
$a = "0000 is great!";

// This is slow
$a = chr(80), chr(72), chr(80), chr(32), ' is great!';

// This would be the best with this example, but it is not always possible
$a = 'PHP is great!';

?>
```

This is a micro-optimisation.

See also [Escape
sequences](https://www.php.net/manual/en/regexp.reference.escape.php).

### Suggestions

-   Use PHP string sequences, and skip chr() at execution time

  ------------ ----------------------------------------------------
  Short name   Php/ShouldPreprocess

  Rulesets     none

  Examples     `phpadsnew-php-shouldpreprocess`{.interpreted-text
               role="ref"}
  ------------ ----------------------------------------------------

Should Typecast
---------------

When typecasting, it is better to use the casting operator, such as
`(int)` or `(bool)`.

Functions such as [intval()](https://www.php.net/intval) or
[settype()](https://www.php.net/settype) are always slower.

``` {.php}
<?php

// Fast version
$int = (int) $X;

// Slow version
$int = intval($X);

// Convert to base 8 : can't use (int) for that
$int = intval($X, 8);


?>
```

This is a micro-optimisation, although such conversion may be use
multiple time, leading to a larger performance increase.

Note that [intval()](https://www.php.net/intval) may also be used to
convert an integer to another base.

### Suggestions

-   Use a typecast, instead of a functioncall.

  ----------- -----------------------------------------------------------
  Short name  Type/ShouldTypecast

  Rulesets    `Analyze`{.interpreted-text role="ref"},
              `CI-checks`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Quick (30 mins)

  Examples    `xataface-type-shouldtypecast`{.interpreted-text
              role="ref"},
              `openconf-type-shouldtypecast`{.interpreted-text
              role="ref"}
  ----------- -----------------------------------------------------------

Should Use Coalesce
-------------------

PHP 7 introduced the `??` operator, that replaces longer structures to
set default values when a variable is not set.

``` {.php}
<?php

// Fetches the request parameter user and results in 'nobody' if it doesn't exist
$username = $_GET['user'] ?? 'nobody';
// equivalent to: $username = isset($_GET['user']) ? $_GET['user'] : 'nobody';

// Calls a hypothetical model-getting function, and uses the provided default if it fails
$model = Model::get($id) ?? $default_model;
// equivalent to: if (($model = Model::get($id)) === NULL) { $model = $default_model; }

?>
```

Sample extracted from PHP docs [Isset
Ternary](https://wiki.php.net/rfc/isset_ternary).

See also [New in PHP 7: null coalesce
operator](https://lornajane.net/posts/2015/new-in-php-7-null-coalesce-operator).

### Suggestions

-   Replace the long syntax with the short one

  ---------- ------------------------------------------------------------
  Short name Php/ShouldUseCoalesce

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Suggestions`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and more recent
  Version    

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `churchcrm-php-shouldusecoalesce`{.interpreted-text
             role="ref"},
             `cleverstyle-php-shouldusecoalesce`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Should Use Constants
--------------------

The following functions have related constants that should be used as
arguments, instead of scalar literals, such as integers or strings.

``` {.php}
<?php

// The file is read and new lines are ignored.
$lines = file('file.txt', FILE_IGNORE_NEW_LINES)

// What is this doing, with 2 ? 
$lines = file('file.txt', 2);

?>
```

See also [Bitmask Constant Arguments in
PHP](https://medium.com/@liamhammett/bitmask-constant-arguments-in-php-cf32bf35c73).

### Suggestions

-   Use PHP native constants whenever possible, for better readability.

  ------------- ---------------------------------------------------------
  Short name    Functions/ShouldUseConstants

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `tine20-functions-shoulduseconstants`{.interpreted-text
                role="ref"}
  ------------- ---------------------------------------------------------

Should Use Explode Args
-----------------------

[explode()](https://www.php.net/explode) has a third argument, which
limits the amount of exploded elements. With it, it is possible to
collect only the first elements, or drop the last ones.

``` {.php}
<?php

$exploded = explode(DELIMITER, $string);

// use explode(DELIMITER, $string, -1);
array_pop($exploded);

// use explode(DELIMITER, $string, -2);
$c = array_slice($exploded, 0, -2);

// with explode()'s third argument : 
list($a, $b) = explode(DELIMITER, $string, 2);

// with list() omitted arguments
list($a, $b, ) = explode(DELIMITER, $string);

?>
```

See also [explode](https://www.php.net/manual/en/function.explode.php).

### Suggestions

-   

  ------------- ----------------------------------
  Short name    Structures/ShouldUseExplodeArgs

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Should Use Foreach
------------------

Use foreach instead of for when traversing an array.

[Foreach()](https://www.php.net/manual/en/control-structures.foreach.php)
is the modern loop : it maps automatically every element of the array to
a blind variable, and loop over it. This is faster and safer.

``` {.php}
<?php

// Foreach version
foreach($array as $element) {
    doSomething($element);
}

// The above case may even be upgraded with array_map and a callback, 
// for the simplest one of them
$array = array_map('doSomething', $array);

// For version (one of various alternatives)
for($i = 0; $i < count($array); $i++) {
    $element = $array[$i];
    doSomething($element);
}

// Based on array_pop or array_shift()
while($value = array_pop($array)) {
    doSomething($array);
}

?>
```

See also
[foreach](https://www.php.net/manual/en/control-structures.foreach.php)
and [5 Ways To Loop Through An Array In
PHP](https://www.codewall.co.uk/5-ways-to-loop-through-array-php/).

### Suggestions

-   Move for() loops to foreach(), whenever they apply to a finite list
    of elements

  ---------- ------------------------------------------------------------------
  Short name Structures/ShouldUseForeach

  Rulesets   `Suggestions`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `expressionengine-structures-shoulduseforeach`{.interpreted-text
             role="ref"},
             `woocommerce-structures-shoulduseforeach`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------------

Should Use Function
-------------------

Functioncalls that fall back to global scope should be using \'use
function\' or be fully namespaced.

PHP searches for functions in the local namespaces, and in case it
fails, makes the same search in the global scope. Anytime a native
function is referenced this way, the search (and fail) happens. This
slows down the scripts.

The speed bump range from 2 to 8 %, depending on the availability of
functions in the local scope. The overall bump is about 1 µs per
functioncall, which makes it a micro optimisation until a lot of
function calls are made.

Based on one of [Marco Pivetta
tweet](https://twitter.com/Ocramius/status/811504929357660160).

``` {.php}
<?php

namespace X {
    use function strtolower as strtolower_aliased;

    // PHP searches for strtolower in X, fails, then falls back to global scope, succeeds.
    $a = strtolower($b);

    // PHP searches for strtolower in global scope, succeeds.
    $a = \strtolower($b);

    // PHP searches for strtolower_aliased in global scope, succeeds.
    $a = \strtolower_aliased($b);
}

?>
```

This analysis is a related to Performances/Php74ArrayKeyExists, and is a
more general version.

See also [blog
post](http://veewee.github.io/blog/optimizing-php-performance-by-fq-function-calls/).

### Suggestions

-   Use the [use]{.title-ref} command for arrray\_key\_exists(), at the
    beginning of the script
-   Use an initial before array\_key\_exists()
-   Remove the namespace

  ------------- ----------------------------------
  Short name    Php/ShouldUseFunction

  Rulesets      `Performances`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------

Should Use Local Class
----------------------

Methods should use the defining class, or be functions.

Methods should use `$this` with another method or a property, or call
`parent\:\:`.
[Static](https://www.php.net/manual/en/language.oop5.static.php) methods
should call another
[static](https://www.php.net/manual/en/language.oop5.static.php) method,
or a [static](https://www.php.net/manual/en/language.oop5.static.php)
property. Methods which are overwritten by a child class are omitted :
the
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
class act as a default value for the children class, and this is
correct.

``` {.php}
<?php

class foo {
    public function __construct() {
        // This method should do something locally, or be removed.
    }
}

class bar extends foo {
    private $a = 1;

    public function __construct() {
        // Calling parent:: is sufficient
        parent::__construct();
    }

    public function barbar() {
        // This is acting on the local object
        $this->a++;
    }

    public function barfoo($b) {
        // This has no action on the local object. It could be a function or a closure where needed
        return 3 + $b;
    }
}

?>
```

Note that a method using a class constant is not considered as using the
local class, for this analyzer.

### Suggestions

-   Make this method a function
-   Actually use \$this, or any related attributes of the class

  ---------- --------------------------------------------------------------------------------------
  Short name Classes/ShouldUseThis

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  ClearPHP   [not-a-method](https://github.com/dseguy/clearPHP/tree/master/rules/not-a-method.md)
  ---------- --------------------------------------------------------------------------------------

Should Use Math
---------------

Use math operators to make the operation readable.

``` {.php}
<?php

// Adding one to self
$a *= 2;
// same as above
$a += $a;

// Squaring oneself
$a \*\*\= 2;
// same as above
$a *= $a;

// Removing oneself
$a = 0;
// same as above
$a -= $a;

// Dividing oneself
$a = 1;
// same as above
$a /= $a;

// Divisition remainer
$a = 0;
// same as above
$a %= $a;

?>
```

See also [Mathematical
Functions](https://www.php.net/manual/en/book.math.php).

### Suggestions

-   Use explicit math assignation

  ------------- ------------------------------------------------------
  Short name    Structures/ShouldUseMath

  Rulesets      `Suggestions`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)

  Examples      `openemr-structures-shouldusemath`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------

Should Use Operator
-------------------

Some functions duplicate the feature of an operator. When in doubt, it
is better to use the operator.

Beware, some edge cases may apply. In particular, backward compatibility
may prevent usage of newer features.

-   [array\_push()](https://www.php.net/array_push) is equivalent to
    \[\]
-   [is\_object()](https://www.php.net/is_object) is equivalent to
    [instanceof](https://www.php.net/manual/en/language.operators.type.php)
-   function\_get\_arg() and function\_get\_args() is equivalent to
    ellipsis :
    [\...](https://www.php.net/manual/en/functions.arguments.php#functions.variable-arg-list)
-   [chr()](https://www.php.net/chr) is equivalent to string escape
    sequences, such as `\n`, `\x69`, `u{04699}`
-   [call\_user\_func()](https://www.php.net/call_user_func) is
    equivalent to `$functionName(arguments)`,
    `` $object->$method(`... <https://www.php.net/manual/en/functions.arguments.php#functions.variable-arg-list>`_$arguments) ``
-   [is\_null()](https://www.php.net/is_null) is equivalent to
    `=== null`
-   php\_version() is equivalent to `PHP_VERSION` (the constant)
-   [is\_array()](https://www.php.net/is_array),
    [is\_int()](https://www.php.net/is_int),
    [is\_object()](https://www.php.net/is_object), etc. is equivalent to
    a scalar typehint

### Suggestions

-   Use \[\] instead of array\_push()
-   Use instanceof instead of is\_object()
-   Use \... instead of function\_get\_arg() and function\_get\_args()
-   Use escape sequences instead of chr()
-   Use dynamic function call instead of call\_user\_func()
-   Use === null instead of is\_null()
-   Use PHP\_VERSION instead of php\_version()
-   Use typehint instead of is\_int(), is\_string(), is\_bool(), etc.

  ---------- -------------------------------------------------------------
  Short name Structures/ShouldUseOperator

  Rulesets   `Suggestions`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `zencart-structures-shoulduseoperator`{.interpreted-text
             role="ref"},
             `sugarcrm-structures-shoulduseoperator`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Should Use Prepared Statement
-----------------------------

Modern databases provides support for prepared statement : it separates
the query from the processed data and raise significantly the security.

Building queries with concatenations is not recommended, though not
always avoidable. When possible, use prepared statements.

``` {.php}
<?php
/* Execute a prepared statement by passing an array of values */

$sql = 'SELECT name, colour, calories
    FROM fruit
    WHERE calories < :calories AND colour = :colour';
$sth = $conn->prepare($sql, array(PDO::ATTR_CURSOR => PDO::CURSOR_FWDONLY));
$sth->execute(array(':calories' => 150, ':colour' => 'red'));
$red = $sth->fetchAll();
?>
```

Same code, without preparation :

``` {.php}
<?php

    $sql = 'SELECT name, color, calories FROM fruit WHERE calories < '.$conn-quote(150).' AND colour = '.$conn->quotes('red').' ORDER BY name';
    $sth = $conn->query($sql) as $row);
}
?>
```

See also [Prepared
Statements](https://www.php.net/manual/en/mysqli.quickstart.prepared-statements.php),
[PHP MySQLi Prepared Statements Tutorial to Prevent SQL
Injection](https://websitebeaver.com/prepared-statements-in-php-mysqli-to-prevent-sql-injection),
[The Best Way to Perform MYSQLI Prepared Statements in
PHP](https://developer.hyvor.com/php/prepared-statements).

### Suggestions

-   Use an ORM
-   Use an Active Record library
-   Change the query to hard code it and make it not injectable

  ------------- --------------------- ------ ----------------------------
  Name          Default               Type   Description

  queryMethod   query\_methods.json   data   Methods that call a query.
  ------------- --------------------- ------ ----------------------------

  ------------- ------------------------------------------------------------------
  Short name    Security/ShouldUsePreparedStatement

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `Security`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)

  Examples      `dolibarr-security-shouldusepreparedstatement`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------------------

Should Use SetCookie() {#should-use-setcookie()}
----------------------

Use [setcookie()](https://www.php.net/setcookie) or
[setrawcookie()](https://www.php.net/setrawcookie). Avoid using
[header()](https://www.php.net/header) to do so, as the PHP native
functions are more convenient and easier to spot during a refactoring.

[setcookie()](https://www.php.net/setcookie) applies some encoding
internally, for the value of the cookie and the date of expiration.
Rarely, this encoding has to be skipped : then, use setrawencoding().

Both functions help by giving a checklist of important attributes to be
used with the cookie.

``` {.php}
<?php

// same as below
setcookie(myCookie, 'chocolate', time()+3600, /, , true, true);

// same as above. Slots for path and domain are omitted, but should be used whenever possible
header('Set-Cookie: myCookie=chocolate; Expires='.date('r', (time()+3600)).'; Secure; HttpOnly');

?>
```

See also
[Set-Cookie](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie),
[setcookie](http://www.php.net/setcookie).

### Suggestions

-   Use setcookie() function, instead of header()
-   Use setcookie() function, instead of header()

  ------------- -----------------------------
  Short name    Php/UseSetCookie

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)
  ------------- -----------------------------

Should Use array\_column() {#should-use-array\\_column()}
--------------------------

Avoid writing a whole slow loop, and use the native
[array\_column()](https://www.php.net/array_column).

[array\_column()](https://www.php.net/array_column) is a native PHP
function, that extract a property or a index from a array of object, or
a multidimensional array. This prevents the usage of foreach to collect
those values.

``` {.php}
<?php

$a = array(array('b' => 1), 
           array('b' => 2, 'c' => 3), 
           array(          'c' => 4)); // b doesn't always exists

$bColumn = array_column($a, 'b');

// Slow and cumbersome code
$bColumn = array();
foreach($a as $k => $v) {
    if (isset($v['b'])) {
        $bColumn[] = $v['b'];
    }
}

?>
```

[array\_column()](https://www.php.net/array_column) is faster than
[foreach()](https://www.php.net/manual/en/control-structures.foreach.php)
(with or without the [isset()](https://www.www.php.net/isset) test) with
3 elements or more, and it is significantly faster beyond 5 elements.
Memory consumption is the same.

See also [\[blog\] \`array\_column()
\<https://www.php.net/array\_column\>]{.title-ref}\_
\<<https://benramsey.com/projects/array-column/>\>\`\_.

### Suggestions

-   Use array\_column(), instead of a foreach()

  ------------- -----------------------------------------
  Short name    Php/ShouldUseArrayColumn

  Rulesets      `Performances`{.interpreted-text
                role="ref"},
                `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------------------

Should Use array\_filter() {#should-use-array\\_filter()}
--------------------------

Should use [array\_filter()](https://www.php.net/array_filter).

[array\_filter()](https://www.php.net/array_filter) is a native PHP
function, that extract elements from an array, based on a closure or a
function. Using [array\_filter()](https://www.php.net/array_filter)
shortens your code, and allows for reusing the filtering logic across
the application, instead of hard coding it every time.

``` {.php}
<?php

$a = range(0, 10); // integers from 0 to 10

// Extracts odd numbers
$odds = array_filter($a, function($x) { return $x % 2; });
$odds = array_filter($a, 'odd');

// Slow and cumbersome code for extracting odd numbers
$odds = array();
foreach($a as $v) {
    if ($a % 2) { // same filter than the closure above, or the odd function below
        $bColumn[] = $v;
    }
}

function foo($x) {
    return $x % 2; 
}

?>
```

[array\_filter()](https://www.php.net/array_filter) is faster than
[foreach()](https://www.php.net/manual/en/control-structures.foreach.php)
(with or without the [isset()](https://www.www.php.net/isset) test) with
3 elements or more, and it is significantly faster beyond 5 elements.
Memory consumption is the same.

See also [array\_filter](https://php.net/array_filter).

### Suggestions

-   Use array\_filter()

  ---------- ------------------------------------------------------------
  Short name Php/ShouldUseArrayFilter

  Rulesets   `Suggestions`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  Examples   `xataface-php-shouldusearrayfilter`{.interpreted-text
             role="ref"},
             `shopware-php-shouldusearrayfilter`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Should Use session\_regenerateid() {#should-use-session\\_regenerateid()}
----------------------------------

session\_regenerateid() should be used when sessions are used.

When using sessions, a session ID is assigned to the user. It is a
random number, used to connect the user and its data on the server.
Actually, anyone with the session ID may have access to the data. This
is why those session ID are so long and complex.

A good approach to protect the session ID is to reduce its lifespan :
the shorter the time of use, the better. While changing the session ID
at every hit on the page may no be possible, a more reasonable approach
is to change the session id when an important action is about to take
place. What important means is left to the application to decide.

Based on this philosophy, a code source that uses ZendSession but never
uses ZendSession::regenerateId() has to be updated.

``` {.php}
<?php

    session_start();

    $id = (int) $_SESSION['id'];
    // no usage of session_regenerateid() anywhere triggers the analysis

    // basic regeneration every 20 hits on the page. 
    if (++$_SESSION['count'] > 20) {
        session_regenerateid();
    }

?>
```

See [session\_regenerateid()](https://www.php.net/session_regenerate_id)
and [PHP Security Guide:
Sessions](http://phpsec.org/projects/guide/4.html).

### Suggestions

-   Add session\_regenerateid() call before any important operation on
    the application

  ------------- ---------------------------------------
  Short name    Security/ShouldUseSessionRegenerateId

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ---------------------------------------

Should Yield With Key
---------------------

[iterator\_to\_array()](https://www.php.net/iterator_to_array) will
overwrite generated values with the same key.

PHP generators are based on the `yield` keyword. They also delegate some
generating to other methods, with `yield from`.

When delegating, `yield from` uses the keys that are generated with
`yield`, and otherwise, it uses auto-generated index, starting with 0.

The trap is that each `yield from` reset the index generation and start
again with 0. Coupled with
[iterator\_to\_array()](https://www.php.net/iterator_to_array), this
means that the final generated array may lack some values, while a
[foreach()](https://www.php.net/manual/en/control-structures.foreach.php)
loop would yield all of them.

``` {.php}
<?php 

function g1() : Generator {
 for ( $i = 0; $i < 4; $i++ ) { yield $i; }
}

function g2() : Generator {
 for ( $i = 5; $i < 10; $i++ ) { yield $i; }
}

function aggregator() : Generator {
 yield from g1();
 yield from g2();
}

print_r(iterator_to_array());

/*
Array
(
    [0] => 6
    [1] => 7
    [2] => 8
    [3] => 9
    [4] => 4  // Note that 4 and 5 still appears
    [5] => 5  // They are not overwritten by the second yield
)
*/


foreach ( aggregator() as $i ) {
 print $i.PHP_EOL;
}

/*
0  // Foreach has no overlap and yield it all.
1
2
3
4
5
6
7
8
9
*/

?>
```

Thanks to [Holger Woltersdorf](https://twitter.com/hollodotme) for
[pointing
this](https://twitter.com/hollodotme/status/1057909890566537217).

See also [Generator
syntax](https://www.php.net/manual/en/language.generators.syntax.php)
and [Yielding values with
keys](https://www.php.net/manual/en/language.generators.syntax.php#control-structures.yield.associative).

### Suggestions

-   Use iterator\_to\_array() on each generator separately, and use
    array\_merge() to merge all the arrays.
-   Always yield with distinct keys
-   Avoid iterator\_to\_array() and use foreach()

  ------------- ------------------------------------------------
  Short name    Functions/ShouldYieldWithKey

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `Top10`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ------------------------------------------------

Signature Trailing Comma
------------------------

Trailing comma in method signature. This feature was added in PHP 8.0.

Allowing the trailing comma makes it possible to reduce the size of
VCS\'s diff, when adding , removing a parameter.

``` {.php}
<?php

// Example from the RFC
class Uri {
    private function __construct(
        ?string $scheme,
        ?string $user,
        ?string $pass,
        ?string $host,
        ?int $port,
        string $path,
        ?string $query,
        ?string $fragment // <-- ARGH!
    ) {
        ...
    }
}
?>
```

See also [PHP RFC: Allow trailing comma in parameter
list](https://wiki.php.net/rfc/trailing_comma_in_parameter_list).

### Suggestions

-   

  ---------- --------------------------------------------------------------
  Short name Php/SignatureTrailingComma

  Rulesets   `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"},
             `CompatibilityPHP73`{.interpreted-text role="ref"},
             `CompatibilityPHP74`{.interpreted-text role="ref"}

  Php        8.0+
  Version    

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        
  ---------- --------------------------------------------------------------

Silently Cast Integer
---------------------

Those are integer literals that are cast to a float when running PHP.
They are too big for the current PHP version, and PHP resorts to cast
them into a float, which has a much larger capacity but a lower
precision.

Compare your literals to `PHP_MAX_INT` (typically `9223372036854775807`)
and `PHP_MIN_INT` (typically `-9223372036854775808`). This applies to
binary (`0b10101`\...), octal (`0123123`\...) and hexadecimal
(`0xfffff`\...) too.

``` {.php}
<?php

echo 0b1010101101010110101011010101011010101011010101011010101011010111;
//6173123008118052203
echo 0b10101011010101101010110101010110101010110101010110101010110101111;
//1.2346246016236E+19

echo 0123123123123123123123;
//1498121094048818771
echo 01231231231231231231231;
//1.1984968752391E+19

echo 0x12309812311230;
//5119979279159856
echo 0x12309812311230fed;
//2.0971435127439E+19

echo 9223372036854775807; //PHP_MAX_INT
//9223372036854775807
echo 9223372036854775808;
9.2233720368548E+18

?>
```

See also [Integer
overflow](https://www.php.net/manual/en/language.types.integer.php#language.types.integer.overflow).

### Suggestions

-   Make sure hexadecimal numbers have the right number of digits :
    generally, it is 15, but it may depends on your PHP version.

  ------------- --------------------------------------------------------
  Short name    Type/SilentlyCastInteger

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `mediawiki-type-silentlycastinteger`{.interpreted-text
                role="ref"}
  ------------- --------------------------------------------------------

Similar Integers
----------------

This analysis reports all integer values that are expressed in different
format.

``` {.php}
<?php

// Three ways to write 10 (more available)
$a = 10;
$b = 012;
$x = 0xA;

// 7 is expressed in one way only
$d = 7;
$d = 7;

// Four ways to write 11 (more available)
$a = 11;
$b = 013;
$x = 0xB;
$x = -+-11;

// Expressions are not counted

?>
```

### Suggestions

-   

  ------------ -------------------------------------------------------------
  Short name   Type/SimilarIntegers

  Rulesets     `Coding Conventions <coding-conventions>`{.interpreted-text
               role="ref"}, `Semantics`{.interpreted-text role="ref"}

  Severity     Minor

  Time To Fix  Quick (30 mins)
  ------------ -------------------------------------------------------------

Simple Global Variable
----------------------

The global keyword should only be used with simple variables. Since PHP
7, it cannot be used with complex or dynamic structures.

``` {.php}
<?php

// Forbidden in PHP 7
global $normalGlobal;

// Forbidden in PHP 7
global $$variable->global ;

// Tolerated in PHP 7
global ${$variable->global};

?>
```

### Suggestions

-   Add curly braces so the syntax is compatibles PHP 5 and PHP 7
-   Remove this syntax, and access the variable through another way :
    argument, array, property.

  ------------- ----------------------------------------
  Short name    Php/GlobalWithoutSimpleVariable

  Rulesets      `CompatibilityPHP70`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.0 and older

  Severity      Critical

  Time To Fix   Slow (1 hour)

  Precision     Very high
  ------------- ----------------------------------------

Simple Switch
-------------

Switches are faster when relying only on integers or strings.

Since PHP 7.2, simple switches that use only strings or integers are
optimized. The gain is as great as the switch is big.

``` {.php}
<?php

// Optimized switch. 
switch($b) {
    case "a":
        break;
    case "b":
        break;
    case "c":
        break;
    case "d":
        break;
    default :
        break;
}

// Unoptimized switch. 
// Try moving the foo() call in the default, to keep the rest of the switch optimized.
switch($c) {
    case "a":
        break;
    case foo($b):
        break;
    case "c":
        break;
    case "d":
        break;
    default :
        break;
}

?>
```

See also [PHP 7.2\'s \"switch\"
optimisations](https://derickrethans.nl/php7.2-switch.html).

### Suggestions

-   Split the switch between literal and dynamic cases
-   Remove the dynamic cases from the switch

  ------------- ----------------------------------
  Short name    Performances/SimpleSwitch

  Rulesets      `Performances`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.2 and more recent

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Simplify Regex
--------------

Avoid using regex when the searched string or the replacement are simple
enough.

PRCE regex are a powerful way to search inside strings, but they also
come at the price of performance. When the query is simple enough, try
using [strpos()](https://www.php.net/strpos) or
[stripos()](https://www.php.net/stripos) instead.

``` {.php}
<?php

// simple preg calls
if (preg_match('/a/', $string))  {}
if (preg_match('/b/i', $string)) {} // case insensitive

// light replacements
if( strpos('a', $string)) {}
if( stripos('b', $string)) {}       // case insensitive

?>
```

### Suggestions

-   Use str\_replace(), strtr() or even strpos()

  ----------- -----------------------------------------------------------
  Short name  Structures/SimplePreg

  Rulesets    `Performances`{.interpreted-text role="ref"}

  Severity    Major

  Time To Fix Quick (30 mins)

  Examples    `zurmo-structures-simplepreg`{.interpreted-text
              role="ref"},
              `openconf-structures-simplepreg`{.interpreted-text
              role="ref"}
  ----------- -----------------------------------------------------------

Slice Arrays First
------------------

Always start by reducing an array before applying some transformation on
it. The shorter array will be processed faster.

``` {.php}
<?php

// fast version
$a = array_map('foo', array_slice($array, 2, 5));

// slower version
$a = array_slice(array_map('foo', $array), 2, 5);
?>
```

The gain produced here is greater with longer arrays, or greater
reductions. They may also be used in loops. This is a micro-optimisation
when used on short arrays.

### Suggestions

-   Use the array transforming function on the result of the array
    shortening function.

  ------------- -------------------------------------------------
  Short name    Arrays/SliceFirst

  Rulesets      `Performances`{.interpreted-text role="ref"},
                `Suggestions`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `wordpress-arrays-slicefirst`{.interpreted-text
                role="ref"}
  ------------- -------------------------------------------------

Slow Functions
--------------

Avoid using those slow native PHP functions, and replace them with
alternatives.

``` {.php}
<?php

$array = source();

// Slow extraction of distinct values
$array = array_unique($array);

// Much faster extraction of distinct values
$array = array_keys(array_count_values($array));

?>
```

+-----------------------+----------------------------------------------+
| Slow Function         | > Faster                                     |
+-----------------------+----------------------------------------------+
| [arra                 | > [foreach()](https://www.php.n              |
| y\_diff()](https://ww | et/manual/en/control-structures.foreach.php) |
| w.php.net/array_diff) | > [foreach()](https://www.php.n              |
| [array\_interse       | et/manual/en/control-structures.foreach.php) |
| ct()](https://www.php | > [isset()](https://www.www.php.net/isset)   |
| .net/array_intersect) | > and                                        |
| [array\_key\_exist    | > [array\_key\_exi                           |
| s()](https://www.php. | sts()](https://www.php.net/array_key_exists) |
| net/array_key_exists) | > [foreach()](https://www.php.n              |
| [ar                   | et/manual/en/control-structures.foreach.php) |
| ray\_map()](https://w | > [ar                                        |
| ww.php.net/array_map) | ray\_flip()](https://www.php.net/array_flip) |
| [array\_s             | > and                                        |
| earch()](https://www. | > [isset()](https://www.www.php.net/isset)   |
| php.net/array_search) | > Use another way Use another way Use        |
| [array\               | > another way                                |
| _udiff()](https://www | > [foreach()](https://www.php.n              |
| .php.net/array_udiff) | et/manual/en/control-structures.foreach.php) |
| [array\_uintersec     | > [isset()](https://www.www.php.net/isset)   |
| t()](https://www.php. | > [strpos()](https://www.php.net/strpos)     |
| net/array_uintersect) | > [strpos()](https://www.php.net/strpos) Use |
| [array\_uns           | > another way Use another way Use another    |
| hift()](https://www.p | > way                                        |
| hp.net/array_unshift) | > [ar                                        |
| [arra                 | ray\_keys()](https://www.php.net/array_keys) |
| y\_walk()](https://ww | > and                                        |
| w.php.net/array_walk) | > [array\_count\_value                       |
| [                     | s()](https://www.php.net/array_count_values) |
| in\_array()](https:// |                                              |
| www.php.net/in_array) |                                              |
| [preg\_re             |                                              |
| place()](https://www. |                                              |
| php.net/preg_replace) |                                              |
| [strstr()](https:     |                                              |
| //www.php.net/strstr) |                                              |
| [uasort()](https:     |                                              |
| //www.php.net/uasort) |                                              |
| [uksort()](https:     |                                              |
| //www.php.net/uksort) |                                              |
| [usort()](https       |                                              |
| ://www.php.net/usort) |                                              |
| [array\_u             |                                              |
| nique()](https://www. |                                              |
| php.net/array_unique) |                                              |
+-----------------------+----------------------------------------------+

[array\_unique()](https://www.php.net/array_unique) has been accelerated
in PHP 7.2 and may be used directly from this version on : [Optimize
\`array\_unique() \<https://www.php.net/array\_unique\>]{.title-ref}\_
\<<https://github.com/php/php-src/commit/6c2c7a023da4223e41fea0225c51a417fc8eb10d>\>\`\_.

[array\_key\_exists()](https://www.php.net/array_key_exists) has been
accelerated in PHP 7.4 and may be used directly from this version on :
[Implement ZEND\_ARRAY\_KEY\_EXISTS opcode to speed up
\`array\_key\_exists()
\<https://www.php.net/array\_key\_exists\>]{.title-ref}\_
\<<https://github.com/php/php-src/pull/3360>\>\`\_.

### Suggestions

-   Replace the slow function with a faster version
-   Remove the usage of the slow function

  ---------- ------------------------------------------------------------------------------------------------------------------
  Short name Performances/SlowFunctions

  Rulesets   `Performances`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [avoid-those-slow-functions](https://github.com/dseguy/clearPHP/tree/master/rules/avoid-those-slow-functions.md)

  Examples   `churchcrm-performances-slowfunctions`{.interpreted-text role="ref"},
             `suitecrm-performances-slowfunctions`{.interpreted-text role="ref"}
  ---------- ------------------------------------------------------------------------------------------------------------------

Sqlite3 Requires Single Quotes
------------------------------

The escapeString() method from `SQLite3` doesn\'t escape `"`, but only
`'`.

``` {.php}
<?php

// OK. escapeString is OK with '
$query = "SELECT * FROM table WHERE col = '".$sqlite->escapeString($x)."'";

// This is vulnerable to " in $x
$query = 'SELECT * FROM table WHERE col = "'.$sqlite->escapeString($x).'"';

?>
```

To properly handle quotes and `NUL` characters, use bindParam() instead.

Quote from the PHP manual comments :
`The reason this function doesn't escape double quotes is because double quotes are used with names (the equivalent of backticks in MySQL), as in table or column names, while single quotes are used for values.`

See also
[SQLite3::escapeString](https://www.php.net/manual/en/sqlite3.escapestring.php).

### Suggestions

-   Use prepared statements whenever possible
-   Switch the query to use single quote

  ------------- --------------------------------------
  Short name    Security/Sqlite3RequiresSingleQuotes

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- --------------------------------------

Static Global Variables Confusion
---------------------------------

PHP can\'t have variable that are both
[static](https://www.php.net/manual/en/language.oop5.static.php) and
variable. While the syntax is legit, the variables will be alternatively
global or
[static](https://www.php.net/manual/en/language.oop5.static.php).

It is recommended to avoid using the same name for a global variable and
a [static](https://www.php.net/manual/en/language.oop5.static.php)
variable.

``` {.php}
<?php

function foo() {
    $a = 1; // $a is a local variable

    global $a; // $a is now a global variable

    static $a; // $a is not w static variable 
}

?>
```

### Suggestions

-   Avoid using static variables
-   Avoid using global variables
-   Avoid using the same name for static and global variables

  ------------- ---------------------------------
  Short name    Structures/SGVariablesConfusion

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Static Loop
-----------

[Static](https://www.php.net/manual/en/language.oop5.static.php) loop
may be preprocessed.

It looks like the following loops are
[static](https://www.php.net/manual/en/language.oop5.static.php) : the
same code is executed each time, without taking into account loop
variables.

``` {.php}
<?php

// Static loop
$total = 0;
for($i = 0; $i < 10; $i++) {
    $total += $i;
}

// The above loop may be replaced by (with some math help)
$total = 10 * (10  + 1) / 2;

// Non-Static loop (the loop depends on the size of the array)
$n = count($array);
for($i = 0; $i < $n; $i++) {
    $total += $i;
}

?>
```

It is possible to create loops that don\'t use any blind variables,
though this is fairly rare. In particular, calling a method may update
an internal pointer, like [next()](https://www.php.net/next) or
`` SimpleXMLIterator\:\:`next() <https://www.php.net/next>`_ ``.

It is recommended to turn a
[static](https://www.php.net/manual/en/language.oop5.static.php) loop
into an expression that avoid the loop. For example, replacing the sum
of all integers by the `function $n * ($n + 1) / 2`, or using
[array\_sum()](https://www.php.net/array_sum).

This analysis doesn\'t detect usage of variables with `compact`.

### Suggestions

-   Precalculate the result of that loop and removes it altogether
-   Check that the loop is not missing a blind variable usage
-   Replace the usage of a loop with a native PHP call : for example,
    with str\_repeat(). Although the loop is still here, it usually
    reflects better the intend.

  ------------- -----------------------------
  Short name    Structures/StaticLoop

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- -----------------------------

Static Methods Called From Object
---------------------------------

[Static](https://www.php.net/manual/en/language.oop5.static.php) methods
may be called without instantiating an object. As such, they never
interact with the special variable
\'[\$this](https://www.php.net/manual/en/language.oop5.basic.php)\', as
they do not depend on object existence.

Besides this,
[static](https://www.php.net/manual/en/language.oop5.static.php) methods
are normal methods that may be called directly from object context, to
perform some utility task.

To maintain code readability, it is recommended to call
[static](https://www.php.net/manual/en/language.oop5.static.php) method
in a [static](https://www.php.net/manual/en/language.oop5.static.php)
way, rather than within object context.

``` {.php}
<?php
    class x {
        static function y( ) {}
    }

    $z = new x( );

    $z->y( ); // Readability : no one knows it is a static call
    x::y( );  // Readability : here we know
?>
```

  ------------- ---------------------------------------
  Short name    Classes/StaticMethodsCalledFromObject

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------------

Static Methods Can\'t Contain \$this {#static-methods-can't-contain-$this}
------------------------------------

[Static](https://www.php.net/manual/en/language.oop5.static.php) methods
are also called `class methods` : they may be called even if the class
has no instantiated object. Thus, the local variable `$this` won\'t
exist, PHP will set it to
[NULL](https://www.php.net/manual/en/language.types.null.php) as usual.

``` {.php}
<?php

class foo {
    // Static method may access other static methods, or property, or none. 
    static function staticBar() {
        // This is not possible in a static method
        return self::otherStaticBar() . static::$staticProperty;
    }

    static function bar() {
        // This is not possible in a static method
        return $this->property;
    }
}

?>
```

Either this is not a
[static](https://www.php.net/manual/en/language.oop5.static.php) method,
which is fixed by removing the `static` keyword, or replace all
[\$this](https://www.php.net/manual/en/language.oop5.basic.php) mention
by [static](https://www.php.net/manual/en/language.oop5.static.php)
properties `Class\:\:$property`.

See also [Static
Keyword](https://www.php.net/manual/en/language.oop5.%60static%20%3Chttps://www.php.net/manual/en/language.oop5.static.php).php\>\`\_

### Suggestions

-   Remove any \$this usage
-   Turn any \$this usage into a static call : \$this-\>foo() =\>
    self::foo()

  ---------- ------------------------------------------------------------------------------------------
  Short name Classes/StaticContainsThis

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-static-this](https://github.com/dseguy/clearPHP/tree/master/rules/no-static-this.md)

  Examples   `xataface-classes-staticcontainsthis`{.interpreted-text role="ref"},
             `sugarcrm-classes-staticcontainsthis`{.interpreted-text role="ref"}
  ---------- ------------------------------------------------------------------------------------------

Strange Name For Constants
--------------------------

Those constants looks like a typo from other names.

``` {.php}
<?php

// This code looks OK : DIRECTORY_SEPARATOR is a native PHP constant
$path = $path . DIRECTORY_SEPARATOR . $file;

// Strange name DIRECOTRY_SEPARATOR
$path = $path . DIRECOTRY_SEPARATOR . $file;

?>
```

### Suggestions

-   Fix any typo in the spelling of the constants
-   Tell us about common misspelling so we can upgrade this analysis

  ------------- --------------------------------
  Short name    Constants/StrangeName

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- --------------------------------

Strange Name For Variables
--------------------------

Variables with strange names. They might be a typo, or bear strange
patterns.

Any variable with three identical letter in a row are considered as
strange. 2 letters in a row is classic, and while three letters may
happen, it is rare enough.

A list of classic typo is also used to find such variables.

This analysis is case-sensitive.

``` {.php}
<?php

class foo {
    function bar() {
        // Strange name $tihs
        return $tihs;
    }

    function barbar() {
        // variables with blocks of 3 times the same character are reported
        // Based on Alexandre Joly's tweet
        $aaa = $bab + $www; 
    }
}

?>
```

See also
[\#QuandLeDevALaFleme](https://twitter.com/bsmt_nevers/status/949238391769653249).

### Suggestions

-   Fix the name of the variable
-   Rename the variable to something better
-   Drop the variable

  ----------- ------------------------------------------------------------
  Short name  Variables/StrangeName

  Rulesets    none

  Severity    Minor

  Time To Fix Slow (1 hour)

  Precision   High

  Examples    `fuelcms-variables-strangename`{.interpreted-text
              role="ref"},
              `phpipam-variables-strangename`{.interpreted-text
              role="ref"}
  ----------- ------------------------------------------------------------

Strict Comparison With Booleans
-------------------------------

Strict comparisons prevent from mistaking an error with a false.

Boolean values may be easily mistaken with other values, especially when
the function may return integer or boolean as a normal course of action.

It is encouraged to use strict comparison === or !== when booleans are
involved in a comparison.

``` {.php}
<?php

// distinguish between : $b isn't in $a, and, $b is at the beginning of $a 
if (strpos($a, $b) === 0) {
    doSomething();
}

// DOES NOT distinguish between : $b isn't in $a, and, $b is at the beginning of $a 
if (strpos($a, $b)) {
    doSomething();
}

// will NOT mistake 1 and true
$a = array(0, 1, 2, true);
if (in_array($a, true, true)) {
    doSomething();
}

// will mistake 1 and true
$a = array(0, 1, 2, true);
if (in_array($a, true)) {
    doSomething();
}

?>
```

[switch()](https://www.php.net/manual/en/control-structures.switch.php)
structures always uses == comparisons.

Native function [in\_array()](https://www.php.net/in_array) has a third
parameter to make it use strict comparisons.

### Suggestions

-   Use strict comparison whenever possible

  ---------- --------------------------------------------------------------
  Short name Structures/BooleanStrictComparison

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Suggestions`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `phinx-structures-booleanstrictcomparison`{.interpreted-text
             role="ref"},
             `typo3-structures-booleanstrictcomparison`{.interpreted-text
             role="ref"}
  ---------- --------------------------------------------------------------

String Initialization
---------------------

It used to be possible to initialize a variable with an string, and use
it as an array. It is not the case anymore in PHP 7.1.

``` {.php}
<?php

// Initialize arrays with array()
$a = array();
$a[3] = 4;

// Don't start with a string
$a = '';
$a[3] = 4;
print $a;

// Don't start with a string
if (is_numeric($a)) {
    $a[] = $a;
}

?>
```

See also [PHP 7.1 no longer converts string to arrays the first time a
value is assigned with square bracket
notation](https://www.drupal.org/project/adaptivetheme/issues/2832900).

### Suggestions

-   Always initialize arrays with an empty array(), not a string.

  ------------- ----------------------------------------
  Short name    Arrays/StringInitialization

  Rulesets      `CompatibilityPHP71`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

String May Hold A Variable
--------------------------

Those strings looks like holding a variable.

Single quotes and Nowdoc syntax may include \$ signs that are treated as
literals, and not replaced with a variable value.

However, there are some potential variables in those strings, making it
possible for an error : the variable was forgotten and will be published
as such. It is worth checking the content and make sure those strings
are not variables.

``` {.php}
<?php

$a = 2;

// Explicit variable, but literal effect is needed
echo '$a is '.$a;

// One of the variable has been forgotten
echo '$a is $a';

// $CAD is not a variable, rather a currency unit
$total = 12;
echo $total.' $CAD';

// $CAD is not a variable, rather a currency unit
$total = 12;

// Here, $total has been forgotten
echo <<<'TEXT'
$total $CAD
TEXT;

?>
```

  ------------- -----------------------------
  Short name    Type/StringHoldAVariable

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- -----------------------------

Strings With Strange Space
--------------------------

An invisible space may be mistaken for a normal space.

However, PHP does straight comparisons, and may fail at recognizing.
This analysis reports when it finds such strange spaces inside strings.

PHP doesn\'t mistake space and tables for whitespace when tokenizing the
code.

This analysis doesn\'t report Unicode Codepoint Notation : those are
visible in the code.

``` {.php}
<?php

// PHP 7 notation, 
$a = \u{3000};
$b = ;

// Displays false
var_dump($a === $b);

?>
```

See also [Unicode
spaces](https://www.cs.tut.fi/~jkorpela/chars/spaces.html), and
[disallow irregular whitespace
(no-irregular-whitespace)](http://eslint.org/docs/rules/no-irregular-whitespace).

### Suggestions

-   Replace the odd spaces with a normal space
-   If unsecable spaces are important for presentation, add them at the
    templating level.

  ---------- -------------------------------------------------------------
  Short name Type/StringWithStrangeSpace

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `openemr-type-stringwithstrangespace`{.interpreted-text
             role="ref"},
             `thelia-type-stringwithstrangespace`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Strpos()-like Comparison {#strpos()-like-comparison}
------------------------

The result of that function may be mistaken with an error.

[strpos()](https://www.php.net/strpos), along with several PHP native
functions, returns a string position, starting at 0, or false, in case
of failure.

``` {.php}
<?php

// This is the best comparison
if (strpos($string, 'a') === false) { }

// This is OK, as 2 won't be mistaken with false
if (strpos($string, 'a') == 2) { }

// strpos is one of the 26 functions that may behave this way
if (preg_match($regex, $string)) { } 

// This works like above, catching the value for later reuse
if ($a = strpos($string, 'a')) { }

// This misses the case where 'a' is the first char of the string
if (strpos($string, 'a')) { }

// This misses the case where 'a' is the first char of the string, just like above
if (strpos($string, 'a') == 0) { }

?>
```

It is recommended to check the result of
[strpos()](https://www.php.net/strpos) with === or !==, so as to avoid
confusing 0 and false.

This analyzer list all the [strpos()](https://www.php.net/strpos)-like
functions that are directly compared with == or !=.
[preg\_match()](https://www.php.net/preg_match), when its first argument
is a literal, is omitted : this function only returns
[NULL](https://www.php.net/manual/en/language.types.null.php) in case of
regex error.

The full list is the following :

-   [array\_search()](https://www.php.net/array_search)
-   [collator\_compare()](https://www.php.net/collator_compare)
-   [collator\_get\_sort\_key()](https://www.php.net/collator_get_sort_key)
-   [current()](https://www.php.net/current)
-   [fgetc()](https://www.php.net/fgetc)
-   [file\_get\_contents()](https://www.php.net/file_get_contents)
-   [file\_put\_contents()](https://www.php.net/file_put_contents)
-   [fread()](https://www.php.net/fread)
-   [iconv\_strpos()](https://www.php.net/iconv_strpos)
-   [iconv\_strrpos()](https://www.php.net/iconv_strrpos)
-   [imagecolorallocate()](https://www.php.net/imagecolorallocate)
-   [imagecolorallocatealpha()](https://www.php.net/imagecolorallocatealpha)
-   [mb\_strlen()](https://www.php.net/mb_strlen)
-   [next()](https://www.php.net/next)
-   [pcntl\_getpriority()](https://www.php.net/pcntl_getpriority)
-   [preg\_match()](https://www.php.net/preg_match)
-   [prev()](https://www.php.net/prev)
-   [readdir()](https://www.php.net/readdir)
-   [stripos()](https://www.php.net/stripos)
-   [strpos()](https://www.php.net/strpos)
-   [strripos()](https://www.php.net/strripos)
-   [strrpos()](https://www.php.net/strrpos)
-   [strtok()](https://www.php.net/strtok)
-   [curl\_exec()](https://www.php.net/curl_exec)

In PHP 8.0, str\_contains() will do the expected job of
[strpos()](https://www.php.net/strpos), with less confusion.

See also [strpos not working
correctly](https://bugs.php.net/bug.php?id=52198).

### Suggestions

-   Use identity comparisons, for 0 values : === instead of ==, etc.
-   Compare with other exact values than 0 : strpos() == 2
-   Use str\_contains()

  ---------- --------------------------------------------------------------------------------------------------
  Short name Structures/StrposCompare

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `Top10`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [strict-comparisons](https://github.com/dseguy/clearPHP/tree/master/rules/strict-comparisons.md)

  Examples   `piwigo-structures-strposcompare`{.interpreted-text role="ref"},
             `thelia-structures-strposcompare`{.interpreted-text role="ref"}
  ---------- --------------------------------------------------------------------------------------------------

Strtr Arguments
---------------

[Strtr()](https://www.php.net/strtr) replaces characters by others in a
string. When using strings, [strtr()](https://www.php.net/strtr)
replaces characters as long as they have a replacement. All others are
ignored.

In particular, [strtr()](https://www.php.net/strtr) works on strings of
the same size, and cannot be used to remove chars.

``` {.php}
<?php

$string = 'abcde';
echo strtr($string, 'abc', 'AB');
echo strtr($string, 'ab', 'ABC');
// displays ABcde 
// c is ignored each time

// strtr can't remove a char
echo strtr($string, 'a', '');
// displays a

?>
```

See also [strtr](http://www.php.net/strtr).

### Suggestions

-   Check the call to strtr() and make sure the arguments are of the
    same size
-   Replace strtr() with str\_replace(), which works with strings and
    array, not chars
-   Replace strtr() with preg\_match(), which works with patterns and
    not chars

  ------------- -------------------------------------------------
  Short name    Php/StrtrArguments

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)

  Examples      `suitecrm-php-strtrarguments`{.interpreted-text
                role="ref"}
  ------------- -------------------------------------------------

Substr To Trim
--------------

When removing the first or the last character of a string,
[trim()](https://www.php.net/trim) does a more readable job.

[trim()](https://www.php.net/trim), [ltrim()](https://www.php.net/ltrim)
and [rtrim()](https://www.php.net/rtrim) accept a string as second
argument. Those will all be removed from the endings of the string.

``` {.php}
<?php

$a = '$drop the dollar'; 
$b = substr($a, 1); // drop the first char 
$b = ltrim($a, '$'); // remove the initial '$'s


$b = substr($a, 1);     // replace with ltrim()

$b = substr($a, 0, -1); // replace with rtrim()

$b = substr($a, 1, -1); // replace with trim()

?>
```

[trim()](https://www.php.net/trim) will remove all occurrences of the
requested char(). This may remove a loop with
[substr()](https://www.php.net/substr), or remove more than is needed.

[trim()](https://www.php.net/trim) doesn\'t work with multi-bytes
strings, but so does [substr()](https://www.php.net/substr). For that,
use [mb\_substr()](https://www.php.net/mb_substr), as there isn\'t any
mb\_trim function (yet).

See also [trim](https://www.php.net/manual/en/function.trim.php),
[ltrim](https://www.php.net/manual/en/function.ltrim.php),
[rtrim](https://www.php.net/manual/en/function.rtrim.php).

### Suggestions

-   Replace substr() with trim(), ltrim() or rtrim().

  ------------- ---------------------------------
  Short name    Structures/SubstrToTrim

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Substring First
---------------

Always start by reducing a string before applying some transformation on
it. The shorter string will be processed faster.

``` {.php}
<?php

// fast version
$result = strtolower(substr($string, $offset, $length));

// slower version
$result = substr(strtolower($string), $offset, $length);
?>
```

The gain produced here is greater with longer strings, or greater
reductions. They may also be used in loops. This is a micro-optimisation
when used on short strings and single string reductions.

This works with any reduction function instead of
[substr()](https://www.php.net/substr), like
[trim()](https://www.php.net/trim),
[iconv()](https://www.php.net/iconv), etc.

### Suggestions

-   Always reduce the string first, then apply some transformation

  ---------- ------------------------------------------------------------
  Short name Performances/SubstrFirst

  Rulesets   `Performances`{.interpreted-text role="ref"},
             `Suggestions`{.interpreted-text role="ref"},
             `Top10`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `spip-performances-substrfirst`{.interpreted-text
             role="ref"},
             `prestashop-performances-substrfirst`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Suspicious Comparison
---------------------

The comparison seems to be misplaced.

A comparison happens in the last argument, while the actual function
expect another type : this may be the case of a badly placed
parenthesis.

``` {.php}
<?php

// trim expect a string, a boolean is given.
if (trim($str === '')){

}

// Just move the first closing parenthesis to give back its actual meaning
if (trim($str) === ''){

}

?>
```

Original idea by [Vladimir Reznichenko](https://twitter.com/kalessil).

### Suggestions

-   Remove the comparison altogether
-   Move the comparison to its right place : that, or more the
    parenthesis.
-   This may be what is intended : just leave it.

  ---------- ----------------------------------------------------------------------
  Short name Structures/SuspiciousComparison

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Instant (5 mins)
  Fix        

  Examples   `phpipam-structures-suspiciouscomparison`{.interpreted-text
             role="ref"},
             `expressionengine-structures-suspiciouscomparison`{.interpreted-text
             role="ref"}
  ---------- ----------------------------------------------------------------------

Swapped Arguments
-----------------

Overwritten methods must be compatible, but argument names is not part
of that compatibility.

Methods with the same name, in two classes of the same hierarchy, must
be compatible for typehint, default value, reference. The name of the
argument is not taken into account when checking such compatibility, at
least until PHP 7.4.

``` {.php}
<?php

class x {
    function foo($a, $b) {}

    function bar($a, $b) {}
}

class y extends x {
    // foo is compatible (identical) with the above class
    function foo($a, $b) {}

    // bar is compatible with the above class, yet, the argument might not receive what they expect.
    function bar($b, $a) {}
}

?>
```

This analysis reports argument lists that differs in ordering. This
analysis doesn\'t report argument lists that also differs in argument
names.

### Suggestions

-   Make sure the names of the argument are in the same order in all
    classes and interfaces

  ------------- -----------------------------
  Short name    Classes/SwappedArguments

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Critical

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Switch Fallthrough
------------------

A switch with fallthrough is prone to errors.

A fallthrough happens when a case or default clause in a switch
statement is not finished by a
[break](https://www.php.net/manual/en/control-structures.break.php) (or
equivalent); CWE report this as a security concern, unless well
documented.

A fallthrough may be used as a feature. Then, it is indistinguishable
from an error.

When the case block is empty, this analysis doesn\'t report it : the
case is then used as an alias.

``` {.php}
<?php
switch($variable) {
    case 1 :   // case 1 is not reported, as it actually shares the same body as case 33
    case 33 :  
        break ;
    case 2 : 
        break ;
    default: 
        ++$a;
    case 4 : 
        break ;
}
?>
```

This analysis doesn\'t take into account comments about the fallthrough.

See also [CWE-484: Omitted \`Break
\<https://www.php.net/manual/en/control-structures.break.php\>]{.title-ref}\_
Statement in Switch
\<<https://cwe.mitre.org/data/definitions/484.html>\>[\_ and \`Rule:
no-switch-case-fall-through
\<https://palantir.github.io/tslint/rules/no-switch-case-fall-through/\>]{.title-ref}\_.

### Suggestions

-   Make separate code for each case. Always use break at the end of a
    case or default.

  ------------- ------------------------------
  Short name    Structures/Fallthrough

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ------------------------------

Switch To Switch
----------------

The following structures are based on if / elseif / else. Since they
have more than three conditions (not withstanding the final else), it is
recommended to use the switch structure, so as to make this more
readable.

On the other hand,
[switch()](https://www.php.net/manual/en/control-structures.switch.php)
structures with less than 3 elements should be expressed as a if / else
structure.

Note that if condition that uses strict typing (=== or !==) can\'t be
converted to
[switch()](https://www.php.net/manual/en/control-structures.switch.php)
as the latter only performs == or != comparisons.

``` {.php}
<?php

if ($a == 1) {

} elseif ($a == 2) {

} elseif ($a == 3) {

} elseif ($a == 4) {

} else {

}

// Better way to write long if/else lists
switch ($a) {
    case 1 : 
        doSomething(1);
        break 1;

    case 2 : 
        doSomething(2);
        break 1;

    case 3 : 
        doSomething(3);
        break 1;

    case 4 : 
        doSomething(4);
        break 1;

    default :
        doSomething();
        break 1;
}

?>
```

Note that simple switch statement, which compare a variable to a literal
are optimised in PHP 7.2 and more recent. This gives a nice performance
boost, and keep code readable.

See also [PHP 7.2\'s switch
optimisations](https://derickrethans.nl/php7.2-switch.html) and [Is Your
Code Readable By Humans? Cognitive Complexity Tells
You](https://www.tomasvotruba.cz/blog/2018/05/21/is-your-code-readable-by-humans-cognitive-complexity-tells-you/).

### Suggestions

-   Use a switch statement, rather than a long string of if/else
-   Use a match() statement, rather than a long string of if/else (PHP
    8.0 +)

  ---------- ------------------------------------------------------------
  Short name Structures/SwitchToSwitch

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `thelia-structures-switchtoswitch`{.interpreted-text
             role="ref"},
             `xoops-structures-switchtoswitch`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Switch With Too Many Default
----------------------------

Switch statements should only hold one default, not more. Check the code
and remove the extra default.

PHP 7.0 won\'t compile a script that allows for several default cases.

Multiple default happens often with large
[switch()](https://www.php.net/manual/en/control-structures.switch.php).

``` {.php}
<?php

switch($a) {
    case 1 : 
        break;
    default : 
        break;
    case 2 : 
        break;
    default :  // This default is never reached
        break;
}

?>
```

### Suggestions

-   Remove the useless default : it may be the first, or the last. In
    case of ambiguity, keep the first, as it is the one being used at
    the moment.

  ---------- --------------------------------------------------------------
  Short name Structures/SwitchWithMultipleDefault

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and older
  Version    

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        
  ---------- --------------------------------------------------------------

Switch Without Default
----------------------

Always use a default statement in
[switch()](https://www.php.net/manual/en/control-structures.switch.php).

Switch statements hold a number of \'case\' that cover all known
situations, and a \'default\' one which is executed when all other
options are exhausted.

``` {.php}
<?php

// Missing default
switch($format) {
    case 'gif' : 
        processGif();
        break 1;

    case 'jpeg' : 
        processJpeg();
        break 1;

    case 'bmp' :
        throw new UnsupportedFormat($format);
}
// In case $format is not known, then switch is ignored and no processing happens, leading to preparation errors


// switch with default
switch($format) {
    case 'text' : 
        processText();
        break 1;

    case 'jpeg' : 
        processJpeg();
        break 1;

    case 'rtf' :
        throw new UnsupportedFormat($format);

    default :
        throw new UnknownFileFormat($format);
}
// In case $format is not known, an exception is thrown for processing 

?>
```

Most of the time,
[switch()](https://www.php.net/manual/en/control-structures.switch.php)
do need a default case, so as to catch the odd situation where the
\'value is not what it was expected\'. This is a good place to catch
unexpected values, to set a default behavior.

### Suggestions

-   Add a default case

  ---------- ----------------------------------------------------------------------------------------------------------------
  Short name Structures/SwitchWithoutDefault

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-switch-without-default](https://github.com/dseguy/clearPHP/tree/master/rules/no-switch-without-default.md)

  Examples   `zencart-structures-switchwithoutdefault`{.interpreted-text role="ref"},
             `traq-structures-switchwithoutdefault`{.interpreted-text role="ref"}
  ---------- ----------------------------------------------------------------------------------------------------------------

Ternary In Concat
-----------------

Ternary and coalesce operator have higher priority than dot \'.\' for
concatenation. This means that :

``` {.php}
<?php
  // print B0CE as expected  
  print 'B'.$b.'C'. ($b > 1 ? 'D') : 'E';

  // print E, instead of B0CE
  print 'B'.$b.'C'. $b > 1 ? 'D' : 'E';

  print 'B'.$b.'C'. $b > 1 ? 'D' : 'E';
?>
```

prints actually \'E\', instead of the awaited \'B0CE\'.

To be safe, always add parenthesis when using ternary operator with
concatenation.

See also [Operator
Precedence](https://www.php.net/manual/en/language.operators.precedence.php).

### Suggestions

-   Use parenthesis
-   Avoid ternaries and coalesce operators inside a string

  ------------- ---------------------------------------------------------
  Short name    Structures/TernaryInConcat

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Critical

  Time To Fix   Quick (30 mins)

  Examples      `teampass-structures-ternaryinconcat`{.interpreted-text
                role="ref"}
  ------------- ---------------------------------------------------------

Test Then Cast
--------------

A test is run on the value, but the cast value is later used.

The cast may introduce a distortion to the value, and still lead to the
unwanted situation. For example, comparing to 0, then later casting to
an int. The comparison to 0 is done without casting, and as such, 0.1 is
different from 0. Yet, (int) 0.1 is actually 0, leading to a Division by
0 error.

``` {.php}
<?php

// Here. $x may be different from 0, but (int) $x may be 0
$x = 0.1;

if ($x != 0) {
    $y = 4 / (int) $x;
}

// Safe solution : check the cast value.
if ( (int) $x != 0) {
    $y = 4 / (int) $x;
}

?>
```

### Suggestions

-   Test with the cast value

  ---------- ------------------------------------------------------------
  Short name Structures/TestThenCast

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Instant (5 mins)
  Fix        

  Examples   `dolphin-structures-testthencast`{.interpreted-text
             role="ref"},
             `suitecrm-structures-testthencast`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Throw Functioncall
------------------

The `throw` keyword expects to use an exception. Calling a function to
prepare that exception before throwing it is possible, but forgetting
the new keyword is also possible.

``` {.php}
<?php

// Forgotten new
throw \RuntimeException('error!');

// Code is OK, function returns an exception
throw getException(ERROR_TYPE, 'error!');

function getException(ERROR_TYPE, $message) {
    return new \RuntimeException($messsage);
}

?>
```

When the `new` keyword is forgotten, then the class constructor is used
as a function name, and now exception is emitted, but an
`Undefined function` fatal error is emitted.

See also
[Exceptions](https://www.php.net/manual/en/language.exceptions.php).

### Suggestions

-   Add the new operator to the call
-   Make sure the function is really a functioncall, not a class name

  ---------- -------------------------------------------------------------
  Short name Exceptions/ThrowFunctioncall

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Instant (5 mins)
  Fix        

  Examples   `sugarcrm-exceptions-throwfunctioncall`{.interpreted-text
             role="ref"},
             `zurmo-exceptions-throwfunctioncall`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Throw In Destruct
-----------------

According to the manual,
`Attempting to throw an exception from a destructor (called in the time of script termination) causes a fatal error.`

The destructor may be called during the lifespan of the script, but it
is not certain. If the exception is thrown later, the script may end up
with a fatal error.

Thus, it is recommended to avoid throwing exceptions within the
`__destruct` method of a class.

``` {.php}
<?php

// No exception thrown
class Bar { 
    function __construct() {
        throw new Exception('__construct');
    }

    function __destruct() {
        $this->cleanObject();
    }
}

// Potential crash
class Foo { 
    function __destruct() {
        throw new Exception('__destruct');
    }
}

?>
```

See also [Constructors and
Destructors](https://www.php.net/manual/en/language.oop5.decon.php).

### Suggestions

-   Remove any exception thrown from a destructor

  ------------- ----------------------------------
  Short name    Classes/ThrowInDestruct

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Throw Was An Expression
-----------------------

Throw used to be an expression. In PHP 7.0, there were some location
where one couldn\'t use a throw : this was the case for arrow functions,
which expect one expression as function\'s body.

Using throw as an instruction makes the code incompatible with PHP 7
version and older.

``` {.php}
<?php

// Valid in PHP 8.0 and more recent
$fn = fn($a) => throw new Exception($a);

?>
```

See also [Throw Expression](https://wiki.php.net/rfc/throw_expression)
and [Exceptions](https://www.php.net/manual/en/language.exceptions.php).

### Suggestions

-   

  ---------- ------------------------------------------------------------
  Short name Php/ThrowWasAnExpression

  Rulesets   `CompatibilityPHP72`{.interpreted-text role="ref"},
             `CompatibilityPHP73`{.interpreted-text role="ref"},
             `CompatibilityPHP74`{.interpreted-text role="ref"}

  Php        8.0+
  Version    

  Severity   Major

  Time To    Quick (30 mins)
  Fix        
  ---------- ------------------------------------------------------------

Throws An Assignement
---------------------

It is possible to throw an exception, and, in the same time, assign this
exception to a variable.

However, the variable will never be used, as the exception is thrown,
and any following code is not executed, unless the exception is caught
in the same scope.

``` {.php}
<?php

    // $e is useful, though not by much
    $e = new() Exception();
    throw $e;

    // $e is useless
    throw $e = new Exception();

?>
```

### Suggestions

-   Drop the assignation

  ------------- ----------------------------------
  Short name    Structures/ThrowsAndAssign

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ----------------------------------

Timestamp Difference
--------------------

`time()` and `microtime()` shouldn\'t be used to calculate duration.

`time()` and `microtime()` are subject to variations, depending on
system clock variations, such as daylight saving time difference (every
spring and fall, one hour variation), or leap seconds, happening on
`June, 30th` or `December 31th`, as announced by
[IERS](https://www.iers.org/IERS/EN/Home/home_node.html).

``` {.php}
<?php

// Calculating tomorow, same hour, the wrong way
// tomorrow is not always in 86400s, especially in countries with daylight saving 
$tomorrow = time()  + 86400; 

// Good way to calculate tomorrow
$datetime = new DateTime('tomorrow');

?>
```

When the difference may be rounded to a larger time unit (rounding the
difference to days, or several hours), the variation may be ignored
safely.

When the difference is very small, it requires a better way to measure
time difference, such as [Ticks
\<https://www.php.net/manual/en/control-structures.declare.php\#control-structures.declare.ticks\>\'\_,
\`ext/hrtime \<https://www.php.net/manual/en/book.hrtime.php\>\'\_, or
including a check on the actual time zone
(]{.title-ref}[ini\_get()]{.title-ref}\` with \'date.timezone\').

See also [PHP DateTime difference -- it's a
trap!](http://blog.codebusters.pl/en/php-datetime-difference-trap/) and
[PHP Daylight savings
bug?](https://stackoverflow.com/questions/22519091/php-daylight-savings-bug).

### Suggestions

-   For small time intervals, use hrtime() functions
-   For larger time intervals, use add() method with `DateTime`

  ---------- -------------------------------------------------------------
  Short name Structures/TimestampDifference

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Slow (1 hour)
  Fix        

  Examples   `zurmo-structures-timestampdifference`{.interpreted-text
             role="ref"},
             `shopware-structures-timestampdifference`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Too Long A Block
----------------

The loop is operating on a block that is too long.

This analysis is applied to loops (for, foreach, while, do..while) and
if/then/else/elseif structures.

Then length of a block is managed with the `longBlock`parameter. By
default, it is 200 lines, from beginning to the end. Comments are taken
into account.

``` {.php}
<?php

$i = 0;
do {
    // 200 lines of PHP code

    ++$i;
} while($i < 100);

?>
```

### Suggestions

-   Move the code of the block to an method or a function
-   Move part of the code of the block to methods or functions
-   Extract repeated patterns and use them

  ----------- --------- --------- --------------------------------------------------------
  Name        Default   Type      Description

  longBlock   200       integer   Size of a block for it to be too long. A block is
                                  commanded by a for, foreach, while, do\...while, if/then
                                  else structure.
  ----------- --------- --------- --------------------------------------------------------

  ------------- ---------------------------------
  Short name    Structures/LongBlock

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Too Many Array Dimensions
-------------------------

When arrays a getting to many nesting.

``` {.php}
<?php

$a          = array();   // level 1;
$a[1]       = array();   // level 2
$a[1][2]    = array();   // level 3 : still valid by default
$a[1][2][3] = array();   // level 4 

?>
```

PHP has no limit, and accepts any number of nesting levels. Yet, this is
usually very memory hungry.

### Suggestions

-   

  --------------- --------- --------- --------------------------------------
  Name            Default   Type      Description

  maxDimensions   3         integer   Number of valid dimensions in an
                                      array.
  --------------- --------- --------- --------------------------------------

  ------------- -----------------------------
  Short name    Arrays/TooManyDimensions

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Too Many Children
-----------------

Classes that have more than 15 children. It is worth checking if they
cannot be refactored in anyway.

The threshold of 15 children can be configured. There is no technical
limitation of the number of children and grand-children for a class.

The analysis doesn\'t work recursively : only direct generations are
counted. Only children that can be found in the code are counted.

``` {.php}
<?php

// parent class
// calling it grandparent to avoid confusion with 'parent'
class grandparent {}


class children1 extends grandparent {}
class children2 extends grandparent {}
class children3 extends grandparent {}
class children4 extends grandparent {}
class children5 extends grandparent {}
class children6 extends grandparent {}
class children7 extends grandparent {}
class children8 extends grandparent {}
class children9 extends grandparent {}
class children11 extends grandparent {}
class children12 extends grandparent {}
class children13 extends grandparent {}
class children14 extends grandparent {}
class children15 extends grandparent {}
class children16 extends grandparent {}
class children17 extends grandparent {}
class children18 extends grandparent {}
class children19 extends grandparent {}

?>
```

See also [Why is subclassing too much bad (and hence why should we use
prototypes to do away with
it)?](https://softwareengineering.stackexchange.com/questions/137687/why-is-subclassing-too-much-bad-and-hence-why-should-we-use-prototypes-to-do-aw).

### Suggestions

-   Split the original class into more specialised classes

  -------------------- --------- --------- -----------------------------------------
  Name                 Default   Type      Description

  childrenClassCount   15        integer   Threshold for too many children classes
                                           for one class.
  -------------------- --------- --------- -----------------------------------------

  ---------- ------------------------------------------------------------
  Short name Classes/TooManyChildren

  Rulesets   `Suggestions`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  Examples   `typo3-classes-toomanychildren`{.interpreted-text
             role="ref"},
             `woocommerce-classes-toomanychildren`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Too Many Dereferencing
----------------------

Linking too many properties and methods, one to the other.

This analysis counts both
[static](https://www.php.net/manual/en/language.oop5.static.php) calls
and normal call; methods, properties and constants. It also takes into
account arrays along the way.

The default limit of chaining methods and properties is set to 7 by
default.

``` {.php}
<?php

// 9 chained calls.
$main->getA()->getB()->getC()->getD()->getE()->getF()->getG()->getH()->getI()->property;

?>
```

Too many chained methods is harder to read.

### Suggestions

-   

  ---------------------- --------- --------- -------------------------------
  Name                   Default   Type      Description

  tooManyDereferencing   7         integer   Maximum number of
                                             dereferencing.
  ---------------------- --------- --------- -------------------------------

  ------------- ------------------------------
  Short name    Classes/TooManyDereferencing

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

Too Many Finds
--------------

Too many methods called \'find\*\' in this class. It is may be time to
consider the [Specification
pattern](https://en.wikipedia.org/wiki/Specification_pattern).

``` {.php}
<?php

// quite a fishy interface
interface UserInterface {
    public function findByEmail($email);
    public function findByUsername($username);
    public function findByFirstName($firstname);
    public function findByLastName($lastname);
    public function findByName($name);
    public function findById($id);

    public function insert($user);
    public function update($user);
}

?>
```

See also [On Taming Repository Classes in
Doctrine](https://beberlei.de/2013/03/04/doctrine_repositories.html) ,
[On Taming Repository Classes in Doctrine... Among other
things.](http://blog.kevingomez.fr/2015/02/07/on-taming-repository-classes-in-doctrine-among-other-things/),
[specifications](https://slides.pixelart.at/2017-02-04/fosdem/specifications/#/).

  -------------- --------- --------- ---------------------------------------------------
  Name           Default   Type      Description

  minimumFinds   5         integer   Minimal number of prefixed methods to report.

  findPrefix     find      string    list of prefix to use when detecting the \'find\'.
                                     Comma-separated list, case insensitive.

  findSuffix               string    list of fix to use when detecting the \'find\'.
                                     Comma-separated list, case insensitive.
  -------------- --------- --------- ---------------------------------------------------

  ------------- -----------------------------
  Short name    Classes/TooManyFinds

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- -----------------------------

Too Many Injections
-------------------

When a class is constructed with more than four dependencies, it should
be split into smaller classes.

``` {.php}
<?php

// This class relies on 5 other instances. 
// It is probably doing too much.
class Foo {
    public function __construct(
            A $a, 
            B $b, 
            C $c,
            D $d
            E $e ) {
        $this->a = $a;
        $this->b = $b;
        $this->d = $d;
        $this->d = $d;
        $this->e = $e;
    }
}

?>
```

See also [Dependency Injection
Smells](http://seregazhuk.github.io/2017/05/04/di-smells/).

### Suggestions

-   Split the class into smaller classes. Try to do less in that class.

  ----------------- --------- --------- -------------------------------------------
  Name              Default   Type      Description

  injectionsCount   5         integer   Threshold for too many injected parameters
                                        for one class.
  ----------------- --------- --------- -------------------------------------------

  ---------- -------------------------------------------------------------
  Short name Classes/TooManyInjections

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  Examples   `nextcloud-classes-toomanyinjections`{.interpreted-text
             role="ref"},
             `thelia-classes-toomanyinjections`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Too Many Local Variables
------------------------

Too many local variables were found in the methods. When over 15
variables are found in such a method, a violation is reported.

Local variables exclude globals (imported with global) and arguments.
Local variable include
[static](https://www.php.net/manual/en/language.oop5.static.php)
variables.

When too many variables are used in a function, it is a code smells. The
function is trying to do too much and needs extra space for juggling.
Beyond 15 variables, it becomes difficult to keep track of their name
and usage, leading to confusion, overwriting or hijacking.

``` {.php}
<?php

// This function is OK : 3 vars are arguments, 3 others are globals.
function a20a3g3($a1, $a2, $a3) {
    global $a4, $a5, $a6;

    $a1  = 1;
    $a2  = 2;
    $a3  = 3 ;
    $a4  = 4 ;
    $a5  = 5 ;
    $a6  = 6 ;
    $a7  = 7 ;
    $a8  = 8 ;
    $a9  = 9 ;
    $a10 = 10;
    $a11  = 11;
    $a12  = 12;
    $a13  = 13 ;
    $a14  = 14 ;
    $a15  = 15 ;
    $a16  = 16 ;
    $a17  = 17 ;
    $a18  = 18 ;
    $a19  = 19 ;
    $a20 = 20;

}

// This function has too many variables
function a20() {

    $a1  = 1;
    $a2  = 2;
    $a3  = 3 ;
    $a4  = 4 ;
    $a5  = 5 ;
    $a6  = 6 ;
    $a7  = 7 ;
    $a8  = 8 ;
    $a9  = 9 ;
    $a10 = 10;
    $a11  = 11;
    $a12  = 12;
    $a13  = 13 ;
    $a14  = 14 ;
    $a15  = 15 ;
    $a16  = 16 ;
    $a17  = 17 ;
    $a18  = 18 ;
    $a19  = 19 ;
    $a20 = 20;

}

?>
```

### Suggestions

-   Remove some of the variables, and inline them
-   Break the big function into smaller ones
-   Find repeated code and make it a separate function

  ------------------------------- --------- --------- ---------------------------------------
  Name                            Default   Type      Description

  tooManyLocalVariableThreshold   15        integer   Minimal number of variables in one
                                                      function or method to report.
  ------------------------------- --------- --------- ---------------------------------------

  ------------- --------------------------------------------------------------
  Short name    Functions/TooManyLocalVariables

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Examples      `humo-gen-functions-toomanylocalvariables`{.interpreted-text
                role="ref"}
  ------------- --------------------------------------------------------------

Too Many Native Calls
---------------------

Avoid stuffing too many PHP native call inside another functioncall.

For readability reasons, or, more often, for edge case handling, it is
recommended to avoid nesting too many PHP native calls.

This analysis reports any situation where more than 3 PHP native calls
are nested.

``` {.php}
<?php

// Too many nested functions 
$cleanArray = array_unique(array_keys(array_count_values(array_column($source, 'x'))));

// Avoid warning when source is empty
$extract = array_column($source, 'x');
if (empty($extract)) {
    $cleanArray = array();
} else {
    $cleanArray = array_unique(array_keys(array_count_values($extract)));
}

// This is not readable, although it is short. 
// It may easily get out of hand.
echo chr(80), chr(72), chr(80), chr(32), ' is great!';

?>
```

  ------------------ --------- --------- ----------------------------------------
  Name               Default   Type      Description

  nativeCallCounts   3         integer   Number of native calls found inside
                                         another call.
  ------------------ --------- --------- ----------------------------------------

  ------------- -------------------------------------------------
  Short name    Php/TooManyNativeCalls

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `spip-php-toomanynativecalls`{.interpreted-text
                role="ref"}
  ------------- -------------------------------------------------

Too Many Parameters
-------------------

Method has too many parameters. Exakat has a default parameter count
which may be configured.

A method that needs more than 8 parameters is trying to do too much : it
should be reviewed and split into smaller methods.

``` {.php}
<?php

// This methods has too many parameters.
function alertSomeone($name, $email, $title, $message, $attachements, $signature, $bcc, $cc, $extra_headers) { 
    /* too much code here */ 
}

?>
```

See also [How many parameters is too many
?](https://www.exakat.io/how-many-parameters-is-too-many/) and [Too Many
Parameters](http://wiki.c2.com/?TooManyParameters).

### Suggestions

-   Reduce the number of parameters to a lower level
-   Break the function into smaller functions
-   Turn the function into a class

  ----------------- --------- --------- -------------------------------------
  Name              Default   Type      Description

  parametersCount   8         integer   Minimal number of parameters to
                                        report.
  ----------------- --------- --------- -------------------------------------

  ---------- --------------------------------------------------------------
  Short name Functions/TooManyParameters

  Rulesets   `Suggestions`{.interpreted-text role="ref"}

  Examples   `wordpress-functions-toomanyparameters`{.interpreted-text
             role="ref"},
             `churchcrm-functions-toomanyparameters`{.interpreted-text
             role="ref"}
  ---------- --------------------------------------------------------------

Too Much Indented
-----------------

Reports methods that are using more than one level of indentation on
average.

Indentations levels are counted for each for, foreach, if\...then,
while, do..while, try..catch..finally structure met. Compulsory
expressions, such as conditions, are not counted in the total. Levels of
indentation start at 0 (no indentation needed)

This analysis targets methods which are build around large conditions :
the actual useful code is nested inside the branches of the if/then/else
(for example).

The default threshold `indentationAverage` of 1 is a good start for
spotting large methods with big conditional code, and will leave smaller
methods, even when they only contain one if/then. Larger methods shall
be refactored in smaller size.

The parameter `minimumSize` set aside methods which are too small for
refactoring.

``` {.php}
<?php

// average 0
function foo0() {
    $a = rand(1,2);
    $a *= 3;

    return $a;
}

// average 0.66 = (0 + 1 + 1) / 3
function foo0_66() {
    // if () is at level 0
    if ($a == 2) { // condition is not counted
        $a = 1;    // level 1
    } else {
        $a = 2;    // level 1
    }
}

// average 1 = (0 + 2 + 1 + 1) / 4
function foo1() {
    // if () is at level 0
    if ($a == 2) {
        // if () is at level 1
        if ($a == 2) {
            $a = 1; // level 2
        }
        $a = 1; // level 1
    } else {
        $a = 2; // level 1
    }
}

?>
```

This analysis is distinct from Structures/MaxLevelOfIdentation, which
only reports the highest level of indentation. This one reports how one
method is build around one big

See also `max-level-of-nesting`{.interpreted-text role="ref"}.

### Suggestions

-   Refactor the method to reduce the highest level of indentation
-   Refactor the method move some of the code to external methods.

  -------------------- --------- ------ --------------------------------------------------------
  Name                 Default   Type   Description

  indentationAverage   1         real   Minimal average of indentation in a method to report.
                                        Default is 1.0, which means that the method is on
                                        average at one level of indentation or more.

  minimumSize          3         real   Minimal number of expressions in a method to apply this
                                        analysis.
  -------------------- --------- ------ --------------------------------------------------------

  ------------- ---------------------------------
  Short name    Functions/TooMuchIndented

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Trailing Comma In Calls
-----------------------

The last argument may be left empty.

This feature was introduced in PHP 7.3.

``` {.php}
<?php

// VCS friendly call
// PHP 7.3 and more recent
foo(1,
    2,
    3,
   );

// backward compatible call
// All PHP versions
foo(1,
    2,
    3
   );

?>
```

See also [PHP RFC: Allow a trailing comma in function
calls](https://wiki.php.net/rfc/trailing-comma-function-calls).

  ---------- ------------------------------------------------------------------
  Short name Php/TrailingComma

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        
  ---------- ------------------------------------------------------------------

Trait Not Found
---------------

A unknown trait is mentioned in the use expression.

The used traits all exist, but in the configuration block, some
unmentioned trait is called.

Be aware that the traits used in any configuration block may originate
in any use expression. PHP will check the configuration block at
instantiation only, and after compiling : at that moment, it will know
all the used traits across the class.

``` {.php}
<?php
class x  { 
    // c is not a used trait
    use a, b { c::d insteadof e;}

    // e is a used trait, even if is not in the use above.
    use e;
}
?>
```

See also
[Traits](https://www.php.net/manual/en/language.oop5.traits.php).

### Suggestions

-   Switch the name of the trait to an existing and used trait
-   Drop the expression that rely on the non-existent trait

  ------------- ----------------------------------------
  Short name    Traits/TraitNotFound

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Typed Property Usage
--------------------

Traditionally, PHP properties aren\'t typed. Since PHP 7.4, it is
possible to type properties, just like arguments.

``` {.php}
<?php

class User {
    public int $id;
    public string $name;

    public function __construct(int $id, string $name) {
        $this->id = $id;
        $this->name = $name;
    }
}
?>
```

See also [Typed Properties
2.0](https://wiki.php.net/rfc/typed_properties_v2).

### Suggestions

-   

  ---------- ------------------------------------------------------------------
  Short name Php/TypedPropertyUsage

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"},
             `CompatibilityPHP73`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        7.4+
  Version    

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        
  ---------- ------------------------------------------------------------------

Typehint Must Be Returned
-------------------------

When using a typehint for a method, it is compulsory to use a at least
one return in the method\'s body. This is true for nullable typehint too
: `return` alone won\'t be sufficient.

``` {.php}
<?php

// The function returns a value (here, correct object)
function foo() : Bar { return new Bar(); }

// The function should at least, return a value
function foo() : Bar { }

// The function should at least, return a value : Null or an object. Void, here, is not acceptable.
function foo() : ?Bar { return; }

?>
```

PHP lint this, but won\'t execute it.

This analysis doesn\'t check if the returned value is compatible with
the returned typehint. Only its presence is checked.

See also [Return Type
Declaration](https://www.php.net/manual/en/functions.returning-values.php#functions.returning-values.type-declaration)
and [Type hint in PHP function parameters and return
values](https://mlocati.github.io/articles/php-type-hinting.html).

### Suggestions

-   Add a return with a valid value

  ------------- ---------------------------------------------------------
  Short name    Functions/TypehintMustBeReturned

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------------------------------

Typehinted References
---------------------

Typehinted arguments have no need for references. Since they are only an
object, they are already a reference.

In fact, adding the & on the argument definition may lead to error like
`Only variables should be passed by reference`.

This applies to the `object` type hint, but not the the others, such as
`int` or `bool`.

``` {.php}
<?php
    // a class
    class X {
        public $a = 3;
    }

    // typehinted reference
    //function foo(object &$x) works too
    function foo(X &$x) {
        $x->a = 1;

        return $x;
    }

    // Send an object 
    $y = foo(new X);

    // This prints 1;
    print $y->a;
?>
```

See also [Passing by
reference](https://www.php.net/manual/en/language.references.pass.php)
and [Objects and
references](https://www.php.net/manual/en/language.oop5.references.php).

### Suggestions

-   Remove reference for typehinted arguments, unless the typehint is a
    scalar typehint.

  ------------- ----------------------------------
  Short name    Functions/TypehintedReferences

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)

  Precision     High
  ------------- ----------------------------------

Unbinding Closures
------------------

Never drop `$this`, once a closure was created in a
non-[static](https://www.php.net/manual/en/language.oop5.static.php)
method.

From the PHP wiki : Currently it is possible to unbind the
[\$this](https://www.php.net/manual/en/language.oop5.basic.php) variable
from a closure that originally had one by using
\$closure-\>bindTo(null). Due to the removal of
[static](https://www.php.net/manual/en/language.oop5.static.php) calls
to non-[static](https://www.php.net/manual/en/language.oop5.static.php)
methods in PHP 8, we now have a guarantee that
[\$this](https://www.php.net/manual/en/language.oop5.basic.php) always
exists inside
non-[static](https://www.php.net/manual/en/language.oop5.static.php)
methods. We would like to have a similar guarantee that
[\$this](https://www.php.net/manual/en/language.oop5.basic.php) always
exists for
non-[static](https://www.php.net/manual/en/language.oop5.static.php)
closures declared inside
non-[static](https://www.php.net/manual/en/language.oop5.static.php)
methods. Otherwise, we will end up imposing an unnecessary performance
penalty either on
[\$this](https://www.php.net/manual/en/language.oop5.basic.php) accesses
in general, or
[\$this](https://www.php.net/manual/en/language.oop5.basic.php) accesses
inside such closures.

``` {.php}
<?php

class x {
    private $a = 3;

    function foo() {
        return function () { echo $this->a; };
    }
}

$closure = (new x)->foo();

// $this was expected, and it is not anymore
$closure->bindTo(null);

$closure->bindTo(new x);

?>
```

Calling bindTo() with a valid object is still valid.

See also [Unbinding ]{.title-ref}\$this
\<<https://www.php.net/manual/en/language.oop5.basic.php>\>[\_ from
non-\`static
\<https://www.php.net/manual/en/language.oop5.static.php\>]{.title-ref}\_
closures
\<<https://wiki.php.net/rfc/deprecations_php_7_4#unbinding_this_from_non-static_closures>\>\`\_.

### Suggestions

-   Create a static closure, which doesn\'t rely on \$this at all
-   Remove the call to bindTo(null).

  ------------- ----------------------------------------
  Short name    Functions/UnbindingClosures

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

Uncaught Exceptions
-------------------

The following exceptions are thrown in the code, but are never caught.

``` {.php}
<?php

// This exception is throw, but not caught. It will lead to a fatal error.
if ($message = check_for_error()) {
    throw new My\Exception($message);
}

// This exception is throw, and caught. 
try {
    if ($message = check_for_error()) {
        throw new My\Exception($message);
    }
} catch (\Exception $e) {
    doSomething();
}

?>
```

Either they will lead to a Fatal Error, or they have to be caught by an
including application. This is a valid behavior for libraries, but is
not for a final application.

See also [Structuring PHP
Exceptions](https://www.alainschlesser.com/structuring-php-exceptions/).

### Suggestions

-   Catch all the exceptions you throw

  ------------- -------------------------------
  Short name    Exceptions/UncaughtExceptions

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------

Unchecked Resources
-------------------

Resources are created, but never checked before being used. This is not
safe.

Always check that resources are correctly created before using them.

``` {.php}
<?php

// always check that the resource is created correctly
$fp = fopen($d,'r');
if ($fp === false) {
    throw new Exception('File not found');
} 
$firstLine = fread($fp);

// This directory is not checked : the path may not exist and return false
$uncheckedDir = opendir($pathToDir);
while(readdir($uncheckedDir)) {
    // do something()
}

// This file is not checked : the path may not exist or be unreadable and return false
$fp = fopen($pathToFile);
while($line = freads($fp)) {
    $text .= $line;
}

// unsafe one-liner : using bzclose on an unchecked resource
bzclose(bzopen('file'));

?>
```

See also
[resources](https://www.php.net/manual/en/language.types.resource.php).

  ---------- ----------------------------------------------------------------------------------------------------------
  Short name Structures/UncheckedResources

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Slow (1 hour)
  Fix        

  ClearPHP   [no-unchecked-resources](https://github.com/dseguy/clearPHP/tree/master/rules/no-unchecked-resources.md)
  ---------- ----------------------------------------------------------------------------------------------------------

Unconditional Break In Loop
---------------------------

An unconditional
[break](https://www.php.net/manual/en/control-structures.break.php) in a
loop creates dead code. Since the
[break](https://www.php.net/manual/en/control-structures.break.php) is
directly in the body of the loop, it is always executed, creating a
strange loop that can only run once.

Here,
[break](https://www.php.net/manual/en/control-structures.break.php) may
also be a return, a goto or a
[continue](https://www.php.net/manual/en/control-structures.continue.php).
They all branch out of the loop. Such statement are valid, but should be
moderated with a condition.

``` {.php}
<?php

// return in loop should be in 
function summAll($array) {
    $sum = 0;

    foreach($array as $a) {
        // Stop at the first error
        if (is_string($a)) {
            return $sum;
        }
        $sum += $a;
    }

    return $sum;
}

// foreach loop used to collect first element in array
function getFirst($array) {
    foreach($array as $a) {
        return $a;
    }
}

?>
```

### Suggestions

-   Remove the loop and call the content of the loop once.

  ---------- ---------------------------------------------------------------
  Short name Structures/UnconditionLoopBreak

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `livezilla-structures-unconditionloopbreak`{.interpreted-text
             role="ref"},
             `mediawiki-structures-unconditionloopbreak`{.interpreted-text
             role="ref"}
  ---------- ---------------------------------------------------------------

Undefined ::class
-----------------

`\:\:class` doesn\'t check if a corresponding class exists.

`\:\:class` must be checked with a call to
[class\_exists()](https://www.php.net/class_exists). Otherwise, it may
lead to a `Class 'foo' not found` or even silent dead code : this
happens also with Catch and
[instanceof](https://www.php.net/manual/en/language.operators.type.php)
commands with undefined classes. PHP doesn\'t raise an error in that
case.

``` {.php}
<?php

class foo() {}

// prints foo
echo foo::class; 

// prints bar though bar doesn't exist.
echo bar::class;

?>
```

See also [Class
Constants](https://www.php.net/manual/en/language.oop5.constants.php).

  ------------- ----------------------------------
  Short name    Classes/UndefinedStaticclass

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Undefined Caught Exceptions
---------------------------

Those are exceptions that are caught in the code, but are not defined in
the application.

They may be externally defined, such as in core PHP, extensions or
libraries. Make sure those exceptions are useful to your application :
otherwise, they are dead code.

``` {.php}
<?php

try {
    library_function($some, $args);

} catch (LibraryException $e) {
    // This exception is not defined, and probably belongs to Library
    print Library failed\n;

} catch (OtherLibraryException $e) {
    // This exception is not defined, and probably do not belongs to this code
    print Library failed\n;

} catch (\Exception $e) {
    // This exception is a PHP standard exception
    print Something went wrong, but not at Libary level\n;
}

?>
```

### Suggestions

-   Remove the catch clause, as it is dead code
-   Make sure the exception is thrown by the underlying code

  ------------ -------------------------------------------
  Short name   Exceptions/CaughtButNotThrown

  Rulesets     `Dead code <dead-code>`{.interpreted-text
               role="ref"}
  ------------ -------------------------------------------

Undefined Class Constants
-------------------------

Class constants that are used, but never defined. This should yield a
fatal error upon execution, but no feedback at compile level.

``` {.php}
<?php

class foo {
    const A = 1;
    define('B', 2);
}

// here, C is not defined in the code and is reported
echo foo::A.foo::B.foo::C;

?>
```

### Suggestions

-   Fix the name of the constant
-   Add the constant to the current class or one of its parent
-   Update the constant\'s visibility

  ------------- ----------------------------
  Short name    Classes/UndefinedConstants

  Rulesets      none

  Severity      Major

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- ----------------------------

Undefined Classes
-----------------

Those classes are used in the code, but there are no definition for
them.

This may happens under normal conditions, if the application makes use
of an unsupported extension, that defines extra classes; or if some
external libraries, such as PEAR, are not provided during the analysis.

``` {.php}
<?php

// FPDF is a classic PDF class, that is usually omitted by Exakat. 
$o = new FPDF();

// Exakat reports undefined classes in instanceof
// PHP ignores them
if ($o instanceof SomeClass) {
    // doSomething();
}

// Classes may be used in typehint too
function foo(TypeHintClass $x) {
    // doSomething();
}

?>
```

This analysis also checks in attributes.

### Suggestions

-   Fix the typo in the class name
-   Add a missing \'use\' expression
-   Create the missing class

  ------------- -----------------------------
  Short name    Classes/UndefinedClasses

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)

  Precision     Medium
  ------------- -----------------------------

Undefined Constant Name
-----------------------

When using the
`syntax for variable, the name used must be a defined constant. It is not a simple string, like 'x', it is an actual constant name.  Interestingly, it is possible to use a qualified name within`,
full or partial. PHP will lint such code, and will collect the value of
the constant immediately. Since there is no fallback mechanism for fully
qualified names, this ends with a Fatal error.

``` {.php}
<?php

const x = a;
$a = Hello;

// Display 'Hello'  -> $a -> Hello
echo ;

// Yield a PHP Warning 
// Use of undefined constant y - assumed 'y' (this will throw an Error in a future version of PHP)
echo ;

// Yield a PHP Fatal error as PHP first checks that the constant exists 
//Undefined constant 'y'
echo ;
?>
```

### Suggestions

-   Define the constant
-   Turn the dynamic syntax into a normal variable syntax
-   Use a fully qualified name (at least one ) to turn this syntax into
    a Fatal error when the constant is not found. This doesn\'t fix the
    problem, but may make it more obvious during the diagnostic.

  ------------- ---------------------------------
  Short name    Variables/UndefinedConstantName

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Undefined Constants
-------------------

Constants definition can\'t be located.

Those constants are not defined in the code, and will raise errors, or
use the fallback mechanism of being treated like a string.

``` {.php}
<?php

const A = 1;
define('B', 2);

// here, C is not defined in the code and is reported
echo A.B.C;

?>
```

It is recommended to define them all, or to avoid using them.

See also
[Constants](https://www.php.net/manual/en/language.constants.php).

### Suggestions

-   Define the constant
-   Fix the name of the constant
-   Fix the namespace of the constant (FQN or use)
-   Remove the usage of the constant

  ----------- -------------------------------------------------------------
  Short name  Constants/UndefinedConstants

  Rulesets    `Analyze`{.interpreted-text role="ref"},
              `Analyze`{.interpreted-text role="ref"},
              `CompatibilityPHP72`{.interpreted-text role="ref"},
              `CI-checks`{.interpreted-text role="ref"},
              `CI-checks`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Quick (30 mins)

  Precision   Very high
  ----------- -------------------------------------------------------------

Undefined Functions
-------------------

Some functions are called, but not defined in the code. This means that
the functions are probably defined in a missing library, or in an
extension. If not, this will yield a Fatal error at execution.

``` {.php}
<?php

// Undefined function 
foo($a);

// valid function, as it belongs to the ext/yaml extension
$parsed = yaml_parse($yaml);

// This function is not defined in the a\b\c namespace, nor in the global namespace
a\b\c\foo(); 

?>
```

See also
[Functions](https://www.php.net/manual/en/language.functions.php).

### Suggestions

-   Fix the name of the function in the code
-   Remove the functioncall in the code
-   Define the function for the code to call it
-   Include the correct library in the code source

  ------------- ----------------------------------
  Short name    Functions/UndefinedFunctions

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- ----------------------------------

Undefined Insteadof
-------------------

`Insteadof` tries to replace a method with another, but it doesn\'t
exists. This happens when the replacing class is refactored, and some of
its definition are dropped.

`Insteadof` may replace a non-existing method with an existing one, but
not the contrary.

``` {.php}
<?php

trait A {
    function C (){}
}

trait B {
    function C (){}
}

class Talker {
    use A, B {
        B::C insteadof A;
        B::D insteadof A;
    }
}

new Talker();
?>
```

This error is not linted : it only appears at execution time.

See also
[Traits](https://www.php.net/manual/en/language.oop5.traits.php).

### Suggestions

-   Remove the insteadof expression
-   Fix the original method and replace it with an existing method

  ------------- ---------------------------------------------------------
  Short name    Traits/UndefinedInsteadof

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)

  Precision     High
  ------------- ---------------------------------------------------------

Undefined Interfaces
--------------------

Some typehints or `instanceof` that are relying on undefined interfaces
or classes. They will always return false. Any condition based upon them
are dead code.

``` {.php}
<?php

class var implements undefinedInterface {
    // If undefinedInterface is undefined, this code lints but doesn't run
}

if ($o instanceof undefinedInterface) {
    // This is silent dead code
}

function foo(undefinedInterface $a) {
    // This is dead code
    // it will probably be discovered at execution
}

?>
```

See also [Object
interfaces](https://www.php.net/manual/en/language.oop5.interfaces.php),
[Type
declarations](https://www.php.net/manual/en/functions.arguments.php#functions.arguments.type-declaration),
and
[Instanceof](https://www.php.net/manual/en/language.operators.type.php).

### Suggestions

-   Implement the missing interfaces
-   Remove the code governed by the missing interface : the whole method
    if it is an typehint, the whole if/then if it is a condition.

  ------------- -------------------------------------------------------------
  Short name    Interfaces/UndefinedInterfaces

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Precision     High

  Examples      `xataface-interfaces-undefinedinterfaces`{.interpreted-text
                role="ref"}
  ------------- -------------------------------------------------------------

Undefined Parent
----------------

List of properties and methods that are accessed using `parent` keyword
but are not defined in the
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
classes.

This may compile but, eventually yields a fatal error during execution.

``` {.php}
<?php

class theParent {
    // No bar() method
    // private bar() method is not accessible to theChild 
}

class theChild extends theParent {
    function foo() {
        // bar is defined in theChild, but not theParent
        parent::bar();
    }

    function bar() {

    }
}

?>
```

Note that if the
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
is defined using `extends someClass` but `someClass` is not available in
the tested code, it will not be reported : it may be in composer,
another dependency, or just missing.

See also
[parent](https://www.php.net/manual/en/keyword.%60parent%20%3Chttps://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php).php\>\`\_.

### Suggestions

-   Remove the usage of the found method
-   Add a definition for the method in the appropriate parent
-   Fix the name of the method, and replace it with a valid definition
-   Change \'parent\' with \'self\' if the method is eventually defined
    in the current class
-   Change \'parent\' with another object, if the method has been
    defined in another class
-   Add the \'extends\' keyword to the class, to actually have a parent
    class

  ------------- -----------------------------
  Short name    Classes/UndefinedParentMP

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Undefined Properties
--------------------

List of properties that are not explicitly defined in the class, its
parents or traits.

``` {.php}
<?php

class foo {
    // property definition
    private bar = 2;

    function foofoo() {
        // $this->bar is defined in the class
        // $this->barbar is NOT defined in the class
        return $this->bar + $this->barbar;
    }
}

?>
```

It is possible to spot unidentified properties by using the PHP\'s magic
methods `__get` and `__set`. Even if the class doesn\'t use magic
methods, any call to an undefined property will be directed to those
methods, and they can be used as a canary, warning that the code is
missing a definition.

``` {.php}
<?php

trait NoUnefinedProperties {
 function __get($name) {
     assert(false, "Attempt to read the $name property, on the class ".__CLASS__;
 }

 function __set($name, $value) {
     assert(false, "Attempt to read the $name property, on the class ".__CLASS__;
 }
}

?>
```

See also
[Properties](https://www.php.net/manual/en/language.oop5.properties.php).

### Suggestions

-   Add an explicit property definition, and give it `null` as a default
    value : this way, it behaves the same as undefined.

  ---------- ------------------------------------------------------------------------------------------------------------
  Short name Classes/UndefinedProperty

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-undefined-properties](https://github.com/dseguy/clearPHP/tree/master/rules/no-undefined-properties.md)

  Examples   `wordpress-classes-undefinedproperty`{.interpreted-text role="ref"},
             `mediawiki-classes-undefinedproperty`{.interpreted-text role="ref"}
  ---------- ------------------------------------------------------------------------------------------------------------

Undefined Trait
---------------

Those are undefined, traits .

When the using class or trait is instantiated, PHP emits a a fatal
error.

``` {.php}
<?php

use Composer/Component/someTrait as externalTrait;

trait t {
    function foo() {}
}

// This class uses trait that are all known
class hasOnlyDefinedTrait {
    use t, externalTrait;
}

// This class uses trait that are unknown
class hasUndefinedTrait {
    use unknownTrait, t, externalTrait;
}
?>
```

Trait which are referenced in a [use]{.title-ref} expression are
omitted: they are considered part of code that is probably outside the
current code, either omitted or in external component.

### Suggestions

-   Define the missing trait
-   Remove usage of the missing trait

  ------------- ---------------------------------------------------------
  Short name    Traits/UndefinedTrait

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Critical

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- ---------------------------------------------------------

Undefined Variable
------------------

Variable that is used before any creation.

It is recommended to use a default value for every variable used. When
not specified, the default value is set to `NULL` by PHP.

``` {.php}
<?php

// Adapted from the PHP manual
$var = 'Bob';
$Var = 'Joe';
// The following line may emit a warning : Undefined variable: $undefined
echo $var, $Var, $undefined;      // outputs Bob, Joe,


?>
```

Variable may be created in various ways : assignation, arguments,
foreach blind variables,
[static](https://www.php.net/manual/en/language.oop5.static.php) and
global variables.

This analysis doesn\'t handle dynamic variables, such as `$$x`. It also
doesn\'t handle variables outside a method or function.

See also [Variable
basics](https://www.php.net/manual/en/language.variables.basics.php).

### Suggestions

-   Remove the expression that is using the undefined variable
-   Fix the variable name
-   Define the variable by assigning a value to it, before using it

  ------------- ----------------------------------
  Short name    Variables/UndefinedVariable

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Undefined static:: Or self::
----------------------------

[self](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
and [static](https://www.php.net/manual/en/language.oop5.static.php)
refer to the current class, or one of its
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php).
The property or the method may be undefined.

``` {.php}
<?php

class x {
    static public function definedStatic() {}
    private definedStatic = 1;

    public function method() {
        self::definedStatic();
        self::undefinedStatic();

        static::definedStatic;
        static::undefinedStatic;
    }
}

?>
```

See also [Late \`Static
\<https://www.php.net/manual/en/language.oop5.static.php\>]{.title-ref}\_
Bindings \<<https://www.php.net/manual/en/language.oop5.late-%60static>
\<<https://www.php.net/manual/en/language.oop5.static.php>\>[\_-bindings.php\>]().

### Suggestions

-   Define the missing method or property
-   Remove usage of that undefined method or property
-   Fix name to call an actual local structure

  ---------- -------------------------------------------------------------
  Short name Classes/UndefinedStaticMP

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `xataface-classes-undefinedstaticmp`{.interpreted-text
             role="ref"},
             `sugarcrm-classes-undefinedstaticmp`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Unicode Escape Partial
----------------------

PHP 7 introduces a new escape sequence for strings : u{hex}. It is
backward incompatible with previous PHP versions for two reasons :

PHP 7 will recognize en replace those sequences, while PHP 5 keep them
intact. PHP 7 will halt on partial Unicode Sequences, as it tries to
understand them, but may fail.

``` {.php}
<?php

echo \u{1F418}\n; 
// PHP 5 displays the same string
// PHP 7 displays : an elephant

echo \u{NOT A UNICODE CODEPOINT}\n; 
// PHP 5 displays the same string
// PHP 7 emits a fatal error

?>
```

Is is recommended to check all those strings, and make sure they will
behave correctly in PHP 7.

  ---------- --------------------------------------------------------------
  Short name Php/UnicodeEscapePartial

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and older
  Version    

  Severity   Major

  Time To    Quick (30 mins)
  Fix        
  ---------- --------------------------------------------------------------

Unicode Escape Syntax
---------------------

Usage of the Unicode Escape syntax, with the `\u{xxxxx}` format,
available since PHP 7.0.

``` {.php}
<?php

// Produce an elephant icon in PHP 7.0+
echo \u{1F418};

// Produce the raw sequence in PHP 5.0
echo \u{1F418};

?>
```

See also [PHP RFC: Unicode Codepoint Escape
Syntax](https://wiki.php.net/rfc/unicode_escape), [Code
point](https://en.wikipedia.org/wiki/Code_point) and
[Unicode](https://en.wikipedia.org/wiki/Unicode).

  ---------- --------------------------------------------------------------
  Short name Php/UnicodeEscapeSyntax

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and more recent
  Version    

  Severity   Major

  Time To    Slow (1 hour)
  Fix        
  ---------- --------------------------------------------------------------

Uninitilized Property
---------------------

Uninitilized properties are not fully bootstrapped at the end of the
constructor.

Properties may be inited at definition time, along with their visibility
and type. Some types are not inited at definition time, as any object,
so they should be inited during constructor. At the end of the former,
all properties shall have a legit value, and be ready for usage.

``` {.php}
<?php

class x {
    private $foo = null;
    private $uninited;

    function __construct($arg) {
        $this->foo = $args;

        // $this->uninited is not inited, nor at definition, nor in constructor
        // it will hold null at the beginning of the next method call
    }
}

?>
```

### Suggestions

-   Remove the property, and move it to another class
-   Add an initialisation for this property

  ------------- ---------------------------------
  Short name    Classes/UninitedProperty

  Rulesets      `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Union Typehint
--------------

Union typehints allows the specification of several typehint for the
same argument or return value. This is a PHP 8.0 new feature.

Several typehints are specified at the same place as a single one. The
different values are separated by a pipe character `|`, like for
exceptions

``` {.php}
<?php

// Example from the RFC https://wiki.php.net/rfc/union_types_v2
class Number {
    private int|float $number;

    public function setNumber(int|float $number): void {
        $this->number = $number;
    }

    public function getNumber(): int|float {
        return $this->number;
    }
}
?>
```

Union types are not compatible with PHP 7 and older.

See also [PHP RFC: Union Types
2.0](https://wiki.php.net/rfc/union_types_v2).

### Suggestions

-   

  ---------- ----------------------------------------------------------------
  Short name Php/Php80UnionTypehint

  Rulesets   `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"},
             `CompatibilityPHP73`{.interpreted-text role="ref"},
             `CompatibilityPHP74`{.interpreted-text role="ref"}

  Php        8.0+
  Version    

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        
  ---------- ----------------------------------------------------------------

Unitialized Properties
----------------------

Properties that are not initialized in the constructor, nor at
definition.

``` {.php}
<?php

class X {
    private $i1 = 1, $i2;
    protected $u1, $u2;

    function __construct() {
        $this->i2 = 1 + $this->u2;
    }

    function m() {
        echo $this->i1, $this->i2, $this->u1, $this->u2;
    }
}
?>
```

With the above class, when m() is accessed right after instantiation,
there will be a missing property. Using default values at property
definition, or setting default values in the constructor ensures that
the created object is consistent.

### Suggestions

-   Add an explicit initialization for each property.

  ------------- --------------------------------------------------------
  Short name    Classes/UnitializedProperties

  Rulesets      `Suggestions`{.interpreted-text role="ref"},
                `Top10`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Examples      `spip-classes-unitializedproperties`{.interpreted-text
                role="ref"}
  ------------- --------------------------------------------------------

Unknown Parameter Name
----------------------

The name of the parameter doesn\'t belong to the method signature. Named
arguments was introduced in PHP 8.0.

``` {.php}
<?php

// All good
foo(a:1, b:2, c:3);
foo(...['a':1, 'b':2, 'c':3]);

// A is not a parameter name, it should be a : names are case sensitive
foo(A:1, b:2, c:3);
foo(...['A':1, 'b':2, 'c':3]);

function foo($a, $b, $c) {}
?>
```

See also [Named Arguments](https://wiki.php.net/rfc/named_params).

### Suggestions

-   Fix the name of the parameter and use a valid one
-   Remove the parameter name, and revert to positional notation

  ------------- ----------------------------------
  Short name    Functions/UnknownParameterName

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Php Version   8.0+

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Unknown Pcre2 Option
--------------------

`PCRE2` supports different options, compared to `PCRE1`. `PCRE2` was
adopted with PHP 7.3.

The `S` modifier : it used to tell PCRE to spend more time studying the
regex, so as to be faster at execution. This is now the default
behavior, and may be dropped from the regex.

The `X` modifier : `X` is still existing with `PCRE2`, though it is now
the default for `PCRE2`, and not for PHP as time of writing. In
particular,
`Any backslash in a pattern that is followed by a letter that has no special meaning causes an error, thus reserving these combinations for future expansion.`.
It is recommended to avoid using useless sequence s in regex to get
ready for that change. All the following letters `gijkmoqyFIJMOTY` .
Note that `clLpPuU` are valid `PRCE` sequences, and are probably failing
for other reasons.

``` {.php}
<?php

// \y has no meaning. With X option, this leads to a regex compilation error, and a failed test.
preg_match('/ye\y/', $string);
preg_match('/ye\y/X', $string);

?>
```

See also [Pattern
Modifiers](https://www.php.net/manual/en/reference.pcre.pattern.modifiers.php)
and [PHP RFC: PCRE2
migration](https://wiki.php.net/rfc/pcre2-migration).

  ------------- -------------------------------------------
  Short name    Php/UnknownPcre2Option

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CompatibilityPHP73`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- -------------------------------------------

Unkown Regex Options
--------------------

Regex support in PHP accepts the following list of options :
`eimsuxADJSUX`.

All other letter used as option are not supported : depending on the
situation, they may be ignored or raise an error.

``` {.php}
<?php

// all options are available
if (preg_match('/\d+/isA', $string, $results)) { }

// p and h are not regex options, p is double
if (preg_match('/\d+/php', $string, $results)) { }

?>
```

See also [Pattern
Modifiers](https://www.php.net/manual/en/reference.pcre.pattern.modifiers.php)

  ------------- ------------------------------
  Short name    Structures/UnknownPregOption

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ------------------------------

Unpacking Inside Arrays
-----------------------

The variadic operator is now available inside arrays. Until PHP 7.4, it
is not possible to use the variadic operator, or `...` inside arrays.

The workaround is to use
[array\_merge()](https://www.php.net/array_merge), after checking that
arrays are not empty.

``` {.php}
<?php

$a = ['a', 'b', 'c'];
$b = ['d', 'e', 'f'];

// PHP 7.4 
$c = [...$a, ...$b];

// PHP 7.3 and older
$c = array_merge($a, $b);

?>
```

See also [Spread Operator in Array Expression](https://wiki.php.net/rfc/spread_operator_for_array) and

:   [PHP 5.6 and the Splat
    Operator](https://lornajane.net/posts/2014/php-5-6-and-the-splat-operator)
    .

### Suggestions

-   Replace array\_merge() with `...`.

  ---------- ------------------------------------------------------------------
  Short name Php/UnpackingInsideArrays

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"},
             `CompatibilityPHP73`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        7.4+
  Version    

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        
  ---------- ------------------------------------------------------------------

Unpreprocessed Values
---------------------

Preprocessing values is the preparation of values before PHP executes
the code.

There is no macro language in PHP, that prepares the code before
compilation, bringing some comfort and short syntax. Most of the time,
one uses PHP itself to preprocess data.

For example :

``` {.php}
<?php
    $days_en = 'monday,tuesday,wednesday,thursday,friday,saturday,sunday';
    $days_zh = '星期－,星期二,星期三,星期四,星期五,星期六,星期日';

    $days = explode(',', $lang === 'en' ? $days_en : $days_zh); 
?>
```

could be written

``` {.php}
<?php
    if ($lang === 'en') {
        $days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    } else {
        $days = ['星期－', '星期二', '星期三', '星期四', '星期五', '星期六', '星期日'];
    }
?>
```

and avoid preprocessing the string into an array first.

Preprocessing could be done anytime the script includes all the needed
values to process the expression.

### Suggestions

-   Preprocess the values and hardcode them in PHP. Do not use PHP to
    calculate something at the last moment.
-   Use already processed values, or cache to avoid calculating the
    value each hit.
-   Create a class that export the data in the right format for every
    situation, including the developer\'s comfort.

  ---------- ------------------------------------------------------------------------------------------------
  Short name Structures/Unpreprocessed

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [always-preprocess](https://github.com/dseguy/clearPHP/tree/master/rules/always-preprocess.md)

  Examples   `zurmo-structures-unpreprocessed`{.interpreted-text role="ref"},
             `piwigo-structures-unpreprocessed`{.interpreted-text role="ref"}
  ---------- ------------------------------------------------------------------------------------------------

Unreachable Class Constant
--------------------------

Class constants may be unreachable due to visibility configuration.

Since PHP 7.1, class constants support visibility. Their usage may be
restricted to the current class, or `private`, to classes that extends
or are extended by the current class, or `protected`. They may also be
`public`, just like it was before.

``` {.php}
<?php

class Foo{
    private const PRIVATE = 1;
            const PUBLIC = 3;
}

// PHP 7.1- and older
echo Foo::PUBLIC;

// This is not accessible
echo Foo::PRIVATE;

?>
```

See also [Class
Constant](https://www.php.net/manual/en/language.oop5.constants.php) and
[PHP RFC: Support Class Constant
Visibility](https://wiki.php.net/rfc/class_const_visibility).

### Suggestions

-   Make the class constant protected, when the call to the constant is
    inside a related class.
-   Create another constant, that may be accessible
-   Make the class constant public

  ------------- ---------------------------------
  Short name    Classes/UnreachableConstant

  Rulesets      `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ---------------------------------

Unreachable Code
----------------

Code may be unreachable, because other instructions prevent its
reaching.

For example, it be located after throw, return,
[exit()](https://www.php.net/%60exit%20%3Chttps://www.www.php.net/exit)\>[\_,
\`die() \<https://www.php.net/\`die
\<https://www.php.net/die\>]{.title-ref}\_\>[\_, goto, \`break
\<https://www.php.net/manual/en/control-structures.break.php\>]{.title-ref}\_
or
[continue](https://www.php.net/manual/en/control-structures.continue.php)
: this way, it cannot be reached, as the previous instruction will
divert the engine to another part of the code.

``` {.php}
<?php

function foo() {
    $a++;
    return $a;
    $b++;      // $b++ can't be reached;
}

function bar() {
    if ($a) {
        return $a;
    } else {
        return $b;
    }
    $b++;      // $b++ can't be reached;
}

foreach($a as $b) {
    $c += $b;
    if ($c > 10) {
        continue 1;
    } else {
        $c--;
        continue;
    }
    $d += $e;   // this can't be reached
}

$a = 1;
goto B;
class foo {}    // Definitions are accessible, but not functioncalls
B: 
echo $a;

?>
```

This is dead code, that may be removed.

### Suggestions

-   Remove the unreachable code
-   Remove the blocking expression, and let the code execute

  ---------- --------------------------------------------------------------------------------------
  Short name Structures/UnreachableCode

  Rulesets   `Dead code <dead-code>`{.interpreted-text role="ref"}, `Suggestions`{.interpreted-text
             role="ref"}

  Severity   Major

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [no-dead-code](https://github.com/dseguy/clearPHP/tree/master/rules/no-dead-code.md)
  ---------- --------------------------------------------------------------------------------------

Unresolved Catch
----------------

Catch clauses do not check for Exception existence.

Catch clauses check that the emitted expression is of the requested
Class, but if that class doesn\'t exist in the code, the catch clause is
always false. This is dead code.

``` {.php}
<?php

try {
    // doSomething()
} catch {TypoedExxeption $e) { // Do not exist Exception
    // Fix this exception
} catch {Stdclass $e) {        // Exists, but is not an exception
    // Fix this exception
} catch {Exception $e) {        // Actual and effective catch
    // Fix this exception
}
?>
```

### Suggestions

-   Fix the name of the exception
-   Remove the catch clause
-   Add a use expression with a valid name
-   Create/import the missing exception

  ----------- ----------------------------------------------------------------------------------------------------
  Short name  Classes/UnresolvedCatch

  Rulesets    `Dead code <dead-code>`{.interpreted-text role="ref"}

  Severity    Major

  Time To Fix Quick (30 mins)

  Precision   High

  ClearPHP    [no-unresolved-catch](https://github.com/dseguy/clearPHP/tree/master/rules/no-unresolved-catch.md)
  ----------- ----------------------------------------------------------------------------------------------------

Unresolved Classes
------------------

The following classes are instantiated in the code, but their definition
couldn\'t be found.

``` {.php}
<?php

class Foo extends Bar {
    private function foobar() {
        // here, parent is not resolved, as Bar is not defined in the code.
        return parent::$prop;
    }
}

?>
```

### Suggestions

-   Check for namespaces and aliases and make sure they are correctly
    configured.

  ------------- -----------------------------
  Short name    Classes/UnresolvedClasses

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Unresolved Instanceof
---------------------

The
[instanceof](https://www.php.net/manual/en/language.operators.type.php)
operator doesn\'t confirm if the compared class exists.

It checks if an variable is of a specific class. However, if the
referenced class doesn\'t exist, because of a bug, a missed inclusion or
a typo, the operator always fails, without a warning.

``` {.php}
<?php

namespace X {
    class C {}

    // This is OK, as C is defined in X
    if ($o instanceof C) { }

    // This is not OK, as C is not defined in global
    // instanceof respects namespaces and use expressions
    if ($o instanceof \C) { }

    // This is not OK, as undefinedClass
    if ($o instanceof undefinedClass) { }

    // This is not OK, as $class is now a full namespace. It actually refers to \c, which doesn't exist
    $class = 'C';
    if ($o instanceof $class) { }
}
?>
```

Make sure the following classes are well defined.

See also
[Instanceof](https://www.php.net/manual/en/language.operators.type.php).

### Suggestions

-   Remove the call to instanceof and all its dependencies.
-   Fix the class name and use a class existing in the project.

  ---------- --------------------------------------------------------------------------------------------------------------
  Short name Classes/UnresolvedInstanceof

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `Dead code <dead-code>`{.interpreted-text role="ref"},
             `Top10`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [no-unresolved-instanceof](https://github.com/dseguy/clearPHP/tree/master/rules/no-unresolved-instanceof.md)

  Examples   `wordpress-classes-unresolvedinstanceof`{.interpreted-text role="ref"}
  ---------- --------------------------------------------------------------------------------------------------------------

Unresolved Use
--------------

The following use instructions cannot be resolved to a known class,
interface, trait, constant or function. They should be dropped or fixed.

A known class, interface, trait, constant or function is defined in PHP
(standard), an extension, a stub or the current code.

``` {.php}
<?php

namespace A {
    // class B is defined
    class B {}
    // class C is not defined
}

namespace X/Y {

    use A/B;  // This use is valid
    use A/C;  // This use point to nothing.

    new B();
    new C();
}

?>
```

Use expression are options for the current namespace.

See also [Using namespaces:
Aliasing/Importing](https://www.php.net/manual/en/language.namespaces.importing.php).

### Suggestions

-   Remove the use expression
-   Fix the use expression

  ----------- ------------------------------------------------------------------------------------------------
  Short name  Namespaces/UnresolvedUse

  Rulesets    `Analyze`{.interpreted-text role="ref"}

  Severity    Major

  Time To Fix Slow (1 hour)

  Precision   High

  ClearPHP    [no-unresolved-use](https://github.com/dseguy/clearPHP/tree/master/rules/no-unresolved-use.md)
  ----------- ------------------------------------------------------------------------------------------------

Unserialize Second Arg
----------------------

Since PHP 7, [unserialize()](https://www.php.net/unserialize) function
has a second argument that limits the classes that may be unserialized.
In case of a breach, this is limiting the classes accessible from
[unserialize()](https://www.php.net/unserialize).

One way to exploit unserialize, is to make PHP unserialized the data to
an available class, may be one that may be auto-loaded.

``` {.php}
<?php

// safe unserialization : only the expected class will be extracted
$serialized = 'O:7:dbClass:0:{}';
$var = unserialize($serialized, ['dbClass']);
$var->connect();

// unsafe unserialization : $var may be of any type that was in the serialized string
// although, here, this is working well.
$serialized = 'O:7:dbClass:0:{}';
$var = unserialize($serialized);
$var->connect();

// unsafe unserialization : $var is not of the expected type.
// and, here, this will lead to disaster.
$serialized = 'O:10:debugClass:0:{}';
$var = unserialize($serialized);
$var->connect();

?>
```

See also [unserialize()](https://www.php.net/unserialize), [Securely
Implementing (De)Serialization in
PHP](https://paragonie.com/blog/2016/04/securely-implementing-de-serialization-in-php),
and [Remote code execution via PHP
\[Unserialize\]](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/).

### Suggestions

-   Add a list of class as second argument of any call to unserialize().
    This is valid for PHP 7.0 and later.

  ---------- -------------------------------------------------------------
  Short name Security/UnserializeSecondArg

  Rulesets   `Security`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and more recent
  Version    

  Severity   Critical

  Time To    Quick (30 mins)
  Fix        

  Examples   `piwigo-security-unserializesecondarg`{.interpreted-text
             role="ref"},
             `livezilla-security-unserializesecondarg`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Unset In Foreach
----------------

Unset applied to the variables of a `foreach` loop are useless. Those
variables are copies and not the actual value. Even if the value is a
reference, unsetting it has no effect on the original array : the only
effect may be indirect, on elements inside an array, or on properties
inside an object.

``` {.php}
<?php

// When unset is useless
$array = [1, 2, 3];
foreach($array as $a) {
    unset($a);
}

print_r($array); // still [1, 2, 3]

foreach($array as $b => &$a) {
    unset($a);
}

print_r($array); // still [1, 2, 3]

// When unset is useful
$array = [ [ 'c' => 1] ]; // Array in array
foreach($array as &$a) {
    unset(&$a['c']);
}

print_r($array); // now [ ['c' => null] ]

?>
```

See also
[foreach](https://www.php.net/manual/en/control-structures.foreach.php).

### Suggestions

-   Drop the unset

  ------------- ----------------------------------------------
  Short name    Structures/UnsetInForeach

  Rulesets      `Dead code <dead-code>`{.interpreted-text
                role="ref"}, `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------------

Unsupported Types With Operators
--------------------------------

Arrays, resources and objects are generally not accepted with unary and
binary operators.

The operators are [+]{.title-ref}, [-]{.title-ref}, [\*]{.title-ref},
[/]{.title-ref}, [\*\*]{.title-ref}, [%]{.title-ref},
[\<\<]{.title-ref}, [\>\>]{.title-ref}, [&]{.title-ref},
[\|]{.title-ref}, [\^]{.title-ref}, [\~]{.title-ref}, [++]{.title-ref}
and [\--]{.title-ref}.

``` {.php}
<?php

var_dump([] % [42]);
// int(0) in PHP 7.x
// TypeError in PHP 8.0 + 

// Also impossible usage : index are string or int
$a = [];
$b = $c[$a]; 

?>
```

In PHP 8.0, the rules have been made stricter and more consistent.

The only valid operator is [+]{.title-ref}, combined with arrays in both
operands. Other situation will throw [TypeError]{.title-ref}.

See also [Stricter type checks for arithmetic/bitwise
operators](https://wiki.php.net/rfc/arithmetic_operator_type_checks) and
[TypeError](https://www.php.net/manual/en/class.typeerror.php).

### Suggestions

-   Do not use those values with those operators
-   Use a condition to skip this awkward situation
-   Add an extra step to turn this value into a valid type

  ------------- -------------------------------------------
  Short name    Structures/UnsupportedTypesWithOperators

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CompatibilityPHP80`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     Medium
  ------------- -------------------------------------------

Unthrown Exception
------------------

These are exceptions that are defined in the code but never thrown.

``` {.php}
<?php

//This exception is defined but never used in the code.
class myUnusedException extends \Exception {}

//This exception is defined and used in the code.
class myUsedException extends \Exception {}

throw new myUsedException('I was called');

?>
```

See also
[Exceptions](https://www.php.net/manual/en/language.exceptions.php).

  ---------- ----------------------------------------------------------------------------------------------------------
  Short name Exceptions/Unthrown

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `Dead code <dead-code>`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-unthrown-exceptions](https://github.com/dseguy/clearPHP/tree/master/rules/no-unthrown-exceptions.md)
  ---------- ----------------------------------------------------------------------------------------------------------

Unused Arguments
----------------

Those arguments are not used in the method or function.

Unused arguments should be removed in functions : they are just dead
code.

Unused argument may have to stay in methods, as the signature is
actually defined in the
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
class.

``` {.php}
<?php

// $unused is in the signature, but not used. 
function foo($unused, $b, $c) {
    return $b + $c;
}
?>
```

### Suggestions

-   Drop the argument from the signature
-   Actually use that argument in the body of the method

  ---------- -------------------------------------------------------------
  Short name Functions/UnusedArguments

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `thinkphp-functions-unusedarguments`{.interpreted-text
             role="ref"},
             `phpmyadmin-functions-unusedarguments`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Unused Class Constant
---------------------

The class constant is unused. Consider removing it.

``` {.php}
<?php

class foo {
    public const UNUSED = 1; // No mention in the code

    private const USED = 2;  // used constant

    function bar() {
        echo self::USED;
    }
}

?>
```

### Suggestions

-   Remove the class constant
-   Use the class constant

  ------------- ------------------------------------
  Short name    Classes/UnusedConstant

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------

Unused Classes
--------------

The following classes are never explicitly used in the code.

Note that this may be valid in case the current code is a library or
framework, since it defines classes that are used by other (unprovided)
codes. Also, this analyzer may find classes that are, in fact,
dynamically loaded.

``` {.php}
<?php

class unusedClasss {}
class usedClass {}

$y = new usedClass();

?>
```

  ------------- ----------------------------------------------
  Short name    Classes/UnusedClass

  Rulesets      `Dead code <dead-code>`{.interpreted-text
                role="ref"}, `Analyze`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------------

Unused Constants
----------------

Those constants are defined in the code but never used. Defining unused
constants slow down the application, as they are executed and stored in
PHP hashtables.

``` {.php}
<?php

// const-defined constant
const USED_CONSTANT  = 0;
const UNUSED_CONSTANT = 1 + USED_CONSTANT;

// define-defined constant
define('ANOTHER_UNUSED_CONSTANT', 3);

?>
```

It is recommended to comment them out, and only define them when it is
necessary.

### Suggestions

-   Make use of the constant
-   Remove the constant

  ------------- -------------------------------------------
  Short name    Constants/UnusedConstants

  Rulesets      `Dead code <dead-code>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- -------------------------------------------

Unused Exception Variable
-------------------------

The variable from a catch clause is not used. It is expected to be used,
either by chaining the exception, or logging the message.

In PHP 8.0, this variable may be omitted.

``` {.php}
<?php

try{
    doSomething();
} catch (A $a) {
    // $a is caught, but not used here
} catch (B $b) {
    // $b is caught, and used
    log($b->getMessage());
} catch (C) {
    // Caught and ignored (PHP 8.0 +)
}

?>
```

### Suggestions

-   Drop the variable in the clause expression (PHP 8.0 and more recent)
-   Chain the exception
-   Log the exception message

  ------------- ------------------------------------
  Short name    Exceptions/UnusedExceptionVariable

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- ------------------------------------

Unused Functions
----------------

The functions below are unused. They look like dead code.

Recursive functions, level 1, are detected : they are only reported when
a call from outside the function is made. Recursive functions calls of
higher level (A calls B calls A) are not handled.

``` {.php}
<?php

function used() {}
// The 'unused' function is defined but never called
function unused() {}

// The 'used' function is called at least once
used();

?>
```

### Suggestions

-   Use the function in the code
-   Remove the functions from the code

  ---------- -------------------------------------------------------------
  Short name Functions/UnusedFunctions

  Rulesets   `Dead code <dead-code>`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `woocommerce-functions-unusedfunctions`{.interpreted-text
             role="ref"},
             `piwigo-functions-unusedfunctions`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Unused Global
-------------

A global keyword is used in a method, yet the variable is not actually
used. This makes PHP import values for nothing, or may create
interference

``` {.php}
<?php
    function foo() {
        global bar;

        return 1;
    }
?>
```

### Suggestions

-   Remove the global declaration
-   Remove the global variable altogether

  ------------- -----------------------------------------------------
  Short name    Structures/UnusedGlobal

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `dolphin-structures-unusedglobal`{.interpreted-text
                role="ref"}
  ------------- -----------------------------------------------------

Unused Inherited Variable In Closure
------------------------------------

Some closures forgot to make usage of inherited variables.

[Closure](https://www.php.net/manual/en/class.closure.php) have two
separate set of incoming variables : the arguments (between parenthesis)
and the inherited variables, in the \'use\' clause. Inherited variables
are extracted from the local environment at creation time, and keep
their value until execution.

The reported closures are requesting some local variables, but do not
make any usage of them. They may be considered as dead code.

``` {.php}
<?php

// In this closure, $y is forgotten, but $u is used.
$a = function ($y) use ($u) { return $u; };

// In this closure, $u is forgotten
$a = function ($y, $z) use ($u) { return $u; };

?>
```

See also [Anonymous
functions](https://www.php.net/manual/en/functions.anonymous.php).

### Suggestions

-   Remove the unused inherited variable
-   Make us of the unused inherited variable

  ---------- ----------------------------------------------------------------
  Short name Functions/UnusedInheritedVariable

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Dead code <dead-code>`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `shopware-functions-unusedinheritedvariable`{.interpreted-text
             role="ref"},
             `mautic-functions-unusedinheritedvariable`{.interpreted-text
             role="ref"}
  ---------- ----------------------------------------------------------------

Unused Interfaces
-----------------

Those interfaces are defined and never used. They should be removed, as
they are dead code.

Interfaces may be use as
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
for other interfaces, as typehint (argument, return and property), in
instance of.

``` {.php}
<?php

interface used {}
interface unused {}

// Used by implementation
class c implements used {}

// Used by extension
interface j implements used {}

$x = new c;

// Used in a instanceof
var_dump($x instanceof used); 

// Used in a typehint
function foo(Used $x) {}

?>
```

### Suggestions

-   Remove the interface
-   Actually use the interface

  ------------- --------------------------------------------------------
  Short name    Interfaces/UnusedInterfaces

  Rulesets      `Dead code <dead-code>`{.interpreted-text role="ref"},
                `Suggestions`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)

  Examples      `tine20-interfaces-unusedinterfaces`{.interpreted-text
                role="ref"}
  ------------- --------------------------------------------------------

Unused Label
------------

Some labels have been defined in the code, but they are not used. They
may be removed as they are dead code.

``` {.php}
<?php

$a = 0;
A: 

    ++$a;

    // A loop. A: is used
    if ($a < 10) { goto A; }

// B is never called explicitely. This is useless.
B: 

?>
```

There is no analysis for undefined goto call, as PHP checks that goto
has a destination label at compile time :

See also
[Goto](https://www.php.net/manual/en/control-structures.goto.php).

### Suggestions

-   Remove the unused label
-   Add a goto call to this label
-   Check for spelling mistakes

  ------------- -------------------------------------------
  Short name    Structures/UnusedLabel

  Rulesets      `Dead code <dead-code>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------------------

Unused Methods
--------------

Those methods are never called.

They are probably dead code, unless they are called dynamically.

This analysis omits methods which are in a class that makes dynamical
[self](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
calls : `$this->$m()`. That way, any method may be called.

This analysis omits methods which are overwritten by a child class. That
way, they are considered to provide a default behavior.

``` {.php}
<?php

class foo {
    public function used() {
        $this->used();
    }

    public function unused() {
        $this->used();
    }
}

class bar extends foo {
    public function some() {
        $this->used();
    }
}

$a = new foo();
$a->used();

?>
```

See also [Dead Code: Unused
Method](https://vulncat.fortify.com/en/detail?id=desc.structural.java.dead_code_unused_method).

### Suggestions

-   Make use of the method
-   Remove the method
-   Move the method to another class

  ------------- -------------------------------------------
  Short name    Classes/UnusedMethods

  Rulesets      `Dead code <dead-code>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- -------------------------------------------

Unused Private Methods
----------------------

Private methods that are not used are dead code.

Private methods are reserved for the defining class. Thus, they must be
used with the current class, with `$this` or `self\:\:`.

Protected methods, in a standalone class, are also included.

``` {.php}
<?php

class Foo {
    // Those methods are used
    private function method() {}
    private static function staticMethod() {}

    // Those methods are not used
    private function unusedMethod() {}
    private static function staticUnusedMethod() {}

    public function bar() {
        self::staticMethod();
        $this->method();
    }
}

?>
```

This analysis skips classes that makes
[self](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
dynamic calls, such as `$this->$method()`.

### Suggestions

-   Remove the private method, as it is unused
-   Add a call to this private method
-   Change method visibility to make it available to other classes

  ------------- -------------------------------------------
  Short name    Classes/UnusedPrivateMethod

  Rulesets      `Dead code <dead-code>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------------------

Unused Private Properties
-------------------------

Unused [static](https://www.php.net/manual/en/language.oop5.static.php)
properties should be removed.

Unused private properties are dead code. They are usually leftovers of
development or refactorisation : they used to have a mission, but are
now left.

Being private, those properties are only accessible to the current class
or trait. As such, validating the

``` {.php}
<?php

class foo {
    // This is a used property (see bar method)
    private $used = 1;

    // This is an unused property
    private $unused = 2;

    function bar($a) {
        $this->used += $a;

        return $this->used;
    }
}

?>
```

### Suggestions

-   Remove the property altogether
-   Check if the property wasn\'t forgotten in the rest of the class
-   Check if the property is correctly named
-   Change the visibility to protected or public : may be a visibility
    refactoring was too harsh

  ---------- -------------------------------------------------------------
  Short name Classes/UnusedPrivateProperty

  Rulesets   `Dead code <dead-code>`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `openemr-classes-unusedprivateproperty`{.interpreted-text
             role="ref"},
             `phpadsnew-classes-unusedprivateproperty`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Unused Protected Methods
------------------------

The following protected methods are unused in children class. As such,
they may be considered for being private.

Methods reported by this analysis are not used by children, yet they are
protected.

``` {.php}
<?php

class Foo {
    // This method is not used
    protected function unusedBar() {}
    protected function usedInFoo() {}
    protected function usedInFooFoo() {}

    public function bar2() {
        // some code
        $this->usedInFoo();
    }
}

class FooFoo extends Foo {
    protected function bar() {}

    public function bar2() {
        // some code
        $this->usedInFooFoo();
    }
}

class someOtherClass {
    protected function bar() {
        // This is not related to foo.
        $this->unusedbar();
    }
}

?>
```

No usage of those methods were found.

This analysis is impacted by dynamic method calls.

### Suggestions

-   Make use of the protected method in the code
-   Remove the method

  ------------- -------------------------------------------
  Short name    Classes/UnusedProtectedMethods

  Rulesets      `Dead code <dead-code>`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- -------------------------------------------

Unused Returned Value
---------------------

The function called returns a value, which is ignored.

Usually, this is a sign of dead code, or a missed check on the results
of the functioncall. At times, it may be a valid call if the function
has voluntarily no return value.

It is recommended to add a check on the return value, or remove the
call.

``` {.php}
<?php

// simplest form
function foo() {
    return 1;
}

foo();

// In case of multiple return, any one that returns something means that return value is meaningful
function bar() {
    if (rand(0, 1)) {
        return 1;
    } else {
        return ;
    }
}

bar();

?>
```

Note that this analysis ignores functions that return void (same meaning
that PHP 7.1 : return ; or no return in the function body).

  ------------- ----------------------------------------------
  Short name    Functions/UnusedReturnedValue

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `Dead code <dead-code>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------------

Unused Trait In Class
---------------------

A trait has been summoned in a class, but is not used. Traits may be
used as a copy/paste of code, bringing a batch of methods and properties
to a class. In the current case, the imported trait is never called. As
such, it may be removed.

Currently, the analysis covers only traits that are used in the class
where they are imported. Also, the properties are not covered yet.

``` {.php}
<?php

trait t {
    function foo() { return 1;}
}

// this class imports and uses the trait
class UsingTrait {
    use t;

    function bar() {
        return $this->foo() + 1;
    }
}

// this class imports but doesn't uses the trait
class UsingTrait {
    use t;

    function bar() {
        return 1;
    }
}

?>
```

There are some sneaky situations, where a trait falls into decay : for
example, creating a method in the importing class, with the name of a
trait class, will exclude the trait method, as the class method has
priority. Other precedence rules may lead to the same effect.

See also
[Traits](https://www.php.net/manual/en/language.oop5.traits.php).

### Suggestions

-   Remove the trait from the class
-   Actually use the trait, at least in the importing class
-   Use conflict resolution to make the trait accessible

  ------------- ---------------------------------
  Short name    Traits/UnusedClassTrait

  Rulesets      `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Unused Use
----------

Unused use statements. They may be removed, as they clutter the code and
slows PHP by forcing it to search in this list for nothing.

``` {.php}
<?php

use A as B; // Used in a new call.
use Unused; // Never used. May be removed

$a = new B();

?>
```

### Suggestions

-   Remove the unused use

  ----------- ------------------------------------------------------------------------------------------
  Short name  Namespaces/UnusedUse

  Rulesets    `Dead code <dead-code>`{.interpreted-text role="ref"}

  Severity    Major

  Time To Fix Instant (5 mins)

  Precision   Very high

  ClearPHP    [no-useless-use](https://github.com/dseguy/clearPHP/tree/master/rules/no-useless-use.md)
  ----------- ------------------------------------------------------------------------------------------

Unusual Case For PHP Functions
------------------------------

Usually, PHP functions are written all in lower case.

``` {.php}
<?php

// All uppercases PHP functions
ECHO STRTOLOWER('This String');

?>
```

  ------------- -------------------------------------------------------------
  Short name    Php/UpperCaseFunction

  Rulesets      `Coding Conventions <coding-conventions>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)

  Precision     High
  ------------- -------------------------------------------------------------

Upload Filename Injection
-------------------------

When receiving a file via Upload, it is recommended to store it under a
[self](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)-generated
name. Any storage that uses the original filename, or even a part of it
may be vulnerable to injections.

``` {.php}
<?php

// Security error ! the $_FILES['upload']['filename'] is provided by the sender.
// 'a.<script>alert(\'a\')</script>'; may lead to a HTML injection.
$extension = substr( strrchr($_FILES['upload']['name'], '.') ,1);
if (!in_array($extension, array('gif', 'jpeg', 'jpg')) { 
    // process error
    continue;
}
// Md5 provides a name without special characters
$name = md5($_FILES['upload']['filename']);
if(@move_uploaded_file($_FILES['upload']['tmp_name'], '/var/no-www/upload/'.$name.'.'.$extension)) {
    safeStoring($name.'.'.$extension, $_FILES['upload']['filename']);
}

// Security error ! the $_FILES['upload']['filename'] is provided by the sender.
if(@move_uploaded_file($_FILES['upload']['tmp_name'], $_FILES['upload']['filename'])) {
    safeStoring($_FILES['upload']['filename']);
}

// Security error ! the $_FILES['upload']['filename'] is provided by the sender.
// 'a.<script>alert('a')</script>'; may lead to a HTML injection.
$extension = substr( strrchr($_FILES['upload']['name'], '.') ,1);
$name = md5($_FILES['upload']['filename']);
if(@move_uploaded_file($_FILES['upload']['tmp_name'], $name.'.'.$extension)) {
    safeStoring($name.'.'.$extension, $_FILES['upload']['filename']);
}

?>
```

It is highly recommended to validate any incoming file, generate a name
for it, and store the result in a folder outside the web folder. Also,
avoid accepting PHP scripts, if possible.

See also
[\[CVE-2017-6090\]](https://cxsecurity.com/issue/WLB-2017100031),
[CWE-616: Incomplete Identification of Uploaded File
Variables](https://cwe.mitre.org/data/definitions/616.html), [Why File
Upload Forms are a Major Security
Threat](https://www.acunetix.com/websitesecurity/upload-forms-threat/).

### Suggestions

-   Validate uploaded filenames
-   Rename files upon storage, and keep the original name in a database

  ------------- ----------------------------------
  Short name    Security/UploadFilenameInjection

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)
  ------------- ----------------------------------

Use ::Class Operator
--------------------

Use `\:\:class` to hardcode class names, instead of strings.

This is actually faster than strings, which are parsed at execution
time, while `\:\:class` is compiled, making it faster to execute.

`\:\:class` operator is also able to handle use expressions, including
aliases and local namespace. The code is easier to maintain. For
example, the target class\'s namespace may be renamed, without changing
the `\:\:class`, while the string must be updated.

`\:\:class` operator works with `self` and `static`keywords.

``` {.php}
<?php

namespace foo\bar;

use foo\bar\X as B;

class X {}

$className = '\foo\bar\X';

$className = foo\bar\X::class;

$className = B\X;

$object = new $className;

?>
```

This is not possible when building the name of the class with
concatenation.

This is a micro-optimization. This also helps
[static](https://www.php.net/manual/en/language.oop5.static.php)
analysis, as it gives more information at compile time to analyse.

See also
[::class](https://www.php.net/manual/en/language.oop5.basic.php#language.oop5.basic.class.class).

### Suggestions

-   Replace strings by the ::class operator whenever possible

  ------------- -------------------------------------------------------
  Short name    Classes/UseClassOperator

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `Performances`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)

  Precision     Medium

  Examples      `typo3-classes-useclassoperator`{.interpreted-text
                role="ref"}
  ------------- -------------------------------------------------------

Use === null {#use-===-null}
------------

It is faster to use === null instead of
[is\_null()](https://www.php.net/is_null).

``` {.php}
<?php

// Operator === is fast
if ($a === null) {

}

// Function call is slow 
if (is_null($a)) {

}


?>
```

### Suggestions

-   Use === comparison

  ---------- ------------------------------------------------------------------------------------------------------------------
  Short name Php/IsnullVsEqualNull

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `php-cs-fixable`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [avoid-those-slow-functions](https://github.com/dseguy/clearPHP/tree/master/rules/avoid-those-slow-functions.md)
  ---------- ------------------------------------------------------------------------------------------------------------------

Use Array Functions
-------------------

There are a lot of native PHP functions for arrays. It is often faster
to take advantage of them than write a loop.

-   [array\_push()](https://www.php.net/array_push) : use
    [array\_merge()](https://www.php.net/array_merge)
-   [array\_slice()](https://www.php.net/array_slice) : use
    [array\_chunk()](https://www.php.net/array_chunk)
-   index access : use
    [array\_column()](https://www.php.net/array_column)
-   append \`\[\][: use \`array\_merge()
    \<https://www.php.net/array\_merge\>]{.title-ref}\_
-   addition : use [array\_sum()](https://www.php.net/array_sum)
-   multiplication : use
    [array\_product()](https://www.php.net/array_product)
-   concatenation : use [implode()](https://www.php.net/implode)
-   ifthen : use [array\_filter()](https://www.php.net/array_filter)

``` {.php}
<?php

$all = implode('-', $s).'-';

// same as above
$all = '';
foreach($array as $s) {
    $all .= $s . '-';
}

?>
```

See also [Array Functions](https://www.php.net/manual/en/ref.array.php) and

:   `no-array\_merge()-in-loops`{.interpreted-text role="ref"}.

### Suggestions

-   Remove the loop and use a native PHP function
-   Add more expressions to the loop : batching multiple operations in
    one loop makes it more interesting than running separates loops.

  ------------- ---------------------------------
  Short name    Structures/UseArrayFunctions

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Use Basename Suffix
-------------------

[basename()](https://www.php.net/basename) will remove extension when it
is provided as argument. The second argument will be removed from the
name of the file.

``` {.php}
<?php

$path = 'phar:///path/to/file.php';

// Don't forget the . 
$filename = basename($path, '.php');

// Too much work for this
$filename = substr(basename($path), 0, -4);

?>
```

Using [basename()](https://www.php.net/basename) instead of
[substr()](https://www.php.net/substr) or else, makes the intention
clear.

See also [basename](http://www.php.net/basename).

### Suggestions

-   Use basename(), remove more complex code based on substr() or
    str\_replace()

  ---------- -------------------------------------------------------------
  Short name Structures/BasenameSuffix

  Rulesets   `Suggestions`{.interpreted-text role="ref"}

  Examples   `nextcloud-structures-basenamesuffix`{.interpreted-text
             role="ref"},
             `dolibarr-structures-basenamesuffix`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Use Case Value
--------------

When
[switch()](https://www.php.net/manual/en/control-structures.switch.php)
has branched to the right case, the value of the switched variable is
know : it is the case.

This doesn\'t work with complex expression cases, nor with default.

``` {.php}
<?php

switch($a) {
    case 'a' : 
        // $a == 'a';
        echo $a;
        break;

    case 'b' : 
        // $a == 'b';
        echo 'b';
        break;
}

?>
```

### Suggestions

-   Use the literal value in the case, to avoid unnecessary computation.

  ------------- ---------------------------------
  Short name    Structures/UseCaseValue

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Use Const And Functions
-----------------------

Since PHP 5.6 it is possible to import specific functions or constants
from other namespaces.

``` {.php}
<?php

namespace A {
    const X = 1;
    function foo() { echo __FUNCTION__; }
}

namespace My{
    use function A\foo;
    use constant A\X;

    echo foo(X);
}

?>
```

See also [Using namespaces:
Aliasing/Importing](https://www.php.net/manual/en/language.namespaces.importing.php).

  ----------- ------------------------------------------------------------
  Short name  Namespaces/UseFunctionsConstants

  Rulesets    `CompatibilityPHP53`{.interpreted-text role="ref"},
              `CompatibilityPHP54`{.interpreted-text role="ref"},
              `CompatibilityPHP55`{.interpreted-text role="ref"}

  Php Version With PHP 5.6 and more recent

  Severity    Major

  Time To Fix Slow (1 hour)

  Precision   Very high
  ----------- ------------------------------------------------------------

Use Constant
------------

The following functioncall have a constant equivalent, that is faster to
use than calling the functions.

This applies to the following functions :

-   [pi()](https://www.php.net/pi) : replace with [M\_PI]{.title-ref}
-   [phpversion()](https://www.php.net/phpversion) : replace with
    [PHP\_VERSION]{.title-ref}
-   [php\_sapi\_name()](https://www.php.net/php_sapi_name) : replace
    with [PHP\_SAPI\_NAME]{.title-ref}

``` {.php}
<?php

// recommended way 
echo PHP_VERSION;

// slow version
echo php_version();

?>
```

See also [PHP why \`pi() \<https://www.php.net/pi\>]{.title-ref}\_ and
M\_PI
\<<https://stackoverflow.com/questions/42021176/php-why-pi-and-m-pi>\>\`\_.

### Suggestions

-   Use the constant version, not the function.

  ------------- ---------------------------------------------------------
  Short name    Structures/UseConstant

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `php-cs-fixable`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ---------------------------------------------------------

Use Constant As Arguments
-------------------------

Some methods and functions are defined to be used with constants as
arguments. Those constants are made to be meaningful and readable,
keeping the code maintenable. It is recommended to use such constants as
soon as they are documented.

``` {.php}
<?php

// Turn off all error reporting
// 0 and -1 are accepted 
error_reporting(0);

// Report simple running errors
error_reporting(E_ERROR | E_WARNING | E_PARSE);

// The first argument can be one of INPUT_GET, INPUT_POST, INPUT_COOKIE, INPUT_SERVER, or INPUT_ENV.
$search_html = filter_input(INPUT_GET, 'search', FILTER_SANITIZE_SPECIAL_CHARS);

// sort accepts one of SORT_REGULAR, SORT_NUMERIC, SORT_STRING, SORT_LOCALE_STRING, SORT_NATURAL
// SORT_FLAG_CASE may be added, and combined with SORT_STRING or SORT_NATURAL
sort($fruits);

?>
```

Here is the list of function that use a unique PHP constant as argument
:

-   [array\_change\_key\_case()](https://www.php.net/array_change_key_case)
-   [array\_multisort()](https://www.php.net/array_multisort)
-   [array\_unique()](https://www.php.net/array_unique)
-   [count()](https://www.php.net/count)
-   dns\_get\_record()
-   [easter\_days()](https://www.php.net/easter_days)
-   [extract()](https://www.php.net/extract)
-   [filter\_input()](https://www.php.net/filter_input)
-   [filter\_var()](https://www.php.net/filter_var)
-   [fseek()](https://www.php.net/fseek)
-   [get\_html\_translation\_table()](https://www.php.net/get_html_translation_table)
-   [gmp\_div\_q()](https://www.php.net/gmp_div_q)
-   [gmp\_div\_qr()](https://www.php.net/gmp_div_qr)
-   [gmp\_div\_r()](https://www.php.net/gmp_div_r)
-   [html\_entity\_decode()](https://www.php.net/html_entity_decode)
-   [htmlspecialchars\_decode()](https://www.php.net/htmlspecialchars_decode)
-   [http\_build\_query()](https://www.php.net/http_build_query)
-   [http\_parse\_cookie()](https://www.php.net/http_parse_cookie)
-   [http\_parse\_params()](https://www.php.net/http_parse_params)
-   [http\_redirect()](https://www.php.net/http_redirect)
-   [http\_support()](https://www.php.net/http_support)
-   [parse\_ini\_file()](https://www.php.net/parse_ini_file)
-   [parse\_ini\_string()](https://www.php.net/parse_ini_string)
-   [parse\_url()](https://www.php.net/parse_url)
-   [pathinfo()](https://www.php.net/pathinfo)
-   [pg\_select()](https://www.php.net/pg_select)
-   [posix\_access()](https://www.php.net/posix_access)
-   [round()](https://www.php.net/round)
-   [scandir()](https://www.php.net/scandir)
-   [socket\_read()](https://www.php.net/socket_read)
-   [str\_pad()](https://www.php.net/str_pad)
-   [trigger\_error()](https://www.php.net/trigger_error)

Here is the list of functions that use a combination of PHP native
functions as argument.

-   [arsort()](https://www.php.net/arsort)
-   [asort()](https://www.php.net/asort)
-   [error\_reporting()](https://www.php.net/error_reporting)
-   [filter\_input()](https://www.php.net/filter_input)
-   [filter\_var()](https://www.php.net/filter_var)
-   [get\_html\_translation\_table()](https://www.php.net/get_html_translation_table)
-   [htmlentities()](https://www.php.net/htmlentities)
-   [htmlspecialchars()](https://www.php.net/htmlspecialchars)
-   [http\_build\_url()](https://www.php.net/http_build_url)
-   [jdtojewish()](https://www.php.net/jdtojewish)
-   [krsort()](https://www.php.net/krsort)
-   [ksort()](https://www.php.net/ksort)
-   [pg\_result\_status()](https://www.php.net/pg_result_status)
-   [phpcredits()](https://www.php.net/phpcredits)
-   [phpinfo()](https://www.php.net/phpinfo)
-   [preg\_grep()](https://www.php.net/preg_grep)
-   [preg\_match()](https://www.php.net/preg_match)
-   [preg\_split()](https://www.php.net/preg_split)
-   [rsort()](https://www.php.net/rsort)
-   [runkit\_import()](https://www.php.net/runkit_import)
-   [sort()](https://www.php.net/sort)
-   [stream\_socket\_client()](https://www.php.net/stream_socket_client)
-   [stream\_socket\_server()](https://www.php.net/stream_socket_server)

### Suggestions

-   Use PHP native constants, whenever possible, instead of meaningless
    literals.

  ---------- ---------------------------------------------------------------
  Short name Functions/UseConstantAsArguments

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `tikiwiki-functions-useconstantasarguments`{.interpreted-text
             role="ref"},
             `shopware-functions-useconstantasarguments`{.interpreted-text
             role="ref"}
  ---------- ---------------------------------------------------------------

Use Count Recursive
-------------------

The code could use the recursive version of count.

The second argument of count, when set to `COUNT_RECURSIVE`, count
recursively the elements. It also counts the elements themselves.

``` {.php}
<?php

$array = array( array(1,2,3), array(4,5,6));

print (count($array, COUNT_RECURSIVE) - count($array, COUNT_NORMAL));

$count = 0;
foreach($array as $a) {
    $count += count($a);
}
print $count;

?>
```

See also [count](https://www.php.net/count).

### Suggestions

-   Drop the loop and use the 2nd argument of count()

  ---------- -------------------------------------------------------------
  Short name Structures/UseCountRecursive

  Rulesets   `Suggestions`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  Examples   `wordpress-structures-usecountrecursive`{.interpreted-text
             role="ref"},
             `prestashop-structures-usecountrecursive`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Use DateTimeImmutable Class
---------------------------

The DateTimeImmutable class is the immutable version of the
[Datetime](https://www.php.net/manual/en/class.datetime.php) class.

While DateTime may be modified \'in situ\', `DateTimeImmutable` cannot
be modified. Any modification to such an object will return a new and
distinct object. This avoid interferences that are hard to track.

``` {.php}
<?php
// Example extracted from Derick Rethans' article (link below)

function formatNextMondayFromNow( DateTime $dt )
{
        return $dt->modify( 'next monday' )->format( 'Y-m-d' );
}

$d = new DateTime();                          //2014-02-17
echo formatNextMondayFromNow( $d ), \n;
echo $d->format( 'Y-m-d' ), \n;             //2014-02-17
?>
```

See also [What\'s all this \'immutable date\' stuff,
anyway?](https://medium.com/@codebyjeff/whats-all-this-immutable-date-stuff-anyway-72d4130af8ce),
[DateTimeImmutable](https://derickrethans.nl/immutable-datetime.html),
[The DateTime class](https://www.php.net/manual/en/class.datetime.php)
and [The DateTimeImmutable
class](https://www.php.net/manual/en/class.datetimeimmutable.php).

### Suggestions

-   Always use DateTimeImmutable when manipulating dates.

  ------------- ---------------------------------
  Short name    Php/UseDateTimeImmutable

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Use Instanceof
--------------

The `instanceof` operator is a more precise alternative to
`is_object()`. It is also faster.

[instanceof](https://www.php.net/manual/en/language.operators.type.php)
checks for an variable to be of a class or its parents or the interfaces
it implements. Once `instanceof` has been used, the actual attributes
available (properties, constants, methods) are known, unlike with
`is_object()`.

Last, `instanceof` may be upgraded to Typehint, by moving it to the
method signature.

``` {.php}
<?php

class Foo {

    // Don't use is_object
    public function bar($o) {
        if (!is_object($o)) { return false; } // Classic argument check
        return $o->method();
    }

    // use instanceof
    public function bar($o) {
        if ($o instanceof myClass) {  // Now, we know which methods are available
            return $o->method();
        }

        return false; } // Default behavior
    }

    // use of typehinting
    // in case $o is not of the right type, exception is raised automatically
    public function bar(myClass $o) {
        return $o->method();
    }
}

?>
```

`instanceof` and `is_object()` may not be always interchangeable.
Consider using [isset()](https://www.www.php.net/isset) on a known
property for a simple check on objects. You may also consider
[is\_string()](https://www.php.net/is_string),
[is\_integer()](https://www.php.net/is_integer) or
[is\_scalar()](https://www.php.net/is_scalar), in particular instead of
`` !`is_object() <https://www.php.net/is_object>`_ ``.

The `instanceof` operator is also faster than the `is_object()`
functioncall.

See also [Type
Operators](https://www.php.net/manual/en/language.operators.type.php#language.operators.type)
and [is\_object](https://www.php.net/manual/en/function.is-object.php).

### Suggestions

-   Use instanceof and remove is\_object()
-   Create a high level interface to check a whole family of classes,
    instead of testing them individually
-   Use typehint when possible
-   Avoid mixing scalar types and objects in the same variable

  ----------- ------------------------------------------------------------
  Short name  Classes/UseInstanceof

  Rulesets    none

  Severity    Major

  Time To Fix Quick (30 mins)

  Precision   High

  Examples    `teampass-classes-useinstanceof`{.interpreted-text
              role="ref"},
              `zencart-classes-useinstanceof`{.interpreted-text
              role="ref"}
  ----------- ------------------------------------------------------------

Use List With Foreach
---------------------

[Foreach()](https://www.php.net/manual/en/control-structures.foreach.php)
structures accepts [list()](https://www.php.net/list) as blind key. If
the loop-value is an array with a fixed structure, it is possible to
extract the values directly into variables with explicit names.

``` {.php}
<?php

// Short way to assign variables
// Works on PHP 7.1, where list() accepts keys.
foreach($names as list('first' => $first, 'last' => $last)) {
    doSomething($first, $last);
}

// Short way to assign variables
// Works on all PHP versions with numerically indexed arrays.
foreach($names as list($first, $last)) {
    doSomething($first, $last);
}

// Long way to assign variables
foreach($names as $name) {
    $first = $name['first'];
    $last = $name['last'];

    doSomething($first, $last);
}

?>
```

See also [list](https://www.php.net/manual/en/function.list.php) and
[foreach](https://www.php.net/manual/en/control-structures.foreach.php).

### Suggestions

-   Use the list keyword (or the short syntax), and simplify the array
    calls in the loop.

  ------------- -------------------------------------------------------------
  Short name    Structures/UseListWithForeach

  Rulesets      `Suggestions`{.interpreted-text role="ref"},
                `Top10`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `mediawiki-structures-uselistwithforeach`{.interpreted-text
                role="ref"}
  ------------- -------------------------------------------------------------

Use Lower Case For Parent, Static And Self {#use-lower-case-for-parent,-static-and-self}
------------------------------------------

The special
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php),
[static](https://www.php.net/manual/en/language.oop5.static.php) and
[self](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
keywords needed to be lowercase to be usable. This was fixed in PHP 5.5;
otherwise, they would yield a \'PHP Fatal error: Class
\'[PARENT](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)\'
not found\'.

[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php),
[static](https://www.php.net/manual/en/language.oop5.static.php) and
[self](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
are traditionally written in lowercase only. Mixed case and Upper case
are both valid, though.

``` {.php}
<?php

class foo {
    const aConstante = 233;

    function method() {
        // Wrong case, error with PHP 5.4.* and older
        echo SELF::aConstante;

        // Always right. 
        echo self::aConstante;
    }
}

?>
```

Until PHP 5.5, non-lowercase version of those keywords are generating a
bug.

### Suggestions

-   Upgrade to PHP 5.6 or more recent

  ------------- ------------------------------------------------------
  Short name    Php/CaseForPSS

  Rulesets      `CompatibilityPHP54`{.interpreted-text role="ref"},
                `CompatibilityPHP53`{.interpreted-text role="ref"}

  Php Version   With PHP 5.5 and older

  Severity      Minor

  Time To Fix   Instant (5 mins)

  Precision     High
  ------------- ------------------------------------------------------

Use Named Boolean In Argument Definition
----------------------------------------

Boolean in argument definitions is confusing.

It is recommended to use explicit constant names, instead. They are more
readable. They also allow for easy replacement when the code evolve and
has to replace those booleans by strings. This works even also with
classes, and class constants.

``` {.php}
<?php

function flipImage($im, $horizontal = NO_HORIZONTAL_FLIP, $vertical = NO_VERTICAL_FLIP) { }

// with constants
const HORIZONTAL_FLIP = true;
const NO_HORIZONTAL_FLIP = true;
const VERTICAL_FLIP = true;
const NO_VERTICAL_FLIP = true;

rotateImage($im, HORIZONTAL_FLIP, NO_VERTICAL_FLIP);


// without constants 
function flipImage($im, $horizontal = false, $vertical = false) { }

rotateImage($im, true, false);

?>
```

See also [Flag
Argument](https://martinfowler.com/bliki/FlagArgument.html), to avoid
boolean altogether.

  ---------- ----------------------------------------------------------------
  Short name Functions/AvoidBooleanArgument

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  Examples   `phpmyadmin-functions-avoidbooleanargument`{.interpreted-text
             role="ref"},
             `cleverstyle-functions-avoidbooleanargument`{.interpreted-text
             role="ref"}
  ---------- ----------------------------------------------------------------

Use Nullable Type
-----------------

The code uses nullable type, available since PHP 7.1.

Nullable Types are an option to type hint : they allow the passing value
to be null, or another type.

According to the authors of the feature : \'It is common in many
programming languages including PHP to allow a variable to be of some
type or null. This null often indicates an error or lack of something to
return.\'

``` {.php}
<?php

function foo(?string $a = 'abc') : ?string {
    return $a.b;
}

?>
```

See also [Type
declarations](https://www.php.net/manual/en/functions.arguments.php#functions.arguments.type-declaration)
and [PHP RFC: Nullable Types](https://wiki.php.net/rfc/nullable_types).

  ---------- ----------------------------------------------------------------
  Short name Php/UseNullableType

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.1 and more recent
  Version    

  Severity   Major

  Time To    Quick (30 mins)
  Fix        
  ---------- ----------------------------------------------------------------

Use PHP Object API
------------------

OOP API is the modern version of the PHP API.

When PHP offers the alternative between procedural and OOP api for the
same features, it is recommended to use the OOP API.

Often, this least to more compact code, as methods are shorter, and
there is no need to bring the resource around. Lots of new extensions
are directly written in OOP form too.

OOP / procedural alternatives are available for
[mysqli](https://www.php.net/manual/en/book.mysqli.php),
[tidy](https://www.php.net/manual/en/book.tidy.php),
[cairo](https://www.php.net/manual/en/book.cairo.php),
[finfo](https://www.php.net/manual/en/book.fileinfo.php), and some
others.

``` {.php}
<?php
/// OOP version
$mysqli = new mysqli(localhost, my_user, my_password, world);

/* check connection */
if ($mysqli->connect_errno) {
    printf(Connect failed: %s\n, $mysqli->connect_error);
    exit();
}

/* Create table doesn't return a resultset */
if ($mysqli->query(CREATE TEMPORARY TABLE myCity LIKE City) === TRUE) {
    printf(Table myCity successfully created.\n);
}

/* Select queries return a resultset */
if ($result = $mysqli->query(SELECT Name FROM City LIMIT 10)) {
    printf(Select returned %d rows.\n, $result->num_rows);

    /* free result set */
    $result->close();
}
?>
```

``` {.php}
<?php
/// Procedural version
$link = mysqli_connect(localhost, my_user, my_password, world);

/* check connection */
if (mysqli_connect_errno()) {
    printf(Connect failed: %s\n, mysqli_connect_error());
    exit();
}

/* Create table doesn't return a resultset */
if (mysqli_query($link, CREATE TEMPORARY TABLE myCity LIKE City) === TRUE) {
    printf(Table myCity successfully created.\n);
}

?>
```

### Suggestions

-   Use the object API

  ---------- ------------------------------------------------------------------------------------------
  Short name Php/UseObjectApi

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  ClearPHP   [use-object-api](https://github.com/dseguy/clearPHP/tree/master/rules/use-object-api.md)

  Examples   `wordpress-php-useobjectapi`{.interpreted-text role="ref"},
             `prestashop-php-useobjectapi`{.interpreted-text role="ref"},
             `sugarcrm-php-useobjectapi`{.interpreted-text role="ref"}
  ---------- ------------------------------------------------------------------------------------------

Use PHP7 Encapsed Strings
-------------------------

PHP 7 has optimized the handling of double-quoted strings. In
particular, double-quoted strings are much less memory hungry than
classic concatenations.

PHP allocates memory at the end of the double-quoted string, making only
one call to the allocator. On the other hand, concatenations are
allocated each time they include dynamic content, leading to higher
memory consumption.

``` {.php}
<?php

$bar = 'bar';

/* PHP 7 optimized this */
$a = "foo and $bar";

/* This is PHP 5 code (aka, don't use it) */
$a = 'foo and ' . $bar;

// Constants can't be used with double quotes
$a = 'foo and ' . __DIR__;
$a = foo and __DIR__; // __DIR__ is not interpolated

?>
```

Concatenations are still needed with constants,
[static](https://www.php.net/manual/en/language.oop5.static.php)
constants, magic constants, functions,
[static](https://www.php.net/manual/en/language.oop5.static.php)
properties or
[static](https://www.php.net/manual/en/language.oop5.static.php)
methods.

See also [PHP 7 performance improvements (3/5): Encapsed strings
optimization](https://blog.blackfire.io/php-7-performance-improvements-encapsed-strings-optimization.html).

  ------------ ----------------------------------
  Short name   Performances/PHP7EncapsedStrings

  Rulesets     `Performances`{.interpreted-text
               role="ref"}
  ------------ ----------------------------------

Use Pathinfo
------------

Use [pathinfo()](https://www.php.net/pathinfo) function instead of
string manipulations.

[pathinfo()](https://www.php.net/pathinfo) is more efficient and
readable and string functions.

``` {.php}
<?php

$filename = '/path/to/file.php';

// With pathinfo();
$details = pathinfo($filename);
print $details['extension'];  // also capture php

// With string functions (other solutions possible)
$ext = substr($filename, - strpos(strreverse($filename), '.')); // Capture php

?>
```

When the path contains UTF-8 characters,
[pathinfo()](https://www.php.net/pathinfo) may strip them. There, string
functions are necessary.

### Suggestions

-   Use pathinfo() and its second argument

  ------------- ----------------------------------------------
  Short name    Php/UsePathinfo

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `suitecrm-php-usepathinfo`{.interpreted-text
                role="ref"}
  ------------- ----------------------------------------------

Use Positive Condition
----------------------

Whenever possible, use a positive condition.

Positive conditions are easier to understand, and lead to less
understanding problems. Negative conditions are not reported when else
is not present.

``` {.php}
<?php

// This is a positive condition
if ($a == 'b') {
    doSomething();
} else {
    doSomethingElse();
}

if (!empty($a)) {
    doSomething();
} else {
    doSomethingElse();
}

// This is a negative condition
if ($a == 'b') {
    doSomethingElse();
} else {
    doSomething();
}

// No need to force $a == 'b' with empty else
if ($a != 'b') {
    doSomethingElse();
} 


?>
```

### Suggestions

-   Invert the code in the if branches, and the condition

  ---------- ----------------------------------------------------------------------
  Short name Structures/UsePositiveCondition

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `spip-structures-usepositivecondition`{.interpreted-text role="ref"},
             `expressionengine-structures-usepositivecondition`{.interpreted-text
             role="ref"}
  ---------- ----------------------------------------------------------------------

Use System Tmp
--------------

It is recommended to avoid hardcoding the temporary file. It is better
to rely on the system\'s temporary folder, which is accessible with
[sys\_get\_temp\_dir()](https://www.php.net/sys_get_temp_dir).

``` {.php}
<?php

// Where the tmp is : 
file_put_contents(sys_get_temp_dir().'/tempFile.txt', $content);


// Avoid hard-coding tmp folder : 
// On Linux-like systems
file_put_contents('/tmp/tempFile.txt', $content);

// On Windows systems
file_put_contents('C:\WINDOWS\TEMP\tempFile.txt', $content);

?>
```

See also [PHP: When is /tmp not
/tmp?](https://www.the-art-of-web.com/php/where-is-tmp/).

### Suggestions

-   Do not hardcode the temporary file, use the system\'s

  ------------- ----------------------------------
  Short name    Structures/UseSystemTmp

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------

Use The Blind Var
-----------------

When in a loop, it is faster to rely on the blind var, rather than the
original source.

When the key is referenced in the foreach loop, it is faster to use the
available container to access a value for reading.

Note that it is also faster to use the value with a reference to handle
the writings.

``` {.php}
<?php

// Reaching $source[$key] via $value is faster
foreach($source as $key => $value) {
    $coordinates = array('x' => $value[0],
                         'y' => $value[1]);
}

// Reaching $source[$key] via $source is slow
foreach($source as $key => $value) {
    $coordinates = array('x' => $source[$key][0],
                         'y' => $source[$key][1]);
}

?>
```

### Suggestions

-   Use the blind var

  ------------- ----------------------------------
  Short name    Performances/UseBlindVar

  Rulesets      `Performances`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ----------------------------------

Use Url Query Functions
-----------------------

PHP features several functions dedicated to processing URL\'s query
string.

-   [parse\_str()](https://www.php.net/parse_str)
-   [parse\_url()](https://www.php.net/parse_url)
-   [http\_build\_query()](https://www.php.net/http_build_query)

Those functions include extra checks : for example,
[http\_build\_query()](https://www.php.net/http_build_query) adds
[urlencode()](https://www.php.net/urlencode) call on the values, and
allow for choosing the separator and the Query string format.

``` {.php}
<?php
$data = array(
    'foo' => 'bar',
    'baz' => 'boom',
    'cow' => 'milk',
    'php' => 'hypertext processor'
);

// safe and efficient way to build a query string
echo http_build_query($data, '', '&') . PHP_EOL;

// slow way to produce a query string
foreach($data as $name => &$value) {
    $value = $name.'='.$value;
}
echo implode('&', $data) . PHP_EOL;

?>
```

### Suggestions

-   

  ------------- ---------------------------------
  Short name    Structures/UseUrlQueryFunctions

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Use With Fully Qualified Name
-----------------------------

Use statement doesn\'t require a fully qualified name.

PHP manual recommends not to use fully qualified name (starting with )
when using the \'use\' statement : they are \"the leading backslash is
unnecessary and not recommended, as import names must be fully
qualified, and are not processed relative to the current namespace\".

``` {.php}
<?php

// Recommended way to write a use statement.
use  A\B\C\D as E;

// No need to use the initial \
use \A\B\C\D as F;

?>
```

### Suggestions

-   Remove the initial in use expressions.

  ------------ -------------------------------------------------------------
  Short name   Namespaces/UseWithFullyQualifiedNS

  Rulesets     `Analyze`{.interpreted-text role="ref"},
               `Coding Conventions <coding-conventions>`{.interpreted-text
               role="ref"}

  Severity     Minor

  Time To Fix  Slow (1 hour)
  ------------ -------------------------------------------------------------

Use array\_slice() {#use-array\\_slice()}
------------------

Array\_slice is de equivalent of [substr()](https://www.php.net/substr)
for arrays.

[array\_splice()](https://www.php.net/array_splice) is also possible, to
remove a portion of array inside the array, not at the ends. This has no
equivalent for strings.

``` {.php}
<?php

$array = range(0, 9);

// Extract the 5 first elements
print_r(array_slice($array, 0, 5));

// Extract the 4 last elements
print_r(array_slice($array, -4));

// Extract the 2 central elements : 4 and 5
print_r(array_splice($array, 4, 2));

// slow way to remove the last elementst of an array
for($i = 0; $i < 4) {
    array_pop($array);
}

?>
```

See also [array\_slice](http://www.php.net/array_slice) and
[array\_splice](http://www.php.net/array_splice).

### Suggestions

-   

  ------------- ----------------------------------
  Short name    Performances/UseArraySlice

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Use const
---------

The const keyword may be used to define constant, just like the
[define()](https://www.php.net/define) function.

When defining a constant, it is recommended to use \'const\' when the
features of the constant are not dynamical (name or value are known at
compile time). This way, constant will be defined at compile time, and
not at execution time.

``` {.php}
<?php
  //Do
  const A = 1;
  // Don't 
  define('A', 1);

?>
```

[define()](https://www.php.net/define) function is useful when the
constant is not known at compile time, or when case sensitivity is
necessary.

``` {.php}
<?php
  // Read $a in database or config file
  define('A', $a);

  // Read $a in database or config file
  define('B', 1, true);
  echo b;
?>
```

See also
[Syntax](https://www.php.net/manual/en/language.constants.syntax.php).

### Suggestions

-   Use const instead of define()

  ---------- --------------------------------------------------------------
  Short name Constants/ConstRecommended

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Coding Conventions <coding-conventions>`{.interpreted-text
             role="ref"}, `Top10`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  Examples   `phpmyadmin-constants-constrecommended`{.interpreted-text
             role="ref"},
             `piwigo-constants-constrecommended`{.interpreted-text
             role="ref"}
  ---------- --------------------------------------------------------------

Use get\_debug\_type() {#use-get\\_debug\\_type()}
----------------------

get\_debug\_type() returns the given type of a variable. It was
introduced in PHP 8.0.

``` {.php}
<?php
  // From the RFC 
  throw new TypeError('Expected ' . Foo::class . ' got ' . (is_object($bar) ? get_class($bar) : gettype($bar)));

  // Becomes
  throw new TypeError('Expected ' . Foo::class . ' got ' . get_debug_type($bar));

?>
```

See also [PHP RFC:
get\_debug\_type](https://wiki.php.net/rfc/get_debug_type).

### Suggestions

-   Replace the ternary with a call to get\_debug\_type()

  ------------- ---------------------------------
  Short name    Php/UseGetDebugType

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Php Version   8.0+

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     Medium
  ------------- ---------------------------------

Use is\_countable {#use-is\\_countable}
-----------------

is\_countable() checks if a variables holds a value that can be counted.
It is recommended to use it before calling
[count()](https://www.php.net/count).

is\_countable() accepts arrays and object whose class implements
countable.

``` {.php}
<?php

function foo($arg) {
    if (!is_countable($arg)) {
        // $arg cannot be passed to count()
        return 0
    }
    return count($arg);
}

function bar($arg) {
    if (!is_array($arg) and !$x instanceof \Countable) {
        // $arg cannot be passed to count()
        return 0
    }

    return count($arg);
}

?>
```

See also [PHP RFC:
is\_countable](https://wiki.php.net/rfc/is-countable).

### Suggestions

-   Use is\_countable()
-   Create a compatibility function that replaces is\_countable() until
    the code is ready for PHP 7.3

  ------------- ---------------------------------
  Short name    Php/CouldUseIsCountable

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.3 and more recent
  ------------- ---------------------------------

Use json\_decode() Options {#use-json\\_decode()-options}
--------------------------

[json\_decode()](https://www.php.net/json_decode) returns objects by
default, unless the second argument is set to `TRUE` or
`JSON_OBJECT_AS_ARRAY`. Then, it returns arrays.

Avoid casting the returned value from
[json\_decode()](https://www.php.net/json_decode), and use the second
argument to directly set the correct type.

``` {.php}
<?php

$json = '{a:b}';

// Good syntax
$array = json_decode($json, JSON_OBJECT_AS_ARRAY);

// GoToo much work
$array = (array) json_decode($json);

?>
```

Note that all objects will be turned into arrays, recursively. If
you\'re expecting an array of objects, don\'t use the
`JSON_OBJECT_AS_ARRAY` constant, and change your JSON code.

Note that `JSON_OBJECT_AS_ARRAY` is the only constant : there is no
defined constant to explicitly ask for an object as returned value.

See also [json\_decode](https://www.php.net/json_decode).

### Suggestions

-   Use the correct second argument of json\_decode() :
    JSON\_OBJECT\_AS\_ARRAY

  ------------- ---------------------------------
  Short name    Structures/JsonWithOption

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Use password\_hash() {#use-password\\_hash()}
--------------------

[password\_hash()](https://www.php.net/password_hash) and
password\_check() are a better choice to replace the use of
[crypt()](https://www.php.net/crypt) to check password.

PHP 5.5 introduced these functions.

``` {.php}
<?php

$password = 'rasmuslerdorf';
$hash = '$2y$10$YCFsG6elYca568hBi2pZ0.3LDL5wjgxct1N8w/oLR/jfHsiQwCqTS';

// The cost parameter can change over time as hardware improves
$options = array('cost' => 11);

// Verify stored hash against plain-text password
if (password_verify($password, $hash)) {
    // Check if a newer hashing algorithm is available
    // or the cost has changed
    if (password_needs_rehash($hash, PASSWORD_DEFAULT, $options)) {
        // If so, create a new hash, and replace the old one
        $newHash = password_hash($password, PASSWORD_DEFAULT, $options);
    }

    // Log user in
}
?>
```

See also [Password
hashing](https://www.php.net/manual/en/book.password.php).

  ------------- ----------------------------------------
  Short name    Php/Password55

  Rulesets      `CompatibilityPHP55`{.interpreted-text
                role="ref"}

  Php Version   With PHP 5.5 and more recent

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

Use pathinfo() Arguments {#use-pathinfo()-arguments}
------------------------

[pathinfo()](https://www.php.net/pathinfo) has a second argument to
select only useful data.

It is twice faster to get only one element from
[pathinfo()](https://www.php.net/pathinfo) than get the four of them,
and use only one.

This analysis reports [pathinfo()](https://www.php.net/pathinfo) usage,
without second argument, where only one or two indices are used, after
the call.

``` {.php}
<?php

// This could use only PATHINFO_BASENAME
function foo_db() {
    $a = pathinfo($file2);
    return $a['basename'];
}

// This could be 2 calls, with PATHINFO_BASENAME and PATHINFO_DIRNAME.
function foo_de() {
    $a = pathinfo($file3);
    return $a['dirname'].'/'.$a['basename'];
}

// This is OK : 3 calls to pathinfo() is slower than array access.
function foo_deb() {
    $a = pathinfo($file4);
    return  $a['dirname'].'/'.$a['filename'].'.'.$a['extension'];
}

?>
```

Depending on the situation, the functions
[dirname()](https://www.php.net/dirname) and
[basename()](https://www.php.net/basename) may also be used. They are
even faster, when only fetching those data.

See also [list](https://www.php.net/manual/en/function.list.php).

### Suggestions

-   Use PHP native function pathinfo() and its arguments

  ---------- ------------------------------------------------------------
  Short name Php/UsePathinfoArgs

  Rulesets   `Performances`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `zend-config-php-usepathinfoargs`{.interpreted-text
             role="ref"},
             `thinkphp-php-usepathinfoargs`{.interpreted-text role="ref"}
  ---------- ------------------------------------------------------------

Use random\_int() {#use-random\\_int()}
-----------------

[rand()](https://www.php.net/rand) and
[mt\_rand()](https://www.php.net/mt_rand) should be replaced with
[random\_int()](https://www.php.net/random_int).

At worse, [rand()](https://www.php.net/rand) should be replaced with
[mt\_rand()](https://www.php.net/mt_rand), which is a drop-in
replacement and [srand()](https://www.php.net/srand) by
[mt\_srand()](https://www.php.net/mt_srand).

[random\_int()](https://www.php.net/random_int) replaces
[rand()](https://www.php.net/rand), and has no seeding function like
[srand()](https://www.php.net/srand).

Other sources of entropy that should be replaced by
[random\_int()](https://www.php.net/random_int) :
[microtime()](https://www.php.net/microtime),
[uniqid()](https://www.php.net/uniqid),
[time()](https://www.php.net/time). Those a often combined with hashing
functions and mixed with other sources of entropy, such as a salt.

``` {.php}
<?php

// Avoid using this
$random = rand(0, 10);

// Drop-in replacement
$random = mt_rand(0, 10);

// Even better but different : 
// valid with PHP 7.0+
try {
    $random = random_int(0, 10);
} catch (\Exception $e) {
    // process case of not enoug random values
}

// This is also a source of entropy, based on srand()
// random_int() is a drop-in replacement here
$a = sha256(uniqid());

?>
```

Since PHP 7, [random\_int()](https://www.php.net/random_int) along with
[random\_bytes()](https://www.php.net/random_bytes), provides
cryptographically secure pseudo-random bytes, which are good to be used
when security is involved.
[openssl\_random\_pseudo\_bytes()](https://www.php.net/openssl_random_pseudo_bytes)
may be used when the `OpenSSL` extension is available.

See also [CSPRNG](https://www.php.net/manual/en/book.csprng.php) and
[OpenSSL](https://www.php.net/manual/en/book.openssl.php).

### Suggestions

-   Use random\_bytes() and randon\_int(). At least, use them as a base
    for random data, and then add extra prefix and suffix, and a hash
    call on top.

  ---------- ------------------------------------------------------------
  Short name Php/BetterRand

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Security`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Instant (5 mins)
  Fix        

  Examples   `thelia-php-betterrand`{.interpreted-text role="ref"},
             `fuelcms-php-betterrand`{.interpreted-text role="ref"}
  ---------- ------------------------------------------------------------

Use session\_start() Options {#use-session\\_start()-options}
----------------------------

It is possible to set the session\'s option at
[session\_start()](https://www.php.net/session_start) call, skipping the
usage of session\_option().

This way, session\'s options are set in one call, saving several hits.

This is available since PHP 7.0. It is recommended to set those values
in the `php.ini` file, whenever possible.

``` {.php}
<?php

// PHP 7.0
session_start(['session.name' => 'mySession',
               'session.cookie_httponly' => 1,
               'session.gc_maxlifetime' => 60 * 60);

// PHP 5.6- old way 
ini_set ('session.name', 'mySession');
ini_set(session.cookie_httponly, 1); 
ini_set('session.gc_maxlifetime', 60 * 60);
session_start();

?>
```

### Suggestions

-   Use session\_start() with array arguments

  ------------- ----------------------------------------------------------
  Short name    Php/UseSessionStartOptions

  Rulesets      `Suggestions`{.interpreted-text role="ref"}

  Php Version   With PHP 7.0 and more recent

  Examples      `wordpress-php-usesessionstartoptions`{.interpreted-text
                role="ref"}
  ------------- ----------------------------------------------------------

Use str\_contains() {#use-str\\_contains()}
-------------------

str\_contains() checks if a string is within another one. It replaces a
call to [strpos()](https://www.php.net/strpos) with a comparison.

``` {.php}
<?php

if (str_contains(abc, a)) { doSomething(); }

// strpos is used only for detection.
if (strpos(abc, a) !== false) { doSomething(); }

// strpos returns a position, 
$pos = strpos(abca, a, 3);
if ($pos > 3) { doSomething();

?>
```

Note that this function is case sensitive : it cannot replace
[stripos()](https://www.php.net/stripos).

Note that this function is single-byte only : it cannot replace
[mb\_strpos()](https://www.php.net/mb_strpos).

This analysis omits calls to [strpos()](https://www.php.net/strpos) that
are saved to a variable. [strpos()](https://www.php.net/strpos) is
actually returning the position of the found string in the haystack,
which may be reused later.

See also [PHP RFC:
str\_contains](https://wiki.php.net/rfc/str_contains).

### Suggestions

-   Switch to str\_contains()

  ------------- ---------------------------------
  Short name    Php/UseStrContains

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Php Version   8.0+

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- ---------------------------------

Used Once Property
------------------

Property used once in their defining class.

Properties used in one method only may be used several times, and read
only. This may be a class constant. Such properties are meant to be
overwritten by an extending class, and that\'s possible with class
constants.

Setting properties with default values is a good way to avoid littering
the code with literal values, and provide a single point of update (by
extension, or by hardcoding) for all those situations. A constant is
definitely better suited for this task.

``` {.php}
<?php

class foo {
    private $defaultCols = '*';
    cont DEFAULT_COLUMNS = '*';

    // $this->defaultCols holds a default value. Should be a constant.
    function bar($table, $cols) {
        // This is necessary to activate usage of default values
        if (empty($cols)) {
            $cols = $this->defaultCols;
        }
        $res = $this->query('SELECT '.$cols.' FROM '.$table);
        // ....
    }

    // Upgraded version of bar, with default values
    function bar2($table, $cols = self::DEFAULT_COLUMNS) {
        $res = $this->query('SELECT '.$cols.' FROM '.$table);
        // .....
    }
}

?>
```

### Suggestions

-   Remove the property, as it is probably not unused
-   Add another usage of the property where it is useful

  ------------- -----------------------------
  Short name    Classes/UsedOnceProperty

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)

  Precision     High
  ------------- -----------------------------

Used Once Variables
-------------------

This is the list of used once variables.

``` {.php}
<?php

// The variables below never appear again in the code
$writtenOnce = 1;

foo($readOnce);

?>
```

Such variables are useless. Variables must be used at least twice : once
for writing, once for reading, at least. It is recommended to remove
them.

In special situations, variables may be used once :

-   PHP predefined variables, as they are already initialized. They are
    omitted in this analyze.
-   Interface function\'s arguments, since the function has no body;
    They are omitted in this analyze.
-   Dynamically created variables (\$\$x,
    \${[\$this](https://www.php.net/manual/en/language.oop5.basic.php)-\>y}
    or also using extract), as they are runtime values and can\'t be
    determined at
    [static](https://www.php.net/manual/en/language.oop5.static.php)
    code time. They are reported for manual review.
-   Dynamically included files will provide in-scope extra variables.

The current analyzer count variables at the application level, and not
at a method scope level.

### Suggestions

-   Remove the variable
-   Fix the name of variable
-   Use the variable a second time, at least

  ---------- -------------------------------------------------------------
  Short name Variables/VariableUsedOnce

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Top10`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `shopware-variables-variableusedonce`{.interpreted-text
             role="ref"},
             `vanilla-variables-variableusedonce`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Used Once Variables (In Scope) {#used-once-variables-(in-scope)}
------------------------------

This is the list of used once variables, scope by scope. Those variables
are used once in a function, a method, a class or a namespace. In any
case, this means the variable is read or written, while it should be
used at least twice.

``` {.php}
<?php

function foo() {
    // The variables below never appear twice, inside foo()
    $writtenOnce = 1;

    foo($readOnce);
    // They do appear again in other functions, or in global space. 
}

function bar() {
    $writtenOnce = 1;
    foo($readOnce);
}

?>
```

### Suggestions

-   Remove the variable
-   Fix the name of variable
-   Use the variable a second time in the current scope, at least

  ------------- ------------------------------------------------------------------
  Short name    Variables/VariableUsedOnceByContext

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     High

  Examples      `shopware-variables-variableusedoncebycontext`{.interpreted-text
                role="ref"}
  ------------- ------------------------------------------------------------------

Useless Abstract Class
----------------------

Those classes are marked \'abstract\' and they are never extended. This
way, they won\'t be instantiated nor used.

Abstract classes that have only
[static](https://www.php.net/manual/en/language.oop5.static.php) methods
are omitted here : one usage of such classes are Utilities classes,
which only offer
[static](https://www.php.net/manual/en/language.oop5.static.php)
methods.

``` {.php}
<?php

// Never extended class : this is useless
abstract class foo {}

// Extended class
abstract class bar {
    public function barbar() {}
}

class bar2 extends bar {}

// Utility class : omitted here
abstract class bar {
    public static function barbar() {}
}

?>
```

### Suggestions

-   Drop the abstract keyword
-   Actually add an abstract keyword

  ------------- -----------------------------
  Short name    Classes/UselessAbstract

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- -----------------------------

Useless Alias
-------------

It is not possible to declare an alias of a method with the same name.

PHP reports that
`Trait method f has not been applied, because there are collisions with other trait methods on x`,
which is a way to say that the alias will be in conflict with the method
name.

When the method is the only one bearing a name, and being imported,
there is no need to alias it. When the method is imported in several
traits, the keyword `insteadof` is available to solve the conflict.

``` {.php}
<?php

trait t {
    function h() {}
}

class x {
    use t { 
        // This is possible
        t::f as g; 

        // This is not possible, as the alias is in conflict with itself
        // alias are case insensitive
        t::f as f; 
    }
}

?>
```

This code lints but doesn\'t execute.

See also [Conflict
resolution](https://www.php.net/manual/en/language.oop5.traits.php#language.oop5.traits.conflict).

### Suggestions

-   Remove the alias
-   Fix the alias or the origin method name
-   Switch to insteadof, and avoid as keyword

  ------------- ---------------------------------------------------------
  Short name    Traits/UselessAlias

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)
  ------------- ---------------------------------------------------------

Useless Brackets
----------------

Standalone brackets have no use. Brackets are used to delimit a block of
code, and are used by control statements. They may also be used to
protect variables in strings.

Standalone brackets may be a left over of an old instruction, or a
misunderstanding of the alternative syntax.

``` {.php}
<?php

// The following brackets are useless : they are a leftover from an older instruction
// if (DEBUG) 
{
    $a = 1;
}

// Here, the extra brackets are useless
for($a = 2; $a < 5; $a++) : {
    $b++;
} endfor;

?>
```

### Suggestions

-   Remove the brackets
-   Restore the flow-control operation that was there and removed
-   Move the block into a method or function, and call it

  ---------- -------------------------------------------------------------
  Short name Structures/UselessBrackets

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `churchcrm-structures-uselessbrackets`{.interpreted-text
             role="ref"},
             `piwigo-structures-uselessbrackets`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Useless Catch
-------------

Catch clause should handle the exception with some work.

Among the task of a catch clause : log the exception, clean any mess
that was introduced, fail graciously.

``` {.php}
<?php

function foo($a) {
    try {
        $b = doSomething($a);
    } catch (Throwable $e) {
        // No log of the exception : no one knows it happened.

        // return immediately ? 
        return false;
    }

    $b->complete();

    return $b;
}

?>
```

See also
[Exceptions](https://www.php.net/manual/en/language.exceptions.php) and
[Best practices for PHP exception
handling](https://www.moxio.com/blog/34/best-practices-for-php-exception-handling).

### Suggestions

-   Add a log call to the catch block
-   Handle correctly the exception

  ---------- ------------------------------------------------------------
  Short name Exceptions/UselessCatch

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  Examples   `zurmo-exceptions-uselesscatch`{.interpreted-text
             role="ref"},
             `prestashop-exceptions-uselesscatch`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Useless Check
-------------

There is no need to check the size of an array content before using
foreach.
[Foreach()](https://www.php.net/manual/en/control-structures.foreach.php)
applies a test on the source, and skips the loop if no element is found.

``` {.php}
<?php

// Checking for type is good. 
if (is_array($array)) {
    foreach($array as $a) {
        doSomething($a);
    }
}

// Foreach on empty arrays doesn't start. Checking is useless
if (!empty($array)) {
    foreach($array as $a) {
        doSomething($a);
    }
}

?>
```

This analysis checks for conditions with
[sizeof()](https://www.php.net/sizeof) and
[count()](https://www.php.net/count). Conditions with
[isset()](https://www.www.php.net/isset) and
[empty()](https://www.php.net/empty) are omitted : they also check for
the variable existence, and thus, offer extra coverage.

See also
[foreach](https://www.php.net/manual/en/control-structures.foreach.php).

### Suggestions

-   Drop the condition and the check
-   Turn the condition into isset(), empty() and is\_array()

  ---------- ------------------------------------------------------------
  Short name Structures/UselessCheck

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `magento-structures-uselesscheck`{.interpreted-text
             role="ref"},
             `phinx-structures-uselesscheck`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Useless Constructor
-------------------

Class constructor that have empty bodies are useless. They may be
removed.

``` {.php}
<?php

class X {
    function __construct() {
        // Do nothing
    }
}

class Y extends X {
    // Useful constructor, as it prevents usage of the parent
    function __construct() {
        // Do nothing
    }
}

?>
```

  ------------- -----------------------------
  Short name    Classes/UselessConstructor

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- -----------------------------

Useless Default Argument
------------------------

One of the argument has a default value, and this default value is never
used. Every time the method is called, the argument is provided
explicitly, rendering the default value actually useless.

``` {.php}
<?php

function goo($a, $b = 3) { 
    // do something here
}

// foo is called 3 times, and sometimes, $b is not provided. 
goo(1,2);
goo(1,2);
goo(1);


function foo($a, $b = 3) { 
    // do something here
}

// foo is called 3 times, and $b is always provided. 
foo(1,2);
foo(1,2);
foo(1,2);
?>
```

### Suggestions

-   Remove the default value
-   Remove the explicit argument in the function call, when it is equal
    to the default value

  ------------- ---------------------------------
  Short name    Functions/UselessDefault

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- ---------------------------------

Useless Final
-------------

When a class is declared final, all of its methods are also final by
default.

There is no need to declare them individually final.

``` {.php}
<?php

    final class foo {
        // Useless final, as the whole class is final
        final function method() { }
    }

    class bar {
        // Useful final, as the whole class is not final
        final function method() { }
    }

?>
```

See also [Final
Keyword](https://www.php.net/manual/en/language.oop5.final.php), and
[When to declare
final](https://ocramius.github.io/blog/when-to-declare-classes-final/).

  ---------- ----------------------------------------------------------------------------------------------
  Short name Classes/UselessFinal

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [no-useless-final](https://github.com/dseguy/clearPHP/tree/master/rules/no-useless-final.md)
  ---------- ----------------------------------------------------------------------------------------------

Useless Global
--------------

Global are useless in two cases. First, on super-globals, which are
always globals, like
[\$\_GET](https://www.php.net/manual/en/reserved.variables.get.php);
secondly, on variables that are not used.

``` {.php}
<?php

// $_POST is already a global : it is in fact a global everywhere
global $_POST;

// $unused is useless
function foo() {
    global $used, $unused;

    ++$used;
}

?>
```

Also, PHP has superglobals, a special team of variables that are always
available, whatever the context. They are : \$GLOBALS, \$\_SERVER,
[\$\_GET](https://www.php.net/manual/en/reserved.variables.get.php),
[\$\_POST](https://www.php.net/manual/en/reserved.variables.post.php),
\$\_FILES, \$\_COOKIE, \$\_SESSION,
[\$\_REQUEST](https://www.php.net/manual/en/reserved.variables.request.php)
and [\$\_ENV](https://www.php.net/manual/en/reserved.variables.env.php).

### Suggestions

-   Drop the global expression

  ---------- ------------------------------------------------------------
  Short name Structures/UselessGlobal

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `zencart-structures-uselessglobal`{.interpreted-text
             role="ref"},
             `humo-gen-structures-uselessglobal`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Useless Instructions
--------------------

Those instructions are useless, or contains useless parts.

For example, an addition whose result is not stored in a variable, or
immediately used, does nothing : it is actually performed, and the
result is lost. Just plain lost. In fact, PHP might detect it, and
optimize it away.

Here the useless instructions that are spotted :

``` {.php}
<?php

// Concatenating with an empty string is useless.
$string = 'This part '.$is.' useful but '.$not.'';

// This is a typo, that PHP turns into a constant, then a string, then nothing.
continue;

// Empty string in a concatenation
$a = 'abc' . '';

// Returning expression, whose result is not used (additions, comparisons, properties, closures, new without =, ...)
1 + 2;

// Returning post-incrementation
function foo($a) {
    return $a++;
}

// array_replace() with only one argument
$replaced = array_replace($array);
// array_replace() is OK with ... 
$replaced = array_replace(...$array);

// @ operator on source array, in foreach, or when assigning literals
$array = @array(1,2,3);

// Multiple comparisons in a for loop : only the last is actually used.
for($i = 0; $j = 0; $j < 10, $i < 20; ++$j, ++$i) {
    print $i.' '.$j.PHP_EOL;
}

// Counting the keys and counting the array is the same.
$c = count(array_keys($array))

//array_keys already provides an array with only unique values, as they were keys in a previous array
$d = array_unique(array_keys($file['messages']))

// No need for assignation inside the ternary operator
$closeQuote = $openQuote[3] === "'" ? substr($openQuote, 4, -2) : $closeQuote = substr($openQuote, 3);

?>
```

### Suggestions

-   Remove the extra semi-colon
-   Remove the useless instruction
-   Assign this expression to a variable and make use of it

  ----------- ----------------------------------------------------------------------------------------------------------
  Short name  Structures/UselessInstruction

  Rulesets    `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Quick (30 mins)

  Precision   High

  ClearPHP    [no-useless-instruction](https://github.com/dseguy/clearPHP/tree/master/rules/no-useless-instruction.md)
  ----------- ----------------------------------------------------------------------------------------------------------

Useless Interfaces
------------------

The interfaces below are defined and are implemented by some classes.

However, they are never used to enforce an object\'s class in the code,
using
[instanceof](https://www.php.net/manual/en/language.operators.type.php)
or in a typehint. As they are currently used, those interfaces may be
removed without change in behavior.

``` {.php}
<?php
    // only defined interface but never enforced
    interface i {};
    class c implements i {} 
?>
```

Interfaces should be used in Typehint or with the
[instanceof](https://www.php.net/manual/en/language.operators.type.php)
operator.

``` {.php}
<?php
    interface i {};

    function foo(i $arg) { 
        // Now, $arg is always an 'i'
    }

    function bar($arg) { 
        if (!($arg instanceof i)) {
            // Now, $arg is always an 'i'
        }
    }
?>
```

### Suggestions

-   Use the interface with instanceof, or a typehint
-   Drop the interface altogether : both definition and implements
    keyword

  ---------- --------------------------------------------------------------------------------------------------------
  Short name Interfaces/UselessInterfaces

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `ClassReview`{.interpreted-text role="ref"},
             `Typechecks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-useless-interfaces](https://github.com/dseguy/clearPHP/tree/master/rules/no-useless-interfaces.md)

  Examples   `woocommerce-interfaces-uselessinterfaces`{.interpreted-text role="ref"}
  ---------- --------------------------------------------------------------------------------------------------------

Useless Parenthesis
-------------------

Situations where parenthesis are not necessary, and may be removed.

Parenthesis group several elements together, and allows for a more
readable expression. They are used with logical and mathematical
expressions. They are necessary when the precedence of the operators are
not the intended execution order : for example, when an addition must be
performed before the multiplication.

Sometimes, the parenthesis provide the same execution order than the
default order : they are deemed useless.

``` {.php}
<?php

    if ( ($condition) ) {}
    while( ($condition) ) {}
    do $a++; while ( ($condition) );

    switch ( ($a) ) {}
    $y = (1);
    ($y) == (1);

    f(($x));

    // = has precedence over == 
    ($a = $b) == $c;

    ($a++);

    // No need for parenthesis in default values
    function foo($c = ( 1 + 2) ) {}
?>
```

See also [Operators
Precedence](https://www.php.net/manual/en/language.operators.precedence.php).

### Suggestions

-   Remove useless parenthesis, unless they are important for
    readability.

  ---------- ---------------------------------------------------------------
  Short name Structures/UselessParenthesis

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `mautic-structures-uselessparenthesis`{.interpreted-text
             role="ref"},
             `woocommerce-structures-uselessparenthesis`{.interpreted-text
             role="ref"}
  ---------- ---------------------------------------------------------------

Useless Referenced Argument
---------------------------

The argument has a reference, but is only used for reading.

This is probably a development artefact that was forgotten. It is better
to remove it.

This analysis also applies to
[foreach()](https://www.php.net/manual/en/control-structures.foreach.php)
loops, that declare the blind variable as reference, then use the
variable as an object, accessing properties and methods. When a variable
contains an object, there is no need to declare a reference : it is a
reference automatically.

``` {.php}
<?php

function foo($a, &$b, &$c) {
    // $c is passed by reference, but only read. The reference is useless.
    $b = $c + $a;
    // The reference is useful for $b
}

foreach ($array as &$element) {
    $element->method();
}

?>
```

See also [Objects and
references](https://www.php.net/manual/en/language.oop5.references.php).

### Suggestions

-   Remove the useless & from the argument
-   Make an actual use of the argument before the end of the method

  ----------- --------------------------------------------------------------------
  Short name  Functions/UselessReferenceArgument

  Rulesets    `Analyze`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Slow (1 hour)

  Precision   High

  Examples    `woocommerce-functions-uselessreferenceargument`{.interpreted-text
              role="ref"},
              `magento-functions-uselessreferenceargument`{.interpreted-text
              role="ref"}
  ----------- --------------------------------------------------------------------

Useless Return
--------------

The spotted functions or methods have a return statement, but this
statement is useless. This is the case for constructor and destructors,
whose return value are ignored or inaccessible.

When return is void, and the last element in a function, it is also
useless.

``` {.php}
<?php

class foo {
    function __construct() {
        // return is not used by PHP
        return 2;
    }
}

function bar(&$a) {
    $a++;
    // The last return, when empty, is useless
    return;
}

?>
```

### Suggestions

-   Remove the return expression. Keep any other calculation.

  ----------- ------------------------------------------------------------
  Short name  Functions/UselessReturn

  Rulesets    `Analyze`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Instant (5 mins)

  Precision   Very high

  Examples    `thinkphp-functions-uselessreturn`{.interpreted-text
              role="ref"},
              `vanilla-functions-uselessreturn`{.interpreted-text
              role="ref"}
  ----------- ------------------------------------------------------------

Useless Switch
--------------

This switch has only one case. It may very well be replaced by a ifthen
structure.

``` {.php}
<?php
switch($a) {
    case 1:
        doSomething();
        break;
}

// Same as 

if ($a == 1) {
    doSomething();
}
?>
```

### Suggestions

-   Turn the switch into a if/then for better readability
-   Add other cases to the switch, making it adapted to the situation

  ---------- -------------------------------------------------------------
  Short name Structures/UselessSwitch

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Instant (5 mins)
  Fix        

  Examples   `phpdocumentor-structures-uselessswitch`{.interpreted-text
             role="ref"},
             `dolphin-structures-uselessswitch`{.interpreted-text
             role="ref"}
  ---------- -------------------------------------------------------------

Useless Type Casting
--------------------

There is no need to overcast returned values.

``` {.php}
<?php

// trim always returns a string : cast is useless
$a = (string) trim($b);

// strpos doesn't always returns an integer : cast is useful
$a = (boolean) strpos($b, $c);

// comparison don't need casting, nor parenthesis
$c = (bool) ($b > 2);

?>
```

See also [Type
juggling](https://www.php.net/manual/en/language.types.type-juggling.php).

### Suggestions

-   Remove the type cast

  ----------- -------------------------------------------------------------
  Short name  Structures/UselessCasting

  Rulesets    `Analyze`{.interpreted-text role="ref"},
              `CI-checks`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Instant (5 mins)

  Precision   Very high

  Examples    `fuelcms-structures-uselesscasting`{.interpreted-text
              role="ref"},
              `thinkphp-structures-uselesscasting`{.interpreted-text
              role="ref"}
  ----------- -------------------------------------------------------------

Useless Type Check
------------------

With typehint, some checks on the arguments are now handled by the type
system.

In particular, a type hinted argument can\'t be null, unless it is
explicitly nullable, or has a `null` value as default.

``` {.php}
<?php

// The test on null is useless, it will never happen
function foo(A $a) {
    if (is_null($a)) { 
        // do something
    }
}

// Either nullable ? is too much, either the default null is
function barbar(?A $a = null) {
}

// The test on null is useful, the default value null allows it
function bar(A $a = null) {
    if ($a === null) { 
        // do something
    }
}


?>
```

See also [Type
Declarations](https://www.php.net/manual/en/functions.arguments.php#functions.arguments.type-declaration).

### Suggestions

-   Remove the nullable typehint
-   Remove the null default value
-   Remove tests on null

  ------------- -------------------------------------------
  Short name    Functions/UselessTypeCheck

  Rulesets      `Dead code <dead-code>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     Very high
  ------------- -------------------------------------------

Useless Typehint
----------------

[\_\_get](https://www.php.net/manual/en/language.oop5.magic.php) and
[\_\_set](https://www.php.net/manual/en/language.oop5.magic.php) magic
methods won\'t use any typehint. The name of the magic property is
always cast to string.

[\_\_call()](https://www.php.net/manual/en/language.oop5.magic.php)

``` {.php}
<?php

class x {
    // typehint is set and ignored
    function __set(float $name, string $value) {
        $this->$name = $value;
    }

    // typehint is set and ignored
    function __get(integer $name) {
        $this->$name = $value;
    }

    // typehint is checked by PHP 8.0 linting
    // typehint is enforced by PHP 7.x
    function __call(integer $name) {
        $this->$name = $value;
    }
}

$o = new x;
$b = array();
// Property will be called 'Array'
$o->{$b} = 2;

// type of $m is check at calling time. It must be string.
$o->{$m}();

?>
```

See also
[\_\_set](https://www.php.net/manual/en/language.oop5.overloading.php#object.set).

### Suggestions

-   Use [string]{.title-ref} for the [\$name]{.title-ref} parameter
-   Use no typehint for the [\$name]{.title-ref} parameter

  ------------- ----------------------------------------
  Short name    Classes/UselessTypehint

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"},
                `ClassReview`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     Very high
  ------------- ----------------------------------------

Useless Unset
-------------

There are situations where trying to remove a variable is actually
useless.

PHP ignores any command that tries to unset a global variable, a
[static](https://www.php.net/manual/en/language.oop5.static.php)
variable, or a blind variable from a foreach loop.

This is different from the garbage collector, which is run on its own
schedule. It is also different from an explicit unset, aimed at freeing
memory early : those are useful.

``` {.php}
<?php

function foo($a) {
    // unsetting arguments is useless
    unset($a);

    global $b;
    // unsetting global variable has no effect 
    unset($b);

    static $c;
    // unsetting static variable has no effect 
    unset($c);

    foreach($d as &$e){
        // unsetting a blind variable is useless
        (unset) $e;
    }
    // Unsetting a blind variable AFTER the loop is good.
    unset($e);
}

?>
```

See also [unset](https://www.php.net/unset).

### Suggestions

-   Remove the unset
-   Set the variable to null : the effect is the same on memory, but the
    variable keeps its existence.
-   Omit unsetting variables, and wait for the end of the scope. That
    way, PHP free memory en mass.

  ---------- ----------------------------------------------------------------------------------------------
  Short name Structures/UselessUnset

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-useless-unset](https://github.com/dseguy/clearPHP/tree/master/rules/no-useless-unset.md)

  Examples   `tine20-structures-uselessunset`{.interpreted-text role="ref"},
             `typo3-structures-uselessunset`{.interpreted-text role="ref"}
  ---------- ----------------------------------------------------------------------------------------------

Uses Default Values
-------------------

Default values are provided to methods so as to make it convenient to
use. However, with new versions, those values may change. For example,
in PHP 5.4, [htmlentities()](https://www.php.net/htmlentities) switched
from `Latin1` to `UTF-8` default encoding.

``` {.php}
<?php

$string = Eu não sou o pão;

echo htmlentities($string);

// PHP 5.3 : Eu n&Atilde;&pound;o sou o p&Atilde;&pound;o
// PHP 5.4 : Eu n&atilde;o sou o p&atilde;o

// Stable across versions
echo htmlentities($string, 'UTF8');

?>
```

As much as possible, it is recommended to use explicit values in those
methods, so as to prevent from being surprise at a future PHP evolution.

This analyzer tend to report a lot of false positives, including usage
of [count()](https://www.php.net/count).
[Count()](https://www.php.net/count) indeed has a second argument for
recursive counts, and a default value. This may be ignored safely.

### Suggestions

-   Mention all arguments, as much as possible

  ------------- ----------------------------------
  Short name    Functions/UsesDefaultArguments

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Using \$this Outside A Class {#using-$this-outside-a-class}
----------------------------

`$this` is a special variable, that should only be used in a class
context.

Until PHP 7.1, `$this` may be used as an argument in a function or a
method, a global, a
[static](https://www.php.net/manual/en/language.oop5.static.php) : while
this is legit, it sounds confusing enough to avoid it.

``` {.php}
<?php

function foo($this) {
    echo $this;
}

// A closure can be bound to an object at later time. It is valid usage.
$closure = function ($x) {
    echo $this->foo($x);
}

?>
```

Starting with PHP 7.1, the PHP engine check thoroughly that `$this` is
used in an appropriate manner, and raise fatal errors in case it isn\'t.

Yet, it is possible to find `$this` outside a class : if the file is
included inside a class, then `$this` will be recognized and validated.
If the file is included outside a class context, it will yield a fatal
error :
`` Using `$this <https://www.php.net/manual/en/language.oop5.basic.php>`_ when not in object context ``.

See also [Closure::bind](https://www.php.net/manual/en/closure.bind.php)
and [The Basics](https://www.php.net/manual/en/language.oop5.basic.php).

  ------------ ----------------------------------------------------------
  Short name   Classes/UsingThisOutsideAClass

  Rulesets     `Analyze`{.interpreted-text role="ref"},
               `CompatibilityPHP71`{.interpreted-text role="ref"},
               `LintButWontExec`{.interpreted-text role="ref"}

  Php Version  With PHP 7.0 and older

  Severity     Critical

  Time To Fix  Instant (5 mins)
  ------------ ----------------------------------------------------------

Using Deprecated Method
-----------------------

A call to a deprecated method has been spotted. A method is deprecated
when it bears a `@deprecated` parameter in its typehint definition.

Deprecated methods which are not called are not reported.

``` {.php}
<?php

// not deprecated method
not_deprecated();

// deprecated method
deprecated();

/**
 * @deprecated since version 2.0.0
 */
function deprecated() {}

function not_deprecated() {}

?>
```

See also
[\@deprecated](https://docs.phpdoc.org/latest/references/phpdoc/tags/deprecated.html).

### Suggestions

-   Replace the deprecated call with a stable call

  ------------- -----------------------------
  Short name    Functions/UsingDeprecated

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------

Usort Sorting In PHP 7.0
------------------------

[Usort()](https://www.php.net/usort),
[uksort()](https://www.php.net/uksort) and
[uasort()](https://www.php.net/uasort) behavior has changed in PHP 7.
Values that are equals (based on the user-provided method) may be sorted
differently than in PHP 5.

If this sorting is important, it is advised to add extra comparison in
the user-function and avoid returning 0 (thus, depending on default
implementation).

``` {.php}
<?php

$a = [ 2, 4, 3, 6];

function noSort($a) { return $a > 5; }

usort($a, 'noSort');
print_r($a);

?>
```

In PHP 5, the results is ::

    Array
    (
        [0] => 3
        [1] => 4
        [2] => 2
        [3] => 6
    )

in PHP 7, the result is ::

    Array
    (
        [0] => 2
        [1] => 4
        [2] => 3
        [3] => 6
    )

### Suggestions

-   Make sure the sorting function doesn\'t generate any ex-aequos.

  ------------- ----------------------------------------
  Short name    Php/UsortSorting

  Rulesets      `CompatibilityPHP70`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)

  Precision     Medium
  ------------- ----------------------------------------

Var Keyword
-----------

Var was used in PHP 4 to mark properties as public. Nowadays, new
keywords are available : public, protected, private. Var is equivalent
to public.

It is recommended to avoid using var, and explicitly use the new
keywords.

``` {.php}
<?php

class foo {
    public $bar = 1;
    // Avoid var
    //var $bar = 1; 
}

?>
```

See also
[Visibility](https://www.php.net/manual/en/language.oop5.visibility.php).

### Suggestions

-   It is recommended to avoid using var, and explicitly use the new
    keywords : private, protected, public

  ---------- ------------------------------------------------------------------------------------------------------
  Short name Classes/OldStyleVar

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  ClearPHP   [no-php4-class-syntax](https://github.com/dseguy/clearPHP/tree/master/rules/no-php4-class-syntax.md)

  Examples   `xataface-classes-oldstylevar`{.interpreted-text role="ref"}
  ---------- ------------------------------------------------------------------------------------------------------

Variable Global
---------------

Variable global such are valid in PHP 5.6, but no in PHP 7.0. They
should be replaced with \${\$foo-\>bar}.

``` {.php}
<?php

// Forbidden in PHP 7
global $normalGlobal;

// Forbidden in PHP 7
global $$variable->global ;

// Tolerated in PHP 7
global ${$variable->global};

?>
```

  ---------- --------------------------------------------------------------
  Short name Structures/VariableGlobal

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and older
  Version    

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        
  ---------- --------------------------------------------------------------

Variable Is Not A Condition
---------------------------

Avoid using a lone variable as a condition. It is recommended to use a
comparative value, or one of the filtering function, such as
[isset()](https://www.www.php.net/isset),
[empty()](https://www.php.net/empty).

Using the raw variable as a condition blurs the difference between an
undefined variable and an empty value. By using an explicit comparison
or validation function, it is easier to understand what the variable
stands for.

``` {.php}
<?php

if (isset($error)) {
    echo 'Found one error : '.$error!;
}

//
if ($errors) {
    print count($errors).' errors found : '.join('', $errors).PHP_EOL;
    echo 'Not found';
}

?>
```

Thanks to the [PMB](https://www.sigb.net/) team for the inspiration.

### Suggestions

-   Make the validation explicit, by using a comparison operator, or one
    of the validation function.

  ------------- -----------------------------------
  Short name    Structures/NoVariableIsACondition

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------------

Variables With One Letter Names
-------------------------------

Variables with one letter name are the shortest name for variables. They
also bear very little meaning : what does contain the variable `$w` ?

Some one-letter variables have meaning : `$x` and `$y` for coordinates,
`$i`, `$j`, `$k` for blind variables. Others tend to be an easy way to
give a name to a variable, without thinking too hard a good name.

``` {.php}
<?php

// $a is reported as a one-letter variable
$a = 0;

// $i is considered a false positive. 
for($i = 0; $i < 10; ++$i) {
    $a += doSomething($i);
}

?>
```

See also [Using single characters for variable names in
loops/exceptions](https://softwareengineering.stackexchange.com/questions/71710/using-single-characters-for-variable-names-in-loops-exceptions?utm_medium=organic&utm_source=google_rich_qa&utm_campaign=google_rich_qa/)
and [Single Letter Variable Names Still Considered
Harmful](https://odetocode.com/blogs/scott/archive/2008/11/17/single-letter-variable-names-still-considered-harmful.aspx).

### Suggestions

-   Make the variable more meaningful, with full words

  ------------ -------------------------------
  Short name   Variables/VariableOneLetter

  Rulesets     `Semantics`{.interpreted-text
               role="ref"}

  Precision    Very high
  ------------ -------------------------------

Weak Typing
-----------

The test on a variable is not enough. The variable is checked for null,
then used as an object or an array.

``` {.php}
<?php

if ($a !== null) {
    echo $a->b;
}

?>
```

See also [From assumptions to
assertions](https://rskuipers.com/entry/from-assumptions-to-assertions).

### Suggestions

-   Use instanceof when checking for objects
-   Use is\_array() when checking for arrays. Also consider
    is\_string(), is\_int(), etc.
-   Use typehint when the variable is an argument

  ------------- -----------------------------------------------
  Short name    Classes/WeakType

  Rulesets      `Analyze`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)

  Examples      `teampass-classes-weaktype`{.interpreted-text
                role="ref"}
  ------------- -----------------------------------------------

Weird Array Index
-----------------

Array index that looks weird. Arrays index may be string or integer, but
some strings looks weird.

In particular, strings that include terminal white spaces, often leads
to missed values.

``` {.php}
<?php

$array = ['a ' => 1, 'b' => 2, 'c' => 3];

// Later in the code

//Notice: Undefined index: a in /Users/famille/Desktop/analyzeG3/test.php on line 8
echo $array['a'];

//Notice: Undefined index: b  in /Users/famille/Desktop/analyzeG3/test.php on line 10
// Note that the space is visible, but easy to miss
echo $array['b '];

// all fine here
echo $array['c'];

?>
```

Although this is rare error, and often easy to spot, it is also very
hard to find when it strikes.

### Suggestions

-   Remove white spaces when using strings as array index.

  ------------- -------------------------------
  Short name    Arrays/WeirdIndex

  Rulesets      `Semantics`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------

While(List() = Each()) {#while(list()-=-each())}
----------------------

This code structure is quite old : it should be replace by the more
modern and efficient foreach.

This structure is deprecated since PHP 7.2. It may disappear in the
future.

``` {.php}
<?php

    while(list($key, $value) = each($array)) {
        doSomethingWith($key) and $value();
    }

    foreach($array as $key => $value) {
        doSomethingWith($key) and $value();
    }
?>
```

See also [PHP RFC: Deprecations for PHP 7.2 : \`Each()
\<https://www.php.net/each\>]{.title-ref}\_
\<<https://wiki.php.net/rfc/deprecations_php_7_2#each>\>\`\_.

### Suggestions

-   Change this loop with foreach
-   Change this loop with an [array]()\* function with a callback

  ---------- ------------------------------------------------------------
  Short name Structures/WhileListEach

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Performances`{.interpreted-text role="ref"},
             `Suggestions`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Instant (5 mins)
  Fix        

  Examples   `openemr-structures-whilelisteach`{.interpreted-text
             role="ref"},
             `dolphin-structures-whilelisteach`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Written Only Variables
----------------------

Those variables are being written, but never read. This way, they are
useless and should be removed, or read at some point.

``` {.php}
<?php

// $a is used multiple times, but never read
$a = 'a';
$a .= 'b';

$b = 3; 
//$b is actually read once
$a .= $b + 3; 

?>
```

### Suggestions

-   Check that variables are written AND read in each context
-   Remove variables that are only read
-   Use the variable that are only read

  ---------- --------------------------------------------------------------------------------------------------
  Short name Variables/WrittenOnlyVariable

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  ClearPHP   [no-unused-variable](https://github.com/dseguy/clearPHP/tree/master/rules/no-unused-variable.md)

  Examples   `dolibarr-variables-writtenonlyvariable`{.interpreted-text role="ref"},
             `suitecrm-variables-writtenonlyvariable`{.interpreted-text role="ref"}
  ---------- --------------------------------------------------------------------------------------------------

Wrong Access Style to Property
------------------------------

Use the right syntax when reaching for a property.
[Static](https://www.php.net/manual/en/language.oop5.static.php)
properties use the `\:\:` operator, and
non-[static](https://www.php.net/manual/en/language.oop5.static.php)
properties use `->`.

Mistaking one of the other raise two different reactions from PHP :
`` Access to undeclared `static <https://www.php.net/manual/en/language.oop5.static.php>`_ property ``
is a fatal error, while
`` PHP Notice:  Accessing `static <https://www.php.net/manual/en/language.oop5.static.php>`_ property aa\:\:$a as non `static <https://www.php.net/manual/en/language.oop5.static.php>`_ ``
is a notice.

``` {.php}
<?php

class a { 
    static public $a = 1;

    function foo() {
        echo self::$a; // right
        echo $this->a; // WRONG
    }
}

class b { 
    public $b = 1;

    function foo() {
        echo $this->$b;  // right
        echo b::$b;      // WRONG
    }
}

?>
```

This analysis reports both
[static](https://www.php.net/manual/en/language.oop5.static.php)
properties with a [-\>]{.title-ref} access, and
non-[static](https://www.php.net/manual/en/language.oop5.static.php)
properties with a [::]{.title-ref} access.

See also [Static
Keyword](https://www.php.net/manual/en/language.oop5.%60static%20%3Chttps://www.php.net/manual/en/language.oop5.static.php).php\>\`\_.

### Suggestions

-   Match the property call with the definition
-   Make the property static

  ------------- ---------------------------------------------------------------
  Short name    Classes/UndeclaredStaticProperty

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `ClassReview`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Critical

  Time To Fix   Quick (30 mins)

  Examples      `humo-gen-classes-undeclaredstaticproperty`{.interpreted-text
                role="ref"}
  ------------- ---------------------------------------------------------------

Wrong Argument Type
-------------------

Checks that the type of the argument is consistent with the type of the
called method.

``` {.php}
<?php

function foo(int $a) { }

//valid call, with an integer
foo(1);

//invalid call, with a string
foo('asd');

?>
```

This analysis is valid with PHP 8.0.

### Suggestions

-   Always use a valid type when calling methods.

  ------------- -----------------------------------
  Short name    Functions/WrongArgumentType

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `Typechecks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------------

Wrong Attribute Configuration
-----------------------------

A class is attributed to the wrong PHP structure.

``` {.php}
<?php
#[Attribute(Attribute::TARGET_CLASS)]
class ClassAttribute { }

// Wrong
#[ClassAttribute]
function foo () {}

// OK
#[ClassAttribute]
class y  {}

?>
```

### Suggestions

-   Remove the attribute from the wrongly attributed structure
-   Extend the configuration of the attribute with
    Attribute::[TARGET]()\*

  ------------- ---------------------------------
  Short name    Php/WrongAttributeConfiguration

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Php Version   8.0+

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------

Wrong Case Namespaces
---------------------

Namespaces are case-insentives.

``` {.php}
<?php

// Namespaces should share the same case
namespace X {}

namespace x {}

?>
```

### Suggestions

-   Synchronize all names

  ------------- ----------------------
  Short name    Namespaces/WrongCase

  Rulesets      none

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------

Wrong Class Name Case
---------------------

The spotted classes are used with a different case than their
definition. While PHP accepts this, it makes the code harder to read.

It may also be a violation of coding conventions.

``` {.php}
<?php

// This use statement has wrong case for origin.
use Foo as X;

// Definition of the class
class foo {}

// Those instantiations have wrong case
new FOO();
new X();

?>
```

See also [PHP class name constant case sensitivity and
PSR-11](https://gist.github.com/bcremer/9e8d6903ae38a25784fb1985967c6056).

### Suggestions

-   Match the defined class name with the called name

  ----------- ----------------------------------------------------------------
  Short name  Classes/WrongCase

  Rulesets    `Coding Conventions <coding-conventions>`{.interpreted-text
              role="ref"},
              `Coding Conventions <coding-conventions>`{.interpreted-text
              role="ref"},
              `Coding Conventions <coding-conventions>`{.interpreted-text
              role="ref"}

  Severity    Minor

  Time To Fix Instant (5 mins)

  Precision   High

  Examples    `wordpress-classes-wrongcase`{.interpreted-text role="ref"}
  ----------- ----------------------------------------------------------------

Wrong Function Name Case
------------------------

The spotted functions are used with a different case than their
definition. While PHP accepts this, it makes the code harder to read.

It may also be a violation of coding conventions.

``` {.php}
<?php

// Definition of the class
function foo () {}

// Those calls have wrong case
FOO();
\Foo();

// This is valid
foo();

?>
```

See also [PHP class name constant case sensitivity and
PSR-11](https://gist.github.com/bcremer/9e8d6903ae38a25784fb1985967c6056).

### Suggestions

-   Match the defined functioncall with the called name

  ------------- ---------------------
  Short name    Functions/WrongCase

  Rulesets      none

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ---------------------

Wrong Number Of Arguments
-------------------------

Those functioncalls are made with too many or too few arguments.

When the number arguments is wrong for native functions, PHP emits a
warning. When the number arguments is too small for custom functions,
PHP raises an exception. When the number arguments is too high for
custom functions, PHP ignores the arguments. Such arguments should be
handled with the variadic operator, or with
[func\_get\_args()](https://www.php.net/func_get_args) family of
functions.

``` {.php}
<?php

echo strtoupper('This function is', 'ignoring arguments');
//Warning: strtoupper() expects exactly 1 parameter, 2 given in Command line code on line 1

echo strtoupper();
//Warning: strtoupper() expects exactly 1 parameter, 0 given in Command line code on line 1

function foo($argument) {}
echo foo();
//Fatal error: Uncaught ArgumentCountError: Too few arguments to function foo(), 0 passed in /Users/famille/Desktop/analyzeG3/test.php on line 10 and exactly 1 expected in /Users/famille/Desktop/analyzeG3/test.php:3

echo foo('This function is', 'ignoring arguments');

?>
```

It is recommended to check the signature of the methods, and fix the
arguments.

### Suggestions

-   Add more arguments to fill the list of compulsory arguments
-   Remove arguments to fit the list of compulsory arguments
-   Use another method or class

  ----------- ----------------------------------------------------------------------------------------------------------
  Short name  Functions/WrongNumberOfArguments

  Rulesets    `Analyze`{.interpreted-text role="ref"}, `CI-checks`{.interpreted-text role="ref"}

  Severity    Major

  Time To Fix Quick (30 mins)

  Precision   High

  ClearPHP    [no-missing-argument.md](https://github.com/dseguy/clearPHP/tree/master/rules/no-missing-argument.md.md)

  Examples    `xataface-functions-wrongnumberofarguments`{.interpreted-text role="ref"}
  ----------- ----------------------------------------------------------------------------------------------------------

Wrong Optional Parameter
------------------------

Wrong placement of optional parameters.

PHP parameters are optional when they defined with a default value, like
this :

``` {.php}
<?php
    function x($arg = 1) {
        // PHP code here
    }
?>
```

When a function have both compulsory and optional parameters, the
compulsory ones should appear first, and the optional should appear last
:

``` {.php}
<?php
    function x($arg, $arg2 = 2) {
        // PHP code here
    }
?>
```

PHP solves this problem at runtime, assign values in the same other, but
will miss some of the default values and emits warnings.

It is better to put all the optional parameters at the end of the
method\'s signature.

Optional parameter wrongly placed are now a Notice in PHP 8.0. The only
previous case that is allowed in PHP 8.0 and also in this analysis, is
when the `null` value is used as default for typed arguments.

See also [Function
arguments](https://www.php.net/manual/en/functions.arguments.php).

### Suggestions

-   Give default values to all but first parameters. Null is a good
    default value, as PHP will use it if not told otherwise.
-   Remove default values to all but last parameters. That is probably a
    weak solution.
-   Change the order of the values, so default-valued parameters are at
    the end. This will probably have impact on the rest of the code, as
    the API is changing.

  ---------- --------------------------------------------------------------
  Short name Functions/WrongOptionalParameter

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        

  Examples   `fuelcms-functions-wrongoptionalparameter`{.interpreted-text
             role="ref"},
             `vanilla-functions-wrongoptionalparameter`{.interpreted-text
             role="ref"}
  ---------- --------------------------------------------------------------

Wrong Parameter Type
--------------------

The expected parameter is not of the correct type. Check PHP
documentation to know which is the right format to be used.

``` {.php}
<?php

// substr() shouldn't work on integers.
// the first argument is first converted to string, and it is 123456.
echo substr(123456, 0, 4); // display 1234

// substr() shouldn't work on boolean
// the first argument is first converted to string, and it is 1, and not t
echo substr(true, 0, 1); // displays 1

// substr() works correctly on strings.
echo substr(123456, 0, 4);

?>
```

  ------------- -------------------------------------------------------
  Short name    Php/InternalParameterType

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)

  Examples      `zencart-php-internalparametertype`{.interpreted-text
                role="ref"}
  ------------- -------------------------------------------------------

Wrong Range Check
-----------------

The interval check should use && and not \|\|.

``` {.php}
<?php

//interval correctly checked a is between 2 and 999
if ($a > 1 && $a < 1000) {}

//interval incorrectly checked : a is 2 or more ($a < 1000 is never checked)
if ($a > 1 || $a < 1000) {}

?>
```

### Suggestions

-   Make the interval easy to read and understand
-   Check the truth table for the logical operation

  ---------- ------------------------------------------------------------
  Short name Structures/WrongRange

  Rulesets   `Analyze`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Instant (5 mins)
  Fix        

  Examples   `dolibarr-structures-wrongrange`{.interpreted-text
             role="ref"},
             `wordpress-structures-wrongrange`{.interpreted-text
             role="ref"}
  ---------- ------------------------------------------------------------

Wrong Type For Native PHP Function
----------------------------------

This analysis reports calls to a PHP native function with a wrongly
typed value.

``` {.php}
<?php

// valid calls
echo exp(1);
echo exp(2.5);

// invalid calls
echo exp(1);
echo exp(array(2.5));

// valid call, but invalid math
// -1 is not a valid value for log(), but -1 is a valid type (int) : it is not reported by this analysis.
echo log(-1);
?>
```

### Suggestions

-   Set the code to the valid type, when calling a PHP native function

  ------------- ----------------------------------
  Short name    Php/WrongTypeForNativeFunction

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

Wrong Type Returned
-------------------

The returned value is not compatible with the specified return type.

``` {.php}
<?php

// classic error
function bar() : int {
    return 'A';
}

// classic static error
const B = 2;
function bar() : string {
    return B;
}

// undecideable error
function bar($c) : string {
    return $c;
}

// PHP lint this, but won't execute it
function foo() : void {
    // No return at all 
}

?>
```

See also [Returning
values](https://www.php.net/manual/en/functions.returning-values.php)
and [Void Return Type](https://wiki.php.net/rfc/void_return_type).

### Suggestions

-   Match the return type with the return value
-   Remove the return expression altogether
-   Add a typecast to the returning expression

  ------------- ------------------------------------------------------
  Short name    Functions/WrongReturnedType

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `ClassReview`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     High
  ------------- ------------------------------------------------------

Wrong Type With Call
--------------------

This analysis checks that a call to a method uses the right literal
values\' types.

Currently, this analysis doesn\'t take into account `strict_types = 1`.

``` {.php}
<?php

function foo(string $a) {

}

// wrong type used
foo(1);

// wrong type used
foo("1");

?>
```

### Suggestions

-   Use the right type with all literals

  ------------- -----------------------------------------------------
  Short name    Functions/WrongTypeWithCall

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `Typechecks`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Precision     Very high
  ------------- -----------------------------------------------------

Wrong Typed Property Default
----------------------------

Property is typed with an incompatible default value type.

Init type might be a new instance, the return of a method call or an
interface compatible object.

``` {.php}
<?php

class x {
    private A $property;
    private B $incompatible;

    function __construct() {
        // This is compatible
        $this->property = new A();

        // This is incompatible : new B() expected
        $this->incompatible = new C();

    }
}

?>
```

PHP compiles such code, but won\'t execute it, as it detects the
incompatibility.

### Suggestions

-   Remove the type hint of the property
-   Fix the initialization call
-   Use an interface for typehint

  ---------- ------------------------------------------------------------
  Short name Classes/WrongTypedPropertyInit

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `LintButWontExec`{.interpreted-text role="ref"},
             `ClassReview`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Php        7.4+
  Version    

  Severity   Minor

  Time To    Quick (30 mins)
  Fix        
  ---------- ------------------------------------------------------------

Wrong Typehinted Name
---------------------

The parameter name doesn\'t reflect the typehint used.

There are no restriction on parameter names, except its uniqueness in
the signature. Yet, using a scalar typehint as the name for another
typehinted value is just misleading.

``` {.php}
<?php

function foo(string $array,
             int $int) {
    // doSomething()
}

function bar(array $strings) {
    // doSomething()
}

?>
```

The comparison relies on exact names : calling an array a list of
`strings` is OK with this analysis.

### Suggestions

-   Rename

  ------------ -------------------------------------------------------------
  Short name   Functions/WrongTypehintedName

  Rulesets     `Coding Conventions <coding-conventions>`{.interpreted-text
               role="ref"}, `Semantics`{.interpreted-text role="ref"}

  Severity     Minor

  Time To Fix  Quick (30 mins)
  ------------ -------------------------------------------------------------

Wrong fopen() Mode {#wrong-fopen()-mode}
------------------

Wrong file opening for [fopen()](https://www.php.net/fopen).

[fopen()](https://www.php.net/fopen) has a few modes, as described in
the documentation : \'r\', \'r+\', for reading; \'w\', \'w+\' for
writing; \'a\', \'a+\' for appending; \'x\', \'x+\' for modifying;
\'c\', \'c+\' for writing and locking, \'t\' for text files and windows
only. An optional \'b\' may be used to make the
[fopen()](https://www.php.net/fopen) call more portable and binary safe.
Another optional \'t\' may be used to make the
[fopen()](https://www.php.net/fopen) call process automatically text
input : this one should be avoided.

``` {.php}
<?php

// open the file for reading, in binary mode
$fp = fopen('/tmp/php.txt', 'rb');

// New option e in PHP 7.0.16 and 7.1.2 (beware of compatibility)
$fp = fopen('/tmp/php.txt', 'rbe');

// Unknown option x
$fp = fopen('/tmp/php.txt', 'rbx');

?>
```

Any other values are not understood by PHP.

### Suggestions

-   Check the docs, choose the right opening mode.

  ------------ ----------------------------------------------------------
  Short name   Php/FopenMode

  Rulesets     `Analyze`{.interpreted-text role="ref"},
               `CI-checks`{.interpreted-text role="ref"}

  Severity     Major

  Time To Fix  Quick (30 mins)

  Examples     `tikiwiki-php-fopenmode`{.interpreted-text role="ref"},
               `humo-gen-php-fopenmode`{.interpreted-text role="ref"}
  ------------ ----------------------------------------------------------

Yoda Comparison
---------------

Yoda comparison is a way to write conditions which places literal values
on the left side.

``` {.php}
<?php
  if (1 == $a) {
    // Then condition
  } 
?>
```

The objective is to avoid mistaking a comparison to an assignation. If
the comparison operator is mistaken, but the literal is on the left,
then an error will be triggered, instead of a silent bug.

``` {.php}
<?php
    // error in comparison! 
    if ($a = 1) {
        // Then condition
    } 
?>
```

See also [Yoda
Conditions](https://en.wikipedia.org/wiki/Yoda_conditions), [Yoda
Conditions: To Yoda or Not to
Yoda](https://knowthecode.io/yoda-conditions-yoda-not-yoda).

  ------------- -------------------------------------------------------------
  Short name    Structures/YodaComparison

  Rulesets      `Coding Conventions <coding-conventions>`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- -------------------------------------------------------------

::: {#\\_\\_dir\\_\\_-then-slash}

------------------------------------------------------------------------
:::

[\_\_DIR\_\_](https://www.php.net/manual/en/language.constants.predefined.php)
must be concatenated with a string starting with /.

The magic constant
[\_\_DIR\_\_](https://www.php.net/manual/en/language.constants.predefined.php)
holds the name of the current directory, without final /. When it is
used to build path, then the following path fragment must start with /.
Otherwise, two directories names will be merged together.

``` {.php}
<?php

// __DIR__ = /a/b/c
// $filePath = /a/b/c/g.php

// /a/b/c/d/e/f.txt : correct path
echo __DIR__.'/d/e/f.txt';
echo dirname($filePath).'/d/e/f.txt';

// /a/b/cd/e/f.txt : most probably incorrect path
echo __DIR__.'d/e/f.txt';
echo dirname($filePath).'d/e/f.txt';

?>
```

### Suggestions

-   Add a check on \_\_DIR\_\_, as it may be \'/\' when run at the root
    of the server
-   Add a \'/\' at the beginning of the path after \_\_DIR\_\_.
-   Add a call to realpath() or file\_exists(), before accessing the
    file.

  ------------- --------------------------------------------------
  Short name    Structures/DirThenSlash

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Major

  Time To Fix   Instant (5 mins)

  Precision     Very high

  Examples      `traq-structures-dirthenslash`{.interpreted-text
                role="ref"}
  ------------- --------------------------------------------------

::: {#\\_\\_debuginfo()-usage}

------------------------------------------------------------------------
:::

The magic method
[\_\_debugInfo()](https://www.php.net/manual/en/language.oop5.magic.php)
provides a custom way to dump an object.

It has been introduced in PHP 5.6. In the previous versions of PHP, this
method is ignored and won\'t be called when debugging.

``` {.php}
<?php

// PHP 5.6 or later
class foo {
    private $bar = 1;
    private $reallyHidden = 2;

    function __debugInfo() {
        return ['bar' => $this->bar,
                'reallyHidden' => 'Secret'];
    }
}

$f = new Foo();
var_dump($f);

/* Displays : 
object(foo)#1 (2) {
  [bar]=>
  int(1)
  [reallyHidden]=>
  string(6) Secret
}
*/

?>
```

See also [Magic
methods](https://www.php.net/manual/en/language.oop5.magic.php).

  ---------- ------------------------------------------------------------
  Short name Php/debugInfoUsage

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"}

  Php        With PHP 5.6 and more recent
  Version    

  Severity   Minor

  Time To    Slow (1 hour)
  Fix        

  Examples   `dolibarr-php-debuginfousage`{.interpreted-text role="ref"}
  ---------- ------------------------------------------------------------

::: {#\\_\\_tostring()-throws-exception}

------------------------------------------------------------------------
:::

Magical method
[\_\_toString()](https://www.php.net/manual/en/language.oop5.magic.php)
can\'t throw exceptions.

In fact,
[\_\_toString()](https://www.php.net/manual/en/language.oop5.magic.php)
may not let an exception pass. If it throw an exception, but must catch
it. If an underlying method throws an exception, it must be caught.

``` {.php}
<?php

class myString {
    private $string = null;

    public function __construct($string) {
        $this->string = $string;
    }

    public function __toString() {
        // Do not throw exceptions in __toString
        if (!is_string($this->string)) {
            throw new Exception("$this->string is not a string!!");
        }

        return $this->string;
    }
}   

?>
```

A fatal error is displayed, when an exception is not intercepted in the
[\_\_toString()](https://www.php.net/manual/en/language.oop5.magic.php)
function.

:

    PHP Fatal error:  Method myString\:\:`__toString() <https://www.php.net/manual/en/language.oop5.magic.php>`_ must not throw an exception, caught Exception: 'Exception message' in ``file.php``

See also
[\_\_toString()](https://www.php.net/manual/en/language.oop5.magic.php).

### Suggestions

-   Remove any usage of exception from \_\_toString() magic method

  ------------- ------------------------------------
  Short name    Structures/toStringThrowsException

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Php Version   7.4-

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------

array\_key\_exists() Speedup {#array\\_key\\_exists()-speedup}
----------------------------

[isset()](https://www.www.php.net/isset) used to be the fastest, but
[array\_key\_exists()](https://www.php.net/array_key_exists) is. Since
PHP 7.4, [array\_key\_exists()](https://www.php.net/array_key_exists)
has its own opcode, leading to better features and speed.

[isset()](https://www.www.php.net/isset) is faster for all non-empty
values, but is limited when the value is
[NULL](https://www.php.net/manual/en/language.types.null.php) or empty :
then, [array\_key\_exists()](https://www.php.net/array_key_exists) has
the good features.

`` This change makes `array_key_exists() <https://www.php.net/array_key_exists>`_ actually faster than `isset() <https://www.www.php.net/isset>`_ by ~25% (tested with GCC 8, -O3, march=native, mtune=native). ``.

``` {.php}
<?php

$foo = [123 => 456];

// This is sufficient and efficient since PHP 7.4
if (array_search_key($foo[123])) {
    // do something
}

// taking advantages of performances for PHP 7.4 and older
if (isset($foo[123]) || array_search_key($foo[123])) {
    // do something
}

?>
```

See also [Implement ZEND\_ARRAY\_KEY\_EXISTS opcode to speed up
\`array\_key\_exists()
\<https://www.php.net/array\_key\_exists\>]{.title-ref}\_
\<<https://github.com/php/php-src/pull/3360>\>\`\_.

### Suggestions

-   Remove the logical test and the isset() call

  ------------- -----------------------------------------
  Short name    Performances/ArrayKeyExistsSpeedup

  Rulesets      `Suggestions`{.interpreted-text
                role="ref"},
                `Performances`{.interpreted-text
                role="ref"}

  Php Version   7.4+

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------------------

array\_key\_exists() Works On Arrays {#array\\_key\\_exists()-works-on-arrays}
------------------------------------

[array\_key\_exists()](https://www.php.net/array_key_exists) requires
arrays as second argument. Until PHP 7.4, objects were also allowed, yet
it is now deprecated.

``` {.php}
<?php

// Valid way to check for key
$array = ['a' => 1];
var_dump(array_key_exists('a', $array))


// Deprecated since PHP 7.4
$object = new Stdclass();
$object->a = 1;
var_dump(array_key_exists('a', $object))

?>
```

See also [array\_key\_exists() with objects](https://wiki.php.net/rfc/deprecations_php_7_4#array_key_exists_with_objects), and

:   [array\_key\_exists](https://php.net/array-key-exists), and.

### Suggestions

-   Use the (array) cast to turn the object into an array
-   Use the native PHP function proprety\_exists() or isset() on the
    property to check them.

  ------------- -------------------------------------------
  Short name    Php/ArrayKeyExistsWithObjects

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}, `Analyze`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------------------

array\_merge() And Variadic {#array\\_merge()-and-variadic}
---------------------------

Always check value in variadic before using it with
[array\_merge()](https://www.php.net/array_merge) and
[array\_merge\_recursive()](https://www.php.net/array_merge_recursive).

Before PHP 7.4, [array\_merge()](https://www.php.net/array_merge) and
[array\_merge\_recursive()](https://www.php.net/array_merge_recursive)
would complain when no argument was provided. As such, using the spread
operator [\...]{.title-ref} on an empty
[array()](https://www.php.net/array) would yield no argument, and an
error.

``` {.php}
<?php

// 
$b = array_merge(...$x);



?>
```

### Suggestions

-   Add a check to the spread variable to ensure it is not empty
-   Append an empty array to to the spread variable to ensure it is not
    empty

  ------------- ----------------------------------
  Short name    Structures/ArrayMergeAndVariadic

  Rulesets      `Analyze`{.interpreted-text
                role="ref"}

  Php Version   7.4-

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------

crypt() Without Salt {#crypt()-without-salt}
--------------------

PHP requires a salt when calling [crypt()](https://www.php.net/crypt).
5.5 and previous versions didn\'t require it. Salt is a simple string,
that is usually only known by the application.

According to the manual : The salt parameter is optional. However,
[crypt()](https://www.php.net/crypt) creates a weak hash without the
salt. PHP 5.6 or later raise an E\_NOTICE error without it. Make sure to
specify a strong enough salt for better security.

``` {.php}
<?php
// Set the password
$password = 'mypassword';

// salted crypt usage (always valid)
$hash = crypt($password, '123salt');

// Get the hash, letting the salt be automatically generated
// This generates a notice after PHP 5.6
$hash = crypt($password);

?>
```

See also [crypt](http://www.php.net/crypt).

### Suggestions

-   Always provide the second argument

  ------------- ----------------------------------------
  Short name    Structures/CryptWithoutSalt

  Rulesets      `CompatibilityPHP54`{.interpreted-text
                role="ref"}

  Php Version   With PHP 5.6 and older

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ----------------------------------------

curl\_version() Has No Argument {#curl\\_version()-has-no-argument}
-------------------------------

[curl\_version()](https://www.php.net/curl_version) used to accept
`CURLVERSION_NOW` as argument. Since PHP 7.4, it is a function without
arguments.

``` {.php}
<?php

// Compatible syntax
$details = curl_version(CURLVERSION_NOW);

// New PHP 7.4 syntax
$details = curl_version();

?>
```

See also
[curl\_version](https://www.php.net/manual/en/function.curl-version.php).

### Suggestions

-   Drop all arguments from curl\_version() calls.

  ------------- ----------------------------------------
  Short name    Structures/CurlVersionNow

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

error\_reporting() With Integers {#error\\_reporting()-with-integers}
--------------------------------

Using named constants with error\_reporting is strongly encouraged to
ensure compatibility for future versions. As error levels are added, the
range of integers increases, so older integer-based error levels will
not always behave as expected. (Adapted from the documentation).

``` {.php}
<?php

// This is ready for PHP next version
error_reporting(E_ALL & ~E_DEPRECATED & ~E_STRICT & ~E_NOTICE & ~E_WARNING);

// This is not ready for PHP next version
error_reporting(2047);

// -1 and 0 are omitted, as they will be valid even is constants changes.
error_reporting(-1);
error_reporting(0);

?>
```

See also [directive
error\_reporting](https://www.php.net/manual/en/errorfunc.configuration.php#ini.error-reporting)
and
[error\_reporting](https://www.php.net/manual/en/function.error-reporting.php).

### Suggestions

-   Always use the constant combination when configuring
    error\_reporting or any PHP native function

  ------------- -------------------------------------------------------------------
  Short name    Structures/ErrorReportingWithInteger

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)

  Examples      `sugarcrm-structures-errorreportingwithinteger`{.interpreted-text
                role="ref"}
  ------------- -------------------------------------------------------------------

eval() Without Try {#eval()-without-try}
------------------

`eval()` emits a `ParseError` exception with PHP 7 and later. Catching
this exception is the recommended way to handle errors when using the
`eval()` function.

``` {.php}
<?php

$code = 'This is no PHP code.';

//PHP 5 style
eval($code);
// Ends up with a Fatal error, at execution time

//PHP 7 style
try {
    eval($code);
} catch (ParseError $e) {
    cleanUpAfterEval();
}

?>
```

Note that it will catch situations where `eval()` is provided with code
that can\'t be used, but it will not catch security problems. Avoid
using `eval()` with incoming data.

### Suggestions

-   Always add a try/catch block around eval() call

  ---------- ----------------------------------------------------------------
  Short name Structures/EvalWithoutTry

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `Security`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and more recent
  Version    

  Severity   Critical

  Time To    Quick (30 mins)
  Fix        

  Examples   `fuelcms-structures-evalwithouttry`{.interpreted-text
             role="ref"},
             `expressionengine-structures-evalwithouttry`{.interpreted-text
             role="ref"}
  ---------- ----------------------------------------------------------------

ext/apc {#ext/apc}
-------

Extension Alternative PHP Cache.

The Alternative PHP Cache (APC) is a free and open opcode cache for PHP.
Its goal is to provide a free, open, and robust framework for caching
and optimizing PHP intermediate code.

This extension is considered unmaintained and dead.

``` {.php}
<?php
   $bar = 'BAR';
   apc_add('foo', $bar);
   var_dump(apc_fetch('foo'));
   echo PHP_EOL;

   $bar = 'NEVER GETS SET';
   apc_add('foo', $bar);
   var_dump(apc_fetch('foo'));
   echo PHP_EOL;
?>
```

See also [Alternative PHP Cache](https://www.php.net/apc).

  ------------- ----------------------------------------
  Short name    Extensions/Extapc

  Rulesets      `CompatibilityPHP55`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.0 and older

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

ext/dba {#ext/dba}
-------

Extension ext/dba.

These functions build the foundation for accessing Berkeley DB style
databases.

``` {.php}
<?php

$id = dba_open('/tmp/test.db', 'n', 'db2');

if (!$id) {
    echo 'dba_open failed'.PHP_EOL;
    exit;
}

dba_replace('key', 'This is an example!', $id);

if (dba_exists('key', $id)) {
    echo dba_fetch('key', $id);
    dba_delete('key', $id);
}

dba_close($id);
?>
```

See also [Database (dbm-style) Abstraction
Layer](https://www.php.net/manual/en/book.dba.php).

  ------------- ----------------------------------------
  Short name    Extensions/Extdba

  Rulesets      `CompatibilityPHP53`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

ext/ereg {#ext/ereg}
--------

Extension ext/ereg.

``` {.php}
<?php
if (ereg ('([0-9]{4})-([0-9]{1,2})-([0-9]{1,2})', $date, $regs)) {
    echo $regs[3].'.'.$regs[2].'.'.$regs[1];
} else {
    echo 'Invalid date format: '.$date;
}
?>
```

See also [Ereg](https://www.php.net/manual/en/function.ereg.php).

  ------------- ----------------------------------------
  Short name    Extensions/Extereg

  Rulesets      `CompatibilityPHP70`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.0 and older

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

ext/fdf {#ext/fdf}
-------

Extension ext/fdf.

Forms Data Format
([FDF](http://www.adobe.com/devnet/acrobat/fdftoolkit.html)) is a format
for handling forms within PDF documents.

``` {.php}
<?php
$outfdf = fdf_create();
fdf_set_value($outfdf, 'volume', $volume, 0);

fdf_set_file($outfdf, 'http:/testfdf/resultlabel.pdf');
fdf_save($outfdf, 'outtest.fdf');
fdf_close($outfdf);
Header('Content-type: application/vnd.fdf');
$fp = fopen('outtest.fdf', 'r');
fpassthru($fp);
unlink('outtest.fdf');
?>
```

See also [Form Data Format](https://www.php.net/manual/en/book.fdf.php).

  ------------- ----------------------------------------
  Short name    Extensions/Extfdf

  Rulesets      `CompatibilityPHP53`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

ext/mcrypt {#ext/mcrypt}
----------

Extension for mcrypt.

This extension has been deprecated as of PHP 7.1.0 and moved to PECL as
of PHP 7.2.0.

This is an interface to the mcrypt library, which supports a wide
variety of block algorithms such as DES, TripleDES, Blowfish (default),
3-WAY, SAFER-SK64, SAFER-SK128, TWOFISH, TEA, RC2 and GOST in CBC, OFB,
CFB and ECB cipher modes. Additionally, it supports RC6 and IDEA which
are considered \'non-free\'. CFB/OFB are 8bit by default.

``` {.php}
<?php
    # --- ENCRYPTION ---

    # the key should be random binary, use scrypt, bcrypt or PBKDF2 to
    # convert a string into a key
    # key is specified using hexadecimal
    $key = pack('H*', 'bcb04b7e103a0cd8b54763051cef08bc55abe029fdebae5e1d417e2ffb2a00a3');

    # show key size use either 16, 24 or 32 byte keys for AES-128, 192
    # and 256 respectively
    $key_size =  strlen($key);
    echo 'Key size: ' . $key_size . PHP_EOL;

    $plaintext = 'This string was AES-256 / CBC / ZeroBytePadding encrypted.';

    # create a random IV to use with CBC encoding
    $iv_size = mcrypt_get_iv_size(MCRYPT_RIJNDAEL_128, MCRYPT_MODE_CBC);
    $iv = mcrypt_create_iv($iv_size, MCRYPT_RAND);

    # creates a cipher text compatible with AES (Rijndael block size = 128)
    # to keep the text confidential 
    # only suitable for encoded input that never ends with value 00h
    # (because of default zero padding)
    $ciphertext = mcrypt_encrypt(MCRYPT_RIJNDAEL_128, $key,
                                 $plaintext, MCRYPT_MODE_CBC, $iv);

    # prepend the IV for it to be available for decryption
    $ciphertext = $iv . $ciphertext;

    # encode the resulting cipher text so it can be represented by a string
    $ciphertext_base64 = base64_encode($ciphertext);

    echo  $ciphertext_base64 . PHP_EOL;

    # === WARNING ===

    # Resulting cipher text has no integrity or authenticity added
    # and is not protected against padding oracle attacks.

    # --- DECRYPTION ---

    $ciphertext_dec = base64_decode($ciphertext_base64);

    # retrieves the IV, iv_size should be created using mcrypt_get_iv_size()
    $iv_dec = substr($ciphertext_dec, 0, $iv_size);

    # retrieves the cipher text (everything except the $iv_size in the front)
    $ciphertext_dec = substr($ciphertext_dec, $iv_size);

    # may remove 00h valued characters from end of plain text
    $plaintext_dec = mcrypt_decrypt(MCRYPT_RIJNDAEL_128, $key,
                                    $ciphertext_dec, MCRYPT_MODE_CBC, $iv_dec);

    echo  $plaintext_dec . PHP_EOL;
?>
```

See also [extension
mcrypt](http://www.php.net/manual/en/book.mcrypt.php) and
[mcrypt](http://mcrypt.sourceforge.net/).

  ------------- ----------------------------------------
  Short name    Extensions/Extmcrypt

  Rulesets      `CompatibilityPHP71`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

ext/mhash {#ext/mhash}
---------

Extension mhash (obsolete since PHP 5.3.0).

This extension provides functions, intended to work with
[mhash](http://mhash.sourceforge.net/).

``` {.php}
<?php
$input = 'what do ya want for nothing?';
$hash = mhash(MHASH_MD5, $input);
echo 'The hash is ' . bin2hex($hash) . '<br />'.PHP_EOL;
$hash = mhash(MHASH_MD5, $input, 'Jefe');
echo 'The hmac is ' . bin2hex($hash) . '<br />'.PHP_EOL;
?>
```

See also [Extension
mhash](https://www.php.net/manual/en/book.mhash.php).

  ------------- ----------------------------------------
  Short name    Extensions/Extmhash

  Rulesets      `CompatibilityPHP54`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

ext/ming {#ext/ming}
--------

Extension ext/ming, to create swf files with PHP.

Ming is an open-source (LGPL) library which allows you to create SWF
(\'Flash\') format movies.

``` {.php}
<?php
  $s = new SWFShape();
  $f = $s->addFill(0xff, 0, 0);
  $s->setRightFill($f);

  $s->movePenTo(-500, -500);
  $s->drawLineTo(500, -500);
  $s->drawLineTo(500, 500);
  $s->drawLineTo(-500, 500);
  $s->drawLineTo(-500, -500);

  $p = new SWFSprite();
  $i = $p->add($s);
  $i->setDepth(1);
  $p->nextFrame();

  for ($n=0; $n<5; ++$n) {
    $i->rotate(-15);
    $p->nextFrame();
  }

  $m = new SWFMovie();
  $m->setBackground(0xff, 0xff, 0xff);
  $m->setDimension(6000, 4000);

  $i = $m->add($p);
  $i->setDepth(1);
  $i->moveTo(-500,2000);
  $i->setName('box');

  $m->add(new SWFAction('/box.x += 3;'));
  $m->nextFrame();
  $m->add(new SWFAction('gotoFrame(0); play();'));
  $m->nextFrame();

  header('Content-type: application/x-shockwave-flash');
  $m->output();
?>
```

See also [Ming (flash)](http://www.libming.org/) and
[Ming](http://www.libming.org/).

  ------------- ----------------------------------------
  Short name    Extensions/Extming

  Rulesets      `CompatibilityPHP53`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

ext/mysql {#ext/mysql}
---------

Extension for MySQL (Original MySQL API).

This extension is deprecated as of PHP 5.5.0, and has been removed as of
PHP 7.0.0. Instead, either the mysqli or PDO\_MySQL extension should be
used. See also the MySQL API Overview for further help while choosing a
MySQL API. .. code-block:: php \<?php \$result = mysql\_query(\'SELECT
\* WHERE 1=1\'); if (!\$result) { die(\'Invalid query: \' .
mysql\_error()); } ?\> See also [Original MySQL
API](http://www.php.net/manual/en/book.mysql.php) and
[MySQL](http://www.mysql.com/).

  ------------- ----------------------------------------
  Short name    Extensions/Extmysql

  Rulesets      `CompatibilityPHP55`{.interpreted-text
                role="ref"}

  Php Version   With PHP 7.0 and older

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

filter\_input() As A Source {#filter\\_input()-as-a-source}
---------------------------

The [filter\_input()](https://www.php.net/filter_input) and
[filter\_input\_array()](https://www.php.net/filter_input_array)
functions access directly to `$_GET`. They represent a source for
external data just like `$_GET`, `$_POST`, etc.

The main feature of [filter\_input()](https://www.php.net/filter_input)
is that it is already filtered. The main drawback is that
`FILTER_FLAG_NONE` is the `none` filter, and that default configuration
is [FILTER\_UNSAFE\_RAW]{.title-ref}.

The filter extension keeps access to the incoming data, even after the
super globals, such as `$_GET`, are unset.

``` {.php}
<?php

// Removing $_GET
$_GET = [];

// with the default : FILTER_UNSAFE_RAW, this means XSS
echo filter_input(INPUT_GET, 'i');

// Same as above : 
echo filter_var(_GET, 'i');

?>
```

Thanks to [Frederic Bouchery](https://twitter.com/FredBouchery/) for
reporting this [special
case](https://twitter.com/FredBouchery/status/1049297213598457857).

See also [Data
filtering](https://www.php.net/manual/en/book.filter.php).

### Suggestions

-   Use the classic \$\_GET, \$\_POST super globals, which are easier to
    audit.
-   Use your framework\'s parameter access.

  ------------- ------------------------------
  Short name    Security/FilterInputSource

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Slow (1 hour)
  ------------- ------------------------------

fputcsv() In Loops {#fputcsv()-in-loops}
------------------

[fputcsv()](https://www.php.net/fputcsv) is slow when called on each
row. It actually flushes the data to the disk each time, and that
results in a inefficient dump to the disk, each call.

To speed up this process, it is recommended to dump the csv to memory
first, then dump the memory to the disk, in larger chunks. Since
[fputcsv()](https://www.php.net/fputcsv) works only on stream, it is
necessary to use a memory stream.

``` {.php}
<?php

// Speedy yet memory intensive version
$f = fopen('php://memory', 'w+');
foreach($data_source as $row) {
    // You may configure fputcsv as usual
    fputcsv($f, $row);
}
rewind($f); // Important
$fp = fopen('final.csv', 'w+');
fputs($fp, stream_get_contents($f));
fclose($fp);
fclose($f);

// Slower version
$fp = fopen('final.csv', 'w+');
foreach($data_source as $row) {
    // You may configure fputcsv as usual
    fputcsv($fp, $row);
}
fclose($fp);
?>
```

The speed improvement is significant on small rows, while it may be less
significant on larger rows : with more data in the rows, the file buffer
may fill up more efficiently. On small rows, the speed gain is up to 7
times.

### Suggestions

-   Use fputcsv() on a memory stream, and flush it on the disk once

  ------------- -----------------------------------
  Short name    Performances/CsvInLoops

  Rulesets      `Performances`{.interpreted-text
                role="ref"},
                `Top10`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- -----------------------------------

func\_get\_arg() Modified {#func\\_get\\_arg()-modified}
-------------------------

[func\_get\_arg()](https://www.php.net/func_get_arg) and
[func\_get\_args()](https://www.php.net/func_get_args) used to report
the calling value of the argument until PHP 7. Since PHP 7, it is
reporting the value of the argument at calling time, which may have been
modified by a previous instruction.

``` {.php}
<?php

function x($a) {
    $a++;
    print func_get_arg(0);
}

x(0);
?>
```

This code will display 1 in PHP 7, and 0 in PHP 5.

  ------------- -------------------------------------------
  Short name    Functions/funcGetArgModified

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CompatibilityPHP70`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- -------------------------------------------

idn\_to\_ascii() New Default {#idn\\_to\\_ascii()-new-default}
----------------------------

The default parameter value of
[idn\_to\_ascii()](https://www.php.net/idn_to_ascii) and
[idn\_to\_utf8()](https://www.php.net/idn_to_utf8) is now
INTL\_IDNA\_VARIANT\_UTS46 instead of the deprecated
INTL\_IDNA\_VARIANT\_2003.

``` {.php}
<?php

echo idn_to_ascii('täst.de'); 

?>
```

See also
[idn\_to\_ascii](https://www.php.net/manual/en/function.idn-to-ascii.php),
[idn\_to\_utf8](https://www.php.net/manual/en/function.idn-to-utf8.php)
and [Unicode IDNA Compatibility
Processing](http://unicode.org/reports/tr46/).

### Suggestions

-   Explicitely add the second parameter to the idn\_to\_ascii() and
    idn\_to\_utf8() functions.

  ------------ ----------------------------------------
  Short name   Php/IdnUts46

  Rulesets     `CompatibilityPHP74`{.interpreted-text
               role="ref"}
  ------------ ----------------------------------------

include\_once() Usage {#include\\_once()-usage}
---------------------

include\_once() and require\_once() functions should be avoided for
performances reasons.

``` {.php}
<?php

// Including a library. 
include 'lib/helpers.inc';

// Including a library, and avoiding double inclusion
include_once 'lib/helpers.inc';

?>
```

Try using autoload for loading classes, or use include() or require()
and make it possible to include several times the same file without
errors.

### Suggestions

-   Avoid using include\_once() whenever possible
-   Use autoload() to load classes, and avoid loading them with include

  ----------- -----------------------------------------------------------
  Short name  Structures/OnceUsage

  Rulesets    `Analyze`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Quick (30 mins)

  Examples    `xoops-structures-onceusage`{.interpreted-text role="ref"},
              `tikiwiki-structures-onceusage`{.interpreted-text
              role="ref"}
  ----------- -----------------------------------------------------------

isset() With Constant {#isset()-with-constant}
---------------------

Until PHP 7, it was possible to use arrays as constants, but it was not
possible to test them with [isset](https://www.www.php.net/isset).

``` {.php}
<?php
const X = [1,2,3];

if (isset(X[4])) {}
?>
```

This would yield an error :
`` Cannot use `isset() <https://www.www.php.net/isset>`_ on the result of an expression (you can use "null !== expression" instead) ``.
This is a backward incompatibility.

  ---------- --------------------------------------------------------------
  Short name Structures/IssetWithConstant

  Rulesets   `CompatibilityPHP53`{.interpreted-text role="ref"},
             `CompatibilityPHP54`{.interpreted-text role="ref"},
             `CompatibilityPHP55`{.interpreted-text role="ref"},
             `CompatibilityPHP56`{.interpreted-text role="ref"}

  Php        With PHP 7.0 and more recent
  Version    

  Severity   Major

  Time To    Instant (5 mins)
  Fix        
  ---------- --------------------------------------------------------------

list() May Omit Variables {#list()-may-omit-variables}
-------------------------

Simply omit any unused variable in a [list()](https://www.php.net/list)
call.

[list()](https://www.php.net/list) is the only PHP function that accepts
to have omitted arguments. If the following code makes no usage of a
listed variable, just omit it.

``` {.php}
<?php
    // No need for '2', so no assignation
    list ($a, , $b) = array(1, 2, 3);

    // works with PHP 7.1 short syntax
    [$a, , $b] = array(1, 2, 3);

    // No need for '2', so no assignation
    list ($a, $c, $b) = array(1, 2, 3);
?>
```

See also [list](https://www.php.net/manual/en/function.list.php).

### Suggestions

-   Remove the unused variables from the list call
-   When the ignored values are at the beginning or the end of the
    array, array\_slice() may be used to shorten the array.

  ----------- ------------------------------------------------------------
  Short name  Structures/ListOmissions

  Rulesets    `Analyze`{.interpreted-text role="ref"},
              `Suggestions`{.interpreted-text role="ref"},
              `CI-checks`{.interpreted-text role="ref"}

  Severity    Minor

  Time To Fix Quick (30 mins)

  Precision   Very high

  Examples    `openconf-structures-listomissions`{.interpreted-text
              role="ref"},
              `fuelcms-structures-listomissions`{.interpreted-text
              role="ref"}
  ----------- ------------------------------------------------------------

mb\_strrpos() Third Argument {#mb\\_strrpos()-third-argument}
----------------------------

Passing the encoding as 3rd parameter to
[mb\_strrpos()](https://www.php.net/mb_strrpos) is deprecated. Instead
pass a 0 offset, and encoding as 4th parameter.

``` {.php}
<?php

// Finds the position of the last occurrence of of a string in a string, starting at position 10
$extract = mb_strrpos($haystack, $needle, 10, 'utf8');

// This is the old behavior. Here, the offset will be 0, by default
$extract = mb_strrpos($haystack, $needle, 'utf8');
?>
```

See also [mb\_strrpos()](https://www.php.net/mb_strrpos).

### Suggestions

-   

  ------------- ----------------------------------------
  Short name    Php/Php74mbstrrpos3rdArg

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ----------------------------------------

mcrypt\_create\_iv() With Default Values {#mcrypt\\_create\\_iv()-with-default-values}
----------------------------------------

Avoid using
[mcrypt\_create\_iv()](https://www.php.net/manual/en/function.mcrypt-create-iv.php)
default values.

[mcrypt\_create\_iv()](https://www.php.net/manual/en/function.mcrypt-create-iv.php)
used to have `MCRYPT_DEV_RANDOM` as default values, and in PHP 5.6, it
now uses `MCRYPT_DEV_URANDOM`.

``` {.php}
<?php
    $size = mcrypt_get_iv_size(MCRYPT_CAST_256, MCRYPT_MODE_CFB);
    // mcrypt_create_iv is missing the second argument
    $iv = mcrypt_create_iv($size);

// Identical to the line below
//    $iv = mcrypt_create_iv($size, MCRYPT_DEV_RANDOM);

?>
```

If the code doesn\'t have a second argument, it relies on the default
value. It is recommended to set explicitly the value, so has to avoid
problems while migrating.

See also
[mcrypt\_create\_iv()](https://www.php.net/manual/en/function.mcrypt-create-iv.php).

  ------------- ----------------------------------------
  Short name    Structures/McryptcreateivWithoutOption

  Rulesets      `CompatibilityPHP70`{.interpreted-text
                role="ref"}

  Php Version   With PHP 5.6 and older

  Severity      Minor

  Time To Fix   Instant (5 mins)
  ------------- ----------------------------------------

move\_uploaded\_file Instead Of copy {#move\\_uploaded\\_file-instead-of-copy}
------------------------------------

Always use
[move\_uploaded\_file()](https://www.php.net/move_uploaded_file) with
uploaded files. Avoid using copy or rename with uploaded file.

[move\_uploaded\_file()](https://www.php.net/move_uploaded_file) checks
to ensure that the file designated by filename is a valid upload file
(meaning that it was uploaded via PHP\'s HTTP POST upload mechanism).

``` {.php}
<?php

    // $a->file was filled with $_FILES at some point
    move_uploaded_file($a->file['tmp_name'], $target);

    // $a->file was filled with $_FILES at some point
    rename($a->file['tmp_name'], $target);

?>
```

See also [move\_uploaded\_file](https://www.php.net/move_uploaded_file)
and [Uploading Files with
PHP](https://www.sitepoint.com/file-uploads-with-php/).

### Suggestions

-   Always use move\_uploaded\_file()
-   Extract the needed information from the file, and leave it for PHP
    to remove without storage

  ------------- ------------------------------
  Short name    Security/MoveUploadedFile

  Rulesets      `Security`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------

openssl\_random\_pseudo\_byte() Second Argument {#openssl\\_random\\_pseudo\\_byte()-second-argument}
-----------------------------------------------

openssl\_random\_pseudo\_byte() uses exceptions to signal an error.
Since PHP 7.4, there is no need to use the second argument.

On the other hand, it is important to catch the exception that
openssl\_random\_pseudo\_byte() may emit.

``` {.php}
<?php
    // PHP 7.4 way to check on random number generation
    try {
        $bytes = openssl_random_pseudo_bytes($i);
    } catch(\Exception $e) {
        die(Error while loading random number);
    }

    // Old way to check on random number generation
    $bytes = openssl_random_pseudo_bytes($i, $cstrong);
    if ($cstrong === false) {
        die(Error while loading random number);
    }
?>
```

See also
[openssl\_random\_pseudo\_byte](https://www.php.net/openssl_random_pseudo_bytes)
and [PHP RFC: Improve \`openssl\_random\_pseudo\_bytes()
\<https://www.php.net/openssl\_random\_pseudo\_bytes\>]{.title-ref}\_
\<<https://wiki.php.net/rfc/improve-openssl-random-pseudo-bytes>\>\`\_.

### Suggestions

-   Skip the second argument, add a try/catch around the call to
    openssl\_random\_pseudo\_bytes()

  ------------- ---------------------------------------------
  Short name    Structures/OpensslRandomPseudoByteSecondArg

  Rulesets      `CompatibilityPHP74`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ---------------------------------------------

parse\_str() Warning {#parse\\_str()-warning}
--------------------

The [parse\_str()](https://www.php.net/parse_str) function parses a
query string and assigns the resulting variables to the local scope.
This may create a unexpected number of variables, and even overwrite the
existing one.

``` {.php}
<?php
  function foo( ) {
    global $a;

    echo $a;
  }

  parse_str('a=1'); // No second parameter
  foo( );
  // displays 1
?>
```

Always use an empty variable a second parameter to
[parse\_str()](https://www.php.net/parse_str), so as to collect the
incoming values, and then, filter them in that array.

### Suggestions

-   Use the second parameter when calling parse\_url();
-   Change to PHP 8.0 version, which made the second argument compulsory

  ---------- ----------------------------------------------------------------------------------------------------
  Short name Security/parseUrlWithoutParameters

  Rulesets   `Security`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Slow (1 hour)
  Fix        

  ClearPHP   [know-your-variables](https://github.com/dseguy/clearPHP/tree/master/rules/know-your-variables.md)
  ---------- ----------------------------------------------------------------------------------------------------

preg\_match\_all() Flag {#preg\\_match\\_all()-flag}
-----------------------

[preg\_match\_all()](https://www.php.net/preg_match_all) has an option
to configure the structure of the results : it is either by capturing
parenthesis (by default), or by result sets.

The second option is the most interesting when the following
[foreach()](https://www.php.net/manual/en/control-structures.foreach.php)
loop has to manipulate several captured strings at the same time. No
need to use an index in the first array and use it in the other arrays.

``` {.php}
<?php
$string = 'ababab';

// default behavior
preg_match_all('/(a)(b)/', $string, $r);
$found = '';
foreach($r[1] as $id => $s) {
    $found .= $s.$r[2][$id];
}

// better behavior
preg_match_all('/(a)(b)/', $string, $r, PREG_SET_ORDER);
$found = '';
foreach($r as $s) {
    $found .= $s[1].$s[2];
}

?>
```

The second syntax is easier to read and may be marginally faster to
execute ([preg\_match\_all()](https://www.php.net/preg_match_all) and
[foreach())](https://www.php.net/manual/en/control-structures.foreach.php).

### Suggestions

-   Use flags to adapt the results of preg\_match\_all() to your code,
    not the contrary.

  ------------- --------------------------------------------------
  Short name    Php/PregMatchAllFlag

  Rulesets      `Suggestions`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)

  Examples      `fuelcms-php-pregmatchallflag`{.interpreted-text
                role="ref"}
  ------------- --------------------------------------------------

preg\_replace With Option e {#preg\\_replace-with-option-e}
---------------------------

[preg\_replace()](https://www.php.net/preg_replace) supported the /e
option until PHP 7.0. It allowed the use of
[eval()](https://www.php.net/eval)\'ed expression as replacement. This
has been dropped in PHP 7.0, for security reasons.

[preg\_replace()](https://www.php.net/preg_replace) with /e option may
be replaced with
[preg\_replace\_callback()](https://www.php.net/preg_replace_callback)
and a closure, or
[preg\_replace\_callback\_array()](https://www.php.net/preg_replace_callback_array)
and an array of closures.

``` {.php}
<?php

// preg_replace with /e
$string = 'abcde';

// PHP 5.6 and older usage of /e
$replaced = preg_replace('/c/e', 'strtoupper($0)', $string);

// PHP 7.0 and more recent
// With one replacement
$replaced = preg_replace_callback('/c/', function ($x) { return strtoupper($x[0]); }, $string);

// With several replacements, preventing multiple calls to preg_replace_callback
$replaced = preg_replace_callback_array(array('/c/' => function ($x) { return strtoupper($x[0]); },
                                              '/[a-b]/' => function ($x) { return strtolower($x[0]); }), $string);
?>
```

### Suggestions

-   Replace call to preg\_replace() and /e with
    preg\_replace\_callback() or preg\_replace\_callback\_array()

  ---------- ----------------------------------------------------------------
  Short name Structures/pregOptionE

  Rulesets   `Analyze`{.interpreted-text role="ref"},
             `CompatibilityPHP70`{.interpreted-text role="ref"},
             `Security`{.interpreted-text role="ref"},
             `CompatibilityPHP71`{.interpreted-text role="ref"},
             `CompatibilityPHP72`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Major

  Time To    Quick (30 mins)
  Fix        

  Examples   `edusoho-structures-pregoptione`{.interpreted-text role="ref"}
  ---------- ----------------------------------------------------------------

self, parent, static Outside Class {#self,-parent,-static-outside-class}
----------------------------------

[self](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php),
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
and [static](https://www.php.net/manual/en/language.oop5.static.php)
should be called inside a class or trait. PHP lint won\'t report those
situations.

[self](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php),
[parent](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
and [static](https://www.php.net/manual/en/language.oop5.static.php) may
be used in a trait : their actual value will be only known at execution
time, when the trait is used.

``` {.php}
<?php
// In the examples, self, parent and static may be used interchangeably

// This raises a Fatal error
//Fatal error: Uncaught Error: Cannot access static:: when no class scope is active
new static();

// static calls
echo self::CONSTANTE;
echo self::$property;
echo self::method();

// as a type hint
function foo(static $x) {
    doSomething();
}

// as a instanceof
if ($x instanceof static) {
    doSomething();
}

?>
```

Such syntax problem is only revealed at execution time : PHP raises a
Fatal error.

The origin of the problem is usually a method that was moved outside a
class, at least temporarily.

See also [Scope Resolution Operator
(::)](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php).

  ------------- ----------------------------------------
  Short name    Classes/NoPSSOutsideClass

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `LintButWontExec`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

set\_exception\_handler() Warning {#set\\_exception\\_handler()-warning}
---------------------------------

The
[set\_exception\_handler()](https://www.php.net/set_exception_handler)
callable function has to be adapted to PHP 7 : `Exception` is not the
right typehint, it is now `Throwable`.

When in doubt about backward compatibility, just drop the typehint.
Otherwise, use `Throwable`.

``` {.php}
<?php

// PHP 5.6- typehint 
class foo { function bar(\Exception $e) {} }

// PHP 7+ typehint 
class foo { function bar(Throwable $e) {} }

// PHP 5 and PHP 7 compatible typehint (note : there is none)
class foo { function bar($e) {} }

set_exception_handler(foo);

?>
```

  ------------- ----------------------------------------
  Short name    Php/SetExceptionHandlerPHP7

  Rulesets      `CompatibilityPHP70`{.interpreted-text
                role="ref"}

  Severity      Major

  Time To Fix   Slow (1 hour)
  ------------- ----------------------------------------

strip\_tags Skips Closed Tag {#strip\\_tags-skips-closed-tag}
----------------------------

[strip\_tags()](https://www.php.net/strip_tags) skips
non-[self](https://www.php.net/manual/en/language.oop5.paamayim-nekudotayim.php)
closing tags. This means that tags such as `<br />` will be ignored from
the 2nd argument of the function.

``` {.php}
<?php

$input = 'a<br />';

// Displays 'a' and clean the tag
echo strip_tags($input, '<br>');

// Displays 'a<br />' and skips the allowed tag
echo strip_tags($input, '<br/>');

?>
```

See also
[strip\_tags](https://www.php.net/manual/en/function.strip-tags.php).

### Suggestions

-   Do not use self-closing tags in the 2nd parameter

  ------------- ------------------------------------
  Short name    Structures/StripTagsSkipsClosedTag

  Rulesets      `Analyze`{.interpreted-text
                role="ref"},
                `CI-checks`{.interpreted-text
                role="ref"}

  Severity      Minor

  Time To Fix   Quick (30 mins)
  ------------- ------------------------------------

strpos() Too Much {#strpos()-too-much}
-----------------

[strpos()](https://www.php.net/strpos) covers the whole string before
reporting 0. If the expected string is expected be at the beginning, or
a fixed place, it is more stable to use
[substr()](https://www.php.net/substr) for comparison.

The longer the haystack (the searched string), the more efficient is
that trick. The string has to be 10k or more to have impact, unless it
is in a loop.

``` {.php}
<?php

// This always reads the same amount of string
if (substr($html, 0, 6) === '<html>') {

}

// When searching for a single character, checking with a known position ($string[$position]) is even faster
if ($html[0] === '<') {

}

// With strpos(), the best way is to search for something that exist, and use absence as worst case scenario 
if (strpos($html, '<html>') > 0) {

} else {
    // 
}

// When the search fails, the whole string has been read
if (strpos($html, '<html>') === 0) {

}

?>
```

This applies to [stripos()](https://www.php.net/stripos) too.

### Suggestions

-   Check for presence, and not for absence
-   use substr() and compare the extracted string
-   For single chars, try using the position in the string

  ------------- ----------------------------------------------------------
  Short name    Performances/StrposTooMuch

  Rulesets      `Analyze`{.interpreted-text role="ref"},
                `CI-checks`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)

  Examples      `wordpress-performances-strpostoomuch`{.interpreted-text
                role="ref"}
  ------------- ----------------------------------------------------------

time() Vs strtotime() {#time()-vs-strtotime()}
---------------------

[time()](https://www.php.net/time) is actually faster than
[strtotime()](https://www.php.net/strtotime) with \'now\' key string.

``` {.php}
<?php

// Faster version
$a = time();

// Slower version
$b = strtotime('now');

?>
```

This is a micro-optimisation. Relative gain is real, but small unless
the function is used many times.

### Suggestions

-   Replace strtotime() with time(). Do not change strtotime() with
    other value than \'now\'.

  ------------- --------------------------------------------------------------
  Short name    Performances/timeVsstrtotime

  Rulesets      `Performances`{.interpreted-text role="ref"}

  Severity      Minor

  Time To Fix   Instant (5 mins)

  Examples      `woocommerce-performances-timevsstrtotime`{.interpreted-text
                role="ref"}
  ------------- --------------------------------------------------------------

var\_dump()\... Usage {#var\\_dump()...-usage}
---------------------

[var\_dump()](https://www.php.net/var_dump), print\_r() or
[var\_export()](https://www.php.net/var_export) should not be left in
any production code. They are debugging functions.

``` {.php}
<?php

if ($error) {
    // Debugging usage of var_dump
    // And major security problem 
    var_dump($query);

    // This is OK : the $query is logged, and not displayed
    $this->log(print_r($query, true));
}

?>
```

They may be tolerated during development time, but must be removed so as
not to have any chance to be run in production.

### Suggestions

-   Remove usage of var\_dump(), print\_r(), var\_export() without 2nd
    argument, and other debug functions.
-   Push all logging to an external file, instead of the browser.

  ---------- ----------------------------------------------------------------------------------------
  Short name Structures/VardumpUsage

  Rulesets   `Analyze`{.interpreted-text role="ref"}, `Security`{.interpreted-text role="ref"},
             `CI-checks`{.interpreted-text role="ref"}

  Severity   Critical

  Time To    Instant (5 mins)
  Fix        

  ClearPHP   [no-debug-code](https://github.com/dseguy/clearPHP/tree/master/rules/no-debug-code.md)

  Examples   `tine20-structures-vardumpusage`{.interpreted-text role="ref"},
             `piwigo-structures-vardumpusage`{.interpreted-text role="ref"}
  ---------- ----------------------------------------------------------------------------------------
